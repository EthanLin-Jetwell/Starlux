public without sharing class BPPController {
    public static String PAGENAME = 'BoardingPassPrinting';
    
    public String errorMessage { get; set; }
    public Boolean showActionButtons { get; set; }//c4 showç™»æ©Ÿè­‰
    public String selectedEmail { get; set; }
    public String noticeContent { get; set; }  // æ–°å¢ç”¨æ–¼å­˜å„²å…¬å‘Šå…§å®¹çš„å±¬æ€§
    public UserManagement__c currentAccount { get; set; }
    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç•«é¢ç¶å®šç”¨å±¬æ€§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    public String  flightPrefix  { get; set; }
    public String  flightNumber  { get; set; }
    public String  departureLocation { get; set; }
    public Date    departureDate { get; set; }
    public String  departureDateStr { get; set; }
    public String  bookingCodes  { get; set; }          // é€—è™Ÿåˆ†éš” PNR
    public Boolean c4OperationDisabled { get; set; }
    public Datetime C4BoardingPassPrintedTimeGMTLocal;
    

    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CSVæ–‡ä»¶ä¸Šå‚³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    public Blob csvFileBody { get; set; }
    public String csvFileName { get; set; }
    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ çµæœé¡¯ç¤ºç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    public List<String> pnrKeys  { get; set; }          // åˆ†é ç±¤
    public String currentTabKey { get; set; }       // é è¨­é¡¯ç¤º
    public List<TravellerInfo__c> travelerList { get; set; }
    public Map<Id, TravellerInfo__c> oldMap { get; set; }
    
    public Map<String , List<PassengerDataWrapper.PassengerInfo>> tabData { get; set; }
    public Boolean showUSFields { get; private set; }
    public Integer currentPage { get; set; }
    public Integer pageSize { get; set; }
    public Integer totalRecords { get; set; }
    public Integer totalPages {
        get {
            if (totalRecords == null || pageSize == null || pageSize == 0) return 1;
            System.debug(totalRecords);
            System.debug(totalPages);System.debug(pageSize);
            System.debug((Integer)Math.ceil((Decimal)totalRecords / pageSize));
            return (Integer)Math.ceil((Decimal)totalRecords / pageSize);
        }
    }
    //for email
    public static Map<String, String>  destinationMap;
    public static Map<String, Integer>  groupCountMap;
    
    /* å‰ç«¯å›å‚³ä¿®æ”¹å…§å®¹çš„ JSON */
    public String jsonInput { get; set; }
    
    public BPPController() {
        pageSize = 50; 
        flightPrefix = 'JX';
        bookingCodes = '';
        currentPage = 1; 
        pnrKeys = new List<String>();
        tabData = new Map<String,List<PassengerDataWrapper.PassengerInfo>>();
        travelerList = new List<TravellerInfo__c>();
        Id recId = ApexPages.currentPage().getParameters().get('id');
        if (recId != null) {
            TravellerInfo__c t = [
                SELECT C4OperationDisable__c
                FROM TravellerInfo__c
                WHERE Id = :recId
                LIMIT 1
            ];
            c4OperationDisabled = t.C4OperationDisable__c;
        } else {
            c4OperationDisabled = false; // é è¨­é¡¯ç¤º
        }
        
        currentAccount = [SELECT Id, Company__c FROM UserManagement__c WHERE Id = :CommonController.getAccountIdFromCookie()];
        
        loadnoticeContent();
    }
    
    /* ---------- æ–°å¢ï¼šå·ï¼çœé¸å–®è³‡æ–™ ---------- */
    private List<String> usStates;                        // åªå­˜ç´”å­—ä¸²
    public List<SelectOption> getUSStateOptions() {       // VF ç«¯å‘¼å«
        if (usStates == null) {
            loadUSStates();
        }
        List<SelectOption> opts = new List<SelectOption>();
        for (String s : usStates) {
            opts.add(new SelectOption(s, s));
        }
        return opts;
    }
    
    private void loadUSStates() {
        usStates = new List<String>();
        List<B2B_Parameter__c> p = [
            SELECT Value__c
            FROM   B2B_Parameter__c
            WHERE  Label__c = 'å·/çœä¸‹æ‹‰é¸å–®'
            LIMIT  1
        ];
        if (!p.isEmpty() && p[0].Value__c != null) {
            for (String s : p[0].Value__c.split(',')) {
                usStates.add(s.trim());
            }
        }
        usStates.sort();
    }
    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å»ºæ§‹å­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* ---------- èµ·é£›åœ°æ¸…å–® ---------- */
    public List<String> origins;
    
    public List<SelectOption> getOriginOptions() {
        if (origins == null) {   
            loadOrigins();
        }
        
        List<SelectOption> opts = new List<SelectOption>();
        opts.add( new SelectOption('TPE', 'TPE') ); 
        
        for (String d : origins) {
            opts.add( new SelectOption(d, d) );
        }
        return opts;
    }
    
    private void loadOrigins() {
        Set<String> depSet = new Set<String>();
        for (AirportCode__c ac : [
            SELECT Departure__c
            FROM   AirportCode__c
            WHERE  RecordType.name = 'B2B Airport Code'
            AND    Departure__c != null 
            AND    Active__c = true
            ORDER BY Departure__c ASC
        ]) {
            depSet.add(ac.Departure__c);
        }
        
        origins = new List<String>(depSet);
        origins.sort();
    }
    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æŸ¥è©¢ PNR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    public PageReference searchPnr() {
        // ä¸€é–‹å§‹å°±æ¸…æ‰å‰ä¸€æ¬¡çš„çµæœ
        pnrKeys.clear();
        tabData.clear();
        travelerList.clear(); 
        errorMessage = '';
        currentTabKey = null;
        showUSFields = false;
        /* 0. åŸºæœ¬æ¬„ä½æª¢æŸ¥ ------------------- */
        if (currentPage == null) currentPage = 1;
        if (totalRecords == null) totalRecords = 0;
        
        if (String.isBlank(bookingCodes) ||
            String.isBlank(flightNumber)  ||
            String.isBlank(departureLocation)|| 
            String.isBlank(departureDateStr) ) {
                errorMessage = 'è«‹è¼¸å…¥ã€Œè¨‚ä½ä»£è™Ÿã€èˆªç­è™Ÿç¢¼ã€èµ·é£›æ—¥æœŸã€èµ·é£›åœ°ã€å¾Œå†æœå°‹';
                ApexPages.addMessage(
                    new ApexPages.Message(
                        ApexPages.Severity.ERROR,
                        'è«‹è¼¸å…¥ã€Œè¨‚ä½ä»£è™Ÿã€èˆªç­è™Ÿç¢¼ã€èµ·é£›æ—¥æœŸã€èµ·é£›åœ°ã€å¾Œå†æœå°‹'
                    )
                );
                return null;
            }
        try {
            String norm = departureDateStr.replace('/', '-');
            departureDate = Date.valueOf(norm);
        } catch (Exception e) {
            errorMessage = 'æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡';
            ApexPages.addMessage(
                new ApexPages.Message(
                    ApexPages.Severity.ERROR,
                    'æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡'
                )
            );
            return null;
        }
        
        /* 1. è§£æ PNR (å¯è¼¸å…¥å¤šç¢¼é€—è™Ÿåˆ†éš”) ------ */
        List<String> rawPnrKeys = bookingCodes.contains(',') ?
            bookingCodes.split(',') :
        new List<String>{ bookingCodes.trim() };
            /*
pnrKeys = bookingCodes.contains(',') ?
bookingCodes.split(',') :
new List<String>{ bookingCodes.trim() };
*/
            String fn = String.isBlank(flightNumber) ? null : flightNumber.trim();
        DateTime startOfDay = DateTime.newInstance(
            departureDate.year(),
            departureDate.month(),
            departureDate.day(),
            0, 0, 0               // 00:00:00ï¼ˆæœ¬åœ°ï¼‰
        );
        DateTime endOfDay = startOfDay.addDays(1).addSeconds(-1);  // 23:59:59
        
        /* 2. æŸ¥ TravellerInfo__c -------------- */
        //Erickä¿®æ”¹164~2
        //WBS PNR_ListPaxByFlight
        Map<String, String> extractedPNRs = AmadeusUtil.listPNRByFlight(fn,departureDate.format()+'');
        // ç¯©é¸å‡ºå…©è€…äº¤é›†çš„ PNR æ¸…å–®
        List<String> matchedPnrKeys = new List<String>();
        List<String> unmatchedPnrKeys = new List<String>();
        System.debug('èµ·é£›åœ°:'+departureLocation);
        for (String p : rawPnrKeys) {
            if (extractedPNRs.containsKey(p) && extractedPNRs.get(p) == departureLocation) {
                matchedPnrKeys.add(p);
            } else {
                unmatchedPnrKeys.add(p);
            }
        }
        System.debug('ç¬¦åˆçš„PNR:'+matchedPnrKeys);
        System.debug('ä¸ç¬¦åˆçš„PNR:'+unmatchedPnrKeys); 
        //WBS PNR_Retrieve
        for (String pnr : matchedPnrKeys) {
            try {
                travelerList.addAll(AmadeusUtil.retrievePNRC4(departureLocation, pnr));
            } catch (Exception ex) {
                System.debug('âš ï¸ PNR_Retrieve å¤±æ•—ï¼š' + pnr + 'ï¼ŒéŒ¯èª¤ï¼š' + ex.getMessage());
                errorMessage = 'âš ï¸ PNR_Retrieve å¤±æ•—ï¼š' + pnr + 'ï¼ŒéŒ¯èª¤ï¼š' + ex.getMessage();
            }
        }
        if(travelerList.size() > 0){
            upsert travelerList External_ID__c;
        }
        // è‹¥ unmatched æœ‰å…§å®¹ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œä½†ä¸ä¸­æ–·æµç¨‹
        if (!unmatchedPnrKeys.isEmpty()) {
            //error toast
            /*
String missingMsg = 'æŸ¥ç„¡PNR : ' + String.join(unmatchedPnrKeys, ',');

ApexPages.addMessage(
new ApexPages.Message(ApexPages.Severity.ERROR, missingMsg)
);
ApexPages.currentPage().getHeaders().put('pnr-missing', missingMsg);
*/
            errorMessage = 'æŸ¥ç„¡éƒ¨åˆ†PNR : ' + String.join(unmatchedPnrKeys, ',');
        }
        // è‹¥å®Œå…¨æ²’äº¤é›†ï¼ˆmatched ç‚ºç©ºï¼‰ï¼Œå°±ä¸­æ–·
        if (matchedPnrKeys.isEmpty()) {
            //error toast
            /*
String missingMsg = 'æŸ¥ç„¡PNR : ' + String.join(unmatchedPnrKeys, ',');
ApexPages.addMessage(
new ApexPages.Message(ApexPages.Severity.ERROR, missingMsg)
);
ApexPages.currentPage().getHeaders().put('pnr-missing', missingMsg);
*/
            errorMessage = 'æŸ¥ç„¡PNR : ' + String.join(unmatchedPnrKeys, ',');
            return null;
        }
        
        oldMap = new Map<Id, TravellerInfo__c>([
            SELECT Id, PNR__c,
            LastName__c, FirstName__c, Title__c, Gender__c, PT__c, ST01__c, ST02__c,
            Country__c, DateOfBirth__c, PassengerType__c, PassportFinished__c,
            PassportNumber__c, PassportExpiryDate__c, PassportIssuingCountry__c,DepartureLocation__c,US_Bound__c,
            VisaNumber__c, VisaExpiryDate__c, VisaIssuingCountry__c,
            USAStreet__c, USACity__c, USAState__c, USAZipCode__c,
            USAEmergencyContactName__c, USAEmergencyContactNationality__c, USAEmergencyContactPhone__c,	Seat__c,
            CheckDisable__c, C3ExternalFinished__c, C3Finished__c, C4BoardingPassPrinted__c, C4BoardingPassPrintedTime__c,C4BoardingPassPrintedTimeGMTLocal__c,
            C4EBoardingPass__c, C4PaperBoardingPass__c, PrintDisable__c, DepartureLocationGMTLocal__c, Barcode__c, PAX__c, Service__c, Meal__c, IATA_MSO_Code__c, RQST_OT__c,
            C1Finished__c, UCI__c ,DID__c ,CAS__c ,DepartureDate__c ,DepartureDate2__c ,FlightNumber__c ,Destination__c ,C3Status__c,C4Finished__c,C3CheckboxDisplay__c, C4CheckboxDisplay__c,
            C1OperationDisable__c, C2OperationDisable__c, C3OperationDisable__c, C4OperationDisable__c, APE__c, APM__c, group_code__c
            FROM   TravellerInfo__c
            //WHERE  PNR__c                 IN :pnrKeys
            WHERE  PNR__c                 IN :matchedPnrKeys
            //AND    FlightNumber__c        =  :fn
            AND    DepartureLocation__c=  :departureLocation
            //AND    DepartureLocationGMTLocal__c >= :startOfDay
            //AND    DepartureLocationGMTLocal__c <= :endOfDay
            ORDER  BY PTOrderBy__c ASC,
            PassengerTypeOrderBy__c ASC
        ]);
        showActionButtons = true;
        
        travelerList = oldMap.values();
        
        c4OperationDisabled = false; // é è¨­å¯æ“ä½œ
        for (TravellerInfo__c t : travelerList) {
            if (t.C4OperationDisable__c) {
                c4OperationDisabled = true;
                break; // æœ‰ä¸€ç­†æ˜¯ true å°±å¯ä»¥åœäº†
            }
        }
        
        System.debug('ç›®å‰æ™‚é–“ï¼š' + DateTime.now());
            
        for (TravellerInfo__c t : travelerList) {
            System.debug('PNR å‡ºç™¼æ™‚é–“ï¼š' + t.DepartureLocationGMTLocal__c);
            
            if (t.DepartureLocationGMTLocal__c != null &&
                t.DepartureLocationGMTLocal__c < DateTime.now()) {
                    System.debug('âœ‹ é€™ç­†å·²éæœŸï¼Œä¸é¡¯ç¤º checkbox');
                    //showActionButtons = false;  2025/08/18 Aaron ä¸çŸ¥é“é€™çµ„æ˜¯æ‹¿ä¾†å¹¹å˜›ç”¨çš„
                    break;
                }
        }
        showUSFields = false; 
        
        if (travelerList.isEmpty()) {
            pnrKeys.clear();
            tabData.clear();
            currentTabKey = null;
            ApexPages.addMessage(
                new ApexPages.Message(
                    ApexPages.Severity.INFO,
                    'æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªæ¢ä»¶æ˜¯å¦æ­£ç¢º'
                )
            );
            return null;
        }
        
        destinationMap = new Map<String, String>();
        groupCountMap = new Map<String, Integer>();
        for (TravellerInfo__c t : travelerList) {
            if(!destinationMap.containsKey(t.pnr__c)) {
                destinationMap.put(t.pnr__c, t.Destination__c);
            }
            if(groupCountMap.containsKey(t.pnr__c)) {
                groupCountMap.put(t.pnr__c, groupCountMap.get(t.pnr__c)+1);
            } else {
                groupCountMap.put(t.pnr__c, 1);
            }
            
            if (t.US_Bound__c) {
                showUSFields = true;
                break;
            }
        }
        
        /* 3. è½‰æˆ Map<PNR , List<PassengerInfo>> çµæ§‹ */
        tabData.clear();
        
        tabData = new PassengerDataWrapper(travelerList).passengerData;
        
        /* 4. ç”¢ç”Ÿåˆ†é ç±¤ç´¢å¼• */
        // åˆ†é ç”¨ key é›†åˆ
        List<String> allKeys = new List<String>(tabData.keySet());
        allKeys.sort();
        totalRecords = 0;
        for (String key : allKeys) {
            totalRecords += tabData.get(key).size(); // æ¯å€‹ PNR ä¸‹çš„ä¹˜å®¢æ•¸
        }
        currentPage = 1;
        
        // ç®—å‡ºè©²é¡¯ç¤ºå¹¾ç­†ï¼ˆæœ€å¤š 50 ä½ä¹˜å®¢ï¼‰
        /*Integer shownCount = 0;
pnrKeys = allKeys;
for (String key : allKeys) {
List<PassengerDataWrapper.PassengerInfo> passengers = tabData.get(key);
for (PassengerDataWrapper.PassengerInfo passenger : passengers) {
if (shownCount < pageSize) {
if (!pnrKeys.contains(key)) {
//pnrKeys.add(key);
}
shownCount++;
} else {
break;
}
}

if (shownCount >= pageSize) {
break;
}
}*/
        
        Integer shownCount = 0;
        pnrKeys = new List<String>();
        for (String key : allKeys) {
            List<PassengerDataWrapper.PassengerInfo> passengers = tabData.get(key);
            for (PassengerDataWrapper.PassengerInfo p : passengers) {
                System.debug('ğŸ” tabData[' + key + '] â†’ Passenger Seat: ' + p.Seat);
            }
            if (shownCount + passengers.size() <= pageSize) {
                pnrKeys.add(key);
                shownCount += passengers.size();
            } else {
                break;
            }
        }
        
        // èµ·å§‹åˆ†é è¨­å®š
        if (!pnrKeys.isEmpty()) {
            currentTabKey = pnrKeys[0];
        }
        
        OperationHistoryUtil.log('search', PAGENAME, flightPrefix+'-'+flightNumber, departureDate, departureLocation, bookingCodes, CommonController.getAccountIdFromCookie());
        return null;   // äº¤çµ¦ VF çš„ reRender
    }
    
    
    public PageReference searchXML() {
        // ä¸€é–‹å§‹å°±æ¸…æ‰å‰ä¸€æ¬¡çš„çµæœ
        pnrKeys.clear();
        tabData.clear();
        travelerList.clear(); 
        errorMessage = '';
        currentTabKey = null;
        showUSFields = false;
        /* 0. åŸºæœ¬æ¬„ä½æª¢æŸ¥ ------------------- */
        if (currentPage == null) currentPage = 1;
        if (totalRecords == null) totalRecords = 0;
        
        if (String.isBlank(bookingCodes) ||
            String.isBlank(flightNumber)  ||
            String.isBlank(departureLocation)|| 
            String.isBlank(departureDateStr) ) {
                errorMessage = 'è«‹è¼¸å…¥ã€Œè¨‚ä½ä»£è™Ÿã€èˆªç­è™Ÿç¢¼ã€èµ·é£›æ—¥æœŸã€èµ·é£›åœ°ã€å¾Œå†æœå°‹';
                ApexPages.addMessage(
                    new ApexPages.Message(
                        ApexPages.Severity.ERROR,
                        'è«‹è¼¸å…¥ã€Œè¨‚ä½ä»£è™Ÿã€èˆªç­è™Ÿç¢¼ã€èµ·é£›æ—¥æœŸã€èµ·é£›åœ°ã€å¾Œå†æœå°‹'
                    )
                );
                return null;
            }
        try {
            String norm = departureDateStr.replace('/', '-');
            departureDate = Date.valueOf(norm);
        } catch (Exception e) {
            errorMessage = 'æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡';
            ApexPages.addMessage(
                new ApexPages.Message(
                    ApexPages.Severity.ERROR,
                    'æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡'
                )
            );
            return null;
        }
        
        /* 1. è§£æ PNR (å¯è¼¸å…¥å¤šç¢¼é€—è™Ÿåˆ†éš”) ------ */
        List<String> rawPnrKeys = bookingCodes.contains(',') ?
            bookingCodes.split(',') :
        new List<String>{ bookingCodes.trim() };
            /*
pnrKeys = bookingCodes.contains(',') ?
bookingCodes.split(',') :
new List<String>{ bookingCodes.trim() };
*/
            String fn = String.isBlank(flightNumber) ? null : flightNumber.trim();
        DateTime startOfDay = DateTime.newInstance(
            departureDate.year(),
            departureDate.month(),
            departureDate.day(),
            0, 0, 0               // 00:00:00ï¼ˆæœ¬åœ°ï¼‰
        );
        DateTime endOfDay = startOfDay.addDays(1).addSeconds(-1);  // 23:59:59
        
        /* 2. æŸ¥ TravellerInfo__c -------------- */
        //Erickä¿®æ”¹164~2
        //WBS PNR_ListPaxByFlight
        Map<String, String> extractedPNRs = AmadeusUtil.listPNRByFlight(fn,departureDate.format()+'');
        // ç¯©é¸å‡ºå…©è€…äº¤é›†çš„ PNR æ¸…å–®
        List<String> matchedPnrKeys = new List<String>();
        List<String> unmatchedPnrKeys = new List<String>();
        System.debug('èµ·é£›åœ°:'+departureLocation);
        for (String p : rawPnrKeys) {
            if (extractedPNRs.containsKey(p) && extractedPNRs.get(p) == departureLocation) {
                matchedPnrKeys.add(p);
            } else {
                unmatchedPnrKeys.add(p);
            }
        }
        System.debug('ç¬¦åˆçš„PNR:'+matchedPnrKeys);
        System.debug('ä¸ç¬¦åˆçš„PNR:'+unmatchedPnrKeys); 

        // è‹¥ unmatched æœ‰å…§å®¹ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œä½†ä¸ä¸­æ–·æµç¨‹
        if (!unmatchedPnrKeys.isEmpty()) {
            //error toast
            /*
String missingMsg = 'æŸ¥ç„¡PNR : ' + String.join(unmatchedPnrKeys, ',');

ApexPages.addMessage(
new ApexPages.Message(ApexPages.Severity.ERROR, missingMsg)
);
ApexPages.currentPage().getHeaders().put('pnr-missing', missingMsg);
*/
            errorMessage = 'æŸ¥ç„¡éƒ¨åˆ†PNR : ' + String.join(unmatchedPnrKeys, ',');
        }
        // è‹¥å®Œå…¨æ²’äº¤é›†ï¼ˆmatched ç‚ºç©ºï¼‰ï¼Œå°±ä¸­æ–·
        if (matchedPnrKeys.isEmpty()) {
            //error toast
            /*
String missingMsg = 'æŸ¥ç„¡PNR : ' + String.join(unmatchedPnrKeys, ',');
ApexPages.addMessage(
new ApexPages.Message(ApexPages.Severity.ERROR, missingMsg)
);
ApexPages.currentPage().getHeaders().put('pnr-missing', missingMsg);
*/
            errorMessage = 'æŸ¥ç„¡PNR : ' + String.join(unmatchedPnrKeys, ',');
            return null;
        }
        
        oldMap = new Map<Id, TravellerInfo__c>([
            SELECT Id, PNR__c,
            LastName__c, FirstName__c, Title__c, Gender__c, PT__c, ST01__c, ST02__c,
            Country__c, DateOfBirth__c, PassengerType__c, PassportFinished__c,
            PassportNumber__c, PassportExpiryDate__c, PassportIssuingCountry__c,DepartureLocation__c,US_Bound__c,
            VisaNumber__c, VisaExpiryDate__c, VisaIssuingCountry__c,
            USAStreet__c, USACity__c, USAState__c, USAZipCode__c,
            USAEmergencyContactName__c, USAEmergencyContactNationality__c, USAEmergencyContactPhone__c,	Seat__c,
            CheckDisable__c, C3ExternalFinished__c, C3Finished__c, C4BoardingPassPrinted__c, C4BoardingPassPrintedTime__c,C4BoardingPassPrintedTimeGMTLocal__c,
            C4EBoardingPass__c, C4PaperBoardingPass__c, PrintDisable__c, DepartureLocationGMTLocal__c, Barcode__c, PAX__c, Service__c, Meal__c, IATA_MSO_Code__c, RQST_OT__c,
            C1Finished__c, UCI__c ,DID__c ,CAS__c ,DepartureDate__c ,DepartureDate2__c ,FlightNumber__c ,Destination__c ,C3Status__c,C4Finished__c,C3CheckboxDisplay__c, C4CheckboxDisplay__c,
            C1OperationDisable__c, C2OperationDisable__c, C3OperationDisable__c, C4OperationDisable__c, APE__c, APM__c, group_code__c, group_code_check__c, External_ID__c
            FROM   TravellerInfo__c
            //WHERE  PNR__c                 IN :pnrKeys
            WHERE  PNR__c                 IN :matchedPnrKeys
            //AND    FlightNumber__c        =  :fn
            AND    DepartureLocation__c=  :departureLocation
            //AND    DepartureLocationGMTLocal__c >= :startOfDay
            //AND    DepartureLocationGMTLocal__c <= :endOfDay
            ORDER  BY PTOrderBy__c ASC,
            PassengerTypeOrderBy__c ASC
        ]);
        showActionButtons = true;
        
        travelerList = oldMap.values();
        
        c4OperationDisabled = false; // é è¨­å¯æ“ä½œ
        for (TravellerInfo__c t : travelerList) {
            if (t.C4OperationDisable__c) {
                c4OperationDisabled = true;
                break; // æœ‰ä¸€ç­†æ˜¯ true å°±å¯ä»¥åœäº†
            }
        }
        
        System.debug('ç›®å‰æ™‚é–“ï¼š' + DateTime.now());
            
        for (TravellerInfo__c t : travelerList) {
            System.debug('PNR å‡ºç™¼æ™‚é–“ï¼š' + t.DepartureLocationGMTLocal__c);
            
            if (t.DepartureLocationGMTLocal__c != null &&
                t.DepartureLocationGMTLocal__c < DateTime.now()) {
                    System.debug('âœ‹ é€™ç­†å·²éæœŸï¼Œä¸é¡¯ç¤º checkbox');
                    //showActionButtons = false;  2025/08/18 Aaron ä¸çŸ¥é“é€™çµ„æ˜¯æ‹¿ä¾†å¹¹å˜›ç”¨çš„
                    break;
                }
        }
        showUSFields = false; 
        
        if (travelerList.isEmpty()) {
            pnrKeys.clear();
            tabData.clear();
            currentTabKey = null;
            ApexPages.addMessage(
                new ApexPages.Message(
                    ApexPages.Severity.INFO,
                    'æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªæ¢ä»¶æ˜¯å¦æ­£ç¢º'
                )
            );
            return null;
        }
        
        destinationMap = new Map<String, String>();
        groupCountMap = new Map<String, Integer>();
        for (TravellerInfo__c t : travelerList) {
            if(!destinationMap.containsKey(t.pnr__c)) {
                destinationMap.put(t.pnr__c, t.Destination__c);
            }
            if(groupCountMap.containsKey(t.pnr__c)) {
                groupCountMap.put(t.pnr__c, groupCountMap.get(t.pnr__c)+1);
            } else {
                groupCountMap.put(t.pnr__c, 1);
            }
            
            if (t.US_Bound__c) {
                showUSFields = true;
                break;
            }
        }
        
        /* 3. è½‰æˆ Map<PNR , List<PassengerInfo>> çµæ§‹ */
        tabData.clear();
        
        tabData = new PassengerDataWrapper(travelerList).passengerData;
        
        /* 4. ç”¢ç”Ÿåˆ†é ç±¤ç´¢å¼• */
        // åˆ†é ç”¨ key é›†åˆ
        List<String> allKeys = new List<String>(tabData.keySet());
        allKeys.sort();
        totalRecords = 0;
        for (String key : allKeys) {
            totalRecords += tabData.get(key).size(); // æ¯å€‹ PNR ä¸‹çš„ä¹˜å®¢æ•¸
        }
        currentPage = 1;
        
        // ç®—å‡ºè©²é¡¯ç¤ºå¹¾ç­†ï¼ˆæœ€å¤š 50 ä½ä¹˜å®¢ï¼‰
        /*Integer shownCount = 0;
pnrKeys = allKeys;
for (String key : allKeys) {
List<PassengerDataWrapper.PassengerInfo> passengers = tabData.get(key);
for (PassengerDataWrapper.PassengerInfo passenger : passengers) {
if (shownCount < pageSize) {
if (!pnrKeys.contains(key)) {
//pnrKeys.add(key);
}
shownCount++;
} else {
break;
}
}

if (shownCount >= pageSize) {
break;
}
}*/
        
        Integer shownCount = 0;
        pnrKeys = new List<String>();
        for (String key : allKeys) {
            List<PassengerDataWrapper.PassengerInfo> passengers = tabData.get(key);
            for (PassengerDataWrapper.PassengerInfo p : passengers) {
                System.debug('ğŸ” tabData[' + key + '] â†’ Passenger Seat: ' + p.Seat);
            }
            if (shownCount + passengers.size() <= pageSize) {
                pnrKeys.add(key);
                shownCount += passengers.size();
            } else {
                break;
            }
        }
        
        // èµ·å§‹åˆ†é è¨­å®š
        if (!pnrKeys.isEmpty()) {
            currentTabKey = pnrKeys[0];
        }
            
        // 1) å–å›å…©é‚Šè³‡æ–™
        List<TravellerInfo__c> fromDb  = oldMap.values();
        List<TravellerInfo__c> fromApi = new List<TravellerInfo__c>();
        for (String pnr : matchedPnrKeys) {
            try { fromApi.addAll(AmadeusUtil.retrievePNRC4(departureLocation, pnr)); }
            catch (Exception ex) { /* errorMessage è™•ç†... */ }
        }
        
        // 2) ä»¥ API ç‚ºä¸»ï¼Œåƒ…æŠŠ DB çš„ group_code_check__c merge é€²ä¾†
        Map<String, TravellerInfo__c> byKey = new Map<String, TravellerInfo__c>();
        
        // 2.1 API ç•¶ base
        for (TravellerInfo__c tApi : fromApi) {
            if (tApi == null || String.isBlank(tApi.External_ID__c)) continue;
            byKey.put(tApi.External_ID__c, tApi.clone(false, true, false, false));
        }
        
        // 2.2 è“‹å› DB çš„æ¬„ä½ï¼ˆåªé€™ä¸€æ¬„ + å¸¶å› Idï¼‰  â¬…ï¸ é‡è¦è£œå¼·ï¼šå¸¶å› Id
        for (TravellerInfo__c tDb : fromDb) {
            if (tDb == null || String.isBlank(tDb.External_ID__c)) continue;
            if (!byKey.containsKey(tDb.External_ID__c)) continue; // API ç‚ºä¸»ï¼šAPI æ²’æœ‰å°±ä¸ç´å…¥
            TravellerInfo__c base = byKey.get(tDb.External_ID__c);
            if (tDb.Id != null) base.Id = tDb.Id;                // å¸¶å› Idï¼Œé¿å…èª¤æ’å…¥
            base.group_code_check__c = tDb.group_code_check__c;   // DB æœ‰å€¼å°±ç¶­æŒï¼›å¤šæ•¸æƒ…æ³æ˜¯ null
        }
        
        travelerList = byKey.values();  // åˆä½µå¾Œï¼ˆAPI æ¬„ä½ + DB çš„ group_code_check__cï¼‰
        
        // 3) ä¾æ¢ä»¶æ±ºå®šæ˜¯å¦å‘¼å« Comment APIï¼ˆåƒ…å°ç›®å‰ä»ç‚º null çš„ï¼‰
        List<TravellerInfo__c> CHECK_PPT = new List<TravellerInfo__c>();
        for (TravellerInfo__c t : travelerList) {
            if (t.group_code__c != 'OK' && t.CAS__c == 'CAC' && t.group_code_check__c == null) {
                t.group_code_check__c = 'added High Priority'; // è‹¥æ˜¯ checkbox/numberï¼Œæ”¹ true/1
                CHECK_PPT.add(t);
            }
        }
        /*
        if (!CHECK_PPT.isEmpty()) {
            AmadeusUtil.DCSCPR_EditCPR_Add_NextComment(CHECK_PPT); // callout
        }*/
        
        // 4) å…¨éƒ¨ upsert å›å»ï¼ˆAPI æ¬„ä½ + æ›´æ–°å¾Œçš„ group_code_check__c ä¸€èµ·è½åº«ï¼‰
        if (!travelerList.isEmpty()) {
            Database.upsert(travelerList, TravellerInfo__c.External_ID__c, false);
        }


        
        OperationHistoryUtil.log('search', PAGENAME, flightPrefix+'-'+flightNumber, departureDate, departureLocation, bookingCodes, CommonController.getAccountIdFromCookie());
        return null;   // äº¤çµ¦ VF çš„ reRender
    }
    
    
    
    public PageReference nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            applyPagination();
        }
        return null;
    }
    
    public PageReference prevPage() {
        if (currentPage > 1) {
            currentPage--;
            applyPagination();
        }
        return null;
    }
    
    private void applyPagination() {
        Integer fromIndex = (currentPage - 1) * pageSize;
        Integer toIndex = Math.min(currentPage * pageSize, totalRecords);
        
        List<String> allKeys = new List<String>(tabData.keySet());
        allKeys.sort();
        
        pnrKeys = new List<String>();
        for (Integer i = fromIndex; i < toIndex; i++) {
            pnrKeys.add(allKeys[i]);
        }
        
        if (!pnrKeys.isEmpty()) {
            currentTabKey = pnrKeys[0];
        }
    }
    
    public Integer currentPageToIndex {
        get {
            Integer shown = 0;
            for (String key : pnrKeys) {
                if (tabData.containsKey(key)) {
                    shown += tabData.get(key).size();
                }
            }
            return shown;
        }
    }
    
    public Integer getCurrentTabCount() {
    if (currentTabKey == null || tabData == null) return 0;
    if (!tabData.containsKey(currentTabKey))      return 0;
    List<PassengerDataWrapper.PassengerInfo> rows = tabData.get(currentTabKey);
    return (rows == null) ? 0 : rows.size();
}
    
    //private Integer currentPageInternal;
    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å„²å­˜ä½¿ç”¨è€…ç·¨è¼¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    public PageReference save() {
        
        if (String.isBlank(jsonInput)) {
            ApexPages.addMessage(
                new ApexPages.Message(ApexPages.Severity.ERROR , 'æ²’æœ‰æ”¶åˆ°ä»»ä½•ä¿®æ”¹è³‡æ–™')
            );
            return null;
        }
        
        /* JSON çµæ§‹ï¼šMap<TravellerInfoId , Map<FieldAPI , NewValue>> */
        Map<String , Object> payload = (Map<String , Object>) JSON.deserializeUntyped(jsonInput);
        List<TravellerInfo__c> updates = new List<TravellerInfo__c>();
        
        for (String recId : payload.keySet()) {
            TravellerInfo__c t = new TravellerInfo__c(Id = recId);
            Map<String , Object> fields = (Map<String , Object>) payload.get(recId);
            for (String api : fields.keySet()) {
                t.put(api , fields.get(api));
            }
            updates.add(t);
        }
        
        if (!updates.isEmpty()) {
            try {
                update updates;
                ApexPages.addMessage(
                    new ApexPages.Message(ApexPages.Severity.CONFIRM , 'æ›´æ–°æˆåŠŸ')
                );
            } catch (DmlException e) {
                ApexPages.addMessages(e);
            }
        }
        return null;
    }
    
    public Boolean hasTabData(String key) {
        return tabData != null && tabData.containsKey(key);
    }
    
    public PageReference reset() {
        errorMessage = '';
        flightNumber = '';
        departureDateStr = '';
        departureDate = null;
        departureLocation = '';
        bookingCodes = '';
        travelerList.clear();
        pnrKeys.clear();
        currentTabKey = null;
        tabData.clear();
        showUSFields = false;
        currentPage = 1;
        totalRecords = 0;
        return null;
    }
    
    public Map<Id, List<String>> emailMap { get; set; }
    
    public List<UserManagement__c> getTourLeaders() {
        List<UserManagement__c> result = [
            SELECT Id, CN_Passport__c, EN_Passport__c, Email__c, Email1__c, Email2__c, Email3__c, Email4__c, Email5__c, Phone1__c
            FROM UserManagement__c
            WHERE Company__c = :currentAccount.Company__c
            AND State__c = 'å·²é–‹é€š'
            ORDER BY CN_Passport__c
        ];
        
        emailMap = new Map<Id, List<String>>();
        
        System.debug('âœ… tourLeaders found: ' + result.size());
        for (UserManagement__c u : result) {
            List<String> emails = new List<String>();
            if(String.isNotBlank(u.Email__c)) emails.add(u.Email__c);
            if(String.isNotBlank(u.Email1__c)) emails.add(u.Email1__c);
            if(String.isNotBlank(u.Email2__c)) emails.add(u.Email2__c);
            if(String.isNotBlank(u.Email3__c)) emails.add(u.Email3__c);
            if(String.isNotBlank(u.Email4__c)) emails.add(u.Email4__c);
            if(String.isNotBlank(u.Email5__c)) emails.add(u.Email5__c);
            
            emailMap.put(u.Id, emails);
        }
        
        return result;
    }
    
    public List<SelectOption> getEmailOptions() {
        List<SelectOption> options = new List<SelectOption>();
        options.add(new SelectOption('', 'è«‹é¸æ“‡')); // é è¨­ç©ºç™½é¸é …
        
        for (UserManagement__c tl : getTourLeaders()) {
            if (!String.isBlank(tl.Email__c)) {
                String label = tl.CN_Passport__c;
                if (!String.isBlank(tl.EN_Passport__c)) {
                    label += ' / ' + tl.EN_Passport__c;
                }
                label += ' - ' + tl.Email__c;
                
                options.add(new SelectOption(tl.Email__c, label));
            }
        }
        
        return options;
    }
    
    // æ–°å¢åŠ è¼‰å…¬å‘Šå…§å®¹çš„æ–¹æ³•
    private void loadnoticeContent() {
        try {
            List<NoticeSetting__c> notices = [SELECT Content__c FROM NoticeSetting__c where Name = 'ç™»æ©Ÿè­‰å‘ŠçŸ¥' LIMIT 1];
            if (!notices.isEmpty() && notices[0].Content__c != null) {
                noticeContent = notices[0].Content__c;
            } else {
                noticeContent = ''; // å¦‚æœæ²’æœ‰å…¬å‘Šå…§å®¹ï¼Œè¨­ç½®ç‚ºç©ºå­—ç¬¦ä¸²
            }
        } catch (Exception e) {
            noticeContent = ''; // ç™¼ç”ŸéŒ¯èª¤æ™‚è¨­ç½®ç‚ºç©ºå­—ç¬¦ä¸²
            System.debug('Error loading notice content: ' + e.getMessage());
        }
    }
    
    // æä¾›ä¸€å€‹å…¬é–‹çš„getteræ–¹æ³•ä¾†è¨ªå•å…¬å‘Šå…§å®¹
    public String getnoticeContent() {
        return noticeContent;
    }
    
    @RemoteAction
    public static void handleDownload(String email, String flightNo, String dep, String flightDate, String pnr, List<String> digitalIds, List<String> paperIds, Id userManagementId) {
        OperationHistoryUtil.log('export', PAGENAME, flightNo, Date.valueOf(flightDate), dep, pnr, userManagementId, digitalIds, paperIds);
    }
    
    @RemoteAction
    public static void handleSendEmail(String email, String flightNo, String dep, String flightDate, String pnr, List<String> digitalIds, List<String> paperIds, Id userManagementId) {

        System.debug(email);
        System.debug(digitalIds);
        System.debug(pnr);
        System.debug(flightDate);
        
        Set<String> allUniqueIds = new Set<String>();
        if (digitalIds != null) allUniqueIds.addAll(digitalIds);
        if (paperIds != null) allUniqueIds.addAll(paperIds);
        List<String> allIdsList = new List<String>(allUniqueIds);
        System.debug(groupCountMap);
        
        Integer successCount = allIdsList.size();
        
        //Get destination
        List<TravellerInfo__c> totalGroup = [SELECT Id, Destination__c, C4Finished__c, C4BoardingPassPrintedTime__c FROM TravellerInfo__c WHERE PNR__c = :pnr];
        Integer groupCount = totalGroup.size();
        String des = totalGroup[0]?.Destination__c;
        
        InfobipUtility.BoardingPassStats stats = new InfobipUtility.BoardingPassStats(
            flightNo, dep, des, flightDate, pnr, groupCount, successCount, groupCount - successCount, digitalIds, paperIds
        );
        InfobipUtility.sendBoardingPassEmail(email, userManagementId, stats);
        
        List<TravellerInfo__c> updateList = new List<TravellerInfo__c>();
        for (TravellerInfo__c passenger : totalGroup) {
            if (digitalIds.contains(passenger.Id) || paperIds.contains(passenger.Id)) {
                passenger.C4Finished__c = true;
                passenger.C4BoardingPassPrintedTime__c = System.now();
                updateList.add(passenger);
            }
        }
        
        update updateList;
        
        OperationHistoryUtil.log('send', 'BoardingPassPrinting', flightNo, Date.valueOf(flightDate), dep, pnr, userManagementId, digitalIds, paperIds);
    }
}