global class Batch_CalculateAU implements Database.Batchable < sObject >{
    global Database.QueryLocator start(Database.BatchableContext bc) {
        String query = 'SELECT Id, Name, Year__c, Month__c, WaypointTaiwan__c, WaypointOutside__c, Original_AU__c FROM Group_By_Waypoint__c';
            
        return Database.getQueryLocator(query);
    }
    
    global void execute(Database.BatchableContext bc, List < SObject > records) {
        List<String> waypointTaiwans = new List<String>();
        List<String> waypointOutsides = new List<String>();
        List<String> yearList = new List<String>();
        List<String> monthList = new List<String>();
        Map<String, Group_By_Waypoint__c> groupWaypointNameMap = new Map<String, Group_By_Waypoint__c>();
        for(SObject obj : records) {
            Group_By_Waypoint__c temp = (Group_By_Waypoint__c)obj;
            waypointTaiwans.add(temp.WaypointTaiwan__c);
            waypointOutsides.add(temp.WaypointOutside__c);
            yearList.add(temp.Year__c);
            monthList.add(temp.Month__c);
            temp.Original_AU__c = 0;
            groupWaypointNameMap.put(temp.Year__c + '-' + temp.Month__c + '-' + temp.WaypointTaiwan__c + '-' + temp.WaypointOutside__c, temp);
        }
        
        for(Group_AU__c ga : [SELECT Au__c, WaypointTaiwan__c, WaypointOutside__c, Year__c, Month__c from Group_AU__c WHERE WaypointTaiwan__c IN :waypointTaiwans AND WaypointOutside__c IN :waypointOutsides AND Year__c IN :yearList AND Month__c IN :monthList]) {
            String name = ga.Year__c + '-' + ga.Month__c + '-' + ga.WaypointTaiwan__c + '-' + ga.WaypointOutside__c;
            if(groupWaypointNameMap.keySet().contains(name)) {
                groupWaypointNameMap.get(name).Original_AU__c = (groupWaypointNameMap.get(name).Original_AU__c == NULL)? ga.AU__c : groupWaypointNameMap.get(name).Original_AU__c + ga.AU__c;
            }
        }
        System.debug(groupWaypointNameMap.values());
        update groupWaypointNameMap.values();
    }
    
    global void finish(Database.BatchableContext bc) {
        System.schedule('Download waypoint report' + Datetime.now().addMinutes(1).format('s m H d M ? yyyy'), Datetime.now().addMinutes(1).format('s m H d M ? yyyy'), new Schedule_Download_Excel(0));
        System.schedule('Download agency report TPE' + Datetime.now().addMinutes(5).format('s m H d M ? yyyy'), Datetime.now().addMinutes(5).format('s m H d M ? yyyy'), new Schedule_Download_Excel(1));
        System.schedule('Download agency report RMQ' + Datetime.now().addMinutes(10).format('s m H d M ? yyyy'), Datetime.now().addMinutes(10).format('s m H d M ? yyyy'), new Schedule_Download_Excel(2));
    }
    
    global static void fakeMethod() {
        Boolean b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
    }
}