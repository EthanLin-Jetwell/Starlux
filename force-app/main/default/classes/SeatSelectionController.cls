public without sharing class SeatSelectionController {
    public static String PAGENAME = 'SeatSelection';
    public String IATAcode { get; set; }
    
    public String errorMessage { get; set; }
    public String successMessage { get; set; }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç•«é¢ç¶å®šç”¨å±¬æ€§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    public String  flightPrefix  {get;set;}
    public String  flightNumber  {get;set;}
    public String  departureLocation { get; set; }
    public Date    departureDate {get;set;}
    public String  departureDateStr { get; set; }
    public String  bookingCodes  {get;set;}          // é€—è™Ÿåˆ†éš” PNR
    public Map<String, Boolean> pnrC2DisabledMap { get; set; }  // Map to track C2OperationDisable per PNR
    public String pnrC2DisabledMapJSON { 
        get { 
            return pnrC2DisabledMap != null ? JSON.serialize(pnrC2DisabledMap) : '{}'; 
        } 
        set; 
    }  

    public String NoticeContentSeatSelection { get; set; }  // æ–°å¢ç”¨æ–¼å­˜å„²å…¬å‘Šå…§å®¹çš„å±¬æ€§
    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ çµæœé¡¯ç¤ºç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    public List<String> pnrKeys  {get;set;}          // åˆ†é ç±¤
    public String       currentTabKey {get;set;}       // é è¨­é¡¯ç¤º
    public List<TravellerInfo__c> travelerList { get; set; }
    //public Map<Id, TravellerInfo__c> oldMap { get; set; }
    
    public Map<String , List<PassengerInfo>> tabData {get;set;}
    public Boolean showUSFields { get; private set; }
    public Integer currentPage { get; set; }
    public Integer pageSize { get; set; }
    public Integer totalRecords { get; set; }
    public Integer totalPages {
        get {
            if (totalRecords == null || pageSize == null || pageSize == 0) return 1;
            return (Integer)Math.ceil((Decimal)totalRecords / pageSize);
        }
    }
    public String aircraftType { get; set; }
    public List<String> cabinCodes { get; set; }
    public List<String> blockedSeats { get; set; }
    
    /* å‰ç«¯å›å‚³ä¿®æ”¹å…§å®¹çš„ JSON */
    public String jsonInput {get;set;}
    
    /* å‰ç«¯å›å‚³åº§ä½é¸æ“‡çš„ JSON */
    public String seatAssignmentInput {get;set;}
    
    public Map<String, AirRetrieveSeatMap.Result> seatMapResults { get; private set; }
    
    public String SeatMapAircraftType;
    public String getSeatMapAircraftType() {
        return getSeatMapAircraftType(currentTabKey);
    }
    
    public String getSeatMapAircraftType(String pnrCode) {
        if (seatMapResults != null && seatMapResults.containsKey(pnrCode) && seatMapResults.get(pnrCode) != null) {
            return seatMapResults.get(pnrCode).iataAircraftTypeCode;
        }
        return '';
    }
    
    public String SeatMapCabins { get {
        return getSeatMapCabins(currentTabKey);
    } set; }
    
    public String getSeatMapCabins(String pnrCode) {
        if (seatMapResults != null && seatMapResults.containsKey(pnrCode) && seatMapResults.get(pnrCode) != null && seatMapResults.get(pnrCode).cabinClasses != null) {
            return JSON.serialize(new List<String>(seatMapResults.get(pnrCode).cabinClasses));
        }
        return '';
    }
    
    public String SeatMapDisabledSeats { get {
        return getSeatMapDisabledSeats(currentTabKey);
    } set; }
    
    public String getSeatMapDisabledSeats(String pnrCode) {
        if (seatMapResults != null && seatMapResults.containsKey(pnrCode) && seatMapResults.get(pnrCode) != null && seatMapResults.get(pnrCode).blockedSeats != null) {
            return JSON.serialize(new List<String>(seatMapResults.get(pnrCode).blockedSeats));
        }
        return '';
    }

    // Add the missing property for Visualforce page access
    public String SeatMapDataForJS { get {
        return getSeatMapDataForJS();
    } set; }

    // Add property for all tab data (passenger info) for frontend
    public String AllTabDataForJS { get {
        return getAllTabDataForJS();
    } set; }

    public class SeatMapJSWrapper {
        @AuraEnabled public String aircraftType { get; set; }
        @AuraEnabled public List<String> cabinClasses { get; set; }
        @AuraEnabled public List<String> blockedSeats { get; set; }

        public SeatMapJSWrapper() {
            this.aircraftType = '';
            this.cabinClasses = new List<String>();
            this.blockedSeats = new List<String>();
        }
    }
     /**
     * @description Provides ALL seat map data for ALL PNRs as a single JSON string.
     *              Changed from current tab only to all tabs for frontend data approach.
     *              Format: {pnr1: {aircraftType, cabinClasses, blockedSeats}, pnr2: {...}}
     */
    public String getSeatMapDataForJS() {
        System.debug('ğŸ” getSeatMapDataForJS called - returning ALL PNR data');
        System.debug('ğŸ” seatMapResults: ' + JSON.serialize(seatMapResults));
        
        if (seatMapResults == null || seatMapResults.isEmpty()) {
            System.debug('âŒ Returning empty object - no seat map data available');
            return '{}';
        }

        // Create map of all PNR seat map data
        Map<String, SeatMapJSWrapper> allPnrData = new Map<String, SeatMapJSWrapper>();
        
        for (String pnrCode : seatMapResults.keySet()) {
            AirRetrieveSeatMap.Result result = seatMapResults.get(pnrCode);
            
            SeatMapJSWrapper dataForPnr = new SeatMapJSWrapper();
            if (result != null) {
                dataForPnr.aircraftType = result.iataAircraftTypeCode;
                
                if (result.cabinClasses != null) {
                    dataForPnr.cabinClasses = new List<String>(result.cabinClasses);
                }
                if (result.blockedSeats != null) {
                    dataForPnr.blockedSeats = new List<String>(result.blockedSeats);
                }
            }
            
            allPnrData.put(pnrCode, dataForPnr);
            System.debug('ğŸ” Added PNR ' + pnrCode + ': ' + JSON.serialize(dataForPnr));
        }

        String result = JSON.serialize(allPnrData);
        System.debug('âœ… getSeatMapDataForJS returning ALL PNR data: ' + result);
        return result;
    }

    /**
     * @description Provides ALL passenger/tab data for ALL PNRs as a single JSON string.
     *              Format: {pnr1: [passenger1, passenger2], pnr2: [...]}
     */
    public String getAllTabDataForJS() {
        System.debug('ğŸ” getAllTabDataForJS called - returning ALL PNR passenger data');
        System.debug('ğŸ” tabData: ' + JSON.serialize(tabData));
        
        if (tabData == null || tabData.isEmpty()) {
            System.debug('âŒ Returning empty object - no tab data available');
            return '{}';
        }

        // tabData is already in the correct format: Map<String, List<PassengerInfo>>
        // Just serialize it directly
        String result = JSON.serialize(tabData);
        System.debug('âœ… getAllTabDataForJS returning ALL PNR passenger data: ' + result);
        return result;
    }
    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…§éƒ¨åŒ…è£é¡ï¼ˆæ”¾åœ¨åŒä¸€æª”æ¡ˆå…§ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    
    
    public class PassengerInfo {
        public String  name          {get;set;}   // å§“/å
        public String  title         {get;set;}
        public String  gender        {get;set;}
        public String  nationality   {get;set;}
        public String  birthDate     {get;set;}
        public String  passengerType {get;set;}
        public Integer docCount      {get;set;}
        public Boolean usBound { get; set; }
        public String recordId { get; set; }
        public String seat { get; set; }
        public Boolean seatIsChargeable { get; set; }
        public String pt { get; set; }
        public String st { get; set; }
        public String rqstOT { get; set; }
        public String CAS { get; set; }
        public String DID { get; set; }
        public String FlightNumber { get; set; } 
        public String DepartureLocation { get; set; } 
		public String Destination { get; set; } 
        public String DepartureDate { get; set; } 
        
        
    }
    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å»ºæ§‹å­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* ---------- èµ·é£›åœ°æ¸…å–® ---------- */
    public List<String> origins { get; private set; }
    
    public List<SelectOption> getOriginOptions() {
        if (origins == null) {   
            loadOrigins();
        }
        
        List<SelectOption> opts = new List<SelectOption>();
        opts.add( new SelectOption('TPE', 'TPE') ); 
        
        for (String d : origins) {
            opts.add( new SelectOption(d, d) );
        }
        return opts;
    }
    private void loadOrigins() {
        Set<String> depSet = new Set<String>();
        for (AirportCode__c ac : [
            SELECT Departure__c
            FROM   AirportCode__c
            WHERE  RecordType.name = 'B2B Airport Code'
            AND    Departure__c != null 
            AND    Active__c = true
            ORDER BY Departure__c ASC
        ]) {
            depSet.add(ac.Departure__c);
        }
        
        origins = new List<String>(depSet);
        origins.sort();
    }
    
    public SeatSelectionController() {
        flightPrefix = 'JX';
        bookingCodes = '';
        currentPage = 1; 
        pageSize = 50; 
        pnrKeys = new List<String>();
        tabData = new Map<String,List<PassengerInfo>>();
        pnrC2DisabledMap = new Map<String, Boolean>();
        seatMapResults = new Map<String, AirRetrieveSeatMap.Result>();
        loadOrigins(); 
        travelerList = new List<TravellerInfo__c>();
        Map<String, Cookie> cookies = ApexPages.currentPage().getCookies();
        if (cookies != null && cookies.containsKey('accountId')) {
            try {
                UserManagement__c usr = [
                    SELECT Id, IATA_MSO_Code__c
                    FROM UserManagement__c
                    WHERE Id = :cookies.get('accountId').getValue()
                    LIMIT 1
                ];
                IATAcode = usr.IATA_MSO_Code__c;
                System.debug('ä½¿ç”¨è€… IATA Code = ' + IATAcode);
            } catch (Exception e) {
                System.debug('æŸ¥è©¢ UserManagement__c å¤±æ•—ï¼š' + e.getMessage());
                IATAcode = null;
            }
        }
        // Initialize successMessage to prevent null/empty message issues
        successMessage = '';
        
        loadNoticeContentSeatSelection();
    }
    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æŸ¥è©¢ PNR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    public PageReference searchPnr() {
        // ä¸€é–‹å§‹å°±æ¸…æ‰å‰ä¸€æ¬¡çš„çµæœ
        pnrKeys.clear();
        tabData.clear();
        travelerList.clear(); 
        errorMessage = '';
        currentTabKey = null;
        showUSFields = false;
        /* 0. åŸºæœ¬æ¬„ä½æª¢æŸ¥ ------------------- */
        if (currentPage == null) currentPage = 1;
        if (pageSize == null) pageSize = 50;
        if (totalRecords == null) totalRecords = 0;

        if (String.isBlank(bookingCodes) ||
            String.isBlank(flightNumber)  ||
            String.isBlank(departureLocation)|| 
            String.isBlank(departureDateStr) ) {
				errorMessage = 'è«‹è¼¸å…¥ã€Œè¨‚ä½ä»£è™Ÿã€èˆªç­è™Ÿç¢¼ã€èµ·é£›æ—¥æœŸã€èµ·é£›åœ°ã€å¾Œå†æœå°‹';                
                ApexPages.addMessage(
                    new ApexPages.Message(
                        ApexPages.Severity.ERROR,
                        'è«‹è¼¸å…¥ã€Œè¨‚ä½ä»£è™Ÿã€èˆªç­è™Ÿç¢¼ã€èµ·é£›æ—¥æœŸã€èµ·é£›åœ°ã€å¾Œå†æœå°‹'
                    )
                );
                return null;
            }
        try {
            String norm = departureDateStr.replace('/', '-');
            departureDate = Date.valueOf(norm);
        } catch (Exception e) {
            errorMessage = 'æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡';
            ApexPages.addMessage(
                new ApexPages.Message(
                    ApexPages.Severity.ERROR,
                    'æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡'
                )
            );
            return null;
        }
        
        /* 1. è§£æ PNR (å¯è¼¸å…¥å¤šç¢¼é€—è™Ÿåˆ†éš”) ------ */
        List<String> rawPnrKeys = bookingCodes.contains(',') ?
            bookingCodes.split(',') :
        new List<String>{ bookingCodes.trim() };
            String fn = String.isBlank(flightNumber) ? null : flightNumber.trim();
        DateTime startOfDay = DateTime.newInstance(
            departureDate.year(),
            departureDate.month(),
            departureDate.day(),
            0, 0, 0               // 00:00:00ï¼ˆæœ¬åœ°ï¼‰
        );
        DateTime endOfDay = startOfDay.addDays(1).addSeconds(-1);  // 23:59:59
        
        /* 2. æŸ¥ TravellerInfo__c -------------- */
        //Erickä¿®æ”¹164~2
        System.debug('About to call AmadeusUtil.listPNRByFlight');
        Map<String,String> extractedPNRs = AmadeusUtil.listPNRByFlight(fn,departureDate.format()+'');
        System.debug('AmadeusUtil.listPNRByFlight completed');
        System.debug('extractedPNRs: ' + extractedPNRs);
        System.debug('rawPnrKeys: ' + rawPnrKeys);
        
        // ç¯©é¸å‡ºå…©è€…äº¤é›†çš„ PNR æ¸…å–®
        List<String> matchedPnrKeys = new List<String>();
        List<String> unmatchedPnrKeys = new List<String>();
        Set<String> unmatchedSet = new Set<String>();
        Set<String> noSeatMapPNRKeys = new Set<String>();
        List<String> failedRetrievePNRKeys = new List<String>(); // Track PNRs that failed to retrieve
        
        for (String p : rawPnrKeys) {
            if (extractedPNRs.containsKey(p) && extractedPNRs.get(p) == departureLocation) {
                matchedPnrKeys.add(p);
            } else {
                if (unmatchedSet.add(p)) unmatchedPnrKeys.add(p);
            }
        }
        System.debug(matchedPnrKeys);
        System.debug(unmatchedPnrKeys); 
        //WBS PNR_Retrieve
        // First, collect all traveler data WITHOUT performing any DML
        for (String pnr : matchedPnrKeys) {
            try {
                List<TravellerInfo__c> pnrTravelers = AmadeusUtil.retrievePNR(departureLocation, pnr);
                if (pnrTravelers != null && !pnrTravelers.isEmpty()) {
                    travelerList.addAll(pnrTravelers);
                } else {
                    System.debug('âš ï¸ PNR_Retrieve ç„¡è³‡æ–™ï¼š' + pnr);
                    failedRetrievePNRKeys.add(pnr);
                }
            } catch (Exception ex) {
                System.debug('âš ï¸ PNR_Retrieve å¤±æ•—ï¼š' + pnr + 'ï¼ŒéŒ¯èª¤ï¼š' + ex.getMessage());
                failedRetrievePNRKeys.add(pnr);
            }
        }
        
        // Retrieve seat maps FIRST before any DML operations
        /*
        if (travelerList.size() > 0) {
            // 2-1-1 æŸ¥è©¢åº§ä½åœ– - ç‚ºæ¯å€‹PNRç²å–åº§ä½åœ– (BEFORE any DML)
            seatMapResults = new Map<String, AirRetrieveSeatMap.Result>();
        
            // Group travelers by PNR to get one seat map per PNR
            Map<String, TravellerInfo__c> pnrToFirstTraveller = new Map<String, TravellerInfo__c>();
            for (TravellerInfo__c traveller : travelerList) {
                if (!pnrToFirstTraveller.containsKey(traveller.PNR__c)) {
                    pnrToFirstTraveller.put(traveller.PNR__c, traveller);
                }
            }
        
            // æš«å­˜éœ€è¦ fallback çš„æ¸…å–®
            List<String> needFallbackPNRs = new List<String>();
        
            // ç¬¬ä¸€è¼ªï¼šå‘¼å« Air_RetrieveSeatMap
            for (String pnrCode : pnrToFirstTraveller.keySet()) {
                TravellerInfo__c traveller = pnrToFirstTraveller.get(pnrCode);
                try {
                    System.debug('DML count before callout = ' + Limits.getDMLStatements());
                    System.debug('Email count before callout = ' + Limits.getEmailInvocations());
        
                    AirRetrieveSeatMap.Result seatMapResult = AmadeusUtilRetrieveSeatMap.Air_RetrieveSeatMap(
                        traveller.DepartureDate__c,
                        traveller.DepartureLocation__c,
                        traveller.Destination__c,
                        traveller.FlightNumber__c,
                        traveller.BookingClass__c
                    );
        
                    if (seatMapResult != null && !String.isBlank(seatMapResult.iataAircraftTypeCode)) {
                        String cabinCode = getCabinClass(traveller.BookingClass__c);
                        if (cabinCode != null) {
                            seatMapResult.cabinClasses = new Set<String>{ cabinCode };
                            seatMapResults.put(pnrCode, seatMapResult);
                        } else {
                            System.debug(':x: BookingClass ç„¡æ³•è½‰æ› CabinClassï¼Œè·³é PNR ' + pnrCode);
                            noSeatMapPNRKeys.add(pnrCode);
                        }
                    } else {
                        System.debug('âš ï¸ SeatMap API ç„¡è³‡æ–™ï¼ŒPNR ' + pnrCode + ' åŠ å…¥ fallback æ¸…å–®');
                        needFallbackPNRs.add(pnrCode);
                    }
                } catch (Exception ex) {
                    System.debug('âŒ PNR ' + pnrCode + ' å‘¼å« SeatMap API éŒ¯èª¤: ' + ex.getMessage());
                    needFallbackPNRs.add(pnrCode);
                }
            }
        
            // ç¬¬äºŒè¼ªï¼šåªé‡å° needFallbackPNRs å‘¼å« DCSSTG_GetFDSeatMap
            for (String pnrCode : needFallbackPNRs) {
                TravellerInfo__c traveller = pnrToFirstTraveller.get(pnrCode);
                try {
                    AirRetrieveSeatMap.Result seatMapResult = AmadeusUtilRetrieveSeatMap.DCSSTG_GetFDSeatMap(
                        traveller.DepartureDate__c,
                        traveller.DepartureLocation__c,
                        traveller.FlightNumber__c
                    );
                    if (seatMapResult != null && !String.isBlank(seatMapResult.iataAircraftTypeCode)) {
                        String cabinCode = getCabinClass(traveller.BookingClass__c);
                        if (cabinCode != null) {
                            seatMapResult.cabinClasses = new Set<String>{ cabinCode };
                            seatMapResults.put(pnrCode, seatMapResult);
                        } else {
                            System.debug(':x: BookingClass ç„¡æ³•è½‰æ› CabinClassï¼Œè·³é PNR ' + pnrCode);
                            noSeatMapPNRKeys.add(pnrCode);
                        }
                    } else {
                        System.debug(':x: PNR ' + pnrCode + ' fallback å‘¼å«å¤±æ•—æˆ–è§£æéŒ¯èª¤');
                        noSeatMapPNRKeys.add(pnrCode);
                    }
                } catch (Exception ex) {
                    System.debug('âŒ PNR ' + pnrCode + ' å‘¼å« DCSSTG API éŒ¯èª¤: ' + ex.getMessage());
                    noSeatMapPNRKeys.add(pnrCode);
                }
            }
        
            // æ‰€æœ‰ callout å®Œæˆå¾Œå†åš DML
            upsert travelerList External_ID__c;
        }
		*/
        
        if(travelerList.size() > 0){
            //2-1-1æŸ¥è©¢åº§ä½åœ– - ç‚ºæ¯å€‹PNRç²å–åº§ä½åœ– (BEFORE any DML)
            seatMapResults = new Map<String, AirRetrieveSeatMap.Result>();
            
            // Group travelers by PNR to get one seat map per PNR
            Map<String, TravellerInfo__c> pnrToFirstTraveller = new Map<String, TravellerInfo__c>();
            for (TravellerInfo__c traveller : travelerList) {
                if (!pnrToFirstTraveller.containsKey(traveller.PNR__c)) {
                    pnrToFirstTraveller.put(traveller.PNR__c, traveller);
                }
            }
            
            // Retrieve seat map for each PNR - BEFORE DML to avoid transaction conflicts
            for (String pnrCode : pnrToFirstTraveller.keySet()) {
                TravellerInfo__c traveller = pnrToFirstTraveller.get(pnrCode);
                System.debug('DML count before callout = ' + Limits.getDMLStatements());
                System.debug('Email count before callout = ' + Limits.getEmailInvocations());

                // Use helper method for seat map retrieval with fallback
                AirRetrieveSeatMap.Result seatMapResult = retrieveSeatMapForPNR(pnrCode, traveller);

                if (seatMapResult != null) {
                    seatMapResults.put(pnrCode, seatMapResult);
                } else {
                    System.debug('âŒ PNR ' + pnrCode + ' æŸ¥åº§ä½åœ–å¤±æ•—');
                    ApexPages.addMessage(new ApexPages.Message(
                        ApexPages.Severity.INFO,
                        'PNR ' + pnrCode + ' æŸ¥åº§ä½åœ–å¤±æ•—'
                    ));
                    noSeatMapPNRKeys.add(pnrCode);
                }
            }

            
            // Now perform DML operations AFTER all API calls are complete
            upsert travelerList External_ID__c;
        }

        System.debug('unmatchedPnrKeys'+ unmatchedPnrKeys);
        System.debug('matchedPnrKeys'+ matchedPnrKeys);
        System.debug('failedRetrievePNRKeys'+ failedRetrievePNRKeys);
        
        OperationHistoryUtil.log('search', PAGENAME, flightPrefix+'-'+flightNumber, departureDate, departureLocation, bookingCodes, CommonController.getAccountIdFromCookie());

        // è‹¥å®Œå…¨æ²’äº¤é›†ï¼ˆmatched ç‚ºç©ºï¼‰ï¼Œå°±ä¸­æ–·
        if (matchedPnrKeys.isEmpty()) {
            errorMessage = 'æŸ¥ç„¡PNRï¼š'+buildPnrFailureMessage(unmatchedPnrKeys);
            return null;
        }

        // å»ºç«‹éŒ¯èª¤è¨Šæ¯
        errorMessage = buildCombinedErrorMessage(unmatchedPnrKeys, failedRetrievePNRKeys, noSeatMapPNRKeys, matchedPnrKeys);
        
        // åªæœ‰ç•¶æ‰€æœ‰PNRéƒ½å¤±æ•—æ™‚æ‰ä¸­æ–·ï¼Œå…è¨±éƒ¨åˆ†æˆåŠŸçš„æƒ…æ³ç¹¼çºŒè™•ç†
        // Check if at least one PNR has valid data (either passenger data or seat map)
        Boolean hasValidData = false;
        for (String pnr : matchedPnrKeys) {
            // Check if this PNR has traveler data that will be processed
            Boolean hasTravelerData = false;
            for (TravellerInfo__c t : travelerList) {
                if (t.PNR__c == pnr) {
                    hasTravelerData = true;
                    break;
                }
            }
            
            // If this PNR has traveler data AND is not completely failed for seat map
            if (hasTravelerData && (!noSeatMapPNRKeys.contains(pnr) || !failedRetrievePNRKeys.contains(pnr))) {
                hasValidData = true;
                break;
            }
        }
        
        // Only return null if NO valid data exists at all
        if (!hasValidData && !noSeatMapPNRKeys.isEmpty() && noSeatMapPNRKeys.containsAll(matchedPnrKeys)) {
            return null;
        }

        
        Map<Id, TravellerInfo__c> oldMap = new Map<Id, TravellerInfo__c>([
            SELECT Id, PNR__c,
            LastName__c, FirstName__c, Title__c, Gender__c, PT__c, ST01__c, ST02__c,
            Country__c, DateOfBirth__c, PassengerType__c, PassportFinished__c,
            PassportNumber__c, PassportExpiryDate__c, PassportIssuingCountry__c,DepartureLocation__c,US_Bound__c,
            VisaNumber__c, VisaExpiryDate__c, VisaIssuingCountry__c,
            USAStreet__c, USACity__c, USAState__c, USAZipCode__c,
            USAEmergencyContactName__c, USAEmergencyContactNationality__c, USAEmergencyContactPhone__c,	Seat__c,
            CheckDisable__c, C3ExternalFinished__c, C3Finished__c, C4BoardingPassPrinted__c, C4BoardingPassPrintedTime__c,
            C4EBoardingPass__c, C4PaperBoardingPass__c, PrintDisable__c, DepartureLocationGMTLocal__c, Barcode__c, PAX__c, Service__c, Meal__c, IATA_MSO_Code__c, RQST_OT__c,
            C1Finished__c, UCI__c ,DID__c ,CAS__c ,SeatIsChargeable__c ,DepartureDate__c ,DepartureDate2__c ,FlightNumber__c ,Destination__c ,C3Status__c,C2OperationDisable__c,C3OperationDisable__c,C4BoardingPassPrintedTimeGMTLocal__c,
            C3CheckboxDisplay__c, APE__c, APM__c
            FROM   TravellerInfo__c
            //WHERE  PNR__c                 IN :pnrKeys
            WHERE  PNR__c                 IN :matchedPnrKeys
            //AND    FlightNumber__c        =  :fn
            AND External_ID__c != null
            AND    DepartureLocation__c=  :departureLocation
			//AND    IATA_MSO_Code__c    =  :IATAcode
            //AND    DepartureLocationGMTLocal__c >= :startOfDay
            //AND    DepartureLocationGMTLocal__c <= :endOfDay
            ORDER  BY PTOrderBy__c ASC,
            PassengerTypeOrderBy__c ASC
        ]);
        if (oldMap.isEmpty()) {
            errorMessage = 'æŸ¥ç„¡PNR : ' + String.join(matchedPnrKeys, ',');
            return null;
        }
        
        // ä¾ PNR åˆ¤æ–·æ˜¯å¦æœ‰ä»»ä½•ä¸€ç­†ç¬¦åˆ IATA
        Map<String, Boolean> pnrHasSameIata = new Map<String, Boolean>();
        for (TravellerInfo__c t : oldMap.values()) {
            if (String.isBlank(t.PNR__c)) continue;
    
            Boolean ok = (!String.isBlank(IATAcode) && t.IATA_MSO_Code__c == IATAcode);
            if (!pnrHasSameIata.containsKey(t.PNR__c)) {
                pnrHasSameIata.put(t.PNR__c, ok);
            } else {
                pnrHasSameIata.put(t.PNR__c, pnrHasSameIata.get(t.PNR__c) || ok);
            }
        }
    
        // æŠŠ IATA ä¸ç¬¦çš„ PNR å¾ matched ç§»é™¤ï¼Œä¸¦åŠ å…¥ unmatchedï¼ˆä¸æ­éœ²åŸå› ï¼‰
        List<String> filteredMatched = new List<String>();
        for (String pnr : matchedPnrKeys) {
            if (pnrHasSameIata.containsKey(pnr) && pnrHasSameIata.get(pnr) == true) {
                filteredMatched.add(pnr);
            } else {
                if (unmatchedSet.add(pnr)) unmatchedPnrKeys.add(pnr);
            }
        }
        matchedPnrKeys = filteredMatched;
    
        // è‹¥ unmatched æœ‰å…§å®¹ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œä½†ä¸ä¸­æ–·æµç¨‹
        if (!unmatchedPnrKeys.isEmpty()) {
            errorMessage = 'æŸ¥ç„¡éƒ¨åˆ†PNR : ' + String.join(unmatchedPnrKeys, ',');
        }
    
        // è‹¥æœ€å¾Œå®Œå…¨æ²’æœ‰å¯ç”¨ PNRï¼Œå°±ä¸­æ–·ï¼ˆå…¨éƒ¨æŸ¥ç„¡ï¼‰
        if (matchedPnrKeys.isEmpty()) {
            errorMessage = 'æŸ¥ç„¡PNR : ' + String.join(unmatchedPnrKeys, ',');
            return null;
        }
        
        Set<String> matchedSet = new Set<String>(matchedPnrKeys);
        travelerList = new List<TravellerInfo__c>();
        for (TravellerInfo__c t : oldMap.values()) {
            if (matchedSet.contains(t.PNR__c)) travelerList.add(t);
        }
        
        // Build per-PNR C2OperationDisable map (only check first passenger per PNR since it's a formula field)
        pnrC2DisabledMap.clear();
        Map<String, TravellerInfo__c> pnrToFirstTraveler = new Map<String, TravellerInfo__c>();
        
        // Get first traveler for each PNR
        for (TravellerInfo__c t : travelerList) {
            if (!pnrToFirstTraveler.containsKey(t.PNR__c)) {
                pnrToFirstTraveler.put(t.PNR__c, t);
            }
        }
        
        // Check C2OperationDisable for first traveler of each PNR
        for (String pnr : pnrToFirstTraveler.keySet()) {
            TravellerInfo__c firstTraveler = pnrToFirstTraveler.get(pnr);
            Boolean isDisabled = firstTraveler.C2OperationDisable__c == true;
            pnrC2DisabledMap.put(pnr, isDisabled);
            
            // Debug logging for C2OperationDisable
            System.debug('ğŸ” PNR ' + pnr + ': C2OperationDisable = ' + isDisabled);
        }
                
        showUSFields = false; 
        
        if (travelerList.isEmpty()) {
            pnrKeys.clear();
            tabData.clear();
            currentTabKey = null;
            ApexPages.addMessage(
                new ApexPages.Message(
                    ApexPages.Severity.INFO,
                    'æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªæ¢ä»¶æ˜¯å¦æ­£ç¢º'
                )
            );
            return null;
        }
        for (TravellerInfo__c t : travelerList) {
            if (t.US_Bound__c) {
                showUSFields = true;
                break;
            }
        }
        
        /* 3. è½‰æˆ Map<PNR , List<PassengerInfo>> çµæ§‹ */
        tabData.clear();
        
        for (TravellerInfo__c t : travelerList) {
            
            if (!tabData.containsKey(t.PNR__c)) {
                tabData.put(t.PNR__c , new List<PassengerInfo>());
            }
            
            /* æ‰¾çœ‹çœ‹æ­¤ä¹˜å®¢æ˜¯å¦å·²å­˜åœ¨ (ä»¥ å§“/å + Title ç•¶ key) */
            String paxKey = t.LastName__c + '/' + t.firstName__c;
            PassengerInfo pInfo;
            for (PassengerInfo p : tabData.get(t.PNR__c)) {
                if (p.name == paxKey) { pInfo = p; break; }
            }
            if (pInfo == null) {
                pInfo = new PassengerInfo();
                pInfo.recordId      = t.Id;
                pInfo.name          = t.LastName__c + '/' + t.firstName__c;
                pInfo.title         = t.title__c;
                pInfo.gender        = t.gender__c;
                pInfo.nationality   = t.country__c;
                pInfo.birthDate     = t.DateOfBirth__c;
                pInfo.passengerType = t.PassengerType__c;
                pInfo.usBound = t.US_Bound__c;
                pInfo.seat = t.Seat__c;
                pInfo.seatIsChargeable = t.SeatIsChargeable__c;
                pInfo.pt = t.PT__c;
                pInfo.st = t.ST01__c;
                pInfo.CAS = t.CAS__c;
                pInfo.DID = t.DID__c;
                pInfo.rqstOT = t.RQST_OT__c;
                pInfo.DepartureDate = t.DepartureDate__c;
                pInfo.DepartureLocation = t.DepartureLocation__c;
                pInfo.Destination = t.Destination__c;
				pInfo.FlightNumber = t.FlightNumber__c;
               
                tabData.get(t.PNR__c).add(pInfo);
            }
            
            
        }
        
        // Check for PNRs with passenger data but no seat map AFTER tabData is populated
        List<String> passengerOnlyPNRKeys = new List<String>();
        for (String pnr : tabData.keySet()) {
            if (!seatMapResults.containsKey(pnr) || seatMapResults.get(pnr) == null) {
                passengerOnlyPNRKeys.add(pnr);
            }
        }
        
        if (!passengerOnlyPNRKeys.isEmpty()) {
            String seatMapError = buildSeatMapFailureMessage(passengerOnlyPNRKeys);
            if (String.isNotBlank(errorMessage)) {
                errorMessage += 'ï¼›' + seatMapError;
            } else {
                errorMessage = seatMapError;
            }
        }
        
        // èµ·å§‹åˆ†é è¨­å®š - åªé¡¯ç¤ºæœ‰å¯¦éš›è³‡æ–™çš„PNRåˆ†é 
        pnrKeys.clear(); // Clear any existing keys
        if (tabData != null && !tabData.isEmpty()) {
            // Only add PNR keys that have BOTH passenger data AND seat map data
            for (String pnr : tabData.keySet()) {
                if (seatMapResults.containsKey(pnr) && seatMapResults.get(pnr) != null) {
                    pnrKeys.add(pnr);
                }
            }
            if (!pnrKeys.isEmpty()) {
                currentTabKey = pnrKeys[0]; // Set first available PNR as current tab
            }
        }
        // Final debug output
        System.debug('ğŸ” [FINAL] pnrC2DisabledMap: ' + JSON.serialize(pnrC2DisabledMap));
        System.debug('ğŸ” [FINAL] currentTabKey: ' + currentTabKey);
        
        return null;   // äº¤çµ¦ VF çš„ reRender
    }

    public PageReference handleTabSwitch(){
        String tempKey = currentTabKey;
        System.debug('temp key in handleTabSwitch' + tempKey);
        // the reason why need to save the tabkey, it is because the searchPnr() will set it to the first pnr
        searchPnr();
        currentTabKey = tempKey;
        System.debug('final tab key in handleTabSwitch ' + currentTabKey);
        return null;
    }
    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å„²å­˜ä½¿ç”¨è€…ç·¨è¼¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    public PageReference save() {
        
        if (String.isBlank(jsonInput)) {
            ApexPages.addMessage(
                new ApexPages.Message(ApexPages.Severity.ERROR , 'æ²’æœ‰æ”¶åˆ°ä»»ä½•ä¿®æ”¹è³‡æ–™')
            );
            return null;
        }
        
        /* JSON çµæ§‹ï¼šMap<TravellerInfoId , Map<FieldAPI , NewValue>> */
        Map<String , Object> payload = (Map<String , Object>) JSON.deserializeUntyped(jsonInput);
        List<TravellerInfo__c> updates = new List<TravellerInfo__c>();
        
        for (String recId : payload.keySet()) {
            TravellerInfo__c t = new TravellerInfo__c(Id = recId);
            Map<String , Object> fields = (Map<String , Object>) payload.get(recId);
            for (String api : fields.keySet()) {
                t.put(api , fields.get(api));
            }
            updates.add(t);
        }
        
        if (!updates.isEmpty()) {
            try {
                update updates;
                ApexPages.addMessage(
                    new ApexPages.Message(ApexPages.Severity.CONFIRM , 'æ›´æ–°æˆåŠŸ')
                );
            } catch (DmlException e) {
                ApexPages.addMessages(e);
            }
        }
        return null;
    }
    
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å„²å­˜åº§ä½é¸æ“‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /*
    public PageReference saveSeatAssignments() {
        System.debug('ğŸ’¾ saveSeatAssignments called');
        System.debug('ğŸ’¾ seatAssignmentInput: ' + seatAssignmentInput);
        
        // Clear previous success message at start of new operation
        successMessage = '';
        
        if (String.isBlank(seatAssignmentInput)) {
            ApexPages.addMessage(
                new ApexPages.Message(ApexPages.Severity.ERROR, 'æ²’æœ‰æ”¶åˆ°åº§ä½é¸æ“‡è³‡æ–™')
            );
            return null;
        }
        
        try {
            // JSON çµæ§‹ï¼šMap<TabKey, Map<PassengerIndex, SeatCode>> 
            Map<String, Object> payload = (Map<String, Object>) JSON.deserializeUntyped(seatAssignmentInput);
            List<TravellerInfo__c> updates = new List<TravellerInfo__c>();
            
            // Process each tab's seat assignments
            for (String tabKey : payload.keySet()) {
                Map<String, Object> tabAssignments = (Map<String, Object>) payload.get(tabKey);
                
                // Get passengers for this tab
                List<PassengerInfo> passengers = tabData.get(tabKey);
                if (passengers == null) continue;
                
                // Process each passenger's seat assignment
                for (String passengerIndexStr : tabAssignments.keySet()) {
                    Integer passengerIndex = Integer.valueOf(passengerIndexStr);
                    String seatCode = (String) tabAssignments.get(passengerIndexStr);
                    
                    // Find the corresponding passenger (1-based index)
                    if (passengerIndex > 0 && passengerIndex <= passengers.size()) {
                        PassengerInfo passenger = passengers.get(passengerIndex - 1);
                        
                        // Create update record
                        TravellerInfo__c traveller = new TravellerInfo__c();
                        traveller.Id = passenger.recordId;
                        traveller.Seat__c = seatCode;
                        updates.add(traveller);
                        
                        System.debug('ğŸ“ Assigning seat ' + seatCode + ' to passenger ' + passenger.name + ' (ID: ' + passenger.recordId + ')');
                    }
                }
            }
            
            if (!updates.isEmpty()) {
                update updates;
                
                // Update local passenger data to reflect changes
                for (TravellerInfo__c updatedTraveller : updates) {
                    updateLocalPassengerData(updatedTraveller.Id, updatedTraveller.Seat__c);
                }
                
                successMessage = 'åº§ä½é¸æ“‡å„²å­˜æˆåŠŸï¼Œå…±æ›´æ–° ' + updates.size() + ' ä½æ—…å®¢';
                System.debug('âœ… Successfully updated ' + updates.size() + ' seat assignments');
            } else {
                successMessage = 'æ²’æœ‰åº§ä½éœ€è¦æ›´æ–°';
            }
            
        } catch (Exception e) {
            System.debug('âŒ Error saving seat assignments: ' + e.getMessage());
            ApexPages.addMessage(
                new ApexPages.Message(ApexPages.Severity.ERROR, 'å„²å­˜åº§ä½é¸æ“‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + e.getMessage())
            );
        }
        
        return null;
    }*/
    public PageReference saveSeatAssignments() {        
        TravellerInfo__c timecheck = [
            SELECT C2OperationDisable__c
            FROM TravellerInfo__c
            WHERE PNR__c = :currentTabKey
            LIMIT 1
        ];
        if(timecheck.C2OperationDisable__c==True){
                errorMessage = 'æ“ä½œä½œæ¥­é€¾æ™‚ï¼Œç„¡æ³•é€²è¡Œç•°å‹•';
                ApexPages.addMessage(new ApexPages.Message(
                    ApexPages.Severity.ERROR, 'æ“ä½œä½œæ¥­é€¾æ™‚ï¼Œç„¡æ³•é€²è¡Œç•°å‹•'
                ));
                return null;
        }
        
        System.debug('ğŸ’¾ saveSeatAssignments called');
        System.debug('ğŸ’¾ seatAssignmentInput: ' + seatAssignmentInput);
    
        // Clear previous success message at start of new operation
        successMessage = '';
        
        if (String.isBlank(seatAssignmentInput)) {
            ApexPages.addMessage(new ApexPages.Message(
                ApexPages.Severity.ERROR, 'æ²’æœ‰æ”¶åˆ°åº§ä½é¸æ“‡è³‡æ–™'
            ));
            return null;
        }
    
        Map<Id, TravellerInfo__c> oldMap = new Map<Id, TravellerInfo__c>();
        
        try {
            Map<String, Object> payload = (Map<String, Object>) JSON.deserializeUntyped(seatAssignmentInput);
    
            List<TravellerInfo__c> newlyAssignedList = new List<TravellerInfo__c>();
            List<TravellerInfo__c> changedSeatList   = new List<TravellerInfo__c>();
            List<TravellerInfo__c> CheckedSeatList   = new List<TravellerInfo__c>();
            List<String> droppedOTNumbers            = new List<String>();
    
            for (String tabKey : payload.keySet()) {
                Map<String, Object> tabAssignments = (Map<String, Object>) payload.get(tabKey);
                List<PassengerInfo> passengers = tabData.get(tabKey);
                if (passengers == null) continue;
    
                for (String indexStr : tabAssignments.keySet()) {
                    Integer idx = Integer.valueOf(indexStr);
                    if (idx <= 0 || idx > passengers.size()) continue;
    
                    PassengerInfo p = passengers.get(idx - 1);
                    String newSeatCode = (String) tabAssignments.get(indexStr);
                    String oldSeatCode = p.seat;
                    if (String.isBlank(p.recordId) || String.isBlank(newSeatCode)) continue;
    
                    // ç„¡ç•°å‹•å°±ç•¥é
                    if (newSeatCode == oldSeatCode) continue;
    
                    System.debug(newSeatCode);
                    System.debug(oldSeatCode);
                    
                    TravellerInfo__c t = new TravellerInfo__c();
                    t.Id = p.recordId;
                    t.Seat__c = newSeatCode;
    
                    // å‚³éç”¨ï¼Œä¸æœƒè¢«æ›´æ–°
                    t.PT__c = p.pt;
                    t.ST01__c = p.st;
    				t.RQST_OT__c = p.rqstOT;
                    t.CAS__c = p.CAS;
                    t.DID__c = p.DID;
                    t.DepartureDate__c = p.DepartureDate;
                    t.DepartureLocation__c = p.DepartureLocation;
                    t.Destination__c = p.Destination;
                    t.FlightNumber__c = p.FlightNumber;
                    t.LastName__c = p.name.split('/')[0];
                    t.FirstName__c = p.name.split('/')[1];
                    
                    TravellerInfo__c tmp = t.clone(true, true, false, false);
                    tmp.Seat__c = oldSeatCode;
                    oldMap.put(p.recordId, tmp);
                    
                    
                    // åˆ¤æ–·æ˜¯æ–°å¢æˆ–è®Šæ›´
                    if (String.isBlank(oldSeatCode)) {
                        newlyAssignedList.add(t);
                        System.debug('ğŸ†• æ–°å¢åº§ä½: ' + newSeatCode + ' âœ ' + p.name);
                    }
                    else if(p.CAS == 'CAC'){
                        CheckedSeatList.add(t);
                        System.debug('ğŸ†• è®Šæ›´åº§ä½(å·²Checkin): ' + newSeatCode + ' âœ ' + p.name);     
                    } else {
                        changedSeatList.add(t);
                        System.debug('ğŸ” è®Šæ›´åº§ä½: ' + oldSeatCode + ' â†’ ' + newSeatCode + ' âœ ' + p.name);
    
                        // ğŸ†• è‹¥æœ‰èˆŠ OTï¼ŒåŠ å…¥ droppedOTNumbers
                        if (!String.isBlank(p.rqstOT)) {
                            droppedOTNumbers.add(p.rqstOT);
                            System.debug('âŒ Dropped OT: ' + p.rqstOT + ' (æ—…å®¢: ' + p.name + ')');
                        }
                    }
    
                    // ç•«é¢åŒæ­¥
                    updateLocalPassengerData(p.recordId, newSeatCode);
                }
            }
    
            // çµ±æ•´è¦æ›´æ–°çš„è³‡æ–™
            List<TravellerInfo__c> newList = new List<TravellerInfo__c>();
            newList.addAll(newlyAssignedList);
            newList.addAll(changedSeatList);
            newList.addAll(CheckedSeatList);

            if (newList.isEmpty()) {
                successMessage = 'æ²’æœ‰åº§ä½éœ€è¦æ›´æ–°';
                return null;
            }
    
            // ğŸ§¹ å‘¼å«åˆªé™¤ OT
            if (!droppedOTNumbers.isEmpty()) {
                try {
                    AmadeusUtil.deleteDroppedOT(departureLocation, currentTabKey, droppedOTNumbers);
                    System.debug('ğŸ§¹ Dropped OT è™Ÿç¢¼æ¸…é™¤å®Œæˆ: ' + JSON.serialize(droppedOTNumbers));
                } catch (Exception ex) {
                    System.debug('âš ï¸ Dropped OT æ¸…é™¤å¤±æ•—: ' + ex.getMessage());
                    ApexPages.addMessage(new ApexPages.Message(
                        ApexPages.Severity.WARNING,
                        'è®Šæ›´åº§ä½æˆåŠŸï¼Œä½†åˆªé™¤ OT æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + ex.getMessage()
                    ));
                }
            }
    
            // æ›´æ–°è³‡æ–™ï¼Œå°WBSä¸€é»å±ç”¨éƒ½æ²’æœ‰ï¼Œä¸éœ€è¦é–‹
            //update updateList;
    
            // ç™¼é€åˆ°å¾Œç«¯ï¼ˆå¯æ ¹æ“šéœ€æ±‚æ”¹æˆ uploadSeatSelectionï¼‰
            if (!CheckedSeatList.isEmpty()) {
            	AmadeusUtil.AllocateSeat_seatRequestInfo(CheckedSeatList);
            }
            if (!newList.isEmpty()){
            	AmadeusUtil.seatSelection(departureLocation, currentTabKey, newList);
        	}
            Integer total = newList.size();
            Integer Changetotal = changedSeatList.size() + CheckedSeatList.size();

            String activePnrBeforeRefresh = currentTabKey;
            // âœ… Refresh both seat map and traveler data with latest API results
            searchPnr();
            currentTabKey = activePnrBeforeRefresh;

            successMessage = 'ä½œæ¥­å®Œæˆï¼Œè«‹å†æ¬¡é»é¸ã€æœå°‹ã€‘ä»¥æª¢è¦–æœ€æ–°ç‹€æ…‹';
            System.debug('âœ… æ›´æ–°å®Œæˆï¼šæ–°å¢ ' + newlyAssignedList.size() + 'ï¼Œè®Šæ›´ ' + Changetotal);

            List<TravellerInfo__c> updates = new List<TravellerInfo__c>();
            
            for (TravellerInfo__c t : newList) {
                t.C2Finished__c = true;
                updates.add(t);
            }
            
            update updates;
            
            System.debug(oldMap);
            System.debug(newList);
            
            OperationHistoryUtil.log('update', PAGENAME, flightPrefix+'-'+flightNumber, departureDate, departureLocation, currentTabKey, CommonController.getAccountIdFromCookie(), oldMap, newList);
            oldMap = new Map<Id, TravellerInfo__c>(newList);
            
            System.debug('âœ… Successfully saved seat assignments + ' + successMessage);
        } catch (Exception ex) {
            System.debug('âŒ Error saving seat assignments: ' + ex.getMessage());
            ApexPages.addMessage(new ApexPages.Message(
                ApexPages.Severity.ERROR, 'å„²å­˜åº§ä½é¸æ“‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + ex.getMessage()
            ));
        }
    
        return null;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ›´æ–°æœ¬åœ°æ—…å®¢è³‡æ–™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    private void updateLocalPassengerData(String travellerId, String newSeat) {
        for (String tabKey : tabData.keySet()) {
            for (PassengerInfo passenger : tabData.get(tabKey)) {
                if (passenger.recordId == travellerId) {
                    passenger.seat = newSeat;
                    return;
                }
            }
        }
    }
    
    public PageReference reset() {
        errorMessage = '';
        flightNumber = '';
        departureDateStr = '';
        departureDate = null;
        departureLocation = '';
        bookingCodes = '';
        travelerList.clear();
        pnrKeys.clear();
        currentTabKey = null;
        tabData.clear();
        pnrC2DisabledMap.clear();
        seatMapResults.clear();
        showUSFields = false;
        currentPage = 1;
        totalRecords = 0;
        return null;
    }

    /**
     * Refreshes data for a specific PNR when user switches tabs
     * Called via actionFunction from frontend when tab is clicked
     * Fetches latest seat map and traveler data from API
     */
    public PageReference refreshPNRData() {
        System.debug('ğŸ”„ refreshPNRData called for tab switching');
        searchPnr();
        return null;
    }

    // æ–°å¢åŠ è¼‰å…¬å‘Šå…§å®¹çš„æ–¹æ³•
    private void loadNoticeContentSeatSelection() {
        try {
            List<NoticeSetting__c> notices = [SELECT Content__c FROM NoticeSetting__c where Name = 'é¸ä½é ˆçŸ¥' LIMIT 1];
            if (!notices.isEmpty() && notices[0].Content__c != null) {
                NoticeContentSeatSelection = notices[0].Content__c;
            } else {
                NoticeContentSeatSelection = ''; // å¦‚æœæ²’æœ‰å…¬å‘Šå…§å®¹ï¼Œè¨­ç½®ç‚ºç©ºå­—ç¬¦ä¸²
            }
        } catch (Exception e) {
            NoticeContentSeatSelection = ''; // ç™¼ç”ŸéŒ¯èª¤æ™‚è¨­ç½®ç‚ºç©ºå­—ç¬¦ä¸²
            System.debug('Error loading notice content: ' + e.getMessage());
        }
    }
    
    // æä¾›ä¸€å€‹å…¬é–‹çš„getteræ–¹æ³•ä¾†è¨ªå•å…¬å‘Šå…§å®¹
    public String getNoticeContentSeatSelection() {
        return NoticeContentSeatSelection;
    }
    
    public Boolean hasTabData(String key) {
        return tabData != null && tabData.containsKey(key);
    }
    
    //BookingClass => CabinClass
    private static final Map<String, String> CabinMap = new Map<String, String>{
        'F' => 'F',
        'A' => 'F',
        'J' => 'J',
        'C' => 'J',
        'D' => 'J',
        'W' => 'W',
        'R' => 'W',
        'E' => 'W',
        'Y' => 'Y',
        'B' => 'Y',
        'H' => 'Y',
        'K' => 'Y',
        'M' => 'Y',
        'L' => 'Y',
        'V' => 'Y',
        'S' => 'Y',
        'N' => 'Y',
        'Q' => 'Y',
        'G' => 'Y'
    };

    // å‚³å…¥å–®ä¸€å­—æ¯ï¼Œå›å‚³å°æ‡‰å€¼ï¼Œè‹¥ç„¡å‰‡å›å‚³ null
    public static String getCabinClass(String bookingClass) {
        if (String.isBlank(bookingClass) || bookingClass.length() != 1) return null;
        return CabinMap.get(bookingClass.toUpperCase());
    }
    
    // é›†ä¸­åŒ–éŒ¯èª¤è¨Šæ¯é‚è¼¯
    private String buildPnrFailureMessage(List<String> pnrList) {
        return String.join(pnrList, ',');
    }
    
    private String buildSeatMapFailureMessage(List<String> pnrList) {
        return 'åº§ä½åœ–æ“·å–å¤±æ•—ï¼š' + String.join(pnrList, ',');
    }
    
    public String buildCombinedErrorMessage(List<String> unmatchedPnrKeys, List<String> failedRetrievePNRKeys, Set<String> noSeatMapPNRKeys, List<String> matchedPnrKeys) {
        List<String> errorMessages = new List<String>();

        // Track if we have any successful PNRs
        Boolean hasSuccessfulPNRs = false;

        // Check if any matched PNRs are NOT in failed lists
        for (String pnr : matchedPnrKeys) {
            if (!failedRetrievePNRKeys.contains(pnr) && !noSeatMapPNRKeys.contains(pnr)) {
                hasSuccessfulPNRs = true;
                break;
            }
        }
        // Add prefix if we have partial success
        if (hasSuccessfulPNRs && (!unmatchedPnrKeys.isEmpty() || !failedRetrievePNRKeys.isEmpty() || !noSeatMapPNRKeys.isEmpty())) {
            errorMessages.add('æŸ¥ç„¡éƒ¨åˆ†PNR');
        }

        if (!unmatchedPnrKeys.isEmpty()) {
            errorMessages.add(buildPnrFailureMessage(unmatchedPnrKeys));
        }

        if (!failedRetrievePNRKeys.isEmpty()) {
            errorMessages.add(buildPnrFailureMessage(failedRetrievePNRKeys));
        }

        if (!noSeatMapPNRKeys.isEmpty()) {
            if (noSeatMapPNRKeys.containsAll(matchedPnrKeys)) {
                errorMessages.add(buildSeatMapFailureMessage(new List<String>(noSeatMapPNRKeys)));
            } else {
                errorMessages.add(buildSeatMapFailureMessage(new List<String>(noSeatMapPNRKeys)));
            }
        }

        return errorMessages.isEmpty() ? '' : String.join(errorMessages, 'ï¼š');
    }

    /**
     * Helper method to rebuild tabData for a specific PNR with fresh traveller data
     * @param pnrCode - The PNR code to rebuild data for
     * @param freshTravellers - Updated traveller records from database
     */
    // private void rebuildTabDataForPNR(String pnrCode, List<TravellerInfo__c> freshTravellers) {
    //     if (String.isBlank(pnrCode) || freshTravellers == null) {
    //         return;
    //     }

    //     // Clear existing data for this PNR
    //     if (tabData.containsKey(pnrCode)) {
    //         tabData.remove(pnrCode);
    //     }

    //     // Rebuild passenger info for this PNR
    //     for (TravellerInfo__c t : freshTravellers) {
    //         if (t.PNR__c != pnrCode) continue; // Skip if not matching PNR

    //         if (!tabData.containsKey(t.PNR__c)) {
    //             tabData.put(t.PNR__c, new List<PassengerInfo>());
    //         }

    //         // Find existing passenger or create new one
    //         String paxKey = t.LastName__c + '/' + t.firstName__c;
    //         PassengerInfo pInfo;
    //         for (PassengerInfo p : tabData.get(t.PNR__c)) {
    //             if (p.name == paxKey) {
    //                 pInfo = p;
    //                 break;
    //             }
    //         }

    //         if (pInfo == null) {
    //             pInfo = new PassengerInfo();
    //             pInfo.recordId      = t.Id;
    //             pInfo.name          = t.LastName__c + '/' + t.firstName__c;
    //             pInfo.title         = t.title__c;
    //             pInfo.gender        = t.gender__c;
    //             pInfo.nationality   = t.country__c;
    //             pInfo.birthDate     = t.DateOfBirth__c;
    //             pInfo.passengerType = t.PassengerType__c;
    //             pInfo.usBound = t.US_Bound__c;
    //             pInfo.pt = t.PT__c;
    //             pInfo.st = t.ST01__c;
    //             pInfo.CAS = t.CAS__c;
    //             pInfo.DID = t.DID__c;
    //             pInfo.rqstOT = t.RQST_OT__c;
    //             pInfo.DepartureDate = t.DepartureDate__c;
    //             pInfo.DepartureLocation = t.DepartureLocation__c;
    //             pInfo.Destination = t.Destination__c;
    //             pInfo.FlightNumber = t.FlightNumber__c;

    //             tabData.get(t.PNR__c).add(pInfo);
    //         }

    //         // Update seat information with fresh data
    //         pInfo.seat = t.Seat__c;
    //         pInfo.seatIsChargeable = t.SeatIsChargeable__c;
    //     }

    //     System.debug('âœ… Rebuilt tabData for PNR: ' + pnrCode + ' with ' + freshTravellers.size() + ' travellers');
    //     System.debug('ğŸ” tabData for PNR: ' + pnrCode + ' : ' + JSON.serialize(tabData.get(pnrCode)));
    // }

    /**
     * Helper method to retrieve seat map for a specific PNR with fallback logic
     * @param pnrCode - The PNR code to retrieve seat map for
     * @param traveller - Sample traveller from this PNR (used to extract flight details)
     * @return AirRetrieveSeatMap.Result or null if both API calls fail
     */
    private AirRetrieveSeatMap.Result retrieveSeatMapForPNR(String pnrCode, TravellerInfo__c traveller) {
        if (traveller == null) {
            System.debug('âŒ Cannot retrieve seat map - traveller is null for PNR: ' + pnrCode);
            return null;
        }

        System.debug('ğŸ” Retrieving seat map for PNR: ' + pnrCode);
        AirRetrieveSeatMap.Result seatMapResult = null;

        try {
            // 1st attempt: primary SeatMap API
            seatMapResult = AmadeusUtilRetrieveSeatMap.Air_RetrieveSeatMap(
                traveller.DepartureDate__c,
                traveller.DepartureLocation__c,
                traveller.Destination__c,
                traveller.FlightNumber__c,
                traveller.BookingClass__c
            );

            // If first call failed or result is missing aircraft type, fallback to DCSSTG
            if (seatMapResult == null || String.isBlank(seatMapResult.iataAircraftTypeCode)) {
                System.debug('âš ï¸ SeatMap API ç„¡è³‡æ–™ï¼Œæ”¹å‘¼å« DCSSTG for PNR ' + pnrCode);
                seatMapResult = AmadeusUtilRetrieveSeatMap.DCSSTG_GetFDSeatMap(
                    traveller.DepartureDate__c,
                    traveller.DepartureLocation__c,
                    traveller.FlightNumber__c
                );
            }

            // Process successful result
            if (seatMapResult != null && !String.isBlank(seatMapResult.iataAircraftTypeCode)) {
                String cabinCode = getCabinClass(traveller.BookingClass__c);
                if (cabinCode != null) {
                    seatMapResult.cabinClasses = new Set<String>{ cabinCode };
                    System.debug('âœ… Seat map retrieved successfully for PNR: ' + pnrCode);
                    return seatMapResult;
                } else {
                    System.debug('âŒ BookingClass ç„¡æ³•è½‰æ› CabinClass for PNR: ' + pnrCode);
                    return null;
                }
            } else {
                System.debug('âŒ Both seat map APIs failed for PNR: ' + pnrCode);
                return null;
            }
        } catch (Exception ex) {
            System.debug('âŒ Exception retrieving seat map for PNR ' + pnrCode + ': ' + ex.getMessage());
            return null;
        }
    }

    /**
     * Helper method to refresh both traveler data and seat map for a specific PNR
     * Updates seatMapResults and tabData properties
     * Follows the same pattern as searchPnr(): API â†’ Database â†’ Query â†’ Rebuild
     * @param pnrCode - The PNR code to refresh data for
     * @param departureLocation - Departure location for API call
     */
    // private void refreshDataForPNR(String pnrCode, String departureLocation) {
    //     System.debug('ğŸ”„ Refreshing data for PNR: ' + pnrCode);

    //     try {
    //         // 1. Retrieve fresh traveler data from API
    //         List<TravellerInfo__c> freshTravellers = AmadeusUtil.retrievePNR(departureLocation, pnrCode);

    //         if (freshTravellers == null || freshTravellers.isEmpty()) {
    //             System.debug('âš ï¸ No fresh traveler data retrieved for PNR: ' + pnrCode);
    //             return;
    //         }

    //         System.debug('âœ… Retrieved ' + freshTravellers.size() + ' fresh travellers from API for PNR: ' + pnrCode);
    //         System.debug('ğŸ” freshTravellers: ' + JSON.serialize(freshTravellers));

    //         // 2. Retrieve fresh seat map BEFORE upsert (to avoid CalloutException)
    //         // Use freshTravellers from API as sample
    //         TravellerInfo__c sampleTraveller = freshTravellers[0];
    //         AirRetrieveSeatMap.Result freshSeatMap = retrieveSeatMapForPNR(pnrCode, sampleTraveller);

    //         // 3. Save to database (triggers/formulas will be computed)
    //         // All callouts must be done before this DML operation
    //         upsert freshTravellers External_ID__c;
    //         System.debug('âœ… Upserted travellers to database for PNR: ' + pnrCode);

    //         // 4. Query back from database to get ALL fields including formula fields
    //         // (Matches the query in searchPnr lines 503-524)
    //         List<TravellerInfo__c> completeData = [
    //             SELECT Id, PNR__c,
    //             LastName__c, FirstName__c, Title__c, Gender__c, PT__c, ST01__c, ST02__c,
    //             Country__c, DateOfBirth__c, PassengerType__c, PassportFinished__c,
    //             PassportNumber__c, PassportExpiryDate__c, PassportIssuingCountry__c, DepartureLocation__c, US_Bound__c,
    //             VisaNumber__c, VisaExpiryDate__c, VisaIssuingCountry__c,
    //             USAStreet__c, USACity__c, USAState__c, USAZipCode__c,
    //             USAEmergencyContactName__c, USAEmergencyContactNationality__c, USAEmergencyContactPhone__c, Seat__c,
    //             CheckDisable__c, C3ExternalFinished__c, C3Finished__c, C4BoardingPassPrinted__c, C4BoardingPassPrintedTime__c,
    //             C4EBoardingPass__c, C4PaperBoardingPass__c, PrintDisable__c, DepartureLocationGMTLocal__c, Barcode__c, PAX__c, Service__c, Meal__c, IATA_MSO_Code__c, RQST_OT__c,
    //             C1Finished__c, UCI__c, DID__c, CAS__c, SeatIsChargeable__c, DepartureDate__c, DepartureDate2__c, FlightNumber__c, Destination__c, C3Status__c, C2OperationDisable__c, C3OperationDisable__c, C4BoardingPassPrintedTimeGMTLocal__c,
    //             C3CheckboxDisplay__c, APE__c, APM__c, BookingClass__c
    //             FROM TravellerInfo__c
    //             WHERE PNR__c = :pnrCode
    //             AND DepartureLocation__c = :departureLocation
    //             ORDER BY PTOrderBy__c ASC, PassengerTypeOrderBy__c ASC
    //         ];

    //         if (completeData.isEmpty()) {
    //             System.debug('âš ï¸ No data found in database after upsert for PNR: ' + pnrCode);
    //             return;
    //         }

    //         System.debug('âœ… Queried ' + completeData.size() + ' complete records from database for PNR: ' + pnrCode);
    //         System.debug('ğŸ” completeData: ' + JSON.serialize(completeData));
    //         // 5. Update seatMapResults
    //         if (freshSeatMap != null) {
    //             seatMapResults.put(pnrCode, freshSeatMap);
    //             System.debug('âœ… Updated seatMapResults for PNR: ' + pnrCode);
    //         } else {
    //             System.debug('âš ï¸ Could not update seat map for PNR: ' + pnrCode);
    //         }

    //         // 6. Update pnrC2DisabledMap for this PNR (matches searchPnr logic lines 528-547)
    //         if (!completeData.isEmpty()) {
    //             TravellerInfo__c firstTraveler = completeData[0];
    //             Boolean isDisabled = firstTraveler.C2OperationDisable__c == true;
    //             pnrC2DisabledMap.put(pnrCode, isDisabled);
    //             System.debug('âœ… Updated pnrC2DisabledMap for PNR ' + pnrCode + ': C2OperationDisable = ' + isDisabled);
    //         }

    //         // 7. Update tabData with complete database data (includes formula fields)
    //         rebuildTabDataForPNR(pnrCode, completeData);
    //         System.debug('âœ… Successfully refreshed all data for PNR: ' + pnrCode);

    //     } catch (Exception ex) {
    //         System.debug('âŒ Error refreshing data for PNR ' + pnrCode + ': ' + ex.getMessage());
    //         System.debug('âŒ Stack trace: ' + ex.getStackTraceString());
    //         // Don't throw - allow operation to continue even if refresh fails
    //     }
    // }
    // 
    public static void fakeMethod() {
        Boolean b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
        b = true;
    }
}