<!--============================= Infos =======================================

Name: B2BForgotPassword
Author: Benson Tseng 
Purpose: STARLUX Airlines 

Static Resources:
Name                             MIME        Description
-------------------------------------------------------------------------------


-------------------------------------------------------------------------------
Backup File:


============================= Infos =======================================-->
<apex:page controller="B2BForgotPasswordController" docType="html-5.0" applyHtmlTag="true" standardStylesheets="false" showHeader="false">
    <head>
        <script>
          window.onload = function () {
            var isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
            if (isTouchDevice) {
              window.location.href = '/B2BForgotPasswordMobile';
            }
          };
        </script>
        <title>ForgotPassword</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
        <c:styleinclude ></c:styleinclude>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
        <apex:stylesheet value="{!$Resource.style_login}"/>
        <style>
            .login-sidebar {
            background-image: url('{!URLFOR($Resource.LoginBackground)}');
            color: white;
            }
            .custom-validation-form .form-control.is-invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
            }
            
            .custom-validation-form .invalid-feedback{
            margin-top:0
            }
            
            ::placeholder {
            color: #ccc !important;
            opacity: 1;
            }
            
            .custom-validation-form .form-control.is-invalid {
            background-image:none;
            
            }
            
            .form-control:focus {
            border-color: rgba(142, 114, 72, 1);
            box-shadow: 0 0 0 0.2rem rgba(232, 224, 218, 0.5);
            } 
            
            .form-control.is-valid:focus,
            .was-validated .form-control:valid:focus {
            border-color: rgba(142, 114, 72, 1);
            box-shadow: 0 0 0 0.25rem rgba(142, 114, 72, 0.25);
            }
            
            .notification-panel{
            width:400px !important;
            }
        </style>
    </head>
    
    
    <body class="d-flex align-items-center py-4">
        <c:globalnotification message="輸入的旅行社IATA代碼、帳號或電子郵件有誤，請重新嘗試" isVisible="{!isWrongCredentials}" />
        <!--不用寄信了<c:globalnotification message="帳號尚未開通，已重新寄送開通信件" isVisible="{!isAccountInactive}" />-->
        <apex:outputPanel rendered="{!isResetPassword}">
            <c:successNotification message="驗證成功，請重新重設密碼" isVisible="{!isResetPassword}" />
            
            <script>
            setTimeout(function() {
                var accountId = '{!accountId}';
                if (accountId) {
                    window.location.href = '/apex/ResetPassword?accountId=' + encodeURIComponent(accountId);
                } else {
                    window.location.href = '/apex/ResetPassword';
                }
            }, 2000);  // 2秒後跳轉
            </script> 
        </apex:outputPanel>
        
        <apex:outputPanel id="messagePanel" layout="block" style="position: absolute; top: 0; right: 0; transform: scale(0.5); color: transparent;">
            <apex:pageMessages id="messages"/>
        </apex:outputPanel>
        <main class="login-container mx-auto">
            <apex:form id="loginForm">
                <div class="card login-box">
                    <div class="row g-0 login-body">
                        <div class="col-md-6 login-sidebar d-flex flex-column justify-content-center" style="height:600px">
                            <h3 class="fw-bold mb-2 text-center login-title"><img src="{!URLFOR($Resource.Logo2)}" class="logo" alt="Logo" style="width:10%;height:auto;font-size:34px"/>旅遊同業團體作業B2B平台</h3>
                        </div>
                        <div class="col-md-6 login-form" style="padding:66px;height:600px">
                            <div class="w-100">
                                <h2 class="fw-bold pb-2 formTitle" style="font-size:36px">忘記密碼</h2>
                                <p style="font-size:12px;color:rgba(142, 114, 72, 1);font-weight:bold;margin-bottom:50px">旅遊同業團體作業B2B平台</p>
                              
                                <div class="custom-validation-form" style="padding-top:36px;">
                                    <div class="position-relative test1" style="margin-bottom:36px">
                                        <span class="material-symbols-outlined" style="position:absolute;margin:11px 8px 10px 16px;font-size:20px;color:rgba(142, 114, 72, 1)">work</span>
                                        <apex:inputText style="padding-left:50px" id="IATAcode" styleClass="form-control" value="{!IATAcode}" html-placeholder="旅行社IATA代碼" maxlength="8"/>
                                        <div id="IATAcodeFeedback" class="invalid-feedback" style="margin-top:0">
                                            必填
                                        </div>
                                    </div>
                                    <div class="position-relative test1" style="margin-bottom:36px">
                                        <span class="material-symbols-outlined" style="position:absolute;margin:11px 8px 10px 16px;font-size:20px;color:rgba(142, 114, 72, 1)">account_circle</span>
                                        <apex:inputText style="padding-left:50px" styleClass="form-control" value="{!UserAccount}" html-placeholder="帳號" maxlength="10"/>
                                        <div class="invalid-feedback" style="margin-top:0">
                                            必填
                                        </div>
                                    </div>
                                    <div class="position-relative test1" style="margin-bottom:36px">
                                        <span class="material-symbols-outlined" style="position:absolute;margin:11px 8px 10px 16px;font-size:20px;color:rgba(142, 114, 72, 1)">mail</span>
                                        <apex:inputText style="padding-left:50px" id="email" styleClass="form-control" value="{!email}" html-placeholder="電子郵件"/>
                                        <div id="emailFeedback" class="invalid-feedback" style="margin-top:0">
                                            必填
                                        </div>
                                    </div>
                                    <apex:commandButton styleClass="btn btn-lg btn-primary mb-3 forgotBtn" style="width:41%;margin-right:10px" action="{!redirectLogin}" value="取消"/>
                                    <apex:commandButton styleClass="btn btn-lg btn-primary btn-login mb-3" action="{!sendEmail}" value="確認" onclick="return validateForm(event);" id="submitBtn"></apex:commandButton>
                                </div>
                                
                                
                            </div>
                            
                            <div class="d-flex justify-content-end" style="width:100%;margin-left:60px">
                                <img src="{!URLFOR($Resource.Logo3)}" class="mb-0" alt="Logo"/>
                            </div>
                        </div>
                    </div>
                </div>
            </apex:form>
            
            <div class="card-footer text-center mt-3">
                <p class="text-white" style="font-size:14px">COPYRIGHT © 2024 STARLUX AIRLINES. ALL RIGHTS RESERVED. </p>
            </div>
        </main>
        
    </body>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script>   
    // 偵測使用者按下 Enter 鍵(好像沒作用，但是可以避免選擇到取消)
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // 防止表單預設提交動作
            document.getElementById('{!$Component.loginForm.submitBtn}').click(); // 觸發寄送按鈕
        }
    });
    
    function validateForm(event) {
        var form = document.querySelector('.custom-validation-form');
        var inputs = form.querySelectorAll('input');
        var isValid = true;
        
        // Regular expressions for validation
        const numberOnly = /^\d+$/;
        const alphanumericSpecial = /^[A-Za-z0-9!@#$%^&*()_+\-=\[\]{};:'",.<>/?\\|`~]+$/;
        const emailFormat = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        inputs.forEach(function(input) {
            var test1Element = input.closest('.test1');
            var feedbackElement = input.parentElement.querySelector('.invalid-feedback');
            var value = input.value.trim();
            
            // Reset styles
            input.classList.remove('is-invalid');
            input.parentElement.classList.remove('was-validated');
            if (test1Element) {
                test1Element.style.marginBottom = '36px';
            }
            
            // Common validation: Required field
            if (value === '') {
                isValid = false;
                setInvalid(input, test1Element, feedbackElement, "必填");
                return;
            }
            
            // Specific validations based on placeholder
            switch(input.placeholder) {
                case "旅行社IATA代碼": {
                    const alphaNum = /^[A-Za-z0-9]+$/;
                
                    const isAlphaNumOk = alphaNum.test(value);
                    const isLenOk      = (value.length >= 7);
                
                    if (!isAlphaNumOk || !isLenOk) {
                        isValid = false;
                
                        const msgs = [];
                        if (!isAlphaNumOk) msgs.push("僅能輸入英文與數字");
                        if (!isLenOk)      msgs.push("請輸入至少 7 個字元");
                
                        setInvalid(input, test1Element, feedbackElement, msgs.join("；"));
                        return;
                    }
                    break;
                }
                    
                case "帳號":
                    // Check if alphanumeric and special characters only
                    if (!alphanumericSpecial.test(value)) {
                        isValid = false;
                        setInvalid(input, test1Element, feedbackElement, "僅能輸入英文字、數字、特殊字元");
                        return;
                    }
                    break;
                    
                case "電子郵件":
                    // Check email format
                    if (!emailFormat.test(value)) {
                        isValid = false;
                        setInvalid(input, test1Element, feedbackElement, "請輸入電子郵件格式");
                        return;
                    }
                    break;
            }
        });
        
        if (!isValid) {
            event.preventDefault();
        }
        return isValid;
    }
    
    // Helper function to set invalid state
    function setInvalid(input, test1Element, feedbackElement, message) {
        input.classList.add('is-invalid');
        input.parentElement.classList.add('was-validated');
        if (feedbackElement) {
            feedbackElement.textContent = message;
        }
        if (test1Element) {
            test1Element.style.marginBottom = 'calc(36px - 21px)';
        }
    }

    
    </script>
</apex:page>