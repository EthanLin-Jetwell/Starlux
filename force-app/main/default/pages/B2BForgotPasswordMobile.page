<apex:page controller="B2BForgotPasswordController" docType="html-5.0" applyHtmlTag="true" standardStylesheets="false" showHeader="false">
  <head>
    <title>ForgotPassword</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
    <c:styleinclude ></c:styleinclude>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <apex:stylesheet value="{!$Resource.style_login}"/>

    <style>
      /* ==== Validations (keep consistent with LoginMobile) ==== */
      .custom-validation-form .form-control.is-invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }
      .custom-validation-form .invalid-feedback {
        display: block;      /* 保留高度避免跳動 */
        min-height: 18px;
        font-size: 12px;
        color: #dc3545;
        visibility: hidden;
      }
      .form-control.is-invalid + .invalid-feedback { visibility: visible; }

      .login-sidebar {
        height: 8vh;
        background-image: url('{!$Resource.LoginBackground}');
        background-size: 105% auto;    /* 放大一點只露左側 */
        background-position: left center;
        background-repeat: no-repeat;
        color: white;
        display: flex; align-items: center; justify-content: center; text-align: center;
        width: calc(100% - 6%);
        max-width: 600px;
        margin: auto;
        border-top-left-radius: 8px; border-top-right-radius: 8px;
        box-shadow: 4px 6px 12px rgba(0,0,0,0.35);
      }
      body { background-color: #f8f9fa; padding-top: 12px; }
      .login-box {
        width: calc(100% - 6%);
        max-width: 600px;
        margin: auto;
        padding: 40px;
        background-color: #fff;
        border-radius: 0 0 8px 8px;
        box-shadow: 4px 6px 12px rgba(0,0,0,0.35);
      }

      .form-control:focus { border-color: rgba(142,114,72,1); box-shadow: 0 0 0 0.2rem rgba(232,224,218,0.5); }
      .material-symbols-outlined { position: absolute; margin: 11px 8px 10px 16px; font-size: 20px; color: rgba(142,114,72,1); }
      .position-relative { position: relative; }

      /* Small footer */
      .copyright { font-size: 14px; }
    </style>
  </head>

  <body>
    <!-- Global notifications (unchanged behavior) -->
    <c:globalnotification message="輸入的旅行社IATA代碼、帳號或密碼有誤，請重新嘗試" isVisible="{!isWrongCredentials}" />
    <apex:outputPanel rendered="{!isResetPassword}">
      <c:successNotification message="驗證成功，請重新重設密碼" isVisible="{!isResetPassword}" />
      <script>
        setTimeout(function(){
          var accountId = '{!accountId}';
          if (accountId) {
            window.location.href = '/apex/ResetPassword?accountId=' + encodeURIComponent(accountId);
          } else {
            window.location.href = '/apex/ResetPassword';
          }
        }, 2000);
      </script>
    </apex:outputPanel>

    <!-- keep pageMessages for controller addMessage -->
    <apex:outputPanel id="messagePanel" layout="block" style="position:absolute; top:0; right:0; transform:scale(0.5); color:transparent;">
      <apex:pageMessages id="messages"/>
    </apex:outputPanel>

    <!-- Top banner like LoginMobile -->
    <div class="login-sidebar">
      <h3>
        <img src="{!URLFOR($Resource.Logo2)}" class="logo" alt="Logo" style="width:9%;height:auto;font-size:24px"/>
        旅遊同業團體作業B2B平台
      </h3>
    </div>

    <main>
      <apex:form id="loginForm">
        <div class="login-box">
          <h2 class="fw-bold pb-2 text-center" style="font-size:30px">忘記密碼</h2>
          <p class="text-center" style="font-size:12px; color: rgba(142,114,72,1); font-weight:bold; margin-bottom:24px;">旅遊同業團體作業B2B平台</p>

          <div class="custom-validation-form">
            <div class="position-relative mb-3" style="margin-top:24px;">
              <span class="material-symbols-outlined">work</span>
              <apex:inputText id="IATAcode" styleClass="form-control" value="{!IATAcode}" html-placeholder="旅行社IATA代碼" maxlength="8" style="padding-left:50px"/>
              <div id="IATAcodeFeedback" class="invalid-feedback">必填</div>
            </div>

            <div class="position-relative mb-3">
              <span class="material-symbols-outlined">account_circle</span>
              <apex:inputText styleClass="form-control" value="{!UserAccount}" html-placeholder="帳號" maxlength="10" style="padding-left:50px"/>
              <div class="invalid-feedback">必填</div>
            </div>

            <div class="position-relative mb-3">
              <span class="material-symbols-outlined">mail</span>
              <apex:inputText id="email" styleClass="form-control" value="{!email}" html-placeholder="電子郵件" style="padding-left:50px"/>
              <div id="emailFeedback" class="invalid-feedback">必填</div>
            </div>

            <div class="d-flex justify-content-between" style="gap:12px;">
              <apex:commandButton styleClass="btn btn-lg btn-primary mb-3 forgotBtn" style="flex:0 0 40%;" action="{!redirectLogin}" value="取消"/>
              <apex:commandButton id="submitBtn" styleClass="btn btn-lg btn-primary btn-login mb-3" style="flex:0 0 58%;" action="{!sendEmail}" value="確認" onclick="return validateForm(event);"/>
            </div>
          </div>

          <div class="d-flex justify-content-end" style="width:100%">
            <img src="{!URLFOR($Resource.Logo3)}" class="mb-0" alt="Logo"/>
          </div>
        </div>
      </apex:form>
    </main>

    <div class="text-center mt-3">
      <p class="text-white copyright">COPYRIGHT © 2024 STARLUX AIRLINES. ALL RIGHTS RESERVED.</p>
    </div>

    <script>
      // Enter = submit (same behavior)
      document.addEventListener('keydown', function(e){
        if (e.key === 'Enter') {
          e.preventDefault();
          try { document.getElementById('{!$Component.loginForm.submitBtn}').click(); } catch(err) {}
        }
      });

      function validateForm(event){
        var form = document.querySelector('.custom-validation-form');
        var inputs = form.querySelectorAll('input');
        var isValid = true;
        var numberOnly = /^\d+$/;
        var alphanumericSpecial = /^[A-Za-z0-9!@#$%^&*()_+\-=\[\]{};:'",.<>/?\\|`~]+$/;
        var emailFormat = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        inputs.forEach(function(input){
          var feedback = input.parentElement.querySelector('.invalid-feedback');
          var value = (input.value || '').trim();
        
          input.classList.remove('is-invalid');
          feedback.textContent = '';
        
          if (!value) {
            feedback.textContent = '必填';
            input.classList.add('is-invalid');
            isValid = false;
        
          } else if (input.placeholder === '旅行社IATA代碼') {
            // A: 僅允許英數
            var alphaNum = /^[A-Za-z0-9]+$/;
            var isAlphaNumOk = alphaNum.test(value);
        
            // B: 長度需 >= 7
            var isLenOk = (value.length >= 7);
        
            if (!isAlphaNumOk || !isLenOk) {
              var msgs = [];
              if (!isAlphaNumOk) msgs.push('僅能輸入英文與數字');
              if (!isLenOk) msgs.push('請輸入至少 7 個字元');
        
              feedback.textContent = msgs.join('；');
              input.classList.add('is-invalid');
              isValid = false;
            }
        
          } else if (input.placeholder === '帳號' && !alphanumericSpecial.test(value)) {
            feedback.textContent = '僅英文字、數字、特殊字元';
            input.classList.add('is-invalid');
            isValid = false;
        
          } else if (input.placeholder === '電子郵件' && !emailFormat.test(value)) {
            feedback.textContent = '請輸入電子郵件格式';
            input.classList.add('is-invalid');
            isValid = false;
          }
        });

        if (!isValid) event.preventDefault();
        return isValid;
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
  </body>
</apex:page>