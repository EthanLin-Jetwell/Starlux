<apex:page controller="CheckINController"  docType="html-5.0" applyHtmlTag="true" standardStylesheets="false" showHeader="false">
    <head>
        <title>CheckIN</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
        <c:styleinclude ></c:styleinclude>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
        <link
              rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
              />
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        
        <link rel="stylesheet" href="{!$Resource.B2BStyle}" />
        <!-- Select2 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        
        <!-- jQuery (ÂøÖË¶Å) -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        
        <!-- Select2 JS -->
            <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        
        <style>
            
            
            .form-select.is-invalid:not([multiple]):not([size]), .form-select.is-invalid:not([multiple])[size="1"], .was-validated .form-select:invalid:not([multiple]):not([size]), .was-validated .form-select:invalid:not([multiple])[size="1"] {
            /* --bs-form-select-bg-icon: url(data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e); */
            padding-right: 4.125rem;
            background-position: right .75rem center, center right 2.25rem;
            background-size: 16px 12px, calc(.75em + .375rem) calc(.75em + .375rem);
            }
            
            /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Èö±ËóèË¢´ÂÅúÁî®Ê¨Ñ‰ΩçÁöÑ placeholder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
            input:disabled::placeholder {          /* Ê®ôÊ∫ñÂØ´Ê≥ï */
            color: transparent !important;
            opacity: 0 !important;
            }
            
            /* WebKit ËàäÂØ´Ê≥ïÔºàÈÉ®ÂàÜ SafariÔºèËàä Chrome ‰ªçÊúÉÁî®Âà∞Ôºâ*/
            input:disabled::-webkit-input-placeholder {
            color: transparent !important;
            opacity: 0 !important;
            }
            
            /* Edge / IE ÂÖºÂÆπÔºàIE Âè™Âà∞ 11Ôºå‰ΩÜ‰øùÈö™Ëµ∑Ë¶ãÔºâ*/
            input:disabled::-ms-input-placeholder {
            color: transparent !important;
            opacity: 0 !important;
            }
            
            /* È†êË®≠ÊÉÖÊ≥ÅÔºöÊâÄÊúâ disabled ÁöÑ date input ÈÉΩÈö±ËóèÂÄº */
            input[type="date"]:disabled {
            color: transparent !important;
            -webkit-text-fill-color: transparent !important;
            opacity: 1;
            }
            
            /* ÊúâÂÄºÁöÑÊôÇÂÄôË¶ÅÈ°ØÁ§∫ÔºàÈù† JS Âä†‰∏ä always-visibleÔºâ */
            input[type="date"].always-visible:disabled {
            color: inherit !important;
            -webkit-text-fill-color: initial !important;
            opacity: 1;
            }
            
            /* Èö±ËóèÂéüÁîüÊåâÈàï */
            input[type="date"]:disabled:not(.always-visible)::-webkit-clear-button,
            input[type="date"]:disabled:not(.always-visible)::-webkit-calendar-picker-indicator {
            display: none !important;
            }
            /* ÁßªÈô§ select È©óË≠âÁ¥ÖËâ≤ iconÔºàChrome/Bootstrap 5Ôºâ */
            select.form-select.is-invalid {
            background-image: none !important;
            }
            
            /* Èö±ËóèÂéüÂßã checkbox */
            input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #999999;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            position: relative;
            display: inline-block;
            vertical-align: middle;
            }
            
            /* ÂãæÈÅ∏ÂæåÁöÑËÉåÊôØÂíåÂãæÂãæ */
            input[type="checkbox"]:checked {
            background-color: #8e6448;
            border-color: #8e6448;
            }
            
            /* ÂãæÂãæÔºö‰ΩøÁî®ÂÅΩÂÖÉÁ¥†Áï´Âá∫‰æÜ */
            input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 1px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            }
            
            /* ÂàùÂßã checkbox Ê®£ÂºèÔºàÊú™ÂãæÈÅ∏Ôºâ */
            input[type="checkbox"].headerCheckbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #999999;
            border-radius: 4px;
            background-color: transparent;
            position: relative;
            cursor: pointer;
            }
            
            /* ÂãæÈÅ∏ÂæåÔºöËÉåÊôØÂ°´ÊªøÔºåÊ©´Á∑öÈ°ØÁ§∫ */
            input[type="checkbox"].headerCheckbox:checked {
            background-color: #8e6448;
            border-color: #8e6448;
            }
            
            /* ÁôΩËâ≤Ê∞¥Âπ≥Á∑öÔºà‰øÆÊ≠£ÁÇ∫Ê∞¥Âπ≥Ôºâ */
            input[type="checkbox"].headerCheckbox:checked::after {
            content: '';
            position: absolute;
            top: 7px;         /* ÂûÇÁõ¥ÁΩÆ‰∏≠ */
            left: 3px;
            width: 12px;
            height: 2px;
            background-color: white;
            transform: rotateY(45deg);
            }
            
            button.btn.btn-primary:disabled {
            background-color: #CCBBB0 !important;
            border-color: #CCBBB0 !important;
            color: white; /* Êàñ #fff */
            cursor: not-allowed;
            }
            
            
            
            .table th,
            .table td {
            text-align: left !important;
            }
            
            @media (max-width: 576px) {
            .table thead th {
            white-space: nowrap;  
            overflow: visible;    
            text-overflow: clip;   
            vertical-align: middle;
            }
            
            .table tbody td { 
            white-space: nowrap; 
            } 
            
            .table-responsive {
            overflow-x: auto;              
            -webkit-overflow-scrolling: touch;
            }
            .table-responsive > .table {
            width: max-content;            
            width: -moz-max-content;
            }
            
            .table {
            --bs-table-cell-padding-y: .6rem;
            --bs-table-cell-padding-x: .9rem;
            }
            
            .table th[style*="position:sticky"],
            .table td[style*="position:sticky"] {
            background: #fff;
            z-index: 2;
            }
            
            
            .table>:not(caption)>*>*:first-child {
            padding-left: 30px !important;
            padding-right: 30px !important;
            }
            
            #fixedBottomButtons .btn {
            flex: 1 1 0;
            width: auto !important;         
            }            
            
            }
            
        </style>
    </head>
    <body class="d-flex py-4">
        <c:B2BNavbar ></c:B2BNavbar>
        <apex:outputPanel id="SearchSuccessPanel" style="display:none">
            <c:successNotification message="ÊêúÂ∞ãÊàêÂäü"/>
        </apex:outputPanel>
        <apex:outputPanel id="SearchErrorPanel" style="display:none">
            <c:FailNotification message="{!errorMessage}"/>
        </apex:outputPanel>
        <apex:outputPanel id="editSuccessPanel" style="display:none">
            <c:successNotification message="‰ΩúÊ•≠ÂÆåÊàêÔºåË´ãÂÜçÊ¨°ÈªûÈÅ∏„ÄêÊêúÂ∞ã„Äë‰ª•Ê™¢Ë¶ñÊúÄÊñ∞ÁãÄÊÖã"/>
        </apex:outputPanel>
        
        <div class="content-wrapper" id="content-wrapper">
            <div class="container-fluid">
                <apex:form id="searchForm">                    
                    <!--<apex:pageMessages id="msgs"/>-->
                    <apex:actionFunction name="saveTravelerUpdates"
                                         action="{!save}"
                                         rerender="editSuccessPanel"
                                         >
                        <apex:param name="jsonData" assignTo="{!jsonInput}" value=""/>
                    </apex:actionFunction>
                    <apex:actionFunction name="goToNextPage" action="{!nextPage}" rerender="resultsBlock"/>
                    <apex:actionFunction name="goToPrevPage" action="{!prevPage}" rerender="resultsBlock"/>
                    <apex:actionFunction name="doReset" action="{!reset}" rerender="resultsBlock,SearchSuccessPanel,SearchErrorPanel"/>
                    <apex:actionFunction name="switchTabAF" rerender="pnrCountPanel,resultTabContent">
                        <apex:param name="newKey" assignTo="{!currentTabKey}" value=""/>
                    </apex:actionFunction>
                    <div id="flightSearchForm" class="row g-3">
                        <!-- Ëà™Áè≠ËôüÁ¢º -->
                        <div class="col-md-3">
                            <label class="form-label">Ëà™Áè≠ËôüÁ¢º*</label>
                            <div class="d-flex">
                                <!-- Â∑¶ÈÇäÁöÑ Prefix+dash -->
                                <div class="input-group me-2" style="width: 40%;">
                                    <input
                                           id="flightPrefix"
                                           class="form-control"
                                           value="{!flightPrefix}"
                                           disabled="true"
                                           style="height: 38px; border-radius: 2px;"/>
                                    <span class="input-group-text" style="border:none;background:none; height: 38px;">-</span>
                                </div>
                                <!-- Âè≥ÈÇäÁöÑËº∏ÂÖ•Ê°Ü -->
                                <div class="input-group" style="flex:1">
                                    <!-- È°ØÁ§∫Áî®Ëº∏ÂÖ•Ê°Ü -->
                                    <input type="text"
                                           id="flightNumber_display"
                                           class="form-control required-field"
                                           placeholder="Ë´ãËº∏ÂÖ•"
                                           oninput="limitFlightInput(this)"
                                           onblur="formatFlightNumber()"/>
                                    
                                    <!-- ÂØ¶ÈöõÈÄÅÂá∫Ê¨Ñ‰Ωç -->
                                    <apex:inputHidden value="{!flightNumber}" id="flightNumber" />
                                </div>
                                
                                
                            </div>
                            <div class="invalid-feedback w-100 ps-4">
                                ÂøÖÂ°´
                            </div>
                        </div>
                        
                        
                        <!-- Ëµ∑È£õÊó•Êúü -->
                        <div class="col-md-2">
                            <label class="form-label">Ëµ∑È£õÊó•Êúü*</label>
                            <div class="input-group">
                                <apex:inputText value="{!departureDateStr}"
                                                id="departureDate"
                                                styleClass="form-control required-field always-visible" 
                                                onkeydown="return false;"/>
                            </div>
                            <div class="invalid-feedback w-100">ÂøÖÂ°´</div>
                        </div>
                        
                        
                        
                        <!-- Ëµ∑È£õÂú∞ -->
                        <div class="col-md-2">
                            <label class="form-label">Ëµ∑È£õÂú∞*</label>
                            
                            <apex:selectList id="departureLocation"
                                             value="{!departureLocation}"
                                             size="1"
                                             styleClass="form-select required-field"
                                             style="border-radius: 2px;">
                                <apex:selectOptions value="{!originOptions}" />
                            </apex:selectList>
                            
                            <div class="invalid-feedback">ÂøÖÂ°´</div>
                        </div>
                        
                        
                        <!-- Ë®Ç‰Ωç‰ª£Ëôü -->
                        <div class="col-md-3">
                            <label class="form-label">Ë®Ç‰Ωç‰ª£Ëôü*</label>
                            
                            <apex:inputText value="{!bookingCodes}"
                                            id="bookingCodes"
                                            styleClass="form-control required-field"
                                            html-placeholder="Ë´ãËº∏ÂÖ•"/>
                            
                            <div class="invalid-feedback w-100">ÂøÖÂ°´</div>
                        </div>
                        
                        
                        <!-- ÊåâÈàï -->
                        
                        <div class="col-md-2 d-flex justify-content-end" style="align-items: anchor-center;">
                            <button id="clearButton" type="button"
                                    class="btn me-2"
                                    style="height:48px;width:80px;color:#8E7248;background:#fff;">
                                Ê∏ÖÈô§
                            </button>
                            <apex:actionFunction name="doSearch" action="{!searchPnr}"
                                                 rerender="resultsBlock,msgs,SearchSuccessPanel,SearchErrorPanel"
                                                 oncomplete="showTabs();" />
                            
                            <button id="validateBtn" type="button"
                                    class="btn"
                                    style="height:48px;width:80px;background:#8E7248;color:#fff;"
                                    onclick="validateSearch();">
                                ÊêúÂ∞ã
                            </button>
                            
                        </div>
                    </div>
                </apex:form>
                
                <!-- ======== ÁµêÊûúÂçÄ (reRender ÁõÆÊ®ô) ======== -->
                <apex:outputPanel id="resultsBlock" layout="block" style="height:88%;">
                    
                    <!-- Tabs (Âè™ÊúâÊêúÂ∞ãÂæåÊâçÈ°ØÁ§∫) -->
                    <div class="mt-4" id="tabResults"
                         style="{!IF(ISBLANK(currentTabKey),'display:none;','')}">
                        <ul class="nav nav-tabs" role="tablist" style="border: none;">
                            <apex:repeat value="{!pnrKeys}" var="pnr">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link {!IF(pnr==currentTabKey,'active','')}"
                                            data-bs-toggle="tab"
                                            data-bs-target="#tab{!pnr}"
                                            type="button" role="tab"
                                            style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); margin-right: 4px; border-radius: 0.375rem;"
                                            onclick="switchTabAF('{!JSENCODE(pnr)}');">
                                        {!pnr}
                                    </button>
                                </li>
                            </apex:repeat>
                        </ul>
                    </div>
                    
                    
                    
                    
                    <!-- Â§ñÊ°Ü -->
                    <div id="outerWrapper" class="mt-0"
                         style="background:#fff;border-radius:4px;
                                {!IF(ISBLANK(currentTabKey),'display:block;','')}
                                ">
                        
                        <!-- Ê≤íË≥áÊñôÊôÇÊèêÁ§∫ -->
                        <div id="searchPrompt"
                             class="search-prompt"
                             style="{!IF(ISBLANK(currentTabKey),'','display:none;')}">
                            Ë´ãÊêúÂ∞ãË≥áÊñô
                        </div>
                        
                        <!-- ÁµêÊûúË°®Ê†º -->
                        <div id="searchResults"
                             style="{!IF(ISBLANK(currentTabKey),'display:none;','')}; overflow-y: auto; position: relative;">
                            <apex:form >
                                <!-- ÈÄôË£°ÂèØÊîæÂàÜÈ†ÅÊéßÂà∂ -->
                                <div class="{!IF(
                                            c3OperationDisabled,
                                            'pagination-controls d-flex align-items-center justify-content-end',
                                            'pagination-controls d-flex align-items-center justify-content-between'
                                            )}"
                                     style="position: sticky; top: 0; z-index: 10; height:78px; margin-top:3px;">
                                    <apex:outputPanel rendered="{!NOT(c3OperationDisabled)}">
                                        <button id="checkinBtn" type="button" class="btn btn-primary px-3 py-1" onclick="prepareCheckin()" disabled="true">
                                            Â†±Âà∞
                                        </button>
                                    </apex:outputPanel>
                                    
                                    
                                    <div>
                                        <!-- Switch : 1-{Ë≥áÊñôÁ∏ΩÁ≠ÜÊï∏} of {Ë≥áÊñôÁ∏ΩÁ≠ÜÊï∏} 2025/06/04 Aaron-->
                                        <apex:outputPanel id="pnrCountPanel">
                                            <span class="me-2">
                                                {!IF(currentTabCount > 0, 1, 0)} - {!currentTabCount} of {!currentTabCount}
                                            </span>
                                        </apex:outputPanel>
                                        
                                        <!-- Prev Button -->
                                        <apex:outputPanel rendered="{!IF(NOT(ISBLANK(currentPage)), currentPage > 1, false)}">
                                            <button class="btn border-0" onclick="goToPrevPage();">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/>
                                                </svg>
                                            </button>
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!IF(NOT(ISBLANK(currentPage)) && currentPage <= 1, true, false)}">
                                            <button class="btn border-0" disabled="disabled" style="color: #d6ccbd; cursor: not-allowed;">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/>
                                                </svg>
                                            </button>
                                        </apex:outputPanel>
                                        
                                        <!-- Next Button -->
                                        <apex:outputPanel rendered="{!IF(NOT(ISBLANK(currentPage)) && NOT(ISBLANK(totalPages)) && currentPage < totalPages, true, false)}">
                                            <button class="btn border-0 me-2" onclick="goToNextPage();">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M8.59 16.59L13.17 12l-4.58-4.59L10 6l6 6-6 6z"/>
                                                </svg>
                                            </button>
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!IF(NOT(ISBLANK(currentPage)) && NOT(ISBLANK(totalPages)) && currentPage >= totalPages, true, false)}">
                                            <button class="btn border-0 me-2" disabled="disabled" style="color: #d6ccbd; cursor: not-allowed;">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M8.59 16.59L13.17 12l-4.58-4.59L10 6l6 6-6 6z"/>
                                                </svg>
                                            </button>
                                        </apex:outputPanel>
                                        
                                        
                                    </div>
                                </div>
                                
                                <div class="tab-content" id="resultTabContent">
                                    <apex:repeat value="{!pnrKeys}" var="pnr">
                                        <div id="tab{!pnr}" role="tabpanel"
                                             class="tab-pane fade {!IF(pnr==currentTabKey,'show active','')}">
                                            
                                            <div class="table-responsive">
                                                <table class="table">
                                                    <thead style="height:94px">
                                                        <!-- ‚á¢ Ë°®È†≠Áï• (ËàáÂéü‰æÜ‰∏ÄËá¥) -->
                                                        <tr>
                                                            <th style="width:5%; text-align-last: center;">
                                                                <apex:outputPanel rendered="{!NOT(c3OperationDisabled)}">
                                                                <input type="checkbox"
                                                                       id="selectAll_{!pnr}"
                                                                       class="headerCheckbox"
                                                                       onclick="toggleAllInTab(this)" />       
                                                                </apex:outputPanel>
                                                            </th>
                                                            <th style="width:10%; color:#8e6448; cursor:pointer;" class="sortable" onclick="sortTableByNumber(this)">No. ‚Üì</th>
                                                            <th style="width:20%;
                                                                       position:sticky;left:0;z-index:2;
                                                                       background:#fff">ÊóÖÂÆ¢ÂßìÂêç / Á®±Ë¨Ç</th>
                                                            <th>Â∫ß‰Ωç</th>
                                                            <th>Êñá‰ª∂ÁãÄÊÖã</th>
                                                            <th>Â†±Âà∞ÁµêÊûú</th>
                                                            
                                                        </tr>
                                                    </thead>
                                                    
                                                    <tbody>
                                                        <apex:variable var="index" value="{!0}" />
                                                        <apex:repeat value="{!tabData[pnr]}" var="p">
                                                            <tr data-id="{!p.recordId}" style="border-bottom:1px solid #dee2e6">
                                                                <td style="text-align: center !important;">
                                                                    <!-- <apex:outputPanel layout="none" rendered="{!AND(NOT(OR(p.CheckDisable, p.C3ExternalFinished)), NOT(ISNULL(p.CAS)))}">
<input type="checkbox" class="rowCheckbox" />
</apex:outputPanel>-->
                                                                    
                                                                    <apex:outputPanel rendered="{!NOT(c3OperationDisabled)}">
                                                                        <apex:outputPanel layout="none" rendered="{!p.C3CheckboxDisplay}">
                                                                            <input type="checkbox"
                                                                                   class="rowCheckbox"
                                                                                   style="{!IF(p.passengerType == 'INF',
                                                                                          'visibility: hidden; position: absolute;',
                                                                                          '')}" />
                                                                        </apex:outputPanel>
                                                                    </apex:outputPanel>
                                                                    
                                                                </td>
                                                                
                                                                <td data-index="{!index + 1}">{!index + 1}</td>
                                                                <td style="font-weight:bold; position:sticky;left:0; z-index:1; background:#fff">
                                                                    <apex:outputText rendered="{!p.passengerType == 'INF'}"> ‚îî </apex:outputText>
                                                                    {!p.lastName}/{!p.firstName} {!p.title}
                                                                </td>
                                                                <td>{!p.Seat}</td>
                                                                <td>
                                                                    {!IF(p.isDocumentCompleted, 'Â∑≤ÂÆåÊàê', 'Êú™ÂÆåÊàê')}
                                                                    
                                                                </td>
                                                                <td>
                                                                    <apex:outputText value="{!p.C3Status}" />
                                                                </td>
                                                                
                                                                
                                                                <!-- Èö±Ëóè document Ë≥áÊñô -->
                                                                <td style="display:none;">
                                                                    <apex:repeat value="{!p.documents}" var="d">
                                                                        <input type="hidden" data-id="{!d.Id}" data-api="LastName__c" value="{!p.lastName}" />
                                                                        <input type="hidden" data-id="{!d.Id}" data-api="firstName__c" value="{!p.firstName}" />
                                                                        <input type="hidden" data-id="{!d.Id}" data-api="PT__c" value="{!p.PT}" />
                                                                        <input type="hidden" data-id="{!d.Id}" data-api="ST01__c" value="{!p.ST}" />
                                                                        <input type="hidden" data-id="{!d.Id}" data-api="ST02__c" value="{!p.ST2}" />
                                                                    </apex:repeat>
                                                                </td>
                                                            </tr>
                                                            <!-- index Á¥ØÂä† -->
                                                            <apex:variable var="index" value="{!index + 1}" />
                                                        </apex:repeat>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </apex:repeat>
                                </div>
                                <apex:actionFunction name="doCheckIn"
                                                     action="{!checkInSelected}"
                                                     rerender="resultTabContent,SearchErrorPanel,editSuccessPanel"
                                                     oncomplete="afterSaveSuccess();">
                                    <apex:param name="ids" assignTo="{!selectedTravellerIdsJson}" value=""/>
                                </apex:actionFunction>
                                
                                <apex:actionFunction name="doUploadDocument"
                                                     action="{!uploadDocument}"
                                                     rerender="resultTabContent"
                                                     oncomplete="afterSaveSuccess()" 
                                                     >
                                </apex:actionFunction>
                                
                            </apex:form>
                        </div> <!-- /searchResults -->
                    </div>   <!-- /outerWrapper -->
                </apex:outputPanel>
            </div>
        </div>
        
        <div class="modal fade" id="checkinConfirmModal" tabindex="-1" aria-labelledby="checkinConfirmLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-sm">
                <div class="modal-content">
                    <div class="modal-body">
                        <p class="mb-0" style="padding: 10px;">Á¢∫Ë™çË¶ÅÂ†±Âà∞ÂóéÔºü</p>
                    </div>
                    <div class="modal-footer d-flex border-0">
                        
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="width:80px;">ÂèñÊ∂à</button>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="handleCheckin()" style="width:80px;">Á¢∫Ë™ç</button>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="fixed-bottom-buttons" id="fixedBottomButtons">
            <div class="container" style="margin-top:0; box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2); z-index: 1050; background-color: #fff;">
                <button type="submit" class="btn" id="lastStep" style="width:90px;height:48px;background-color:white;color:#8E7248;border:1px solid #8E7248;">‰∏ä‰∏ÄÊ≠•</button>
                <!--<button type="submit" id="nextStep1" class="btn me-2" style="width:90px;height:48px;background-color:white;color:#8E7248;border:1px solid #8E7248;">‰∏ã‰∏ÄÊ≠•</button>-->
                <button type="button"
                        id="nextStep1"
                        class="btn me-2"
                        style="width:90px;height:48px;background-color:white;color:#8E7248;border:1px solid #8E7248;"
                        onclick="goToNextStep();">‰∏ã‰∏ÄÊ≠•</button>
                
            </div>
        </div>
        <div id="loadingOverlay" style="display: none;">
            <div style="
                        position: fixed;
                        top: 0; left: 0; right: 0; bottom: 0;
                        background-color: rgba(255, 255, 255, 0.7);
                        z-index: 99999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        ">
                <div class="spinner-border" role="status" style="width: 4rem; height: 4rem; color: #212121;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                
            </div>
        </div>
    </body>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const flightNumber = urlParams.get('flightNumber') || '';
            const departureDate = urlParams.get('departureDate') || '';
            const bookingCodes = urlParams.get('bookingCodes') || '';
            const departureLocation = urlParams.get('departureLocation') || '';
            
            
            // Ë®≠ÁΩÆÂÄºÂà∞Â∞çÊáâÊ¨Ñ‰Ωç
            document.getElementById('flightNumber_display').value = flightNumber;
            document.getElementById('{!$Component.searchForm.flightNumber}').value = flightNumber;
            document.getElementById('{!$Component.searchForm.departureDate}').value = departureDate;
            const depEl = document.getElementById('{!$Component.searchForm.departure}');
            if (depEl && departureLocation) depEl.value = departureLocation;
            document.getElementById('{!$Component.searchForm.bookingCodes}').value = bookingCodes;
            
            // Â¶ÇÊûú select ÂÖÉÁ¥†ÊòØÁî± apex:selectList ÁîüÊàêÁöÑÔºåÂèØËÉΩÈúÄË¶ÅÈ°çÂ§ñËôïÁêÜ:
            const depSelect = document.getElementById('{!$Component.searchForm.departure}');
            if(depSelect){
                for (let option of depSelect.options) {
                    if (option.value === departureLocation) {
                        option.selected = true;
                        break;
                    }
                }
            }
            
            // ÂèØËß∏ÁôºÊêúÂ∞ã
            if (flightNumber && departureDate && (depEl?.value || departureLocation) && bookingCodes) {
                                                  // ‚úÖ È°ØÁ§∫ loading Áï´Èù¢
                                                  const overlay = document.getElementById('loadingOverlay');
                                                  if (overlay) {
                                                  overlay.style.display = 'block';
                                                  document.body.style.overflow = 'hidden';
                                                  }
                                                  
                                                  // ‚úÖ Âü∑Ë°åÊêúÂ∞ã
                                                  doSearch();
                                                  }
                                                  });
                                                  
                                                  
                                                  function goToNextStep() {
                                                  const flightPrefix = document.getElementById('flightPrefix').value;
                                                  const flightNumber = document.getElementById('flightNumber_display').value;
                                                  const departureDate = document.getElementById('{!$Component.searchForm.departureDate}').value;
                                                  const departureLocation = document.querySelector('[id$="departureLocation"]').value;
                                                  const bookingCodes = document.getElementById('{!$Component.searchForm.bookingCodes}').value;
                                                  
                                                  if (!flightNumber || !departureDate || !departureLocation || !bookingCodes) {
                                                  alert('Ë´ãÂÖàÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç„ÄÇ');
                                                  return;
                                                  }
                                                  
                                                  // ÁµÑÂêàURL‰∏¶Ë∑≥ËΩâËá≥‰∏ã‰∏ÄÈ†Å
                                                  const params = new URLSearchParams({
                                                  flightPrefix,
                                                  flightNumber,
                                                  departureDate,
                                                  departureLocation,
                                                  bookingCodes
                                                  });
                                                  
                                                  window.location.href = '/apex/BoardingPassPrinting?' + params.toString();
                                                  }
                                                  
                                                  
                                                  let hasSearched = false;
                                                  
                                                  function prepareCheckin() {
                                                      const activePane =
                                                        document.querySelector('#resultTabContent .tab-pane.show.active') ||
                                                        document.querySelector('#resultTabContent .tab-pane.active');
                                                    if (!activePane) return;
                                                  const selectedCheckboxes = activePane.querySelectorAll('.rowCheckbox:checked');
                                                  if (selectedCheckboxes.length === 0) {
                                                  alert('Ë´ãÂÖàÂãæÈÅ∏ÊóÖÂÆ¢');
                                                  return;
                                                  }
                                                  
                                                  // ÂÑ≤Â≠òÁõÆÂâçÈÅ∏ÂèñÁöÑ rowÔºàËã•Êó•ÂæåÈúÄË¶ÅÂÇ≥ÂÄºÔºâ
                                                  window.selectedCheckinRows = Array.from(selectedCheckboxes).map(cb => cb.closest('tr'));
                                                  
                                                  // È°ØÁ§∫ modal
                                                  const modal = new bootstrap.Modal(document.getElementById('checkinConfirmModal'));
                                                  modal.show();
                                                  }
                                                  
                                                  /*function handleCheckin() {
        const selectedRows = window.selectedCheckinRows || [];
        
        // ÂèñÂæóÊØè‰ΩçÊóÖÂÆ¢ÂßìÂêç
        const passengers = selectedRows.map(row => {
            const lastName = row.querySelector('input[data-api="LastName__c"]')?.value || '';
            const firstName = row.querySelector('input[data-api="firstName__c"]')?.value || '';
            return `${lastName}/${firstName}`;
                                            });
        
        // üëâ ÁúüÊ≠£ÁöÑÂ†±Âà∞ÈÇèËºØÔºà‰Ω†ÂèØÊîπÁÇ∫ÂëºÂè´ Apex ÊàñÊõ¥Êñ∞ UIÔºâ
        console.log('‚úÖ Â∑≤Â†±Âà∞‰πòÂÆ¢Ôºö', passengers);
        
        // TODOÔºö‰Ω†ÂèØÂú®ÈÄôË£°ÂëºÂè´ Apex ÊàñÂà∑Êñ∞ UI
    }*/
                                                  
                                                  function handleCheckin() {
                                                  const selectedRows = window.selectedCheckinRows || [];
                                                  const ids = selectedRows
                                                  .map(row => row.dataset.id)
                                                  .filter(v => !!v);
                                                  
                                                  if (!ids.length) {
                                                  alert('Êú™ÈÅ∏Êìá‰ªª‰ΩïÊóÖÂÆ¢');
                                                  return;
                                                  }
                                                  
                                                  
                                                  // È°ØÁ§∫ loading ÈÅÆÁΩ©
                                                  document.getElementById('loadingOverlay').style.display = 'block';
                                                  document.body.style.overflow = 'hidden'; // Á¶ÅÊ≠¢ÊªæÂãï
                                                  window.needToRefresh = true; // Âú®ÂÖ®ÂüüË®òÈåÑÈúÄË¶ÅÂà∑Êñ∞
                                                  
                                                  doCheckIn(JSON.stringify(ids));
                                                  }
                                                  
                                                  
                                                  
                                                  document.addEventListener('DOMContentLoaded', function () {
                                                  var backBtn = document.getElementById('lastStep');
                                                  if (!backBtn) return;
                                                  
                                                  backBtn.addEventListener('click', function (e) {
                                                  // ‰∏çËÆì submit Ëß∏ÁôºÈ†êË®≠Êèê‰∫§
                                                  e.preventDefault();
                                                  
                                                  // ËÆÄÂèñÁõÆÂâçË°®ÂñÆÂÄº
                                                  var flightPrefix = document.getElementById('flightPrefix')?.value || '';
                                                  var flightNumber = document.getElementById('flightNumber_display')?.value || '';
                                                  var departureDate = document.getElementById('{!$Component.searchForm.departure}') 
                                                  ? document.getElementById('{!$Component.searchForm.departureDate}').value
                                                  : document.querySelector('[id$="departureDate"]')?.value || '';
                                                  // departureÔºàBoardingPassPrinting ÁöÑ select id Âè´ "departure"Ôºâ
                                                  var depEl = document.getElementById('{!$Component.searchForm.departure}') 
                                                  || document.querySelector('[id$="departure"]');
                                                  var departureLocation = depEl ? depEl.value : '';
                                                  
                                                  var bookingCodes = document.getElementById('{!$Component.searchForm.bookingCodes}') 
                ? document.getElementById('{!$Component.searchForm.bookingCodes}').value
                : document.querySelector('[id$="bookingCodes"]')?.value || '';
                
                // ÁµÑ QueryStringÔºàÊ≤øÁî® CheckIn ‚Üí BoardingPassPrinting ÁöÑ key ÂëΩÂêçÔºâ
                var params = new URLSearchParams({
                flightPrefix: flightPrefix,
                flightNumber: flightNumber,
                departureDate: departureDate,
                departureLocation: departureLocation,  // ÈóúÈçµÔºöÁî® departureLocation ÈÄôÂÄã key
                bookingCodes: bookingCodes
                });
            
            // Â∞éÂõû CheckIn
            window.location.href = '/apex/SeatSelection?' + params.toString();
        });
    // ÂàùÂßã disable ‰∏ä‰∏ÄÊ≠• & ‰∏ã‰∏ÄÊ≠•
    document.getElementById('lastStep').disabled = true;
    document.getElementById('nextStep1').disabled = true;
    
    const checkinBtn = document.getElementById('checkinBtn');
    
  window.updateCheckinButtonState = function(scope){
    const container = scope 
      || document.querySelector('.tab-pane.show.active') 
      || document;
    const anyChecked = !!container.querySelector('.rowCheckbox:checked');
    const btn = document.getElementById('checkinBtn');
    if (btn) btn.disabled = !anyChecked;
  };
    function updateCheckinButtonState(scope){
      return window.updateCheckinButtonState(scope);
    }
  // ÂàùÂßãÂåñÊôÇÂëºÂè´‰∏ÄÊ¨°
  window.updateCheckinButtonState();
    
    // Á∂ÅÂÆöÊâÄÊúâ checkbox ÁöÑËÆäÊõ¥‰∫ã‰ª∂
    document.addEventListener('change', function (e) {
        if (e.target.classList.contains('rowCheckbox')) {
            updateCheckinButtonState();
            
            const clickedCheckbox = e.target;
            const row = clickedCheckbox.closest('tr');
            if (!row) return;
            
            const nextRow = row.nextElementSibling;
            if (!nextRow) return;
            
            const nameCell = nextRow.querySelector('td:nth-child(3)');
            if (!nameCell) return;
            
            const isInf = nameCell.textContent.trim().startsWith('‚îî');
            if (!isInf) return;
            
            const infCheckbox = nextRow.querySelector('.rowCheckbox');
            if (infCheckbox) {
                infCheckbox.checked = clickedCheckbox.checked;
                console.log(`üçº Â¨∞ÂÖí checkbox Â∑≤ÂêåÊ≠•ÁÇ∫Ôºö${clickedCheckbox.checked}`);
            }
        }
    });
    
    // Â¶ÇÊûú selectAll checkbox ‰πüÈúÄË¶ÅÂΩ±ÈüøÊåâÈàïÁãÄÊÖã
    const selectAll = document.getElementById('selectAll');
    if (selectAll) {
        selectAll.addEventListener('change', updateCheckinButtonState);
    }
    });
    
    
    function toggleAllInTab(master){
      const pane = master.closest('.tab-pane') || document.querySelector('.tab-pane.show.active');
      if (!pane) return;
    
      const boxes = pane.querySelectorAll('.rowCheckbox');
      boxes.forEach(cb => {
        cb.checked = master.checked;
        // Ëß∏ÁôºÂéüÊú¨Á∂ÅÂú® .rowCheckbox ÁöÑ change ÈÇèËºØÔºàÂê´ INF ÈÄ£ÂãïÁ≠âÔºâ
        cb.dispatchEvent(new Event('change', { bubbles: true }));
      });
    
      // ÂêåÊ≠• INFÔºàËã•‰Ω†‰øùÁïôÈÄôÊÆµÈÇèËºØÔºâ
      syncInfCheckboxes(pane);
    
      // Á´ãÂç≥Êõ¥Êñ∞„ÄåÂ†±Âà∞„ÄçÊåâÈàïÁãÄÊÖã
      window.updateCheckinButtonState(pane);
    }
    
    function syncInfCheckboxes(scope){
      const rows = scope.querySelectorAll('tbody tr');
      for (let i = 1; i < rows.length; i++){
        const curr = rows[i], prev = rows[i-1];
        const nameCell = curr.querySelector('td:nth-child(3)');
        if (!nameCell) continue;
        const isInf = nameCell.textContent.trim().startsWith('‚îî');
        if (!isInf) continue;
    
        const infCb = curr.querySelector('.rowCheckbox');
        const adtCb = prev.querySelector('.rowCheckbox');
        if (infCb && adtCb) infCb.checked = adtCb.checked;
      }
    }

    
    let ascending = true;
    function sortTableByNumber(headerEl) {
        const table = headerEl.closest('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            const aText = a.querySelector('td[data-index]').textContent.trim();
            const bText = b.querySelector('td[data-index]').textContent.trim();
            const aNo = parseInt(aText, 10);
            const bNo = parseInt(bText, 10);
            return ascending ? aNo - bNo : bNo - aNo;
        });
        
        rows.forEach(row => tbody.appendChild(row));
        ascending = !ascending;
        headerEl.innerHTML = `No. ${ascending ? '‚Üë' : '‚Üì'}`;
    }
    
    
    //bookingCodesÂç°Êéß
    /*
    document.addEventListener('DOMContentLoaded', function () {
        const bookingInput = document.getElementById('{!$Component.searchForm.bookingCodes}');
        if (bookingInput) {
            bookingInput.setAttribute('maxlength', '50');
            
            bookingInput.addEventListener('input', function () {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9,]/g, '');
            });
        }
    });*/
    document.addEventListener('DOMContentLoaded', function () {
        const bookingInput = document.getElementById('{!$Component.searchForm.bookingCodes}');
        if (bookingInput) {
            bookingInput.setAttribute('maxlength', '50');
            
            let isComposing = false;
            
            bookingInput.addEventListener('compositionstart', function () {
                isComposing = true;
            });
            
            bookingInput.addEventListener('compositionend', function () {
                isComposing = false;
                // ÁµÑÂ≠óÁµêÊùüÂæåÂÜçÊ∏ÖÁêÜËº∏ÂÖ•
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9,]/g, '');
            });
            
            bookingInput.addEventListener('input', function () {
                if (isComposing) return; // ÁµÑÂ≠ó‰∏≠‰∏çËôïÁêÜ
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9,]/g, '');
            });
        }
    });
// ‚úÖ Áî®‰∫ã‰ª∂ÂßîÊ¥æÊñπÂºèËôïÁêÜ tab ÂàáÊèõÔºà‰∏çÁî®ÁÆ° VF ÈáçÁπ™ÂπæÊ¨°Ôºâ
document.addEventListener('shown.bs.tab', function (e) {
  const btn = e.target;
  if (!btn.matches('button[data-bs-toggle="tab"]')) return;

  // ‚ë† ÂàáÊèõÂàÜÈ†ÅÂ∞±ÂÖàÂº∑Âà∂ÈóúÈñâ„ÄåÂ†±Âà∞„ÄçÊåâÈàï
  const checkinBtn = document.getElementById('checkinBtn');
  if (checkinBtn) {
    checkinBtn.disabled = true;
  }

  // ‚ë° ÊâæÂà∞Êñ∞È°ØÁ§∫ÁöÑÈÇ£ÂÄã PNR pane
  const target = btn.getAttribute('data-bs-target');
  const pane =
    target
      ? document.querySelector(target)
      : document.querySelector('#resultTabContent .tab-pane.show.active');
  if (!pane) return;

  // ‚ë¢ Ê∏ÖÊéâË©≤ÂàÜÈ†ÅÊâÄÊúâ rowCheckbox ÂãæÈÅ∏
  pane.querySelectorAll('.rowCheckbox:checked').forEach(cb => {
    cb.checked = false;
  });

  // ‚ë£ headerCheckbox ‰∏ÄËµ∑Ê∏ÖÊéâ
  const headerCb = pane.querySelector('.headerCheckbox');
  if (headerCb) headerCb.checked = false;

  // ‚ë§ ÂÜçË∑ë‰∏ÄÊ¨°‰Ω†ÁöÑÂÖ±Áî®ÁãÄÊÖãÂà§Êñ∑Ôºà‰øùÈö™Ôºâ
  if (typeof window.updateCheckinButtonState === 'function') {
    window.updateCheckinButtonState(pane);
  }
});


    
    //Ëà™Áè≠ËôüÁ¢º
    function limitFlightInput(el) {
        let raw = el.value.toUpperCase().replace(/[^0-9A-Z]/g, ''); 
        raw = raw.slice(0, 5); 
        
        const match = raw.match(/^(\d*)([A-Z]*)$/);
        if (!match) {
            el.value = raw;
            return;
        }
        
        let numberPart = match[1];
        let letterPart = match[2];
        
        if (letterPart.length === 0) {
            numberPart = numberPart.slice(0, 4);
        } else {
            const maxDigits = 5 - letterPart.length;
            numberPart = numberPart.slice(0, maxDigits);
        }
        
        el.value = numberPart + letterPart;
    }
    
    
    function formatFlightNumber() {
        const displayEl = document.getElementById('flightNumber_display');
        const hiddenEl = document.getElementById('{!$Component.searchForm.flightNumber}');
        
        let raw = displayEl.value.trim().toUpperCase();
        const match = raw.match(/^(\d*)([A-Z]*)$/);
        
        if (!match) {
            hiddenEl.value = raw;
            displayEl.value = raw;
            return;
        }
        
        let numberPart = match[1];
        const letterPart = match[2];
        
        if (letterPart.length === 0) {
            // Á¥îÊï∏Â≠óÔºöË£ú 0 Âà∞ 4 Á¢º
            numberPart = numberPart.padStart(4, '0');
        } else {
            // Âê´Ëã±ÊñáÔºöË£ú 0 Âà∞Á∏ΩÈï∑ 5 Á¢º
            const padLength = 5 - letterPart.length;
            numberPart = numberPart.padStart(padLength, '0');
        }
        
        const formatted = numberPart + letterPart;
        
        displayEl.value = formatted;
        hiddenEl.value = raw;
    }
    
    
    document.addEventListener('DOMContentLoaded', function () {
        
        /* 1Ô∏è‚É£ ÂèñÂæóÊó•ÊúüËº∏ÂÖ•Ê°Ü */
        const dateEl = document.getElementById(
            '{!$Component.searchForm.departureDate}'
        );
        
        /* 2Ô∏è‚É£ ÁÆóÂá∫„Äå‰ªäÂ§© ‚Äì 4 Â§©„Äç */
        const today  = new Date();
        const minDay = new Date(today.getFullYear(),   
                                today.getMonth(),      
                                today.getDate() - 4);  
        
        /* 3Ô∏è‚É£ ËΩâÊàê yyyy-MM-dd Ê†ºÂºè (date input ÈúÄË¶Å) */
        const pad = n => n.toString().padStart(2, '0');
        const minStr = [
            minDay.getFullYear(),
            pad(minDay.getMonth() + 1),
            pad(minDay.getDate())
        ].join('-');
        
        /* 4Ô∏è‚É£ ÂØ´ÂÖ• min Â±¨ÊÄß */
        dateEl.setAttribute('min', minStr);
        
        /* 5Ô∏è‚É£ Ëã•Ê¨Ñ‰ΩçÈ†êË®≠ÂÄº < minÔºå‰πüÂêåÊ≠•Ë™øÊï¥ */
        if (dateEl.value && dateEl.value < minStr) {
            dateEl.value = minStr;
        }
    });
    
    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('table tbody tr');
        
        for (let i = 1; i < rows.length; i++) {
            const currRow = rows[i];
            const prevRow = rows[i - 1];
            
            const nameCell = currRow.querySelector('td:nth-child(3)');
            if (!nameCell) continue;
            
            // ÈÄèÈÅé„Äå‚îî„ÄçÂà§Êñ∑ÊòØÂê¶ÁÇ∫Â¨∞ÂÖí
            const isInf = nameCell.textContent.trim().startsWith('‚îî');
            if (!isInf) continue;
            
            const infCheckbox = currRow.querySelector('.rowCheckbox');
            const adtCheckbox = prevRow.querySelector('.rowCheckbox');
            
            if (infCheckbox && adtCheckbox) {
                // ÂàùÂßãÂêåÊ≠•ÁãÄÊÖã
                infCheckbox.checked = adtCheckbox.checked;
                
                // Êàê‰∫∫ÊóÖÂÆ¢ÂãæÈÅ∏ÊôÇÔºåÈÄ£ÂãïÂ¨∞ÂÖí
                adtCheckbox.addEventListener('change', function () {
                    infCheckbox.checked = this.checked;
                });
            }
        }
    });
    
    document.addEventListener('click', function(event) {
        // Â∞ãÊâæÊâÄÊúâ notification Èù¢ÊùøÔºàÂèØËÉΩÊúâÂ§öÂÄãÔºâ
        const notifications = document.querySelectorAll('.notification-panel');
        
        notifications.forEach(function(notification) {
            // Â¶ÇÊûúÈªûÊìäÁöÑ‰∏çÊòØ notification Ë£°Èù¢ÁöÑÊù±Ë•øÔºåÂ∞±ÈóúÈñâ
            if (!notification.contains(event.target)) {
                notification.style.display = 'none';
            }
        });
    });
    
    
    
    // Add style for the input fields
    const style = document.createElement('style');
    style.textContent = `
    .form-control-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.2rem;
        text-align: center;
    }
    
    .editable-field:disabled {
        background-color: rgba(248, 248, 248, 1) !important;
        border: 1px solid rgba(223, 220, 215, 1);
        padding: 0;
        margin: 0;
        height: auto;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        text-align: center;
    }
    
    td.text-center {
        text-align: center;
        vertical-align: middle;
    }
    
    td.text-center .form-control {
        margin: 0 auto;
    }
    `;
    document.head.appendChild(style);
    
    function clearFields(button) {
        const row = button.closest('tr');
        row.querySelectorAll('input.ClearItems, select.ClearItems').forEach(i=>{
            i.value = '';
        });
        }
            
            
            let originalValues = {};
            const lastStepBtn = document.getElementById('lastStep');
            const nextStepBtn = document.getElementById('nextStep1');
            const submitButton = document.getElementById('submitButton');
            
            function showTabs() {
            const msgs        = document.getElementById('{!$Component.msgs}');
            const successTip  = document.getElementById('{!$Component.SearchSuccessPanel}');
            const errorTip    = document.getElementById('{!$Component.SearchErrorPanel}');
            const tabResults  = document.getElementById('tabResults');
            const searchResults = document.getElementById('searchResults');
            const fixedBtns   = document.getElementById('fixedBottomButtons');
            const searchPrompt = document.getElementById('searchPrompt');
            
            const shouldFlashCheckin = !!window.flashCheckinSuccess;
            if (shouldFlashCheckin) window.flashCheckinSuccess = false;
            
            const errorMessage = errorTip.textContent.trim()
            .split('//<![CDATA[')[0].split('/*<![CDATA[')[0].trim();
            const hasErrorText = !(errorMessage === null) && !(errorMessage.trim().length === 0);
            
            if (hasErrorText) {
            // --- ÊúâÈåØË™§ ---
            if (errorMessage.startsWith('Êü•ÁÑ°ÈÉ®ÂàÜPNR')) {
            // ÊúâË≥áÊñô‰ΩÜÈÉ®ÂàÜÁº∫ÔºàÂçäÊàêÂäüÔºâ
            searchPrompt.style.display   = 'none';
            tabResults.style.display     = 'block';
            searchResults.style.display  = 'block';
            fixedBtns.style.display      = 'flex';
            errorTip.style.display       = 'block';
            
            // ‚úÖ ‰øÆÊîπËôïÔºöÈÉ®ÂàÜÊàêÂäü‰∏çÈ°ØÁ§∫‰ªª‰ΩïÊàêÂäü toast
            if (successTip) successTip.style.display = 'none';
            const okPanel = document.querySelector('[id$=editSuccessPanel]');
            if (okPanel) okPanel.style.display = 'none';
            
        } else {
            // Á¥îÈåØË™§ÔºöÂè™È°ØÁ§∫ÈåØË™§Ôºå‰∏çÈ°ØÁ§∫‰ªª‰ΩïÊàêÂäüÊèêÁ§∫
            searchPrompt.style.display   = '';
            searchPrompt.textContent     = 'Êü•Ë©¢ÁÑ°ÁµêÊûú';
            tabResults.style.display     = 'none';
            searchResults.style.display  = 'none';
            fixedBtns.style.display      = 'none';
            if (successTip) successTip.style.display = 'none';
            errorTip.style.display       = 'block';
        }
        } else {
            // --- Ê≠£Â∏∏ÊàêÂäü ---
            searchPrompt.style.display   = 'none';
            tabResults.style.display     = 'block';
            searchResults.style.display  = 'block';
            fixedBtns.style.display      = 'flex';
            errorTip.style.display       = 'none';
            
            if (shouldFlashCheckin) {
            // Â†±Âà∞ÊÉÖÂ¢ÉÔºöÂè™È°ØÁ§∫„ÄåÂ†±Âà∞ÊàêÂäü„Äç
            if (successTip) successTip.style.display = 'none';
            const okPanel = document.querySelector('[id$=editSuccessPanel]');
            if (okPanel) {
            okPanel.style.display = 'block';
            setTimeout(() => { okPanel.style.display = 'none'; }, 2000);
        }
        } else {
            // ‰∏ÄËà¨ÊêúÂ∞ãÔºöÈ°ØÁ§∫„ÄåÊêúÂ∞ãÊàêÂäü„Äç
            if (successTip) {
            successTip.style.display = 'block';
            setTimeout(() => { successTip.style.display = 'none'; }, 2000);
        }
        }
            
            document.getElementById('lastStep').disabled = false;
            document.getElementById('nextStep1').disabled = false;
        }
            
            document.getElementById('loadingOverlay').style.display = 'none';
            refreshPageUI();
            updateCheckinButtonState();
        }
            
            (function() {
            var sidebar = document.getElementById('sidebar');
            if (sidebar) {
            sidebar.classList.add('hidden');
            sidebar.classList.remove('normal');
        }
        })();            
            function adjustContentWrapper() {
            var sidebar = document.getElementById('sidebar');
            var contentWrapper = document.getElementById('content-wrapper');
            var fixedBottomButtons = document.getElementById('fixedBottomButtons');
            
            // ÂèñÂæó sidebar ÁöÑÁï∂ÂâçÊ®£Âºè
            var sidebarStyle = window.getComputedStyle(sidebar);
            var transformValue = sidebarStyle.getPropertyValue('transform');
            
            // Ê™¢Êü• sidebar ÊòØÂê¶Êúâ 'hidden' class Êàñ 'normal' class
            if (sidebar.classList.contains('hidden') && window.innerWidth >= 1025) {
            contentWrapper.style.paddingLeft = '0';
            fixedBottomButtons.style.paddingLeft = '0';
        } else if (sidebar.classList.contains('hidden') && window.innerWidth < 1025) {
            contentWrapper.style.paddingLeft = '0';
            fixedBottomButtons.style.paddingLeft = '0';
        }
            
            if (sidebar.classList.contains('normal') && window.innerWidth >= 1025) {
            contentWrapper.style.paddingLeft = '250px';
            contentWrapper.style.transition = 'padding-left 0.3s ease-in-out';
            fixedBottomButtons.style.paddingLeft = '250px';
            fixedBottomButtons.style.transition = 'padding-left 0.3s ease-in-out';
        } else if (sidebar.classList.contains('normal') && window.innerWidth < 1025) {
            contentWrapper.style.paddingLeft = '0';
            fixedBottomButtons.style.paddingLeft = '0';
        }
        }
            
            // Áõ£ËÅΩ sidebar ÁöÑ class ËÆäÂåñ
            var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
            if (mutation.type === "attributes" && mutation.attributeName === "class") {
            adjustContentWrapper();
        }
        });
        });
            
            // Áï∂ DOM ÂÖßÂÆπÂä†ËºâÂÆåÊàêÂæåÂü∑Ë°å
            document.addEventListener('DOMContentLoaded', function() {
            var sidebar = document.getElementById('sidebar');
            observer.observe(sidebar, {
            attributes: true
        });
        
        // ÂàùÂßãË™øÁî® adjustContentWrapper
        adjustContentWrapper();
    });
    
    // ÂêåÊôÇÁõ£ËÅΩ window resize ‰∫ã‰ª∂ÔºåËÆìÁï´Èù¢Á∏ÆÂ∞èÂæå‰πüËÉΩÊ≠£Á¢∫Ë™øÊï¥
    window.addEventListener('resize', adjustContentWrapper);
    
    //Ê∏ÖÈô§ÈçµÊääÊù±Ë•øÈÉΩÊ∏ÖÈô§
    document.addEventListener('DOMContentLoaded', function() {
        const btnClear = document.getElementById('clearButton');
        btnClear.addEventListener('click', function() {
            doReset(); 
            // ÊãøÂà∞ VF ÁúüÊ≠£Áî¢ÁîüÁöÑ input id
            
            const idFlightNum = '{!$Component.searchForm.flightNumber}';
            const idDepart    = '{!$Component.searchForm.departureDate}';
            const idBooking   = '{!$Component.searchForm.bookingCodes}';
            
            // 1. Ê∏ÖÁ©∫Ê¨Ñ‰ΩçÂÄº
            document.getElementById('flightNumber_display').value = '';
            document.getElementById(idFlightNum).value = '';
            document.getElementById(idDepart).value    = '';
            document.getElementById(idBooking).value   = '';
            
            // 2. ÁßªÈô§ÊâÄÊúâÈ©óË≠âÊ®£Âºè & Ë®äÊÅØ
            document.querySelectorAll('#flightSearchForm .required-field').forEach(field => {
                field.classList.remove('is-invalid');
                const fb = field.parentElement.querySelector('.invalid-feedback');
                if (fb) fb.remove();
            });
                
                // 3. ÈÇÑÂéü‰ªãÈù¢È°ØÁ§∫
                document.getElementById('outerWrapper').style.marginBottom   = '0';
                document.getElementById('fixedBottomButtons').style.display  = 'none';
                document.getElementById('searchResults').style.display      = 'none';
                //document.getElementById('searchPrompt').style.display       = 'block';
                document.getElementById('searchPrompt').textContent         = 'Ë´ãÊêúÂ∞ãË≥áÊñô';
                document.getElementById('tabResults').style.display         = 'none';
                
                hasSearched = false;
            });
            });
                
                
                function validateSearch () {
                
                const fields = document.querySelectorAll('#flightSearchForm .required-field');
                let ok = true;
                
                fields.forEach(field => {
                field.classList.remove('is-invalid');
                const old = field.parentElement.querySelector('.invalid-feedback');
                if (old) old.remove();
                
                if (!field.value.trim()) {
                ok = false;
                field.classList.add('is-invalid');
                
                const div = document.createElement('div');
                div.className = 'invalid-feedback w-100';
                div.textContent = 'ÂøÖÂ°´';
                field.insertAdjacentElement('afterend', div);
            }
            });
                
                if (ok) {
                // È°ØÁ§∫ loading ÈÅÆÁΩ©
                document.getElementById('loadingOverlay').style.display = 'block';
                document.body.style.overflow = 'hidden';  // Á¶ÅÊ≠¢ÊªæÂãï
                
                // È©óË≠âÈÄöÈÅé ‚Üí Ëß∏ÁôºÈö±ËóèÁöÑ commandButton
                doSearch();
            }
            }
                
                function afterSaveSuccess() {
                console.log('‚úÖ ÂÑ≤Â≠òÂÆåÊàêÔºåÈñãÂßãËôïÁêÜÂæåÁ∫å UI');
                
                if (window.needToRefresh) {
                // ‚úÖ ÂëäË®¥‰∏ã‰∏ÄÊ≠•ÔºàshowTabsÔºâÈÄôÊ¨°ÊòØÂ†±Âà∞ÊàêÂäüÂæåÁöÑÈáçÊñ∞Êï¥ÁêÜ
                window.flashCheckinSuccess = true;
                window.needToRefresh = false;
                doSearch();  // ÂÜçÊíàÊúÄÊñ∞Ë≥áÊñô
                return;
            }
                
                // ‚úÖ Èö±Ëóè loading
                document.getElementById('loadingOverlay').style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // ‚úÖ È°ØÁ§∫ÂÑ≤Â≠òÊàêÂäüÊèêÁ§∫
                const okPanel = document.querySelector('[id$=editSuccessPanel]');
                if (okPanel) {
                okPanel.style.display = 'block';
                setTimeout(() => {
                okPanel.style.display = 'none';
            }, 2000);
            }
                
                // ‚úÖ È°ØÁ§∫ÊêúÂ∞ãÁµêÊûúÁï´Èù¢ÔºàÁïôÂú®ÁõÆÂâçÈ†ÅÈù¢Ôºâ
                showTabs(); // ‚Üê ‰Ω†Â∑≤ÂÆöÁæ©ÁöÑÂáΩÂºèÔºåÊúÉÈ°ØÁ§∫ tabResults„ÄÅsearchResults
                
            }
                
                
                
                
                </script>
    <script>
    (function () {
        // Áõ¥Êé•Áî® getElementByIdÔºåÈÅøÂÖç selector ÈúÄË¶ÅÂÜíËôüËΩâÁæ©ÁöÑÂïèÈ°å
        var fieldId = '{!$Component.searchForm:departureDate}';
        
        function isMobileLike() {
            try {
                if (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) return true;
            } catch (e) {}
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        function supportsNativeDate() {
            var i = document.createElement('input');
            i.setAttribute('type', 'date');
            return i.type === 'date' && ('valueAsDate' in i);
        }
        
        function initDateField() {
            var el = document.getElementById(fieldId);
            if (!el) return;
            
            // ÈÅøÂÖçÈáçË§áÂàùÂßãÂåñ
            if (el._flatpickr) { el._flatpickr.destroy(); }
            
            var mobile = isMobileLike();
            
            if (mobile) {
                // ÊâãÊ©üÔºöÂº∑Âà∂Áî® flatpickrÔºàÈÅøÂÖçÂéüÁîüËàáÂ•ó‰ª∂ÂêåÊôÇÂá∫ÁèæÔºâ
                el.setAttribute('type', 'text');
                if (window.flatpickr) {
                    flatpickr(el, {
                        dateFormat: 'Y-m-d',
                        allowInput: false,
                        clickOpens: true,
                        disableMobile: true,  // ÈóúÈçµÔºöË°åÂãïË£ùÁΩÆ‰πüÂè™È°ØÁ§∫ flatpickrÔºåËÄåÈùûÂéüÁîü
                        minDate: new Date().fp_incr(-4) 
                    });
                }
            } else {
                // Ê°åÊ©üÔºöÂÑ™ÂÖàÂéüÁîüÔºõËã•ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÔºåÂÜçÈÄÄÂõû flatpickr
                if (supportsNativeDate()) {
                    el.setAttribute('type', 'date'); // Âè™Áî®ÂéüÁîüÔºå‰∏çÂàùÂßãÂåñ flatpickr
                } else {
                    el.setAttribute('type', 'text');
                    if (window.flatpickr) {
                        flatpickr(el, {
                            dateFormat: 'Y-m-d',
                            allowInput: false,
                            clickOpens: true,
                            disableMobile: true
                        });
                    }
                }
            }
        }
        
        // ÂàùÊ¨°ËºâÂÖ•
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDateField);
        } else {
            initDateField();
        }
        window.addEventListener('load', initDateField);
        
        // VF/JSF Â±ÄÈÉ®ÈáçÁπ™ÂæåÈáçÊéõ
        // 1) ÂéüÁîü JSF AJAXÔºàËã•È†ÅÈù¢ÊúâÁî®Ôºâ
        if (window.jsf && jsf.ajax && jsf.ajax.addOnEvent) {
            jsf.ajax.addOnEvent(function(data){
                if (data && data.status === 'success') initDateField();
            });
        }
        // 2) jQuery AJAXÔºàËã•ÊúâÔºâ
        if (window.jQuery) {
            jQuery(document).on('ajaxComplete', initDateField);
        }
        // 3) ËÆì apex:commandButton/commandLink ÂèØÂú® oncomplete ÂëºÂè´
        window.initDateField = initDateField;
    })();
    </script>
</apex:page>