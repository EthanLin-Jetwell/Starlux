<apex:page controller="EditTravelerController"  docType="html-5.0" applyHtmlTag="true" standardStylesheets="false" showHeader="false">
    <head>
        <title>EditTraveler</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
        <c:styleinclude ></c:styleinclude>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
        <link
              rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
              />
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        
        <link rel="stylesheet" href="{!$Resource.B2BStyle}" />
        <!-- Select2 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        
        <!-- jQuery (ÂøÖË¶Å) -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        
        <!-- Select2 JS -->
            <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        
        <style>
            
            .form-select.is-invalid:not([multiple]):not([size]), .form-select.is-invalid:not([multiple])[size="1"], .was-validated .form-select:invalid:not([multiple]):not([size]), .was-validated .form-select:invalid:not([multiple])[size="1"] {
            /* --bs-form-select-bg-icon: url(data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e); */
            padding-right: 0.25rem;
            background-position: right .75rem center, center right 2.25rem;
            background-size: 16px 12px, calc(.75em + .375rem) calc(.75em + .375rem);
            color: #626466;
            }
            
            /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Èö±ËóèË¢´ÂÅúÁî®Ê¨Ñ‰ΩçÁöÑ placeholder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
            input:disabled::placeholder {          /* Ê®ôÊ∫ñÂØ´Ê≥ï */
            color: transparent !important;
            opacity: 0 !important;
            }
            
            /* WebKit ËàäÂØ´Ê≥ïÔºàÈÉ®ÂàÜ SafariÔºèËàä Chrome ‰ªçÊúÉÁî®Âà∞Ôºâ*/
            input:disabled::-webkit-input-placeholder {
            color: transparent !important;
            opacity: 0 !important;
            }
            
            /* Edge / IE ÂÖºÂÆπÔºàIE Âè™Âà∞ 11Ôºå‰ΩÜ‰øùÈö™Ëµ∑Ë¶ãÔºâ*/
            input:disabled::-ms-input-placeholder {
            color: transparent !important;
            opacity: 0 !important;
            }
            
            /* È†êË®≠ÊÉÖÊ≥ÅÔºöÊâÄÊúâ disabled ÁöÑ date input ÈÉΩÈö±ËóèÂÄº */
            input[type="date"]:disabled {
            color: transparent !important;
            -webkit-text-fill-color: transparent !important;
            opacity: 1;
            }
            
            /* ÊúâÂÄºÁöÑÊôÇÂÄôË¶ÅÈ°ØÁ§∫ÔºàÈù† JS Âä†‰∏ä always-visibleÔºâ */
            input[type="date"].always-visible:disabled {
            color: inherit !important;
            -webkit-text-fill-color: initial !important;
            opacity: 1;
            }
            
            /* Èö±ËóèÂéüÁîüÊåâÈàï */
            input[type="date"]:disabled:not(.always-visible)::-webkit-clear-button,
            input[type="date"]:disabled:not(.always-visible)::-webkit-calendar-picker-indicator {
            display: none !important;
            }
            /* ÁßªÈô§ select È©óË≠âÁ¥ÖËâ≤ iconÔºàChrome/Bootstrap 5Ôºâ */
            select.form-select.is-invalid {
            background-image: var(--bs-form-select-bg-img), none !important;
            }
            
            .input-wrapper {
            position: relative;
            display: inline-block;
            }
            
            #searchResults {
            max-height: unset;
            overflow: unset;
            }
            
            #searchResults .tab-content {
            max-height: calc(100vh - 53vh); /* ÈÅøÂÖçË∂ÖÂá∫Áï´Èù¢È´òÂ∫¶ÔºåÂèØ‰æùÈúÄÊ±ÇÂæÆË™ø */
            overflow: scroll;
            white-space: nowrap; /* Ê∞¥Âπ≥Êç≤Ëª∏ÂøÖË¶ÅË®≠ÂÆö */
            }
            
            
            .table-responsive {
            overflow: unset !important;
            }
            
            table {
            white-space: nowrap;
            }
            
            /* Mobile responsive styles for accordion layout */
            @media (max-width: 768px) {
            /* Hide table on mobile */
            .table-responsive {
            display: none !important;
            }
            
            .section-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #495057;
            font-size: 0.9rem;
            text-transform: uppercase;
            }
            
            .section-header {
            padding: 0.5rem 0;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 0.75rem;
            }
            
            .section-header .section-title {
            font-weight: bold;
            color: #495057;
            font-size: 1rem;
            }
            
            .clear-document-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            }
            
            /* Only show clear buttons in edit mode */
            .clear-document-btn.d-none {
            display: none !important;
            }
            
            /* Show clear buttons when in edit mode */
            .editing .clear-document-btn {
            display: inline-block !important;
            }
            
            /* Hide accordion items for unselected passengers */
            .passenger-accordion.passenger-hidden {
            display: none !important;
            }
            
            .info-divider {
            width: 100%;
            height: 2px;
            background-color: #8E7248;
            margin: 2rem 0;
            }
            
            .accordion-button:not(.collapsed) {
            color: #212529; /* Or your preferred text color */
            background-color: transparent; /* Or #fff if your accordion background is white */
            box-shadow: none; /* Removes the inner border */
            }
            
            /* 2. Override the blue 'glow' (box-shadow) when the button is focused */
            .accordion-button:focus {
            box-shadow: none;
            border-color: rgba(0,0,0,.125); /* Optional: reset border color */
            }
            
            }
            
            /* Desktop styles - hide accordion */
            @media (min-width: 769px) {
            .mobile-accordion {
            display: none !important;
            }
            }
            /* È†êË®≠ÔºöÈö±ËóèÊâÄÊúâÊ∏ÖÈô§/‰ΩèÂùÄ/ÂúòÁ∞ΩÊåâÈàï */
            .clear-document-btn.d-none,
            .USaddressbtn.d-none,
            .groupVisaBtn.d-none {
            display: none !important;
            }
            
            /* Á∑®ËºØÊ®°Âºè‰∏ãÔºöÈ°ØÁ§∫ */
            .editing .clear-document-btn,
            .editing .USaddressbtn,
            .editing .groupVisaBtn {
            display: inline-flex !important;
            }
            
            
        </style>
    </head>
    <body class="d-flex py-4">
        <c:B2BNavbar ></c:B2BNavbar>
        <apex:outputPanel id="SearchSuccessPanel" style="display:none">
            <c:successNotification message="ÊêúÂ∞ãÊàêÂäü"/>
        </apex:outputPanel>
        <apex:outputPanel id="SearchErrorPanel" style="display:none">
            <c:FailNotification message="{!errorMessage}"/>
        </apex:outputPanel>
        <apex:outputPanel id="editSuccessPanel" style="display:none">
            <c:successNotification message="ÂÑ≤Â≠òÊàêÂäü"/>
        </apex:outputPanel>
        
        <div class="content-wrapper" id="content-wrapper">
            <div class="container-fluid">
                <apex:form id="searchForm">
                    <!--<apex:pageMessages id="msgs"/>-->
                    <apex:actionFunction name="saveTravelerUpdates"
                                         action="{!save}"
                                         rerender="editSuccessPanel"
                                         >
                        <apex:param name="jsonData" assignTo="{!jsonInput}" value=""/>
                    </apex:actionFunction>
                    <apex:actionFunction name="goToNextPage" action="{!nextPage}" rerender="resultsBlock"/>
                    <apex:actionFunction name="goToPrevPage" action="{!prevPage}" rerender="resultsBlock"/>
                    <apex:actionFunction name="doReset" action="{!reset}" rerender="resultsBlock,SearchSuccessPanel,SearchErrorPanel"/>
                    <apex:actionFunction name="switchTabAF" rerender="pnrCountPanel,resultTabContent">
                        <apex:param name="newKey" assignTo="{!currentTabKey}" value=""/>
                    </apex:actionFunction>
                    <div id="flightSearchForm" class="row g-3">
                        <!-- Ëà™Áè≠ËôüÁ¢º -->
                        <div class="col-md-3">
                            <label class="form-label">Ëà™Áè≠ËôüÁ¢º*</label>
                            <div class="d-flex">
                                <!-- Â∑¶ÈÇäÁöÑ Prefix+dash -->
                                <div class="input-group me-2" style="width: 40%;">
                                    <input
                                           id="flightPrefix"
                                           class="form-control"
                                           value="{!flightPrefix}"
                                           disabled="true"
                                           style="height: 38px; border-radius: 2px;"/>
                                    <span class="input-group-text" style="border:none;background:none; height: 38px;">-</span>
                                </div>
                                <!-- Âè≥ÈÇäÁöÑËº∏ÂÖ•Ê°Ü -->
                                <div class="input-group" style="flex:1">
                                    <!-- È°ØÁ§∫Áî®Ëº∏ÂÖ•Ê°Ü -->
                                    <input type="text"
                                           id="flightNumber_display"
                                           class="form-control required-field"
                                           placeholder="Ë´ãËº∏ÂÖ•"
                                           oninput="limitFlightInput(this)"
                                           onblur="formatFlightNumber()"/>
                                    
                                    <!-- ÂØ¶ÈöõÈÄÅÂá∫Ê¨Ñ‰Ωç -->
                                    <apex:inputHidden value="{!flightNumber}" id="flightNumber" />
                                </div>
                                
                                
                            </div>
                            <div class="invalid-feedback w-100 ps-4">
                                ÂøÖÂ°´
                            </div>
                        </div>
                        
                        
                        <!-- Ëµ∑È£õÊó•Êúü -->
                        <div class="col-md-2">
                            <label class="form-label">Ëµ∑È£õÊó•Êúü*</label>
                            <div class="input-group">
                                <apex:inputText value="{!departureDateStr}"
                                                id="departureDate"
                                                styleClass="form-control required-field always-visible"
                                                html-placeholder="Ë´ãÈÅ∏Êìá"
                                                onfocus="this.type='date'; this.showPicker && this.showPicker();"
                                                onblur="if(!this.value) this.type='text';"
                                                />
                            </div>
                            <div class="invalid-feedback w-100">ÂøÖÂ°´</div>
                        </div>
                        
                        
                        
                        <!-- Ëµ∑È£õÂú∞ -->
                        <div class="col-md-1">
                            <label class="form-label">Ëµ∑È£õÂú∞*</label>
                            
                            <apex:selectList id="departureLocation"
                                             value="{!departureLocation}"
                                             size="1"
                                             styleClass="form-select required-field"
                                             style="border-radius: 2px;">
                                <apex:selectOptions value="{!originOptions}" />
                            </apex:selectList>
                            
                            <div class="invalid-feedback">ÂøÖÂ°´</div>
                        </div>
                        
                        
                        <!-- Ë®Ç‰Ωç‰ª£Ëôü -->
                        <div class="col-md-4">
                            <label class="form-label">Ë®Ç‰Ωç‰ª£Ëôü*</label>
                            
                            <apex:inputText value="{!bookingCodes}"
                                            id="bookingCodes"
                                            styleClass="form-control required-field"
                                            html-placeholder="Ë´ãËº∏ÂÖ•"/>
                            
                            <div class="invalid-feedback w-100">ÂøÖÂ°´</div>
                        </div>
                        
                        
                        <!-- ÊåâÈàï -->
                        
                        <div class="col-md-2 d-flex justify-content-end" style="align-items: anchor-center;">
                            <button id="clearButton" type="button"
                                    class="btn me-2"
                                    style="height:48px;width:80px;color:#8E7248;background:#fff;">
                                Ê∏ÖÈô§
                            </button>
                            <apex:actionFunction name="doSearch" action="{!searchPnr}"
                                                 rerender="resultsBlock,msgs,SearchSuccessPanel,SearchErrorPanel"
                                                 oncomplete="showTabs();" />
                            
                            <button id="validateBtn" type="button"
                                    class="btn"
                                    style="height:48px;width:80px;background:#8E7248;color:#fff;"
                                    onclick="validateSearch();">
                                ÊêúÂ∞ã
                            </button>
                            
                        </div>
                    </div>
                </apex:form>
                
                <!-- ======== ÁµêÊûúÂçÄ (reRender ÁõÆÊ®ô) ======== -->
                <apex:outputPanel id="resultsBlock" layout="block" style="height:88%;">
                    
                    <!-- ‚ñº‚ñº‚ñº [Append-Only] ËøΩÂä†ÔºöÈÅ∏ÂèñÊóÖÂÆ¢ÁöÑ Modal -->
                    <div class="modal fade" id="selectPassengersModal" tabindex="-1" aria-labelledby="selectPassengersModalLabel" aria-hidden="true">
                        <div class="modal-dialog" style="max-width:560px">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="selectPassengersModalLabel" style="font-weight:bold">ÈÅ∏ÂèñÊóÖÂÆ¢ÔºàPNRÔºö<span id="spm-pnr"></span>Ôºâ</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ÈóúÈñâ"></button>
                                </div>
                                <div class="modal-body" style="max-height:60vh;overflow:auto;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="spm-select-all">ÂÖ®ÈÅ∏</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="spm-clear-all">ÂÖ®‰∏çÈÅ∏</button>
                                        </div>
                                        <small class="text-muted">ÈªûÊï¥Âàó‰∫¶ÂèØÈÅ∏Âèñ</small>
                                    </div>
                                    <div id="spm-list" class="list-group"></div>
                                </div>
                                <div class="modal-footer" style="background:#fafafa;border:none">
                                    <button type="button" class="btn" data-bs-dismiss="modal" style="width:73px;height:40px;background:#fff;color:#8E7248;border:none">ÂèñÊ∂à</button>
                                    <button type="button" class="btn" id="spm-apply" style="width:96px;height:40px;background:#8E7248;color:#fff;border-radius:4px">Á¢∫Ë™ç</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ ËøΩÂä†ÁµêÊùü -->
                    
                    
                    
                    <!-- Tabs (Âè™ÊúâÊêúÂ∞ãÂæåÊâçÈ°ØÁ§∫) -->
                    <div class="mt-4" id="tabResults"
                         style="{!IF(ISBLANK(currentTabKey),'display:none;','')}">
                        <ul class="nav nav-tabs" role="tablist" style="border: none;">
                            <apex:repeat value="{!pnrKeys}" var="pnr">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link {!IF(pnr==currentTabKey,'active','')}"
                                            data-bs-toggle="tab"
                                            data-bs-target="#tab{!pnr}"
                                            type="button" role="tab"
                                            style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); margin-right: 4px; border-radius: 0.375rem;"
                                            onclick="switchTabAF('{!JSENCODE(pnr)}');">
                                        {!pnr}
                                    </button>
                                </li>
                            </apex:repeat>
                        </ul>
                    </div>
                    
                    
                    <!-- ÁæéÂúãÂú∞ÂùÄ Modal -->
                    <div class="modal fade" id="usAddressModal" tabindex="-1" aria-labelledby="usAddressModalLabel" aria-hidden="true">
                        <div class="modal-dialog" style="">
                            <div class="modal-content" style="max-width:500px;overflow:scroll">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="usAddressModalLabel" style="font-weight:bold">Âú∞ÂùÄ</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="address" class="form-label">Ë°óÈÅì*</label>
                                        <!--<input type="text" class="form-control" id="address" placeholder="Ë´ãËº∏ÂÖ•"/>-->
                                        <input type="text" class="form-control" id="address" placeholder="Ë´ãËº∏ÂÖ•"
                                               data-api="USAStreet__c"
                                               oninput="cleanPassportInput(this)"
                                               />
                                    </div>
                                    <div class="mb-3">
                                        <label for="city" class="form-label">ÂüéÂ∏Ç*</label>
                                        <!--<input type="text" class="form-control" id="city" placeholder="Ë´ãËº∏ÂÖ•"/>-->
                                        <input type="text" class="form-control" id="city" placeholder="Ë´ãËº∏ÂÖ•" data-api="UScity__c"
                                               oninput="cleanPassportInput(this)"
                                               />
                                    </div>
                                    <div class="mb-3">
                                        <label for="state" class="form-label">Â∑û/ÁúÅ*</label>
                                        <!--<input type="text" class="form-control" id="state" placeholder="Ë´ãËº∏ÂÖ•"/>-->
                                        <!--<select class="form-control us-state-select"
id="state"
data-api="USstate__c">
<option value="">Ë´ãÈÅ∏Êìá</option>
<apex:repeat value="{!USStateOptions}" var="opt">
<option value="{!opt.value}">{!opt.label}</option>
</apex:repeat>
</select>-->
                                        <select class="form-select form-select-sm editable-field"
                                                id="state"
                                                data-api="USstate__c"
                                                style="width: 100%; height: 38px;">
                                            <option value="" placeholder="Ë´ãÈÅ∏Êìá">Ë´ãÈÅ∏Êìá</option>
                                            <apex:repeat value="{!USStateOptions}" var="opt">
                                                <option value="{!opt.value}">{!opt.label}</option>
                                            </apex:repeat>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="postalCode" class="form-label">ÈÉµÈÅûÂçÄËôü*</label>
                                        <!--<input type="text" class="form-control" id="postalCode" placeholder="Ë´ãËº∏ÂÖ•"/>-->
                                        <input maxlength="5" type="text" class="form-control" id="postalCode" placeholder="Ë´ãËº∏ÂÖ•" data-api="USpostalcode__c"
                                               oninput="cleanPassportInput(this)"
                                               />
                                    </div>
                                    <div class="mb-3">
                                        <label for="emergencyContact" class="form-label">Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂßìÂêç*</label>
                                        <!--<input type="text" class="form-control" id="emergencyContact" placeholder="Ë´ãËº∏ÂÖ•"/>-->
                                        <input type="text" class="form-control" id="emergencyContact" placeholder="Ë´ãËº∏ÂÖ•" data-api="UScontact__c"
                                               oninput="cleanPassportInput(this)"
                                               />
                                    </div>
                                    <div class="mb-3">
                                        <label for="emergencyNationality" class="form-label">Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂúãÁ±ç*</label>
                                        <!--<input type="text" class="form-control" id="emergencyNationality" placeholder="Ë´ãËº∏ÂÖ•"/>-->
                                        <input type="text" class="form-control" id="emergencyNationality" placeholder="Ë´ãËº∏ÂÖ•" data-api="UScontactNationality__c"
                                               oninput="cleanPassportInput(this)"
                                               />
                                    </div>
                                    <div class="mb-3">
                                        <label for="phone" class="form-label">Á∑äÊÄ•ËÅØÁµ°‰∫∫ÈõªË©±*</label>
                                        <!--<input type="text" class="form-control" id="phone" placeholder="Ë´ãËº∏ÂÖ•"/>-->
                                        <input type="text" class="form-control" id="phone" placeholder="Ë´ãËº∏ÂÖ•" data-api="UScontactphone__c"
                                               oninput="cleanPassportInput(this)"
                                               />
                                    </div>
                                </div>
                                <div class="modal-footer" style="background-color:rgba(250, 250, 250, 1);border:none">
                                    <button type="button" class="btn" data-bs-dismiss="modal" style="width:73px;height:48px;background-color:rgba(250, 250, 250, 1);color:rgba(142, 114, 72, 1);border:none">ÂèñÊ∂à</button>
                                    <button type="button" class="btn" onclick="saveUSAddress()" style="width:73px;height:48px;background-color:rgba(142, 114, 72, 1);color:white;border-radius:4px">ÂÑ≤Â≠ò</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!--ÂúòÈ´îÁ∞ΩË≠â Modal -->
                    <div class="modal fade" id="groupVisaModal" tabindex="-1" aria-labelledby="groupVisaModalLabel" aria-hidden="true">
                        <div class="modal-dialog" style="max-width: 500px; height: 416px;top: 50%; left: 50%; transform: translate(-50%, -50%); margin: 0;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="groupVisaModalLabel" style="font-weight:bold">ÂúòÁ∞Ω</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="applicant" class="form-label">Ë≠â‰ª∂ËôüÁ¢º*</label>
                                        <input type="text" class="form-control" id="applicant" placeholder="Ë´ãËº∏ÂÖ•" data-api="applicant"
                                               oninput="cleanVisaInput(this, 'applicant')"
                                               />
                                        
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="visaDate" class="form-label">Âà∞ÊúüÊó•*</label>
                                        <input type="text"
                                               class="form-control"
                                               id="visaDate"
                                               placeholder="Ë´ãÈÅ∏Êìá"
                                               onfocus="this.type='date'; 
                                                        const dep = document.getElementById('{!$Component.searchForm.departureDate}');
                                                        if (dep && dep.value) this.min = dep.value;
                                                        this.showPicker && this.showPicker();
                                                        "
                                               onblur="if (!this.value) this.type='text';"/>
                                        
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="visaCountry" class="form-label">ÁôºÁÖßÂúãÂÆ∂(ÈÅ©Áî®ÂúãÂÆ∂)*</label>
                                        <input type="text" class="form-control" id="visaCountry" placeholder="Ë´ãËº∏ÂÖ•" data-api="visaCountry"
                                               oninput="cleanVisaInput(this, 'visaCountry')"
                                               />
                                    </div>
                                </div>
                                <div class="modal-footer" style="background-color:rgba(250, 250, 250, 1);border:none">
                                    <button type="button" class="btn" data-bs-dismiss="modal" style="width:73px;height:48px;background-color:rgba(250, 250, 250, 1);color:rgba(142, 114, 72, 1);border:none">ÂèñÊ∂à</button>
                                    <button type="button" class="btn" onclick="saveGroupVisa()" style="width:73px;height:48px;background-color:rgba(142, 114, 72, 1);color:white;border-radius:4px">ÂÑ≤Â≠ò</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Â§ñÊ°Ü -->
                    <div id="outerWrapper" class="mt-0"
                         style="background:#fff;border-radius:4px;
                                {!IF(ISBLANK(currentTabKey),'display:block;','')}
                                ">
                        
                        <!-- Ê≤íË≥áÊñôÊôÇÊèêÁ§∫ -->
                        <div id="searchPrompt"
                             class="search-prompt"
                             style="{!IF(ISBLANK(currentTabKey),'','display:none;')}">
                            Ë´ãÊêúÂ∞ãË≥áÊñô
                        </div>
                        
                        <!-- ÁµêÊûúË°®Ê†º -->
                        <div id="searchResults"
                             style="{!IF(ISBLANK(currentTabKey),'display:none;','')};">
                            <apex:form >
                                <!-- ‚ñº‚ñº‚ñº [Integrated SPM] Hidden + Modal (inside searchResults form) -->
                                <apex:inputHidden id="selectedIdsHidden" value="{!selectedTravellerIdsJson}" />
                                <div class="modal fade" id="selectPassengersModal" tabindex="-1" aria-labelledby="selectPassengersModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" style="max-width:560px">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="selectPassengersModalLabel" style="font-weight:bold">
                                                    ÈÅ∏ÂèñÊóÖÂÆ¢ÔºàPNRÔºö<span id="spm-pnr"></span>Ôºâ
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ÈóúÈñâ"></button>
                                            </div>
                                            <div class="modal-body" style="max-height:60vh;overflow:auto;">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <div>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="spm-select-all">ÂÖ®ÈÅ∏</button>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="spm-clear-all">ÂÖ®‰∏çÈÅ∏</button>
                                                    </div>
                                                    <small class="text-muted">Â∞èÂ≠©ÔºàÂßìÂêçÂê´„Äå‚îî„ÄçÔºâÊúÉÈö®ÂêåÂÖ∂‰∏ä‰∏Ä‰ΩçÂ§ß‰∫∫ÔºõÂ∞èÂ≠©‰∏çÈ°ØÁ§∫ÂãæÈÅ∏Ê°Ü„ÄÇ</small>
                                                </div>
                                                <div id="spm-list" class="list-group"></div>
                                            </div>
                                            <div class="modal-footer" style="background:#fafafa;border:none">
                                                <button type="button" class="btn" data-bs-dismiss="modal" style="width:73px;height:40px;background:#fff;color:#8E7248;border:none">ÂèñÊ∂à</button>
                                                <button type="button" class="btn" id="spm-apply" style="width:96px;height:40px;background:#8E7248;color:#fff;border-radius:4px">Â•óÁî®</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- ‚ñ≤‚ñ≤‚ñ≤ [Integrated SPM] End -->
                                
                                <!-- ÈÄôË£°ÂèØÊîæÂàÜÈ†ÅÊéßÂà∂ -->
                                <div class="pagination-controls d-flex
                                            align-items-center justify-content-between"
                                     style="position: sticky; top: 0; z-index: 10; height:78px; margin-top:3px;">
                                    <div></div>
                                    
                                    
                                    <div>
                                        <!-- Switch : 1-{Ë≥áÊñôÁ∏ΩÁ≠ÜÊï∏} of {Ë≥áÊñôÁ∏ΩÁ≠ÜÊï∏} 2025/06/04 Aaron-->
                                        <apex:outputPanel id="pnrCountPanel">
                                            <span class="me-2">
                                                {!IF(currentTabCount > 0, 1, 0)} - {!currentTabCount} of {!currentTabCount}
                                            </span>
                                        </apex:outputPanel>
                                        
                                        <!-- Prev Button -->
                                        <apex:outputPanel rendered="{!IF(NOT(ISBLANK(currentPage)), currentPage > 1, false)}">
                                            <button class="btn border-0" onclick="goToPrevPage();">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/>
                                                </svg>
                                            </button>
                                            
                                            
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!IF(NOT(ISBLANK(currentPage)) && currentPage <= 1, true, false)}">
                                            <button class="btn border-0" disabled="disabled" style="color: #d6ccbd; cursor: not-allowed;">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/>
                                                </svg>
                                            </button>
                                        </apex:outputPanel>
                                        
                                        <!-- Next Button -->
                                        <apex:outputPanel rendered="{!IF(NOT(ISBLANK(currentPage)) && NOT(ISBLANK(totalPages)) && currentPage < totalPages, true, false)}">
                                            <button class="btn border-0 me-2" onclick="goToNextPage();">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M8.59 16.59L13.17 12l-4.58-4.59L10 6l6 6-6 6z"/>
                                                </svg>
                                            </button>
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!IF(NOT(ISBLANK(currentPage)) && NOT(ISBLANK(totalPages)) && currentPage >= totalPages, true, false)}">
                                            <button class="btn border-0 me-2" disabled="disabled" style="color: #d6ccbd; cursor: not-allowed;">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M8.59 16.59L13.17 12l-4.58-4.59L10 6l6 6-6 6z"/>
                                                </svg>
                                            </button>
                                        </apex:outputPanel>
                                        
                                        
                                    </div>
                                </div>
                                <!-- Ëß£Êûê‰∏äÂÇ≥DebugÁî® -->
                                <div id="csv-debug-panel" style="
                                                                 position: fixed;
                                                                 bottom: 80px;
                                                                 right: 20px;
                                                                 width: 300px;
                                                                 max-height: 400px;
                                                                 overflow-y: auto;
                                                                 background: #fdf8e4;
                                                                 border: 1px solid #ccc;
                                                                 padding: 10px 10px 10px 14px;
                                                                 font-size: 12px;
                                                                 z-index: 9999;
                                                                 box-shadow: 0 0 5px rgba(0,0,0,0.2);
                                                                 display: none;
                                                                 position: fixed;
                                                                 ">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong>üìã CSV ‰∏äÂÇ≥ Debug</strong>
                                        <button onclick="document.getElementById('csv-debug-panel').style.display='none';"
                                                style="background: none; border: none; font-weight: bold; color: #888; font-size: 14px; cursor: pointer;">
                                            
                                        </button>
                                    </div>
                                    <div id="csv-debug-log" style="margin-top: 8px; white-space: pre-wrap;"></div>
                                </div> 
                                
                                
                                <div class="tab-content" id="resultTabContent">
                                    <apex:repeat value="{!pnrKeys}" var="pnr">
                                        <div id="tab{!pnr}" role="tabpanel"
                                             class="tab-pane fade {!IF(pnr==currentTabKey,'show active','')}">
                                            
                                            <div class="table-responsive" style="overflow: unset;">
                                                <table class="table">
                                                    <thead style="height:94px; position: sticky; top: 0; z-index: 5; background: #fff;
                                                                  box-shadow: inset 0 1px 0 #CCBBB0, 0 2px 4px -2px rgba(0,0,0,0.08);">
                                                        <!-- ‚á¢ Ë°®È†≠Áï• (ËàáÂéü‰æÜ‰∏ÄËá¥) -->
                                                        <tr>
                                                            <th style="min-width:200px;
                                                                       position:sticky;left:0;z-index:2;
                                                                       background:#fff">ÊóÖÂÆ¢ÂßìÂêç / Á®±Ë¨Ç</th>
                                                            <th>ÊÄßÂà•</th>
                                                            <th>ÂúãÁ±ç</th>
                                                            <th>Âá∫ÁîüÊó•Êúü</th>
                                                            <th style="text-wrap-mode: nowrap;">ÊóÖË°åÊñá‰ª∂</th>
                                                            <th>Ë≠â‰ª∂ËôüÁ¢º</th>
                                                            <th style="width:15%">Âà∞ÊúüÊó•</th>
                                                            <th style="width:10%">ÁôºÁÖßÂúãÂÆ∂(ÈÅ©Áî®ÂúãÂÆ∂)</th>
                                                            <apex:outputPanel rendered="{!NOT(showUSFields)}" layout="none">
                                                                <th></th>
                                                            </apex:outputPanel>
                                                            <apex:outputPanel rendered="{!showUSFields}" layout="none">
                                                                <th>Ë°óÈÅì</th>
                                                                <th>ÂüéÂ∏Ç</th>
                                                                <th>Â∑û/ÁúÅ</th>
                                                                <th>ÂúãÁ±ç/Âú∞ÂçÄ</th>
                                                                <th>ÈÉµÈÅûÂçÄËôü</th>
                                                                <th>Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂßìÂêç</th>
                                                                <th>Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂúãÁ±ç</th>
                                                                <th>Á∑äÊÄ•ËÅØÁµ°‰∫∫ÈõªË©±</th>
                                                                <th></th>
                                                            </apex:outputPanel>
                                                        </tr>
                                                    </thead>
                                                    
                                                    <tbody>
                                                        <apex:variable var="index" value="{!0}" />
                                                        <apex:repeat value="{!tabData[pnr]}" var="p">
                                                            <apex:repeat value="{!p.documents}" var="d">
                                                                <tr style="border-bottom:1px solid #dee2e6">
                                                                    <!-- Âè™Âú®Á¨¨‰∏ÄÂºµË≠â‰ª∂ÊôÇ rowspan È°ØÁ§∫ÂÄãË≥á -->
                                                                    <apex:outputPanel rendered="{!d.docType == 'Ë≠∑ÁÖß'}" layout="none">
                                                                        <td rowspan="2"
                                                                            style="font-weight:bold;
                                                                                   position:sticky;left:0;
                                                                                   z-index:1;
                                                                                   background:#fff;
                                                                                   box-shadow: 8px 0 12px -4px rgba(0, 0, 0, 0.25);
                                                                                   "
                                                                            data-id="{!d.Id}"
                                                                            data-passport-finished="{!IF(p.PassportFinished,'true','false')}"
                                                                            >
                                                                            <apex:outputText rendered="{!p.passengerType == 'INF'}"> ‚îî  </apex:outputText>
                                                                            {!p.lastName}/{!p.firstName} {!p.title}
                                                                            
                                                                        </td>
                                                                        <td style="display:none;">
                                                                            <input type="hidden" data-id="{!d.Id}" data-api="LastName__c" value="{!p.lastName}" />
                                                                            <input type="hidden" data-id="{!d.Id}" data-api="firstName__c" value="{!p.firstName}" />
                                                                            <input type="hidden" data-id="{!d.Id}" data-api="PT__c" value="{!p.PT}" />
                                                                            <input type="hidden" data-id="{!d.Id}" data-api="ST01__c" value="{!p.ST}" />
                                                                            <input type="hidden" data-id="{!d.Id}" data-api="ST02__c" value="{!p.ST2}" />
                                                                        </td>
                                                                        <!--<td rowspan="{!p.docCount}">-->
                                                                        <td rowspan="2">
                                                                            <div class="input-wrapper">
                                                                                <select 
                                                                                        class="form-select form-select-sm editable-field text-align-last: center;" 
                                                                                        style="width:160px;height:160px;text-align: -webkit-center;" 
                                                                                        data-id="{!d.Id}"
                                                                                        data-api="gender__c" 
                                                                                        disabled="true"
                                                                                        onblur="document.getElementById('{!$Component.genderHidden}').value = this.value;"
                                                                                        >
                                                                                    <apex:outputText rendered="{!ISBLANK(p.gender)}">
                                                                                        <option value="" selected="selected"></option>
                                                                                    </apex:outputText>
                                                                                    
                                                                                    <!-- ADT / CHD È°ûÂûãÈ°ØÁ§∫ F / M -->
                                                                                    <apex:outputPanel rendered="{!OR(p.passengerType == 'ADT', p.passengerType == 'CHD')}">
                                                                                        <apex:outputText rendered="{!p.gender == 'M'}">
                                                                                            <option value="M" selected="selected">M</option>
                                                                                        </apex:outputText>
                                                                                        <apex:outputText rendered="{!p.gender != 'M'}">
                                                                                            <option value="M">M</option>
                                                                                        </apex:outputText>
                                                                                        
                                                                                        <apex:outputText rendered="{!p.gender == 'F'}">
                                                                                            <option value="F" selected="selected">F</option>
                                                                                        </apex:outputText>
                                                                                        <apex:outputText rendered="{!p.gender != 'F'}">
                                                                                            <option value="F">F</option>
                                                                                        </apex:outputText>
                                                                                    </apex:outputPanel>
                                                                                    
                                                                                    <!-- INF È°ûÂûãÈ°ØÁ§∫ FI / MI -->
                                                                                    <apex:outputPanel rendered="{!p.passengerType == 'INF'}">
                                                                                        <apex:outputText rendered="{!p.gender == 'MI'}">
                                                                                            <option value="MI" selected="selected">MI</option>
                                                                                        </apex:outputText>
                                                                                        <apex:outputText rendered="{!p.gender != 'MI'}">
                                                                                            <option value="MI">MI</option>
                                                                                        </apex:outputText>
                                                                                        
                                                                                        <apex:outputText rendered="{!p.gender == 'FI'}">
                                                                                            <option value="FI" selected="selected">FI</option>
                                                                                        </apex:outputText>
                                                                                        <apex:outputText rendered="{!p.gender != 'FI'}">
                                                                                            <option value="FI">FI</option>
                                                                                        </apex:outputText>
                                                                                    </apex:outputPanel>
                                                                                </select>
                                                                                
                                                                                <apex:inputHidden value="{!p.gender}" id="genderHidden"/>
                                                                            </div>
                                                                        </td>
                                                                        
                                                                        <!--<td rowspan="{!p.docCount}">-->
                                                                        <td rowspan="2">
                                                                            <div class="input-wrapper">
                                                                                <input value="{!p.nationality}" 
                                                                                       class="form-control form-control-sm editable-field" 
                                                                                       style="width:140px;height:160px" 
                                                                                       disabled="true" 
                                                                                       placeholder="Ë´ãËº∏ÂÖ•"
                                                                                       data-api="nationality__c" 
                                                                                       data-id="{!d.Id}"
                                                                                       oninput="cleanPassportInput(this)"
                                                                                       onblur="document.getElementById('{!$Component.nationalityHidden}').value = this.value;"
                                                                                       />
                                                                                <apex:inputHidden value="{!p.nationality}" id="nationalityHidden"/>
                                                                            </div>
                                                                        </td>
                                                                        <!--<td rowspan="{!p.docCount}">-->
                                                                        <td rowspan="2">
                                                                            <div class="input-wrapper">
                                                                                <input value="{!p.birthDate}" 
                                                                                       type="date" 
                                                                                       class="form-control form-control-sm editable-field always-visible" 
                                                                                       style="width:160px;height:160px" 
                                                                                       data-api="DateOfBirth__c" 
                                                                                       data-id="{!d.Id}"
                                                                                       data-pt="{!p.passengerType}"
                                                                                       disabled="true"
                                                                                       onblur="document.getElementById('{!$Component.birthdDateHidden}').value = this.value;"
                                                                                       />
                                                                                <apex:inputHidden value="{!p.birthDate}" id="birthdDateHidden"/>
                                                                            </div>
                                                                        </td>
                                                                    </apex:outputPanel>
                                                                    
                                                                    
                                                                    <!-- Ë≠â‰ª∂Âàó -->
                                                                    <td><span class="travel-document">{!d.docType}</span></td>
                                                                    <!-- ====== Ë≠∑ÁÖßÊ¨Ñ‰Ωç ====== -->
                                                                    <apex:outputPanel rendered="{!d.docType == 'Ë≠∑ÁÖß'}" layout="none">
                                                                        <!-- Ë≠â‰ª∂ËôüÁ¢º -->
                                                                        <td>
                                                                            <div class="input-wrapper">
                                                                                <input type="text"
                                                                                       value="{!d.docNumber}" 
                                                                                       class="form-control form-control-sm editable-field ClearItems"
                                                                                       style="width:180px;height:60px"
                                                                                       disabled="true"
                                                                                       placeholder="Ë´ãËº∏ÂÖ•"
                                                                                       data-api="PassportNumber__c"
                                                                                       data-id="{!d.Id}"
                                                                                       oninput="cleanPassportInput(this)"
                                                                                       onblur="document.getElementById('{!$Component.docNumberHidden}').value = this.value;"
                                                                                       />
                                                                                <apex:inputHidden value="{!d.docNumber}" id="docNumberHidden"/>
                                                                            </div>
                                                                        </td>
                                                                        
                                                                        <!-- Âà∞ÊúüÊó• -->
                                                                        <td>
                                                                            <div class="input-wrapper">
                                                                                <input value="{!d.expiryDate}" 
                                                                                       class="form-control form-control-sm editable-field ClearItems always-visible"
                                                                                       style="width:180px;height:60px"
                                                                                       disabled="true"
                                                                                       type="date"
                                                                                       data-api="PassportExpiryDate__c"
                                                                                       data-id="{!d.Id}"
                                                                                       onblur="document.getElementById('{!$Component.expiryDateHidden}').value = this.value;"
                                                                                       />
                                                                                <apex:inputHidden value="{!d.expiryDate}" id="expiryDateHidden"/>
                                                                            </div>
                                                                        </td>
                                                                        
                                                                        <!-- ÁôºÁÖßÂúãÂÆ∂ -->
                                                                        <td>
                                                                            <div class="input-wrapper">
                                                                                <input value="{!d.issuingCountry}" 
                                                                                       class="form-control form-control-sm editable-field ClearItems"
                                                                                       style="width:180px;height:60px"
                                                                                       disabled="true"
                                                                                       placeholder="Ë´ãËº∏ÂÖ•"
                                                                                       data-api="PassportIssuingCountry__c"
                                                                                       oninput="cleanPassportInput(this)"
                                                                                       data-id="{!d.Id}"
                                                                                       onblur="document.getElementById('{!$Component.issuingCountryHidden}').value = this.value;"
                                                                                       />
                                                                                <apex:inputHidden value="{!d.issuingCountry}" id="issuingCountryHidden"/>
                                                                            </div>
                                                                        </td>
                                                                        
                                                                        <!-- ÁæéÂúãÂú∞ÂùÄÂçÄÂ°ä -->
                                                                        <apex:outputPanel rendered="{!showUSFields}" layout="none">
                                                                            <!-- Ë°óÈÅì -->
                                                                            <td>
                                                                                <div class="input-wrapper">
                                                                                    <input value="{!d.USStreet}"
                                                                                           class="form-control form-control-sm editable-field ClearItems"
                                                                                           style="width:300px;height:60px"
                                                                                           disabled="true"
                                                                                           data-api="USAStreet__c"
                                                                                           data-id="{!d.Id}"
                                                                                           placeholder="Ë´ãËº∏ÂÖ•"
                                                                                           oninput="cleanPassportInput(this)"
                                                                                           onblur="document.getElementById('{!$Component.USStreetHidden}').value = this.value;"
                                                                                           />
                                                                                    <apex:inputHidden value="{!d.USStreet}" id="USStreetHidden"/>
                                                                                </div>
                                                                            </td>
                                                                            
                                                                            <!-- ÂüéÂ∏Ç -->
                                                                            <td>
                                                                                <div class="input-wrapper">
                                                                                    <input value="{!d.UScity}"
                                                                                           class="form-control form-control-sm editable-field ClearItems"
                                                                                           style="width:150px;height:60px"
                                                                                           disabled="true"
                                                                                           data-api="UScity__c"
                                                                                           data-id="{!d.Id}"
                                                                                           placeholder="Ë´ãËº∏ÂÖ•"
                                                                                           oninput="cleanPassportInput(this)"
                                                                                           onblur="document.getElementById('{!$Component.UScityHidden}').value = this.value;"
                                                                                           />
                                                                                    <apex:inputHidden value="{!d.UScity}" id="UScityHidden"/>
                                                                                </div>
                                                                            </td>
                                                                            
                                                                            <!-- Â∑û/ÁúÅ -->
                                                                            <td>
                                                                                <div class="input-wrapper">
                                                                                    <select class="form-select form-select-sm editable-field ClearItems"
                                                                                            data-api="USstate__c"
                                                                                            data-id="{!d.Id}"
                                                                                            disabled="true"
                                                                                            style="width:150px;height:60px;text-align:center;"
                                                                                            onblur="document.getElementById('{!$Component.USstateHidden}').value = this.value;"
                                                                                            >
                                                                                        
                                                                                        
                                                                                        <apex:outputText rendered="{!ISBLANK(d.USstate)}">
                                                                                            <option value="" data-placeholder="true" selected="selected">&nbsp;</option>
                                                                                        </apex:outputText>
                                                                                        
                                                                                        <apex:repeat value="{!USStateOptions}" var="opt">
                                                                                            <apex:outputText rendered="{!opt.value == d.USstate}">
                                                                                                <option value="{!opt.value}" selected="selected">{!opt.label}</option>
                                                                                            </apex:outputText>
                                                                                            <apex:outputText rendered="{!opt.value != d.USstate}">
                                                                                                <option value="{!opt.value}">{!opt.label}</option>
                                                                                            </apex:outputText>
                                                                                        </apex:repeat>
                                                                                    </select>
                                                                                    
                                                                                    <apex:inputHidden value="{!d.USstate}" id="USstateHidden"/>
                                                                                </div>
                                                                            </td>
                                                                            
                                                                            <td>
                                                                                <input value="USA"
                                                                                       class="form-control form-control-sm"
                                                                                       style="width:150px;height:60px"
                                                                                       disabled="true"
                                                                                       />
                                                                            </td>
                                                                            
                                                                            <!-- ÈÉµÈÅûÂçÄËôü -->
                                                                            <td>
                                                                                <div class="input-wrapper">
                                                                                    <input value="{!d.USpostalcode}"
                                                                                           maxlength="5"
                                                                                           class="form-control form-control-sm editable-field ClearItems"
                                                                                           style="width:150px;height:60px"
                                                                                           disabled="true"
                                                                                           data-api="USpostalcode__c"
                                                                                           data-id="{!d.Id}"
                                                                                           placeholder="Ë´ãËº∏ÂÖ•"
                                                                                           oninput="cleanPassportInput(this)"
                                                                                           onblur="document.getElementById('{!$Component.USpostalcodeHidden}').value = this.value;"
                                                                                           />
                                                                                    <apex:inputHidden value="{!d.USpostalcode}" id="USpostalcodeHidden"/>
                                                                                </div>
                                                                            </td>
                                                                            
                                                                            <!-- Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂßìÂêç -->
                                                                            <apex:outputPanel rendered="{!p.passengerType != 'INF'}" layout="none">
                                                                                
                                                                                <td>
                                                                                    <div class="input-wrapper">
                                                                                        <input value="{!d.UScontact}"
                                                                                               class="form-control form-control-sm editable-field ClearItems"
                                                                                               style="width:150px;height:60px"
                                                                                               disabled="true"
                                                                                               data-api="UScontact__c"
                                                                                               data-id="{!d.Id}"
                                                                                               placeholder="Ë´ãËº∏ÂÖ•"
                                                                                               oninput="cleanPassportInput(this)"
                                                                                               onblur="document.getElementById('{!$Component.UScontactHidden}').value = this.value;"
                                                                                               />
                                                                                        <apex:inputHidden value="{!d.UScontact}" id="UScontactHidden"/>
                                                                                    </div>
                                                                                </td>
                                                                                
                                                                                <!-- Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂúãÁ±ç -->
                                                                                <td>
                                                                                    <div class="input-wrapper">
                                                                                        <input value="{!d.UScontactNationality}"
                                                                                               class="form-control form-control-sm editable-field ClearItems"
                                                                                               style="width:150px;height:60px"
                                                                                               disabled="true"
                                                                                               data-api="UScontactNationality__c"
                                                                                               data-id="{!d.Id}"
                                                                                               placeholder="Ë´ãËº∏ÂÖ•"
                                                                                               oninput="cleanPassportInput(this)"
                                                                                               onblur="document.getElementById('{!$Component.UScontactNationalityHidden}').value = this.value;"
                                                                                               />
                                                                                        <apex:inputHidden value="{!d.UScontactNationality}" id="UScontactNationalityHidden"/>
                                                                                    </div>
                                                                                </td>
                                                                                
                                                                                <!-- Á∑äÊÄ•ËÅØÁµ°‰∫∫ÈõªË©± -->
                                                                                <td>
                                                                                    <div class="input-wrapper">
                                                                                        <input value="{!d.UScontactphone}"
                                                                                               class="form-control form-control-sm editable-field ClearItems"
                                                                                               style="width:150px;height:60px"
                                                                                               disabled="true"
                                                                                               data-api="UScontactphone__c"
                                                                                               data-id="{!d.Id}"
                                                                                               placeholder="Ë´ãËº∏ÂÖ•"
                                                                                               oninput="cleanPassportInput(this)"
                                                                                               onblur="document.getElementById('{!$Component.UScontactphoneHidden}').value = this.value;"
                                                                                               />
                                                                                        <apex:inputHidden value="{!d.UScontactphone}" id="UScontactphoneHidden"/>
                                                                                    </div>
                                                                                </td>
                                                                            </apex:outputPanel>
                                                                        </apex:outputPanel>
                                                                    </apex:outputPanel>
                                                                    
                                                                    
                                                                    <!-- ====== Á∞ΩË≠âÊ¨Ñ‰Ωç ====== -->
                                                                    
                                                                    
                                                                    <apex:outputPanel rendered="{!d.docType == 'Á∞ΩË≠â'}" layout="none">
                                                                        <td>
                                                                            <div class="input-wrapper">
                                                                                <input value="{!d.visaNumber}" 
                                                                                       class="form-control form-control-sm editable-field ClearItems"
                                                                                       style="width:180px;height:60px"
                                                                                       data-api="VisaNumber__c"
                                                                                       data-doc="visa"
                                                                                       maxlength="25"
                                                                                       placeholder="Ë´ãËº∏ÂÖ•"
                                                                                       oninput="cleanVisaInput(this, 'number')"
                                                                                       disabled="true"
                                                                                       onblur="document.getElementById('{!$Component.visaNumberHidden}').value = this.value;"
                                                                                       />
                                                                                <apex:inputHidden value="{!d.visaNumber}" id="visaNumberHidden"/>
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <div class="input-wrapper">
                                                                                <input value="{!d.visaExpiryDate}" 
                                                                                       class="form-control form-control-sm editable-field ClearItems always-visible"
                                                                                       style="width:180px;height:60px"
                                                                                       data-api="VisaExpiryDate__c"
                                                                                       data-doc="visa"
                                                                                       placeholder="Ë´ãËº∏ÂÖ•"
                                                                                       disabled="true"
                                                                                       type="date"
                                                                                       onblur="document.getElementById('{!$Component.visaExpiryDateHidden}').value = this.value;"
                                                                                       />
                                                                                <apex:inputHidden value="{!d.visaExpiryDate}" id="visaExpiryDateHidden"/>
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <div class="input-wrapper">
                                                                                <input value="{!d.visaIssuingCountry}" 
                                                                                       class="form-control form-control-sm editable-field ClearItems"
                                                                                       style="width:180px;height:60px"
                                                                                       data-api="VisaIssuingCountry__c"
                                                                                       data-doc="visa"
                                                                                       maxlength="3"
                                                                                       placeholder="Ë´ãËº∏ÂÖ•"
                                                                                       oninput="cleanPassportInput(this)"
                                                                                       disabled="true"
                                                                                       onblur="document.getElementById('{!$Component.visaIssuingCountryHidden}').value = this.value;"
                                                                                       />
                                                                                <apex:inputHidden value="{!d.visaIssuingCountry}" id="visaIssuingCountryHidden"/>
                                                                            </div>
                                                                        </td>
                                                                    </apex:outputPanel>
                                                                    
                                                                    
                                                                    
                                                                    
                                                                    
                                                                    <td class="edit-only" style="display: none; justify-items: baseline;">
                                                                        <div class="d-flex gap-3">
                                                                            <!-- Ê∏ÖÈô§ÊåâÈàï -->
                                                                            <button type="button"
                                                                                    class="btn actionbtn"
                                                                                    title="Ê∏ÖÈô§"
                                                                                    onclick="clearFields(this)"
                                                                                    disabled="true"
                                                                                    style="width:38px;height:38px;padding:0;
                                                                                           border:none;background:none;cursor: not-allowed;">
                                                                                <span class="material-symbols-outlined"
                                                                                      style="width:38px;height:38px;
                                                                                             background:#C8565A;color:#fff;
                                                                                             display:flex;
                                                                                             align-items:center;
                                                                                             justify-content:center;
                                                                                             border-radius:4px">
                                                                                    close
                                                                                </span>
                                                                            </button>
                                                                            
                                                                            <!-- ‰ΩèÂùÄÊåâÈàï -->
                                                                            <apex:outputPanel rendered="{!AND(p.usBound, index == 0)}" layout="none">
                                                                                <button 
                                                                                        type="button"
                                                                                        class="btn actionbtn USaddressbtn" 
                                                                                        style="width:60px;height:38px;padding:12px;
                                                                                               border:none;background:#8E7248;
                                                                                               color:#fff;display:flex;
                                                                                               align-items:center;
                                                                                               justify-content:center;
                                                                                               border-radius:4px;
                                                                                               cursor: not-allowed;"
                                                                                        data-id="{!p.recordId}" 
                                                                                        onclick="showUSAddressModal()" 
                                                                                        title="ÁæéÂúã‰ΩèÂùÄ"
                                                                                        disabled="true">
                                                                                    ‰ΩèÂùÄ
                                                                                </button>
                                                                            </apex:outputPanel>
                                                                            
                                                                            <!-- ÂúòÁ∞ΩÊåâÈàï -->
                                                                            <apex:outputPanel rendered="{!AND(NOT(p.usBound), d.docType == 'Á∞ΩË≠â', index == 1)}" layout="none">
                                                                                <button 
                                                                                        type="button"
                                                                                        class="btn actionbtn groupVisaBtn" 
                                                                                        style="width:60px;height:38px;padding:12px;
                                                                                               border:none;background:#8E7248;
                                                                                               color:#fff;display:flex;
                                                                                               align-items:center;
                                                                                               justify-content:center;
                                                                                               border-radius:4px;
                                                                                               cursor: not-allowed;"
                                                                                        onclick="showGroupModal()" 
                                                                                        title="ÂúòÈ´îÁ∞ΩË≠â"
                                                                                        disabled="true">
                                                                                    ÂúòÁ∞Ω
                                                                                </button>
                                                                            </apex:outputPanel>
                                                                        </div>
                                                                    </td>
                                                                    
                                                                </tr>
                                                                <apex:variable var="index" value="{!index + 1}" />
                                                            </apex:repeat>
                                                        </apex:repeat>
                                                    </tbody>
                                                    
                                                </table>
                                            </div>
                                            
                                            <!-- Mobile Accordion Structure (only shows on mobile) -->
                                            <div class="mobile-accordion">
                                                <apex:variable var="accordionIndex" value="{!0}" />
                                                <apex:repeat value="{!tabData[pnr]}" var="p">
                                                    <apex:repeat value="{!p.documents}" var="firstDoc" first="0" rows="1">
                                                        <div class="accordion" id="{!pnr}{!accordionIndex}">
                                                            <div class="accordion-item passenger-accordion" data-passenger-id="{!firstDoc.Id}">
                                                                <h2 class="accordion-header" id="heading{!pnr}{!accordionIndex}">
                                                                    <button class="accordion-button collapsed" type="button" 
                                                                            data-bs-toggle="collapse" 
                                                                            data-bs-target="#collapse{!pnr}{!accordionIndex}"
                                                                            aria-expanded="false" 
                                                                            aria-controls="collapse{!pnr}{!accordionIndex}">
                                                                        <apex:outputText rendered="{!p.passengerType == 'INF'}"> ‚îî </apex:outputText>
                                                                        {!p.lastName}/{!p.firstName} {!p.title}
                                                                    </button>
                                                                </h2>
                                                                <div id="collapse{!pnr}{!accordionIndex}"
                                                                     class="accordion-collapse collapse"
                                                                     data-bs-parent="#{!pnr}{!accordionIndex}"
                                                                     aria-labelledby="heading{!pnr}{!accordionIndex}">
                                                                    <div class="accordion-body">
                                                                        <!-- Personal Information Section -->
                                                                        <div class="passenger-info-section">
                                                                            <div class="row mb-3 align-items-center">
                                                                                <label class="col-6 col-form-label">ÊÄßÂà•</label>
                                                                                <div class="col-6">
  <select class="form-select form-select-sm editable-field"
          data-api="gender__c" data-id="{!firstDoc.Id}" disabled="true">
    <apex:outputPanel layout="none" rendered="{!OR(p.passengerType == 'ADT', p.passengerType == 'CHD')}">
      <apex:outputText rendered="{!ISBLANK(p.gender)}">
        <option value="" selected="selected"></option>
      </apex:outputText>
      <apex:outputText rendered="{!p.gender == 'M'}">
        <option value="M" selected="selected">M</option>
      </apex:outputText>
      <apex:outputText rendered="{!p.gender != 'M'}">
        <option value="M">M</option>
      </apex:outputText>
      <apex:outputText rendered="{!p.gender == 'F'}">
        <option value="F" selected="selected">F</option>
      </apex:outputText>
      <apex:outputText rendered="{!p.gender != 'F'}">
        <option value="F">F</option>
      </apex:outputText>
    </apex:outputPanel>
    <apex:outputPanel layout="none" rendered="{!p.passengerType == 'INF'}">
      <apex:outputText rendered="{!ISBLANK(p.gender)}">
        <option value="" selected="selected"></option>
      </apex:outputText>
      <apex:outputText rendered="{!p.gender == 'MI'}">
        <option value="MI" selected="selected">MI</option>
      </apex:outputText>
      <apex:outputText rendered="{!p.gender != 'MI'}">
        <option value="MI">MI</option>
      </apex:outputText>
      <apex:outputText rendered="{!p.gender == 'FI'}">
        <option value="FI" selected="selected">FI</option>
      </apex:outputText>
      <apex:outputText rendered="{!p.gender != 'FI'}">
        <option value="FI">FI</option>
      </apex:outputText>
    </apex:outputPanel>
  </select>
</div>
                                                                            </div>
                                                                            <div class="row mb-3 align-items-center">
                                                                                <label class="col-6 col-form-label">ÂúãÁ±ç</label>
                                                                                <div class="col-6">
  <input class="form-control form-control-sm editable-field"
         data-api="nationality__c" data-id="{!firstDoc.Id}"
         maxlength="3" placeholder="Ë´ãËº∏ÂÖ•(ISO3)"
         disabled="true" />
</div>
                                                                            </div>
                                                                            <div class="row mb-3 align-items-center">
                                                                                <label class="col-6 col-form-label">Âá∫ÁîüÂπ¥ÊúàÊó•</label>
                                                                                <div class="col-6">
  <input type="date" class="form-control form-control-sm editable-field always-visible"
         data-api="DateOfBirth__c" data-id="{!firstDoc.Id}"
         disabled="true" />
</div>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        <div class="info-divider"></div>
                                                                        
                                                                        <!-- Passport Section -->
                                                                        <apex:variable var="docIndex" value="{!0}" />
                                                                        <apex:repeat value="{!p.documents}" var="d">
                                                                            <apex:outputPanel rendered="{!d.docType == 'Ë≠∑ÁÖß'}" layout="none">
                                                                                <div class="passenger-info-section document-section" data-doc-type="Ë≠∑ÁÖß">
                                                                                    <div class="section-header d-flex justify-content-between align-items-center">
                                                                                        <div class="section-title">Ë≠∑ÁÖß</div>
                                                                                        <div class="d-flex gap-2">
                                                                                            <!-- ‰ΩèÂùÄÔºöÊØîÁÖßÊ°åÊ©ü => showUSFields && p.usBound ‰∏îÁ¨¨‰∏ÄÂºµÊñá‰ª∂ -->
                                                                                            <apex:outputPanel rendered="{!AND(p.usBound, docIndex == 0)}" layout="none">
                                                                                                <button type="button"
                                                                                                        class="btn actionbtn USaddressbtn d-none"
                                                                                                        style="background:#8E7248;color:#fff;border:none;border-radius:4px"
                                                                                                        data-id="{!p.recordId}"
                                                                                                        onclick="showUSAddressModal()"
                                                                                                        disabled="true" title="ÁæéÂúã‰ΩèÂùÄ">
                                                                                                    ‰ΩèÂùÄ
                                                                                                </button>
                                                                                            </apex:outputPanel>
                                                                                            <!-- Ê∏ÖÈô§ -->
                                                                                            <button type="button"
                                                                                                    class="btn actionbtn clear-document-btn d-none"
                                                                                                    title="Ê∏ÖÈô§"
                                                                                                    onclick="clearFields(this)"
                                                                                                    style="width:38px;height:38px;padding:0;
                                                                                                           border:none;background:none;">
                                                                                                <span class="material-symbols-outlined"
                                                                                                      style="width:38px;height:38px;
                                                                                                             background:#C8565A;color:#fff;
                                                                                                             display:flex;
                                                                                                             align-items:center;
                                                                                                             justify-content:center;
                                                                                                             border-radius:4px">
                                                                                                    close
                                                                                                </span>
                                                                                            </button>
                                                                                            
                                                                                            
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    <!-- Add divider here -->
                                                                                    <div class="divider"></div>
                                                                                    
                                                                                    <div class="row mb-3 align-items-center">
                                                                                        <label class="col-6 col-form-label">Ë≠â‰ª∂ËôüÁ¢º</label>
                                                                                        <div class="col-6">
                                                                                            <input value="{!d.docNumber}" class="form-control form-control-sm editable-field ClearItems" disabled="true" data-api="PassportNumber__c"
                                                                                                   data-id="{!d.Id}" placeholder="Ë´ãËº∏ÂÖ•" oninput="cleanPassportInput(this)" onblur="document.getElementById('{!$Component.passportNumberHidden}').value = this.value;"
                                                                                                   />
                                                                                            <apex:inputHidden value="{!d.docNumber}" id="passportNumberHidden" />
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    <div class="row mb-3 align-items-center">
                                                                                        <label class="col-6 col-form-label">Âà∞ÊúüÊó•</label>
                                                                                        <div class="col-6">
                                                                                            <input type="date" value="{!d.expiryDate}" class="form-control form-control-sm editable-field ClearItems always-visible"
                                                                                                   disabled="true" data-api="PassportExpiryDate__c" data-id="{!d.Id}" onblur="document.getElementById('{!$Component.passportExpiryHidden}').value = this.value;"
                                                                                                   />
                                                                                            <apex:inputHidden value="{!d.expiryDate}" id="passportExpiryHidden" />
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    <div class="row mb-3 align-items-center">
                                                                                        <label class="col-6 col-form-label">ÁôºÁÖßÂúãÂÆ∂(ÈÅ©Áî®ÂúãÂÆ∂)</label>
                                                                                        <div class="col-6">
                                                                                            <input value="{!d.issuingCountry}" class="form-control form-control-sm editable-field ClearItems" disabled="true" data-api="PassportIssuingCountry__c"
                                                                                                   data-id="{!d.Id}" placeholder="Ë´ãËº∏ÂÖ•" onblur="document.getElementById('{!$Component.passportIssuingHidden}').value = this.value;"
                                                                                                   />
                                                                                            <apex:inputHidden value="{!d.issuingCountry}" id="passportIssuingHidden" />
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    <!-- US Address Information for Passport -->
                                                                                    <apex:outputPanel rendered="{!showUSFields}" layout="none">
                                                                                        <div class="row mb-3 align-items-center">
                                                                                            <label class="col-6 col-form-label">ÁæéÂúã‰ΩèÂùÄ</label>
                                                                                            <div class="col-6">
                                                                                                <input value="{!d.USStreet}" class="form-control form-control-sm editable-field ClearItems" disabled="true" data-api="USStreet__c"
                                                                                                       data-id="{!d.Id}" placeholder="Ë´ãËº∏ÂÖ•" />
                                                                                            </div>
                                                                                        </div>
                                                                                        
                                                                                        <div class="row mb-3 align-items-center">
                                                                                            <label class="col-6 col-form-label">ÂüéÂ∏Ç</label>
                                                                                            <div class="col-6">
                                                                                                <input value="{!d.UScity}" class="form-control form-control-sm editable-field ClearItems" disabled="true" data-api="UScity__c"
                                                                                                       data-id="{!d.Id}" placeholder="Ë´ãËº∏ÂÖ•" />
                                                                                            </div>
                                                                                        </div>
                                                                                        
                                                                                        <div class="row mb-3 align-items-center">
                                                                                            <label class="col-6 col-form-label">Â∑ûÂà•</label>
                                                                                            <div class="col-6">
                                                                                                <select class="form-select form-select-sm editable-field ClearItems" disabled="true" data-api="USstate__c" data-id="{!d.Id}">
                                                                                                    <apex:outputText rendered="{!ISBLANK(d.USstate)}">
                                                                                                        <option value="">&nbsp;</option>
                                                                                                    </apex:outputText>
                                                                                                    <apex:repeat value="{!USStateOptions}" var="opt">
                                                                                                        <apex:outputText rendered="{!opt.value == d.USstate}">
                                                                                                            <option value="{!opt.value}" selected="selected">{!opt.label}</option>
                                                                                                        </apex:outputText>
                                                                                                        <apex:outputText rendered="{!opt.value != d.USstate}">
                                                                                                            <option value="{!opt.value}">{!opt.label}</option>
                                                                                                        </apex:outputText>
                                                                                                    </apex:repeat>
                                                                                                </select>
                                                                                            </div>
                                                                                        </div>
                                                                                        
                                                                                        <div class="row mb-3 align-items-center">
                                                                                            <label class="col-6 col-form-label">ÂúãÂÆ∂/Âú∞ÂçÄ</label>
                                                                                            <div class="col-6">
                                                                                                <input value="USA" class="form-control form-control-sm" readonly="readonly" />
                                                                                            </div>
                                                                                        </div>
                                                                                        
                                                                                        <div class="row mb-3 align-items-center">
                                                                                            <label class="col-6 col-form-label">ÈÉµÈÅûÂçÄËôü</label>
                                                                                            <div class="col-6">
                                                                                                <input value="{!d.USpostalcode}" maxlength="5" class="form-control form-control-sm editable-field ClearItems" disabled="true"
                                                                                                       data-api="USpostalcode__c" data-id="{!d.Id}" placeholder="Ë´ãËº∏ÂÖ•" />
                                                                                            </div>
                                                                                        </div>
                                                                                        
                                                                                        <div class="row mb-3 align-items-center">
                                                                                            <label class="col-6 col-form-label">Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂßìÂêç</label>
                                                                                            <div class="col-6">
                                                                                                <input value="{!d.UScontact}" class="form-control form-control-sm editable-field ClearItems" disabled="true" data-api="UScontact__c"
                                                                                                       data-id="{!d.Id}" placeholder="Ë´ãËº∏ÂÖ•" />
                                                                                            </div>
                                                                                        </div>
                                                                                        
                                                                                        <div class="row mb-3 align-items-center">
                                                                                            <label class="col-6 col-form-label">Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂúãÁ±ç</label>
                                                                                            <div class="col-6">
                                                                                                <input value="{!d.UScontactNationality}" class="form-control form-control-sm editable-field ClearItems" disabled="true" data-api="UScontactNationality__c"
                                                                                                       data-id="{!d.Id}" placeholder="Ë´ãËº∏ÂÖ•" />
                                                                                            </div>
                                                                                        </div>
                                                                                        
                                                                                        <div class="row mb-3 align-items-center">
                                                                                            <label class="col-6 col-form-label">Á∑äÊÄ•ËÅØÁµ°‰∫∫ÈõªË©±</label>
                                                                                            <div class="col-6">
                                                                                                <input value="{!d.UScontactphone}" class="form-control form-control-sm editable-field ClearItems" disabled="true" data-api="UScontactphone__c"
                                                                                                       data-id="{!d.Id}" placeholder="Ë´ãËº∏ÂÖ•" />
                                                                                            </div>
                                                                                        </div>
                                                                                    </apex:outputPanel>
                                                                                </div>
                                                                            </apex:outputPanel>
                                                                            <apex:variable var="docIndex" value="{!docIndex + 1}" />
                                                                            
                                                                        </apex:repeat>
                                                                        
                                                                        <div class="info-divider"></div>
                                                                        <!-- Visa Section -->
                                                                        <apex:variable var="visaIdx" value="{!0}" />
                                                                        <apex:repeat value="{!p.documents}" var="d">
                                                                            <apex:outputPanel rendered="{!d.docType == 'Á∞ΩË≠â'}" layout="none">
                                                                                <div class="passenger-info-section document-section" data-doc-type="Á∞ΩË≠â">
                                                                                    <div class="section-header d-flex justify-content-between align-items-center">
                                                                                        <div class="section-title">Á∞ΩË≠â</div>
                                                                                        <div class="d-flex gap-2">
                                                                                            
                                                                                            
                                                                                            <!-- ÂúòÁ∞ΩÔºöÊØîÁÖßÊ°åÊ©ü => NOT(p.usBound) ‰∏îÁ¨¨‰∫åÂºµÊñá‰ª∂Ôºàindex == 1Ôºâ -->
                                                                                            <apex:outputPanel rendered="{!AND(NOT(p.usBound), visaIdx == 0)}" layout="none">
                                                                                                <button type="button"
                                                                                                        class="btn actionbtn groupVisaBtn d-none"
                                                                                                        style="background:#8E7248;color:#fff;border:none;border-radius:4px"
                                                                                                        onclick="showGroupModal()"
                                                                                                        disabled="true" title="ÂúòÈ´îÁ∞ΩË≠â">
                                                                                                    ÂúòÁ∞Ω
                                                                                                </button>
                                                                                            </apex:outputPanel>
                                                                                            <!-- Ê∏ÖÈô§ -->
                                                                                            <button type="button"
                                                                                                    class="btn actionbtn clear-document-btn d-none"
                                                                                                    title="Ê∏ÖÈô§"
                                                                                                    onclick="clearFields(this)"
                                                                                                    style="width:38px;height:38px;padding:0;
                                                                                                           border:none;background:none;">
                                                                                                <span class="material-symbols-outlined"
                                                                                                      style="width:38px;height:38px;
                                                                                                             background:#C8565A;color:#fff;
                                                                                                             display:flex;
                                                                                                             align-items:center;
                                                                                                             justify-content:center;
                                                                                                             border-radius:4px">
                                                                                                    close
                                                                                                </span>
                                                                                            </button>
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    <!-- Add divider here -->
                                                                                    <div class="divider"></div>
                                                                                    
                                                                                    <div class="row mb-3 align-items-center">
                                                                                        <label class="col-6 col-form-label">Ë≠â‰ª∂ËôüÁ¢º</label>
                                                                                        <div class="col-6">
                                                                                            <input value="{!d.visaNumber}" class="form-control form-control-sm editable-field ClearItems" disabled="true" data-api="VisaNumber__c"
                                                                                                   data-doc="visa" data-id="{!d.Id}" maxlength="25" placeholder="Ë´ãËº∏ÂÖ•" oninput="cleanPassportInput(this)"
                                                                                                   onblur="document.getElementById('{!$Component.visaNumberHidden}').value = this.value;"
                                                                                                   />
                                                                                            <apex:inputHidden value="{!d.visaNumber}" id="visaNumberHidden" />
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    <div class="row mb-3 align-items-center">
                                                                                        <label class="col-6 col-form-label">Âà∞ÊúüÊó•</label>
                                                                                        <div class="col-6">
                                                                                            <input type="date" value="{!d.visaExpiryDate}" class="form-control form-control-sm editable-field ClearItems always-visible"
                                                                                                   disabled="true" data-api="VisaExpiryDate__c" data-doc="visa" data-id="{!d.Id}"
                                                                                                   onblur="document.getElementById('{!$Component.visaExpiryHidden}').value = this.value;"
                                                                                                   />
                                                                                            <apex:inputHidden value="{!d.visaExpiryDate}" id="visaExpiryHidden" />
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    <div class="row mb-3 align-items-center">
                                                                                        <label class="col-6 col-form-label">ÁôºÁÖßÂúãÂÆ∂(ÈÅ©Áî®ÂúãÂÆ∂)</label>
                                                                                        <div class="col-6">
                                                                                            <input value="{!d.visaIssuingCountry}" class="form-control form-control-sm editable-field ClearItems" disabled="true" data-api="VisaIssuingCountry__c"
                                                                                                   data-doc="visa" data-id="{!d.Id}" placeholder="Ë´ãËº∏ÂÖ•" onblur="document.getElementById('{!$Component.visaIssuingHidden}').value = this.value;"
                                                                                                   />
                                                                                            <apex:inputHidden value="{!d.visaIssuingCountry}" id="visaIssuingHidden" />
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </apex:outputPanel>
                                                                            <apex:outputPanel rendered="{!d.docType == 'Á∞ΩË≠â'}" layout="none">
                                                                                <apex:variable var="visaIdx" value="{!visaIdx + 1}" />
                                                                            </apex:outputPanel>
                                                                        </apex:repeat>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </apex:repeat>
                                                    <apex:variable var="accordionIndex" value="{!accordionIndex + 1}" />
                                                </apex:repeat>
                                            </div>
                                            
                                        </div>
                                    </apex:repeat>
                                </div>
                                <apex:actionFunction name="doUploadDocument"
                                                     action="{!uploadDocument}"
                                                     rerender="resultTabContent"
                                                     oncomplete="afterSaveSuccess()" 
                                                     >
                                </apex:actionFunction>
                                <!-- 
<button type="button" id="debugJsonBtn" class="btn btn-warning" style="position:fixed; bottom:160px; right:20px; z-index:9999;" onclick="doUploadDocument();">
Ê∏¨Ë©¶Áî®ÊåâÈàï È°ØÁ§∫JSON+ÂÑ≤Â≠ò
</button>  -->
                                
                                <!-- ‚ñº‚ñº‚ñº [Append-Only] ËøΩÂä†ÔºöÊñ∞ÁöÑ actionFunctionÔºåÂëºÂè´ uploadDocumentSelected() -->
                                <apex:actionFunction name="doUploadDocumentWithIds"
                                                     action="{!uploadDocumentSelected}"
                                                     rerender="resultTabContent"
                                                     oncomplete="afterSaveSuccess()">
                                    <apex:param name="selectedIdsParam" assignTo="{!selectedTravellerIdsJson}" value=""/>
                                </apex:actionFunction>
                                <!-- ‚ñ≤‚ñ≤‚ñ≤ ËøΩÂä†ÁµêÊùü -->
                            </apex:form>
                        </div> <!-- /searchResults -->
                    </div>   <!-- /outerWrapper -->
                    <div id="pnrC1DisabledMapContainer" style="display: none;" data-pnr-c1-disabled-map="{!(pnrC1DisabledMapJSON)}"></div>
                </apex:outputPanel>
            </div>
        </div>
        
        
        <div class="fixed-bottom-buttons" id="fixedBottomButtons" style="display:none">
            <div class="container" style="margin-top:0; box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2); z-index: 1050; background-color: #fff;">
                <button type="button" class="btn" id="cancelBtn" style="width:73px;height:48px;background-color:white;color:#8E7248;border:none;display:none">ÂèñÊ∂à</button>
                <button
                        type="button"
                        id="testbtn"
                        class="btn"
                        style="width:73px;height:48px;background-color:#8E7248;color:white;border-radius:4px; {!IF(c1OperationDisabled,'display:none;','')}"
                        >Á∑®ËºØ</button>
                <button type="button" id="nextStep1" onclick="goToNextStep();" class="btn me-2" style="width: 89px;height:48px;border-color:#8E7248;color:#8E7248;background-color:white;border-radius: 4px;">‰∏ã‰∏ÄÊ≠•</button>
                <input type="file" id="fileUpload" style="display: none" multiple='multiple' accept=".xlsx,.xls,.csv,.pdf,.doc,.docx"/>
                <button type="button" class="btn" id="uploadButton" style="width:73px;height:48px;background-color:#8E7248;color:white;border-radius: 4px;display:none">‰∏äÂÇ≥</button>
                <!--<button type="button" id="debugJsonBtn" class="btn btn-warning" style="position:fixed; bottom:160px; right:20px; z-index:9999;">
È°ØÁ§∫ JSON
</button>-->
            </div>
        </div>
        <div id="loadingOverlay" style="display: none;">
            <div style="
                        position: fixed;
                        top: 0; left: 0; right: 0; bottom: 0;
                        background-color: rgba(255, 255, 255, 0.7);
                        z-index: 99999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        ">
                <div class="spinner-border" role="status" style="width: 4rem; height: 4rem; color: #212121;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                
            </div>
        </div>
    

<!-- BEGIN: Immediate RWD/Modal -> PC sync (v3: gender/nationality/DOB robust; sibling-hidden update; date normalize) -->
<script>
(function(){
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function qs(sel, root){ return (root||document).querySelector(sel); }

  // --- helpers ---
  function normalizeDob(value){
    if (!value) return '';
    var v = (''+value).trim();
    // 2025/9/3 -> 2025-09-03 ; 2025-9-3 -> 2025-09-03
    var m = v.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
    if (m){
      var y = m[1], mm = ('0'+m[2]).slice(-2), dd = ('0'+m[3]).slice(-2);
      return y + '-' + mm + '-' + dd;
    }
    // 20250903 -> 2025-09-03
    var m2 = v.match(/^(\d{4})(\d{2})(\d{2})$/);
    if (m2){
      return m2[1] + '-' + m2[2] + '-' + m2[3];
    }
    return v;
  }

  function findPcInput(docId, api) {
    if (!docId || !api) return null;
    var el = qs('.table-responsive [data-id="'+docId+'"][data-api="'+api+'"]');
    if (el) return el;
    var row = qs('.table-responsive [data-id="'+docId+'"]');
    if (row) {
      el = qs('[data-api="'+api+'"]', row);
      if (el) return el;
    }
    return null;
  }

  // Fallback PC hidden ids for non-personal fields (per earlier mapping). Personal info uses sibling hidden.
  var PC_HIDDEN_ID_BY_API = {
    'PassportNumber__c':       '{!$Component.docNumberHidden}',
    'PassportExpiryDate__c':   '{!$Component.expiryDateHidden}',
    'PassportIssuingCountry__c':'{!$Component.issuingCountryHidden}',
    'VisaNumber__c':           '{!$Component.visaNumberHidden}',
    'VisaExpiryDate__c':       '{!$Component.visaExpiryDateHidden}',
    'VisaIssuingCountry__c':   '{!$Component.visaIssuingCountryHidden}',
    'USStreet__c':             '{!$Component.USStreetHidden}',
    'UScity__c':               '{!$Component.UScityHidden}',
    'USstate__c':              '{!$Component.USstateHidden}',
    'USpostalcode__c':         '{!$Component.USpostalcodeHidden}',
    'UScontact__c':            '{!$Component.UScontactHidden}',
    'UScontactNationality__c': '{!$Component.UScontactNationalityHidden}',
    'UScontactphone__c':       '{!$Component.UScontactphoneHidden}'
  };
  function findPcHiddenViaMap(api){
    var hidId = PC_HIDDEN_ID_BY_API[api];
    if (!hidId) return null;
    try { return document.getElementById(hidId); } catch(e) { return null; }
  }

  function findSiblingHidden(pcInput){
    if (!pcInput) return null;
    var wrap = pcInput.closest('.input-wrapper') || pcInput.parentElement;
    if (!wrap) return null;
    // prefer an <input type="hidden"> inside the same wrapper
    var hid = wrap.querySelector('input[type="hidden"]');
    return hid || null;
  }

  // --- docId inference for RWD elements ---
  function inferDocIdByIndex(fromEl){
    try{
      var accItem = fromEl.closest('.accordion-item');
      if (!accItem) return null;
      var container = accItem.parentElement;
      var items = qsa(':scope > .accordion-item', container);
      var idx = items.indexOf(accItem);
      if (idx < 0) return null;
      var pcRows = qsa('.table-responsive [data-id]');
      if (pcRows[idx]) return pcRows[idx].getAttribute('data-id');
    }catch(e){}
    return null;
  }

  function getDocId(el){
    if (!el) return null;
    var id = el.getAttribute('data-id');
    if (id) return id;
    var holder = el.closest('[data-id],[data-passenger-id]');
    if (holder) {
      if (holder.hasAttribute('data-id')) return holder.getAttribute('data-id');
      if (holder.hasAttribute('data-passenger-id')) return holder.getAttribute('data-passenger-id');
    }
    var m;
    ['#usAddressModal', '#groupVisaModal', '.mobile-accordion'].some(function(sel){
      m = el.closest(sel);
      return !!m;
    });
    if (m && m.getAttribute('data-id')) return m.getAttribute('data-id');
    return inferDocIdByIndex(el);
  }

  // --- core sync ---
  function syncToPc(docId, api, value){
    if (api === 'DateOfBirth__c') value = normalizeDob(value);
    var pc = findPcInput(docId, api);
    if (pc) {
      // set value for input/select/date even if disabled
      if (pc.value !== value) pc.value = value == null ? '' : value;

      // also update sibling hidden (genderHidden / nationalityHidden / birthdDateHidden etc.)
      var sibHidden = findSiblingHidden(pc);
      if (sibHidden) {
        sibHidden.value = pc.value;
      }

      // fire events so existing onblur handlers also run
      pc.dispatchEvent(new Event('input',  {bubbles:true}));
      pc.dispatchEvent(new Event('change', {bubbles:true}));
      pc.dispatchEvent(new Event('blur',   {bubbles:true}));
      return true;
    }
    // last resort: write the page-level hidden via map (non-personal fields)
    var hid = findPcHiddenViaMap(api);
    if (hid) { hid.value = value == null ? '' : (api === 'DateOfBirth__c' ? normalizeDob(value) : value); return true; }
    if (window && !window.__RWD_SYNC_WARNED__) window.__RWD_SYNC_WARNED__ = 0;
    if (window.__RWD_SYNC_WARNED__ < 20) {
      console.warn('[RWD‚ÜíPC] Mapping miss', {docId:docId, api:api, value:value});
      window.__RWD_SYNC_WARNED__++;
    }
    return false;
  }

  // Stamp data-id onto modal fields when opening
  document.addEventListener('click', function(e){
    var btn = e.target.closest('.USaddressbtn, .GroupVisaBtn, [data-open-us-modal], [data-open-visa-modal]');
    if (!btn) return;
    var row = btn.closest('tr') || btn.closest('[data-id]');
    var docId = row && (row.getAttribute('data-id') || (qs('[data-id]', row) && qs('[data-id]', row).getAttribute('data-id')));
    var modalSel = (btn.classList.contains('USaddressbtn') || btn.hasAttribute('data-open-us-modal')) ? '#usAddressModal' : '#groupVisaModal';
    var modal = qs(modalSel);
    if (modal && docId) {
      modal.setAttribute('data-id', docId);
      qsa('[data-api]', modal).forEach(function(el){ el.setAttribute('data-id', docId); });
    }
  }, true);

  // Global delegation for immediate sync
  function onEvent(type){
    document.addEventListener(type, function(e){
      var t = e.target;
      if (!(t instanceof HTMLElement)) return;
      if (!t.matches('.mobile-accordion [data-api], #usAddressModal [data-api], #groupVisaModal [data-api]')) return;
      var api = t.getAttribute('data-api');
      var id  = getDocId(t);
      if (!api) return;
      if (!id) {
        id = inferDocIdByIndex(t);
        if (id) t.setAttribute('data-id', id);
      }
      if (id) syncToPc(id, api, t.value);
    }, true);
  }
  ['input','change','blur'].forEach(onEvent);

  // Defensive: strip any RWD hidden writers if still present
  function stripHiddenWriters(rootSel){
    qsa(rootSel + ' [onblur]').forEach(function(el){
      var ob = el.getAttribute('onblur') || '';
      if (ob.indexOf('Hidden') >= 0) {
        el.setAttribute('data-removed-onblur', ob);
        el.removeAttribute('onblur');
        try { el.onblur = null; } catch(e){}
      }
    });
  }
  document.addEventListener('DOMContentLoaded', function(){
    stripHiddenWriters('.mobile-accordion');
    stripHiddenWriters('#usAddressModal');
    stripHiddenWriters('#groupVisaModal');
  });
  window.__InitImmediateRwdProxy__ = function(){
    ['.mobile-accordion','#usAddressModal','#groupVisaModal'].forEach(stripHiddenWriters);
  };
})();
</script>
<!-- END: Immediate RWD/Modal -> PC sync (v3) -->






<!-- BEGIN: PC‚ÜîRWD Two-way Personal Sync (gender/nationality/birthDate) -->
<script>
(function(){
  const APIS = ['gender__c','nationality__c','DateOfBirth__c'];
  let HYDRATING = false;

  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function qs(sel, root){ return (root||document).querySelector(sel); }

  // Normalizers to align formats
  function normalize(api, v){
    if (api === 'DateOfBirth__c'){
      v = (v||'').trim();
      let m = v.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
      if (m){ return `${m[1]}-${('0'+m[2]).slice(-2)}-${('0'+m[3]).slice(-2)}`; }
      let m2 = v.match(/^(\d{4})(\d{2})(\d{2})$/);
      if (m2){ return `${m2[1]}-${m2[2]}-${m2[3]}`; }
      return v;
    }
    if (api === 'nationality__c'){
      return (v||'').toUpperCase().replace(/[^A-Z]/g,'').slice(0,3);
    }
    return v;
  }

  // Locate PC UI & its hidden, given docId + api
  function findPcInput(docId, api){
    return qs(`.table-responsive [data-id="${docId}"][data-api="${api}"]`);
  }
  function findPcHidden(pcEl){
    if (!pcEl) return null;
    // 1) Parse inline onblur target id
    const ob = pcEl.getAttribute('onblur') || '';
    const m  = ob.match(/getElementById\(['"]([^'"]+)['"]\)/);
    if (m){
      const hid = document.getElementById(m[1]);
      if (hid) return hid;
    }
    // 2) Same wrapper
    const wrap = pcEl.closest('.input-wrapper') || pcEl.parentElement;
    if (wrap){
      const hid2 = wrap.querySelector('input[type="hidden"]');
      if (hid2) return hid2;
    }
    // 3) Row fallback
    const row = pcEl.closest('tr');
    return row ? row.querySelector('input[id$="Hidden"]') : null;
  }

  // Locate RWD fields for docId + api
  function findRwdInputs(docId, api){
    // Prefer exact [data-id]
    let list = qsa(`.mobile-accordion [data-api="${api}"][data-id="${docId}"]`);
    if (list.length) return list;
    // Fallback: under a container with data-passenger-id
    qsa(`.mobile-accordion [data-passenger-id="${docId}"]`).forEach(function(box){
      list = list.concat(qsa(`[data-api="${api}"]`, box));
    });
    return list;
  }

  // Push RWD -> PC (on user input)
  function pushRwdToPc(rwdEl){
    const api = rwdEl.getAttribute('data-api'); if (APIS.indexOf(api) < 0) return;
    // Find docId from self/ancestor
    let docId = rwdEl.getAttribute('data-id');
    if (!docId){
      const holder = rwdEl.closest('[data-id],[data-passenger-id]');
      if (holder) docId = holder.getAttribute('data-id') || holder.getAttribute('data-passenger-id');
    }
    if (!docId) return;
    const pc = findPcInput(docId, api);
    if (!pc) return;
    const val = normalize(api, rwdEl.value);
    if (val !== rwdEl.value) rwdEl.value = val;
    if (pc.value !== val) pc.value = val;
    // Fire events to preserve PC logic, then also set hidden defensively
    try { pc.dispatchEvent(new Event('input',  {bubbles:true})); } catch(e){}
    try { pc.dispatchEvent(new Event('change', {bubbles:true})); } catch(e){}
    try { pc.dispatchEvent(new Event('blur',   {bubbles:true})); } catch(e){}
    const hid = findPcHidden(pc);
    if (hid) hid.value = val;
  }

  // Pull PC -> RWD (for initial paint or when PC has values)
  function pullPcToRwd(){
    HYDRATING = true;
    try {
      qsa('.table-responsive [data-id][data-api]').forEach(function(pc){
        const api = pc.getAttribute('data-api');
        if (APIS.indexOf(api) < 0) return;
        const docId = pc.getAttribute('data-id');
        const hid = findPcHidden(pc);
        let v = (hid && hid.value !== undefined && hid.value !== '') ? hid.value : pc.value;
        v = normalize(api, v);
        const rwds = findRwdInputs(docId, api);
        rwds.forEach(function(el){
          if (el.value !== v) el.value = v;
        });
      });
    } finally {
      // brief timeout to avoid bouncing back as change
      setTimeout(function(){ HYDRATING = false; }, 0);
    }
  }

  function onRwdEvent(e){
    if (HYDRATING) return; // skip echo
    const t = e.target.closest('.mobile-accordion [data-api][data-id], .mobile-accordion [data-api]');
    if (!t) return;
    pushRwdToPc(t);
  }

  // Hook up
  document.addEventListener('input',  onRwdEvent, true);
  document.addEventListener('change', onRwdEvent, true);

  // Initial hydrate from PC values
  document.addEventListener('DOMContentLoaded', function(){
    pullPcToRwd();
    // settle after lazy renders
    setTimeout(pullPcToRwd, 80);
    setTimeout(pullPcToRwd, 300);
    setTimeout(pullPcToRwd, 800);
  });
  // When an accordion card is opened (mobile), hydrate that section too
  document.addEventListener('shown.bs.collapse', pullPcToRwd, true);

  // Manual hooks for partial refresh / rerender
  window.__HydrateRwdFromPc__ = pullPcToRwd;
})();
</script>
<!-- END: PC‚ÜîRWD Two-way Personal Sync -->


<!-- BEGIN: PC-first Hydrator & Guarded RWD‚ÜíPC (personal fields) -->
<script>
(function(){
  const APIS = ['gender__c','nationality__c','DateOfBirth__c'];
  let HYDRATING = false;

  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function qs(sel, root){ return (root||document).querySelector(sel); }

  function normalize(api, v){
    if (api === 'DateOfBirth__c'){
      v = (v||'').trim();
      let m = v.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
      if (m){ return `${m[1]}-${('0'+m[2]).slice(-2)}-${('0'+m[3]).slice(-2)}`; }
      let m2 = v.match(/^(\d{4})(\d{2})(\d{2})$/);
      if (m2){ return `${m2[1]}-${m2[2]}-${m2[3]}`; }
      return v;
    }
    if (api === 'nationality__c'){
      return (v||'').toUpperCase().replace(/[^A-Z]/g,'').slice(0,3);
    }
    return v;
  }

  function findPcInput(docId, api){
    return qs(`.table-responsive [data-id="${docId}"][data-api="${api}"]`);
  }
  function findPcHidden(pcEl){
    if (!pcEl) return null;
    const ob = pcEl.getAttribute('onblur') || '';
    const m  = ob.match(/getElementById\(['"]([^'"]+)['"]\)/);
    if (m){
      const hid = document.getElementById(m[1]);
      if (hid) return hid;
    }
    const wrap = pcEl.closest('.input-wrapper') || pcEl.parentElement;
    if (wrap){
      const hid2 = wrap.querySelector('input[type="hidden"]');
      if (hid2) return hid2;
    }
    const row = pcEl.closest('tr');
    return row ? row.querySelector('input[id$="Hidden"]') : null;
  }

  function findRwdInputs(docId, api){
    // Prefer exact [data-id] on the field
    let list = qsa(`.mobile-accordion [data-api="${api}"][data-id="${docId}"]`);
    if (list.length) return list;
    // Fallback within an accordion card carrying data-passenger-id
    qsa(`.mobile-accordion [data-passenger-id="${docId}"]`).forEach(function(box){
      list = list.concat(qsa(`[data-api="${api}"]`, box));
    });
    return list;
  }

  // --- PC -> RWD hydrate ---
  function hydrateFromPcOnce(){
    const pcs = qsa('.table-responsive [data-id][data-api]');
    if (!pcs.length) return false; // nothing yet, let caller retry
    HYDRATING = true;
    try {
      pcs.forEach(function(pc){
        const api = pc.getAttribute('data-api');
        if (APIS.indexOf(api) < 0) return;
        const docId = pc.getAttribute('data-id');
        const hid = findPcHidden(pc);
        let v = (hid && hid.value !== undefined && hid.value !== '') ? hid.value : pc.value;
        v = normalize(api, v);
        const rwds = findRwdInputs(docId, api);
        rwds.forEach(function(el){
          if (el.value !== v) el.value = v;
        });
      });
    } finally {
      setTimeout(function(){ HYDRATING = false; }, 0);
    }
    return true;
  }

  function hydrateFromPcWithRetry(){
    let tries = 0, maxTries = 20;
    (function tick(){
      const ok = hydrateFromPcOnce();
      if (!ok && tries < maxTries){
        tries++;
        setTimeout(tick, tries < 5 ? 60 : (tries < 12 ? 150 : 350));
      }
    })();
  }

  // --- Guarded RWD -> PC (only on user edits) ---
  function pushRwdToPc(rwdEl){
    const api = rwdEl.getAttribute('data-api');
    if (APIS.indexOf(api) < 0) return;
    let docId = rwdEl.getAttribute('data-id');
    if (!docId){
      const holder = rwdEl.closest('[data-id],[data-passenger-id]');
      if (holder) docId = holder.getAttribute('data-id') || holder.getAttribute('data-passenger-id');
    }
    if (!docId) return;
    const pc = findPcInput(docId, api);
    if (!pc) return;
    const val = normalize(api, rwdEl.value);
    if (val !== rwdEl.value) rwdEl.value = val;
    if (pc.value !== val) pc.value = val;
    try { pc.dispatchEvent(new Event('input',  {bubbles:true})); } catch(e){}
    try { pc.dispatchEvent(new Event('change', {bubbles:true})); } catch(e){}
    try { pc.dispatchEvent(new Event('blur',   {bubbles:true})); } catch(e){}
    const hid = findPcHidden(pc);
    if (hid) hid.value = val;
  }

  function onRwdEvent(e){
    if (HYDRATING) return; // don't echo during hydrate
    const t = e.target.closest('.mobile-accordion [data-api]');
    if (!t) return;
    // Only push if this change came from a user action
    // Prefer e.isTrusted (modern browsers), or a flag set on focus/keydown/mousedown
    if (!(e.isTrusted || t.dataset.userEdited === '1')) return;
    pushRwdToPc(t);
  }

  function markUserEdited(e){
    const t = e.target && e.target.closest('.mobile-accordion [data-api]');
    if (!t) return;
    t.dataset.userEdited = '1';
  }

  // Wire events
  document.addEventListener('focusin', markUserEdited, true);
  document.addEventListener('keydown', markUserEdited, true);
  document.addEventListener('mousedown', markUserEdited, true);
  document.addEventListener('input',  onRwdEvent, true);
  document.addEventListener('change', onRwdEvent, true);

  // Initial PC -> RWD hydrate on load, tab show, and accordion expand
  document.addEventListener('DOMContentLoaded', hydrateFromPcWithRetry);
  document.addEventListener('shown.bs.collapse', hydrateFromPcWithRetry, true);
  document.addEventListener('shown.bs.tab', hydrateFromPcWithRetry, true);

  // Manual hook for partial rerender
  window.__HydrateRwdFromPc__ = hydrateFromPcWithRetry;
})();
</script>
<!-- END: PC-first Hydrator & Guarded RWD‚ÜíPC (personal fields) -->


<!-- BEGIN: Mirror PC filter to RWD (show only passengers visible in PC table) -->
<script>
(function(){
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }

  function isVisible(el){
    if (!el) return false;
    if (!(el.offsetWidth || el.offsetHeight || el.getClientRects().length)) return false;
    const cs = getComputedStyle(el);
    return cs.display !== 'none' && cs.visibility !== 'hidden' && cs.opacity !== '0';
  }

  function getVisiblePcDocIds(){
    const ids = [];
    const rows = qsa('.table-responsive tbody tr');
    rows.forEach(function(tr){
      if (!isVisible(tr)) return;
      const cell = tr.querySelector('[data-id]');
      const id = cell && cell.getAttribute('data-id');
      if (id) ids.push(id);
    });
    return ids;
  }

  function annotateRwdCards(){
    qsa('.mobile-accordion .accordion-item').forEach(function(item){
      if (!item.hasAttribute('data-passenger-id')){
        const el = item.querySelector('[data-id]');
        if (el) item.setAttribute('data-passenger-id', el.getAttribute('data-id'));
      }
    });
  }

  function applyRwdPassengerFilter(docIds){
    annotateRwdCards();
    const items = qsa('.mobile-accordion .accordion-item');
    const showAll = !docIds || !docIds.length;
    let firstShown = null;
    items.forEach(function(item){
      const pid = item.getAttribute('data-passenger-id');
      const show = showAll || (pid && docIds.indexOf(pid) >= 0);
      item.style.display = show ? '' : 'none';
      if (show && !firstShown) firstShown = item;
    });
    if (firstShown){
      const btn = firstShown.querySelector('.accordion-button');
      if (btn && btn.classList.contains('collapsed')){
        try { btn.click(); } catch(e){}
      }
    }
  }

  function syncRwdWithPcFilter(){
    const ids = getVisiblePcDocIds();
    applyRwdPassengerFilter(ids);
  }

  // --- Hooks ---
  // 1) On modal "apply" buttons: after click, wait a tick for PC to update then mirror to RWD
  document.addEventListener('click', function(e){
    const isApply = e.target.closest('.btn-apply-filter, [data-action="apply-filter"], .modal .btn-primary');
    if (!isApply) return;
    setTimeout(syncRwdWithPcFilter, 50);
    setTimeout(syncRwdWithPcFilter, 220);
  }, true);

  // 2) When any modal closes, mirror again (PC likely finished)
  document.addEventListener('hidden.bs.modal', function(){
    setTimeout(syncRwdWithPcFilter, 50);
  }, true);

  // 3) Observe PC table for visibility or content changes
  (function observePc(){
    const table = document.querySelector('.table-responsive tbody');
    if (!table) return;
    const mo = new MutationObserver(function(){
      syncRwdWithPcFilter();
    });
    mo.observe(table, {attributes:true, attributeFilter:['style','class'], childList:true, subtree:true});
    // Initial sync
    syncRwdWithPcFilter();
  })();

  // Manual API (debug/force)
  window.syncRwdWithPcFilter = syncRwdWithPcFilter;
})();
</script>
<!-- END: Mirror PC filter to RWD -->


<!-- BEGIN: Mirror PC filter to RWD (row-level logic, ignores parent visibility) -->
<script>
(function(){
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function getScope(){
    try{
      var pnr = window.getCurrentPNR && window.getCurrentPNR();
      var scope = pnr ? document.querySelector('#tab'+pnr) : document;
      return scope || document;
    }catch(e){ return document; }
  }
  function rowHidden(tr){
    if (!tr) return true;
    if (tr.hasAttribute('hidden')) return true;
    var st = (tr.getAttribute('style')||'').toLowerCase();
    if (st.indexOf('display:none') >= 0) return true;
    var cls = tr.className || '';
    if (/(^|\s)(d-none|hidden|is-hidden)(\s|$)/i.test(cls)) return true;
    return false; // treat as visible per PC filter
  }
  function getPcDocIdsByFilter(){
    var scope = getScope();
    var ids = [];
    qsa('.table-responsive tbody tr', scope).forEach(function(tr){
      if (rowHidden(tr)) return;
      var cell = tr.querySelector('[data-id]');
      var id = cell && cell.getAttribute('data-id');
      if (id) ids.push(id);
    });
    return ids;
  }
  function annotateRwdCards(){
    var scope = getScope();
    qsa('.mobile-accordion .accordion-item', scope).forEach(function(item){
      if (!item.hasAttribute('data-passenger-id')){
        var inner = item.querySelector('[data-id]');
        if (inner) item.setAttribute('data-passenger-id', inner.getAttribute('data-id'));
      }
    });
  }
  function applyRwdFilter(ids){
    var scope = getScope();
    annotateRwdCards();
    var showAll = !ids || !ids.length;
    var firstShown = null;
    qsa('.mobile-accordion .accordion-item', scope).forEach(function(item){
      var pid = item.getAttribute('data-passenger-id');
      var show = showAll || (pid && ids.indexOf(pid) >= 0);
      item.style.display = show ? '' : 'none';
      if (show && !firstShown) firstShown = item;
    });
    if (firstShown){
      var btn = firstShown.querySelector('.accordion-button');
      if (btn && btn.classList.contains('collapsed')){
        try{ btn.click(); }catch(e){}
      }
    }
  }
  function syncMirror(){
    var ids = getPcDocIdsByFilter();
    applyRwdFilter(ids);
  }

  // Hooks
  document.addEventListener('click', function(e){
    var apply = e.target.closest('.btn-apply-filter, [data-action="apply-filter"], .modal .btn-primary, .btn-primary.apply-filter');
    if (!apply) return;
    setTimeout(syncMirror, 60);
    setTimeout(syncMirror, 240);
  }, true);
  document.addEventListener('hidden.bs.modal', function(){ setTimeout(syncMirror, 60); }, true);

  // Rebuild when PC table updates
  (function observePc(){
    var scope = getScope();
    var tbody = scope.querySelector('.table-responsive tbody');
    if (!tbody) return;
    var mo = new MutationObserver(function(){ syncMirror(); });
    mo.observe(tbody, {attributes:true, attributeFilter:['style','class','hidden'], childList:true, subtree:true});
  })();

  // Also mirror on tab show / DOM ready
  document.addEventListener('shown.bs.tab', function(){ setTimeout(syncMirror, 50); }, true);
  document.addEventListener('DOMContentLoaded', function(){ setTimeout(syncMirror, 100); });

  // Manual
  window.syncRwdWithPcFilter = syncMirror;
})();
</script>
<!-- END: Mirror PC filter to RWD (row-level logic, ignores parent visibility) -->


<!-- BEGIN: RWD strict hide style -->
<style>
  /* force-hide helper */
  .rwd-filter-hidden { display: none !important; }
  .mobile-accordion .accordion-item[hidden] { display: none !important; }
</style>
<!-- END: RWD strict hide style -->

<!-- BEGIN: RWD strict passenger filter (mirror PC rows robustly) -->
<script>
(function(){
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function qs(sel, root){ return (root||document).querySelector(sel); }

  function inActiveTabScope(){
    // Try scope to active PNR tab if available
    try {
      var getPNR = window.getCurrentPNR && window.getCurrentPNR();
      if (getPNR) {
        var panel = document.querySelector('#tab' + getPNR);
        if (panel) return panel;
      }
    } catch(e){}
    return document;
  }

  function rowIsFilteredOut(tr){
    // Consider a row filtered out if it explicitly carries hidden markers on itself
    if (!tr) return false;
    if (tr.hasAttribute('hidden')) return true;
    var cls = tr.className || '';
    if (/\b(d-none|hidden|is-hidden)\b/.test(cls)) return true;
    var st = tr.getAttribute('style') || '';
    if (/display\s*:\s*none/i.test(st)) return true;
    return false;
  }

  function getPcVisibleDocIds(){
    var scope = inActiveTabScope();
    var tbody = qs('.table-responsive tbody', scope);
    if (!tbody) return [];
    var ids = [];
    qsa('tr', tbody).forEach(function(tr){
      // If PC removed rows from DOM, only remaining rows appear here (good).
      // If PC hides rows via CSS on tr, rowIsFilteredOut catches it.
      if (rowIsFilteredOut(tr)) return;
      var cell = tr.querySelector('[data-id]');
      var id = cell && cell.getAttribute('data-id');
      if (id) ids.push(id);
    });
    return ids;
  }

  var CARD_SELECTORS = [
    '.mobile-accordion .accordion-item',
    '.mobile-accordion .card',
    '.mobile-accordion [data-passenger-id]'
  ];

  function getRwdCards(){
    var scope = inActiveTabScope();
    var out = [];
    CARD_SELECTORS.forEach(function(sel){
      qsa(sel, scope).forEach(function(el){
        if (out.indexOf(el) === -1) out.push(el);
      });
    });
    return out;
  }

  function ensureCardId(card){
    if (!card) return null;
    var pid = card.getAttribute('data-passenger-id');
    if (pid) return pid;
    // Try from inner any element with data-id
    var inner = card.querySelector('[data-id]');
    if (inner) {
      pid = inner.getAttribute('data-id');
      if (pid) {
        card.setAttribute('data-passenger-id', pid);
        return pid;
      }
    }
    // Try from associated collapse target
    var hdrBtn = card.querySelector('.accordion-button[data-bs-target]');
    if (hdrBtn) {
      var tgtSel = hdrBtn.getAttribute('data-bs-target');
      var panel = document.querySelector(tgtSel);
      if (panel) {
        var inner2 = panel.querySelector('[data-id]');
        if (inner2){
          pid = inner2.getAttribute('data-id');
          if (pid) {
            card.setAttribute('data-passenger-id', pid);
            return pid;
          }
        }
      }
    }
    return null;
  }

  function hideCard(card){
    card.classList.add('rwd-filter-hidden');
    card.setAttribute('hidden','hidden');
    // Also hide its collapse panel if it lives outside the card
    var btn = card.querySelector('.accordion-button[data-bs-target]');
    if (btn){
      var sel = btn.getAttribute('data-bs-target');
      var panel = document.querySelector(sel);
      if (panel) {
        panel.classList.add('rwd-filter-hidden');
        panel.setAttribute('hidden','hidden');
      }
    }
  }
  function showCard(card){
    card.classList.remove('rwd-filter-hidden');
    card.removeAttribute('hidden');
    var btn = card.querySelector('.accordion-button[data-bs-target]');
    if (btn){
      var sel = btn.getAttribute('data-bs-target');
      var panel = document.querySelector(sel);
      if (panel) {
        panel.classList.remove('rwd-filter-hidden');
        panel.removeAttribute('hidden');
      }
    }
  }

  function applyMirror(){
    var visibleIds = getPcVisibleDocIds();
    var showAll = !visibleIds || !visibleIds.length;
    var cards = getRwdCards();
    var firstShown = null;
    cards.forEach(function(card){
      var pid = ensureCardId(card);
      var show = showAll || (pid && visibleIds.indexOf(pid) >= 0);
      if (show) {
        showCard(card);
        if (!firstShown) firstShown = card;
      } else {
        hideCard(card);
      }
    });
    if (firstShown){
      var btn = firstShown.querySelector('.accordion-button');
      if (btn && btn.classList.contains('collapsed')){
        try { btn.click(); } catch(e){}
      }
    }
  }

  // Observe PC tbody for changes in attributes/class/style and child list
  function observePc(){
    var scope = inActiveTabScope();
    var tbody = qs('.table-responsive tbody', scope);
    if (!tbody) return;
    var mo = new MutationObserver(function(){
      applyMirror();
    });
    mo.observe(tbody, {attributes:true, attributeFilter:['style','class','hidden'], childList:true, subtree:true});
    applyMirror();
  }

  // Hooks
  document.addEventListener('DOMContentLoaded', observePc);
  document.addEventListener('shown.bs.modal', function(){ setTimeout(applyMirror, 80); }, true);
  document.addEventListener('hidden.bs.modal', function(){ setTimeout(applyMirror, 80); }, true);
  document.addEventListener('shown.bs.tab', function(){ setTimeout(applyMirror, 80); }, true);
  window.syncRwdWithPcFilterStrict = applyMirror;
})();
</script>
<!-- END: RWD strict passenger filter -->

</body>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    
    <script type="text/javascript">
        
        var pnrC1DisabledMap = {};
    function goToNextStep() {
        const flightPrefix = document.getElementById('flightPrefix').value;
        const flightNumber = document.getElementById('flightNumber_display').value;
        const departureDate = document.getElementById('{!$Component.searchForm.departureDate}').value;
        const departureLocation = document.querySelector('[id$="departureLocation"]').value;
        const bookingCodes = document.getElementById('{!$Component.searchForm.bookingCodes}').value;
        
        if (!flightNumber || !departureDate || !departureLocation || !bookingCodes) {
            alert('Ë´ãÂÖàÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç„ÄÇ');
            return;
        }
        
        // ÁµÑÂêàURL‰∏¶Ë∑≥ËΩâËá≥‰∏ã‰∏ÄÈ†Å
        const params = new URLSearchParams({
            flightPrefix,
            flightNumber,
            departureDate,
            departureLocation,
            bookingCodes
        });
            
            window.location.href = '/apex/SeatSelection?' + params.toString();
        }
            
            document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const flightNumber = urlParams.get('flightNumber') || '';
            const departureDate = urlParams.get('departureDate') || '';
            const bookingCodes = urlParams.get('bookingCodes') || '';
            const departureLocation = urlParams.get('departureLocation') || '';
            
            
            // Ë®≠ÁΩÆÂÄºÂà∞Â∞çÊáâÊ¨Ñ‰Ωç
            document.getElementById('flightNumber_display').value = flightNumber;
            document.getElementById('{!$Component.searchForm.flightNumber}').value = flightNumber;
            document.getElementById('{!$Component.searchForm.departureDate}').value = departureDate;
            const depEl = document.getElementById('{!$Component.searchForm.departure}');
            if (depEl && departureLocation) depEl.value = departureLocation;
            document.getElementById('{!$Component.searchForm.bookingCodes}').value = bookingCodes;
            
            // Â¶ÇÊûú select ÂÖÉÁ¥†ÊòØÁî± apex:selectList ÁîüÊàêÁöÑÔºåÂèØËÉΩÈúÄË¶ÅÈ°çÂ§ñËôïÁêÜ:
            const depSelect = document.getElementById('{!$Component.searchForm.departure}');
            if(depSelect){
            for (let option of depSelect.options) {
            if (option.value === departureLocation) {
            option.selected = true;
            break;
        }
        }
        }
            
            // ÂèØËß∏ÁôºÊêúÂ∞ã
            if (flightNumber && departureDate && (depEl?.value || departureLocation) && bookingCodes) {
            // ‚úÖ È°ØÁ§∫ loading Áï´Èù¢
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
            overlay.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
            
            // ‚úÖ Âü∑Ë°åÊêúÂ∞ã
            doSearch();
        }
            
        });
            
            let hasSearched = false;
            
            function applyDOBConstraints() {
            const departureInput = document.getElementById('{!$Component.searchForm.departureDate}');
            if (!departureInput) return;
            
            const departureDate = new Date(departureInput.value);
            if (isNaN(departureDate.getTime())) return;
            
            const dobInputs = document.querySelectorAll('input[data-api="DateOfBirth__c"]');
            dobInputs.forEach(dobInput => {
            const pt = dobInput.dataset.pt?.toUpperCase();
            if (!pt) return;
            
            let minDate = null, maxDate = null;
            
            if (pt === 'ADT') {
            maxDate = new Date(departureDate);
            maxDate.setFullYear(maxDate.getFullYear() - 12);
            minDate = new Date(1900, 0, 1);
        } else if (pt === 'CHD') {
            maxDate = new Date(departureDate);
            maxDate.setFullYear(maxDate.getFullYear() - 2);
            minDate = new Date(departureDate);
            minDate.setFullYear(minDate.getFullYear() - 12);
        } else if (pt === 'INF') {
            maxDate = new Date(departureDate);
            minDate = new Date(departureDate);
            minDate.setFullYear(minDate.getFullYear() - 2);
        } else {
            return;
        }
            
            // Â∞áÊó•ÊúüÊ†ºÂºèÂåñÁÇ∫ yyyy-MM-dd
            const formatDate = (d) => d.toISOString().split('T')[0];
            dobInput.min = formatDate(minDate);
            dobInput.max = formatDate(maxDate);
        });
        }
            
            
            
            
            document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('input[type="date"]:disabled').forEach(function (input) {
            // ÁßªÈô§‰ªª‰ΩïËàäÁöÑ class
            input.classList.remove('always-visible');
            // Â¶ÇÊûúÊúâÂÄºÔºåÂâáÂä†‰∏ä always-visible classÔºå‰ΩøÂÖ∂È°ØÁ§∫Âá∫‰æÜ
            if (input.value && input.value.trim() !== '') {
            input.classList.add('always-visible');
        }
        });
        });
            
            //bookingCodesÂç°Êéß
            /*
    document.addEventListener('DOMContentLoaded', function () {
        const bookingInput = document.getElementById('{!$Component.searchForm.bookingCodes}');
        if (bookingInput) {
            bookingInput.setAttribute('maxlength', '50');
            
            bookingInput.addEventListener('input', function () {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9,]/g, '');
            });
        }
    });
    */
            document.addEventListener('DOMContentLoaded', function () {
            const bookingInput = document.getElementById('{!$Component.searchForm.bookingCodes}');
            if (bookingInput) {
            bookingInput.setAttribute('maxlength', '50');
            
            let isComposing = false;
            
            bookingInput.addEventListener('compositionstart', function () {
            isComposing = true;
        });
            
            bookingInput.addEventListener('compositionend', function () {
            isComposing = false;
            // ÁµÑÂ≠óÁµêÊùüÂæåÂÜçÊ∏ÖÁêÜËº∏ÂÖ•
            this.value = this.value.toUpperCase().replace(/[^A-Z0-9,]/g, '');
        });
            
            bookingInput.addEventListener('input', function () {
            if (isComposing) return; // ÁµÑÂ≠ó‰∏≠‰∏çËôïÁêÜ
            this.value = this.value.toUpperCase().replace(/[^A-Z0-9,]/g, '');
        });
        }
        });
            
            
            //Ëà™Áè≠ËôüÁ¢º
            function limitFlightInput(el) {
            let raw = el.value.toUpperCase().replace(/[^0-9A-Z]/g, ''); 
            raw = raw.slice(0, 5); 
            
            const match = raw.match(/^(\d*)([A-Z]*)$/);
            if (!match) {
            el.value = raw;
            return;
        }
            
            let numberPart = match[1];
            let letterPart = match[2];
            
            if (letterPart.length === 0) {
            numberPart = numberPart.slice(0, 4);
        } else {
            const maxDigits = 5 - letterPart.length;
            numberPart = numberPart.slice(0, maxDigits);
        }
            
            el.value = numberPart + letterPart;
        }
            
            
            function formatFlightNumber() {
            const displayEl = document.getElementById('flightNumber_display');
            const hiddenEl = document.getElementById('{!$Component.searchForm.flightNumber}');
            
            let raw = displayEl.value.trim().toUpperCase();
            const match = raw.match(/^(\d*)([A-Z]*)$/);
            
            if (!match) {
            hiddenEl.value = raw;
            displayEl.value = raw;
            return;
        }
            
            let numberPart = match[1];
            const letterPart = match[2];
            
            if (letterPart.length === 0) {
            // Á¥îÊï∏Â≠óÔºöË£ú 0 Âà∞ 4 Á¢º
            numberPart = numberPart.padStart(4, '0');
        } else {
            // Âê´Ëã±ÊñáÔºöË£ú 0 Âà∞Á∏ΩÈï∑ 5 Á¢º
            const padLength = 5 - letterPart.length;
            numberPart = numberPart.padStart(padLength, '0');
        }
            
            const formatted = numberPart + letterPart;
            
            displayEl.value = formatted;
            hiddenEl.value = raw;
        }
            
            function cleanVisaInput(input, type) {
            let val = input.value.toUpperCase();
            if (type === 'number') {
            val = val.substring(0, 25);
        }
            
            if (type === 'applicant') {
            val = val.substring(0, 25);
        }
            
            if (type === 'country') {
            val = val.substring(0, 3);
        }
            
            if (type === 'visaCountry') {
            val = val.substring(0, 3);
        }
            
            
            
            input.value = val;
        }
            
            
            //Á∞ΩË≠âË≥áÊñôÂàó
            function validateVisaInput(input, type) {
            const value = input.value.trim().toUpperCase();
            input.value = value;
            input.classList.remove('is-invalid');
            const old = input.parentElement.querySelector('.invalid-feedback');
            if (old) old.remove();
            
            let isValid = true;
            let errorMsg = '';
            
            const containsChinese = /[\u4e00-\u9fa5]/.test(value);
            
            
            if (['number', 'applicant'].includes(type)) {
            if (!/^[A-Z0-9]{1,25}$/.test(value)) {
            isValid = false;
            errorMsg = 'ÂÉÖËã±ÊñáÂ≠ó„ÄÅÊï∏Â≠ó';
        }
        }
            
            if (type === 'visaCountry') {
            if (!/^[A-Z]+$/.test(value)) {
            isValid = false;
            errorMsg = 'ÂÉÖËã±ÊñáÂ≠ó';
        } else if (value.length !== 3) {
            isValid = false;
            errorMsg = 'Ë´ãËº∏ÂÖ•3ÂÄãÂ≠óÂÖÉ';
        }
        }
            
            if (type === 'visaDate') {
            const departureStr = document.getElementById('{!$Component.searchForm.departureDate}').value;
            const depDate = new Date(departureStr);
            const inputDate = new Date(value);
            if (!/^\d{4}-\d{2}-\d{2}$/.test(value) || isNaN(inputDate.getTime()) || inputDate < depDate) {
            isValid = false;
            errorMsg = 'Êó•Êúü‰∏çÂèØÊó©ÊñºËµ∑È£õÊó•';
        }
        }
            
            if (!isValid) {
            input.classList.add('is-invalid');
            const fb = document.createElement('div');
            fb.className = 'invalid-feedback';
            fb.textContent = errorMsg;
            input.parentElement.appendChild(fb);
        }
        }
            
            
            //Á∞ΩË≠âModal
            function saveGroupVisa() {
            // Ê∏ÖÈô§ËàäÊúâÈåØË™§ÊèêÁ§∫
            document.querySelectorAll('#groupVisaModal input').forEach(input => {
            input.classList.remove('is-invalid');
            const feedback = input.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.remove();
        }
        });
            
            const rules = [
            {
            id: 'applicant',
            label: 'Ë≠â‰ª∂ËôüÁ¢º',
            required: true,
            max: 25,
            pattern: /^[A-Z0-9]+$/i,
            transform: v => v.toUpperCase(),
            errorMsg: 'ÂÉÖÈôêËã±Êñá„ÄÅÊï∏Â≠ó'
        },
                                           {
                                               id: 'visaDate',
                                               label: 'Âà∞ÊúüÊó•',
                                               required: true,
                                               validate: function (value) {
                                                   const departure = document.getElementById('{!$Component.searchForm.departureDate}').value;
                                                   const inputDate = new Date(value);
                                                   const departureDate = new Date(departure);
                                                   if (!/^\d{4}[-/]\d{2}[-/]\d{2}$/.test(value)) return 'Ë´ãËº∏ÂÖ•ÊúâÊïàÊó•Êúü';
                                                   if (isNaN(inputDate.getTime())) return 'Ê†ºÂºèÈåØË™§';
                                                   if (inputDate < departureDate) return 'Êó•Êúü‰∏çÂèØÊó©ÊñºËµ∑È£õÊó•';
                                                   return '';
                                               }
                                           },
                                           {
                                               id: 'visaCountry',
                                               label: 'ÁôºÁÖßÂúãÂÆ∂(ÈÅ©Áî®ÂúãÂÆ∂)',
                                               required: true,
                                               transform: v => v.toUpperCase(),
                                               validate: function (value) {
                                                   if (value === '') return ''; // Ê≤íÂ°´Â∞±Ë∑≥ÈÅéÈ©óË≠â
                                                   if (!/^[A-Z]+$/i.test(value)) return 'ÂÉÖÈôêËã±Êñá';
                                                   if (value.length !== 3) return 'Ë´ãËº∏ÂÖ•3ÂÄãÂ≠óÂÖÉ';
                                                   return '';
                                               }
                                           }
                                           
                                           ];
                                           
                                           let isValid = true;
                                           
                                           rules.forEach(rule => {
                                           const input = document.getElementById(rule.id);
            let value = input.value.trim();
            if (rule.transform) value = rule.transform(value);
            input.value = value;
            
            if (rule.required && value === '') {
                showInputError(input, 'ÂøÖÂ°´');
                isValid = false;
                return;
            }
            
            /*if (rule.id === 'visaCountry' && value !== '') {
            if (/[\u4e00-\u9fa5]/.test(value)) {
                showInputError(input, 'ÂÉÖÈôêËã±Êñá');
                isValid = false;
            }
        }*/
            
            
            if (rule.length && value.length !== rule.length) {
                showInputError(input, `Ë´ãËº∏ÂÖ• ${rule.length} ÂÄãÂ≠óÂÖÉ`);
                isValid = false;
                return;
            }
            
            if (rule.max && value.length > rule.max) {
                showInputError(input, `Èï∑Â∫¶‰∏çÂèØË∂ÖÈÅé ${rule.max} Á¢º`);
                isValid = false;
                return;
            }
            
            if (rule.pattern && !rule.pattern.test(value)) {
                showInputError(input, rule.errorMsg || 'Ê†ºÂºèÈåØË™§');
                isValid = false;
                return;
            }
            
            if (typeof rule.validate === 'function') {
                const msg = rule.validate(value);
                if (msg) {
                    showInputError(input, msg);
                    isValid = false;
                    return;
                }
            }
        });
    
    if (!isValid) return;
    
    // ÂõûÂ°´ÂÄºÂà∞Á∞ΩË≠âÂàó
    const currentTab = document.querySelector('.tab-pane.show.active');
    if (!currentTab) return;
    
    const visaNumber = document.getElementById('applicant').value.trim();
    const visaExpiryDate = document.getElementById('visaDate').value.trim();
    const visaCountry = document.getElementById('visaCountry').value.trim();
    
    const rows = currentTab.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const docTypeEl = row.querySelector('.travel-document');
        if (docTypeEl && docTypeEl.textContent.trim() === 'Á∞ΩË≠â') {
        const inputs = row.querySelectorAll('input.ClearItems');
        if (inputs.length >= 3) {
        inputs[0].value = visaNumber;
        inputs[1].value = visaExpiryDate;
        inputs[2].value = visaCountry;
        
        [0, 1, 2].forEach(i => {
        inputs[i].style.boxShadow = '0 0 5px 2px #00bfff';
        setTimeout(() => inputs[i].style.boxShadow = '', 1000);
    });
    }
    }
    });
    
    const modalElement = document.getElementById('groupVisaModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    modal.hide();
    }
    
    function cleanPassportInput(input) {
        const api = input.dataset.api;
        let val = input.value.toUpperCase(); // ‰øùÁïôÂ§ßÂ∞èÂØ´ËΩâÊèõÔºå‰ΩÜ‰∏çÈÅéÊøæ‰ªª‰ΩïÂ≠óÂÖÉ
        
        if (api === 'PassportNumber__c') {
            val = val.substring(0, 15);
        } else if (api === 'USAStreet__c' || api === 'UScity__c') {
            val = val.substring(0, 35);
        } else if (api === 'USpostalcode__c') {
            val = val.substring(0, 5);
        } else if (api === 'UScontact__c') {
            val = val.substring(0, 50);
        } else if (api === 'UScontactNationality__c' || api === 'VisaIssuingCountry__c' || api === 'nationality__c' || api === 'PassportIssuingCountry__c') {
            val = val.substring(0, 3);
        } else if (api === 'UScontactphone__c') {
            val = val.substring(0, 20);
        }
        
        input.value = val;
    }
    
    
    function validatePassportInput(input) {
        const api = input.dataset.api;
        const value = input.value.trim().toUpperCase();
        input.value = value;
        input.classList.remove('is-invalid');
        const old = input.parentElement.querySelector('.invalid-feedback');
        if (old) old.remove();
        
        let isValid = true;
        let errorMsg = '';
        
        if (api === 'PassportNumber__c') {
            if (!/^[A-Z0-9]{1,15}$/.test(value)) {
                isValid = false;
                errorMsg = 'ÂÉÖËã±ÊñáÂ≠ó„ÄÅÊï∏Â≠ó';
            }
        } else if (api === 'PassportIssuingCountry__c' || api === 'nationality__c' || api === 'nationality__c' || api === 'VisaIssuingCountry__c' ) {
            if (!/^[A-Z]{1,15}$/.test(value)) {
                isValid = false;
                errorMsg = 'ÂÉÖËã±ÊñáÂ≠ó';
            } else if (value.length !== 3) {
                isValid = false;
                errorMsg = 'Ë´ãËº∏ÂÖ•3ÂÄãÂ≠óÂÖÉ';
            }
        } else if (api === 'USstate__c') {
            if (!value || value === '' || value === 'Ë´ãÈÅ∏Êìá') {
                isValid = false;
                errorMsg = 'ÂøÖÂ°´';
            }
        } else if (api === 'USAStreet__c' || api === 'UScity__c') {
            if (!/^[A-Z0-9 ]{1,35}$/.test(value)) {
                isValid = false;
                errorMsg = 'ÂÉÖËã±ÊñáÂ≠ó„ÄÅÊï∏Â≠ó„ÄÅÁ©∫Ê†º';
            }
        } else if (api === 'USpostalcode__c') {
            if (!/^\d{1,5}$/.test(value)) {
                isValid = false;
                errorMsg = 'ÂÉÖÊï∏Â≠ó';
            }
        } else if (api === 'UScontact__c') {
            if (!/^[A-Z ]{1,50}$/.test(value)) {
                isValid = false;
                errorMsg = 'ÂÉÖËã±ÊñáÂ≠ó„ÄÅÁ©∫Ê†º';
            }
        } else if (api === 'UScontactNationality__c') {
            if (!/^[A-Z ]{1,50}$/.test(value)) {
                isValid = false;
                errorMsg = 'ÂÉÖËã±ÊñáÂ≠ó';
            } else if (value.length !== 3) {
                isValid = false;
                errorMsg = 'Ë´ãËº∏ÂÖ•3ÂÄãÂ≠óÂÖÉ';
            }
            
            /*} else if (api === 'UScontactNationality__c' ||api === 'VisaIssuingCountry__c' ||api === 'nationality__c' ||api === 'PassportIssuingCountry__c') {
            if (!/^[A-Z]{3}$/.test(value)) {
                isValid = false;
                errorMsg = 'Ë´ãËº∏ÂÖ•3ÂÄãÂ≠óÂÖÉ';
            }*/
        } else if (api === 'UScontactphone__c') {
            if (!/^[0-9 ]{1,20}$/.test(value)) {
                isValid = false;
                errorMsg = 'ÂÉÖÊï∏Â≠ó';
            }
        }
        
        if (!isValid) {
            input.classList.add('is-invalid');
            const fb = document.createElement('div');
            fb.className = 'invalid-feedback';
            fb.textContent = errorMsg;
            input.parentElement.appendChild(fb);
        }
    }
    
    
    
    //ÁæéÂúãÂú∞ÂùÄmodal
    function saveUSAddress() {
        document.querySelectorAll('#usAddressModal input, #usAddressModal select').forEach(input => {
            input.classList.remove('is-invalid');
            const feedback = input.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.remove();
        }
        });
            
            const validations = [
            { id: 'address', label: 'Ë°óÈÅì', required: true, max: 35, pattern: /^[A-Z0-9 ]+$/i, errorMsg: 'ÂÉÖËã±ÊñáÂ≠ó„ÄÅÊï∏Â≠ó„ÄÅÁ©∫Ê†º' },
                                                                                           { id: 'city', label: 'ÂüéÂ∏Ç', required: true, max: 35, pattern: /^[A-Z0-9 ]+$/i, errorMsg: 'ÂÉÖËã±ÊñáÂ≠ó„ÄÅÊï∏Â≠ó„ÄÅÁ©∫Ê†º' },
                                                                                           { id: 'state', label: 'Â∑û/ÁúÅ', required: true},
                                                                                           { id: 'postalCode', label: 'ÈÉµÈÅûÂçÄËôü', required: true, max: 5, pattern: /^[0-9]+$/, errorMsg: 'ÂÉÖÊï∏Â≠ó' },
                                                                                           { id: 'emergencyContact', label: 'Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂßìÂêç', required: true, max: 50, pattern: /^[A-Z ]+$/i, errorMsg: 'ÂÉÖËã±ÊñáÂ≠ó„ÄÅÁ©∫Ê†º' },
                                                                                           { id: 'emergencyNationality', label: 'Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂúãÁ±ç', required: true, pattern: /^[A-Z]+$/, errorMsg: 'ÂÉÖËã±ÊñáÂ≠ó',length: 3 },
                                                                                           { id: 'phone', label: 'Á∑äÊÄ•ËÅØÁµ°‰∫∫ÈõªË©±', required: true, max: 20, pattern: /^[0-9 ]+$/, errorMsg: 'ÂÉÖÊï∏Â≠ó' }
                                                                                           ];
                                                                                           
                                                                                           let isValid = true;
                                                                                           for (let rule of validations) {
            const input = document.getElementById(rule.id);
            let value = input.value.trim().toUpperCase();
            input.value = value;
            
            // ÂøÖÂ°´È©óË≠â
            if (rule.required && value === '') {
                showInputError(input, 'ÂøÖÂ°´');
                isValid = false;
                continue;
            }
            
            if (rule.id === 'state') {
                validatePassportInput(input);
                if (input.classList.contains('is-invalid')) {
                    isValid = false;
                    continue;
                }
            }
            
            // ÁâπÊÆäËôïÁêÜÁ∑äÊÄ•ËÅØÁµ°‰∫∫ÂúãÁ±çÈï∑Â∫¶
            if (rule.id === 'emergencyNationality') {
                // ÂÖàÊìã‰∏≠ÊñáÔºà‰ªª‰Ωï„ÄåÊº¢Â≠ó„ÄçÔºâ
                if (/\p{Script=Han}/u.test(value)) {
                    showInputError(input, 'ÂÉÖËã±ÊñáÂ≠ó');
                    isValid = false;
                    continue;
                }
                
                // Èï∑Â∫¶ÈúÄÁÇ∫ 3
                if (value.length !== 3) {
                    showInputError(input, 'Ë´ãËº∏ÂÖ•3ÂÄãÂ≠óÂÖÉ');
                    isValid = false;
                    continue;
                }
            }
            
            
            // Èï∑Â∫¶È©óË≠â
            if (rule.length && value.length !== rule.length) {
                showInputError(input, `Ë´ãËº∏ÂÖ• ${rule.length} ÂÄãÂ≠óÂÖÉ`);
                isValid = false;
                continue;
            }
            
            if (rule.max && value.length > rule.max) {
                showInputError(input, `${rule.label}Èï∑Â∫¶‰∏çÂèØË∂ÖÈÅé ${rule.max} Á¢º`);
                isValid = false;
                continue;
            }
            
            if (rule.pattern && !rule.pattern.test(value)) {
                showInputError(input, rule.errorMsg || `${rule.label}Ê†ºÂºèÈåØË™§`);
                isValid = false;
                continue;
            }
        }
        
        if (!isValid) return;
        
        // Â°´ÂÄº + highlight
        const data = {};
        document.querySelectorAll('#usAddressModal input[data-api], #usAddressModal select[data-api]').forEach(input => {
            const key = input.getAttribute('data-api');
            const val = input.value.trim();
            data[key] = val;
        });
        
        const currentTab = document.querySelector('.tab-pane.show.active');
        if (!currentTab) return;
        
        const rows = currentTab.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const docTypeEl = row.querySelector('.travel-document');
            if (docTypeEl && docTypeEl.textContent.trim() === 'Ë≠∑ÁÖß') {
            row.querySelectorAll('input.ClearItems[data-api], select.ClearItems[data-api]').forEach(input => {
            const api = input.getAttribute('data-api');
            if (data[api] !== undefined) {
            input.value = data[api];
            input.dispatchEvent(new Event('blur', { bubbles: true })); // ‚Üê 0813‰øÆÊ≠£blur
        input.style.boxShadow = '0 0 5px 2px #00bfff';
        setTimeout(() => input.style.boxShadow = '', 1000);
    }
    });
    }
    });
    const modalElement = document.getElementById('usAddressModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    modal.hide();
    }
    
    
    function showInputError(input, message) {
        input.classList.add('is-invalid');
        
        const td = input.parentNode;
        td.style.position = 'relative';      // ‚Üê ‰øùÈö™ÔºöÁ¢∫‰øùÂèØÂÅö absolute ÂÆö‰Ωç
        
        const div = document.createElement('div');
        div.className = 'invalid-feedback';
        div.textContent = message;
        td.appendChild(div);
    }
    
    
    
    
    //Ë≥áÊñôÂÖßÁöÑÊ∏ÖÈô§ÂèäÁæéÂúãÂú∞ÂùÄÊåâÈàï
    const actionButtons = document.querySelectorAll('.actionbtn');
    actionButtons.forEach(b => {
        b.disabled = false;
        b.style.cursor = 'pointer';
    });
        
        
        document.addEventListener('DOMContentLoaded', function () {
        
        /* 1Ô∏è‚É£ ÂèñÂæóÊó•ÊúüËº∏ÂÖ•Ê°Ü */
        const dateEl = document.getElementById(
        '{!$Component.searchForm.departureDate}'
        );
        
        /* 2Ô∏è‚É£ ÁÆóÂá∫„Äå‰ªäÂ§© ‚Äì 4 Â§©„Äç */
        const today  = new Date();
        /*const minDay = new Date(today.getFullYear(),   
        today.getMonth(),      
        today.getDate() - 4);  
        */
        /* 3Ô∏è‚É£ ËΩâÊàê yyyy-MM-dd Ê†ºÂºè (date input ÈúÄË¶Å) */
        const pad = n => n.toString().padStart(2, '0');
        const minStr = [
        minDay.getFullYear(),
        pad(minDay.getMonth() + 1),
        pad(minDay.getDate())
        ].join('-');
        
        /* 4Ô∏è‚É£ ÂØ´ÂÖ• min Â±¨ÊÄß */
        dateEl.setAttribute('min', minStr);
        
        /* 5Ô∏è‚É£ Ëã•Ê¨Ñ‰ΩçÈ†êË®≠ÂÄº < minÔºå‰πüÂêåÊ≠•Ë™øÊï¥ */
        if (dateEl.value && dateEl.value < minStr) {
        dateEl.value = minStr;
    }
    });
        
        
        document.addEventListener('click', function(event) {
        // Â∞ãÊâæÊâÄÊúâ notification Èù¢ÊùøÔºàÂèØËÉΩÊúâÂ§öÂÄãÔºâ
        const notifications = document.querySelectorAll('.notification-panel');
        
        notifications.forEach(function(notification) {
        // Â¶ÇÊûúÈªûÊìäÁöÑ‰∏çÊòØ notification Ë£°Èù¢ÁöÑÊù±Ë•øÔºåÂ∞±ÈóúÈñâ
        if (!notification.contains(event.target)) {
        notification.style.display = 'none';
    }
    });
    });
        
        // Êñá‰ª∂‰∏äÂÇ≥Áõ∏ÈóúÁöÑ JavaScript
        document.addEventListener('DOMContentLoaded', function() {
        const uploadButton = document.getElementById('uploadButton');
        const fileInput = document.getElementById('fileUpload');
        
        uploadButton.addEventListener('click', function() {
        fileInput.click();
    });
        
        /*function showErrorToast(message) {
        const toastId = 'customToast';
        let existing = document.getElementById(toastId);
        if (existing) existing.remove();
        
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = 'toast align-items-center text-white bg-danger border-0 show';
        toast.style.position = 'fixed';
        toast.style.bottom = '100px';
        toast.style.right = '20px';
        toast.style.zIndex = '9999';
        toast.style.minWidth = '200px';
        
        toast.innerHTML = `
        <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove();"></button>
        </div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
        if (document.body.contains(toast)) toast.remove();
    }, 5000);
    }*/
        function showErrorToast(message) {
        const id = 'notification-error-toast';
        let existing = document.getElementById(id);
        if (existing) existing.remove();
        
        const div = document.createElement('div');
        div.id = id;
        div.className = 'notification-panel-error';
        div.innerHTML = `
        <span style="margin-right:8px;">
        <img src="/resource/alertFailed" height="20" style="margin-bottom:3px;margin-right:5px">
        </span>
        <p class="error-message-text" style="margin:0;margin-top:2px;">${message}</p>
        <div class="slds-notify__close">
        <input type="button" value="x" class="close-button" onclick="this.parentElement.parentElement.remove()"/>
        </div>
        `;
        
        Object.assign(div.style, {
        zIndex: '2000',
        position: 'fixed',
        top: '40px',
        left: '50%',
        transform: 'translateX(-50%)',
        backgroundColor: '#E74C3C',
        color: 'white',
        padding: '10px 40px 10px 10px',
        boxShadow: '0 4px 8px rgba(0, 0, 0, 0.1)',
        borderRadius: '4px',
        maxWidth: '90%',
        minWidth: '200px',
        whiteSpace: 'nowrap',
        display: 'flex',
        alignItems: 'center'
    });
    
    document.body.appendChild(div);
    setTimeout(() => {
        if (document.body.contains(div)) div.remove();
    }, 5000);
    }
    
    //Erick 2025/5/19 Ëß£Êûê‰∏äÂÇ≥ ÈúÄË¶ÅÂÜçÊâìÈñã
    function debugLog(msg) {
        /*const panel = document.getElementById('csv-debug-panel');
    	const logBox = document.getElementById('csv-debug-log');
    	panel.style.display = 'block';
    	logBox.innerText += msg + '\n';*/
    }
    
    
    // üîç Ê™¢Êü•ÊòØÂê¶ÁÇ∫‰∫ÇÁ¢ºÔºàÈùû UTF-8 Á∑®Á¢ºÁöÑÂèØËÉΩÊÄßÔºâ
    function isPossiblyGarbled(text) {
        const suspiciousChar = / /;
        return suspiciousChar.test(text);
    }
    
    //Erick 2025/6/3 Ëß£Êûê‰∏äÂÇ≥
    fileInput.addEventListener('change', function (e) {
        const file = this.files[0];
        if (!file) return;
        
        const maxSize = 1 * 1024 * 1024; // 1MB
        
        // üß® 1. Ê™¢Êü•ÂâØÊ™îÂêç
        if (!file.name.toLowerCase().endsWith('.csv')) {
            showErrorToast('‰∏äÂÇ≥Ê™îÊ°àÂÉÖÊé•Âèó CSV Ê†ºÂºè');
            fileInput.value = '';
            return;
        }
        
        // üß® 2. Ê™¢Êü•Ê™îÊ°àÂ§ßÂ∞è
        if (file.size > maxSize) {
            showErrorToast('‰∏äÂÇ≥Ê™îÊ°àÈúÄÂ∞èÊñºÁ≠âÊñº1MB');
            fileInput.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function (event) {
            const csvText = event.target.result;
            
            if (csvText.includes('\uFFFD')) {
                showErrorToast('‰∏äÂÇ≥Ê™îÊ°àÁ∑®Á¢ºÈùû UTF-8');
                fileInput.value = '';
                return;
            }
            
            const parsed = Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true
            });
            
            // ‚úÖ Ê™¢Êü•Ê¨Ñ‰ΩçÂêçÁ®±ËàáÈ†ÜÂ∫è
            const expectedHeader = [
                'Ê¨Ñ‰ΩçÂêçÁ®±','ÊóÖÂÆ¢ÂßìÂêç','Á®±Ë¨Ç','ÊÄßÂà•','ÂúãÁ±ç','Âá∫ÁîüÊó•Êúü','Ë≠∑ÁÖß',
                'Ë≠∑ÁÖß_Ë≠â‰ª∂ËôüÁ¢º','Ë≠∑ÁÖß_Âà∞ÊúüÊó•','Ë≠∑ÁÖß_ÁôºÁÖßÂúãÂÆ∂(ÈÅ©Áî®ÂúãÂÆ∂)',
                'Á∞ΩË≠â','Á∞ΩË≠â_Ë≠â‰ª∂ËôüÁ¢º','Á∞ΩË≠â_Âà∞ÊúüÊó•','Á∞ΩË≠â_ÁôºÁÖßÂúãÂÆ∂(ÈÅ©Áî®ÂúãÂÆ∂)',
                'Ë°óÈÅì','ÂüéÂ∏Ç','Â∑û/ÁúÅ','ÂúãÁ±ç/Âú∞ÂçÄ','ÈÉµÈÅûÂçÄËôü',
                'Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂßìÂêç','Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂúãÁ±ç','Á∑äÊÄ•ËÅØÁµ°‰∫∫ÈõªË©±'
            ];
            
            const actualHeader = parsed.meta.fields.map(f => f.trim());
            
            const isHeaderMatch = expectedHeader.length === actualHeader.length &&
                expectedHeader.every((h, i) => h === actualHeader[i]);
            
            if (!isHeaderMatch) {
                showErrorToast('‰∏äÂÇ≥Ê™îÊ°àÊ¨Ñ‰ΩçÂêçÁ®±Áº∫Â§±ÔºåË´ãÈáçÊñ∞Ê™¢Êü•');
                fileInput.value = '';
                return;
            }
            
            // üß© ÊéíÈô§Ââç 3 Á≠ÜÔºàÊ¨Ñ‰ΩçË™™ÊòéËàáÁØÑ‰æãÔºâ
            const filteredData = parsed.data.slice(2);
            
            // üß© ËôïÁêÜÁï´Èù¢ÁµêÊßãÔºåÂª∫Á´ã passengerBlocks
            const passengerBlocks = [];
            const rows = document.querySelectorAll('#searchResults tbody tr');
            let currentGroup = [];
            
            // üîß Ê®ôÊ∫ñÂåñÂêçÁ®±Áî®ÔºöÂéªÊéâÂ§öÈ§òÁ¨¶ËôüËàáÁ©∫ÁôΩ
            function normalizeName(text) {
                if (!text) return '';
                
                // ÂÖàËΩâÂ§ßÂØ´ÔºåÊñπ‰æø‰πãÂæåÊØîÂ∞ç
                let t = String(text).toUpperCase();
                
                // 1) ÁßªÈô§Èõ∂ÂØ¨Â≠óÂÖÉËàáÁï´Èù¢Áî®Á¨¶Ëôü
                t = t.replace(/[\u200B\uFEFF]/g, '') // Èõ∂ÂØ¨Á©∫ÁôΩËàá BOM
                .replace(/[‚îî|]/g, '');
                
                // 2) ÂÖàÁßªÈô§Á®±Ë¨ÇÔºàÁî®ÈùûËã±Êï∏Êàñ / ‰ΩúÁÇ∫ÈÇäÁïåÔºåÊØî \b Êõ¥Á©©Ôºâ
                t = t.replace(/(^|[^A-Z0-9/])(MR|MS|MRS|MISS|MSTR)(?=([^A-Z0-9/]|$))/g, '$1');
                                                                       
                                                                       // 3) ÁßªÈô§ÊâÄÊúâÁ©∫ÁôΩ
                                                                       t = t.replace(/\s+/g, '');
                                                                       
                                                                       // 4) ÂÉÖ‰øùÁïôËã±Êï∏ËàáÊñúÁ∑ö
                                                                       t = t.replace(/[^A-Z0-9/]/g, '');
                                                                   
                                                                   // 5) Â§öÈáçÊñúÁ∑öÂêà‰Ωµ
                                                                   t = t.replace(/\/+/g, '/');
                
                // 6) ÂÉÖ‰øùÁïô„ÄåÂßì/Âêç„ÄçÂâçÂÖ©ÊÆµÔºàÂ§öÁöÑÂøΩÁï•Ôºâ
                const parts = t.split('/');
                if (parts.length >= 2) return `${parts[0]}/${parts[1]}`;
                return t; // Ëã•Ê≤íÊúâ /ÔºåÂ∞±ÂõûÂÇ≥Ê∏ÖÁêÜÂæåÂ≠ó‰∏≤Ôºà‰πüÂèØÊîπÊàê '' ËÆìÂÆÉË¶ñÁÇ∫‰∏çÂåπÈÖçÔºâ
            }    
            
            // üîß Êó•ÊúüÊ®ôÊ∫ñÂåñÔºöÂæû 1990/1/1 ‚Üí 1990-01-01
            function normalizeDate(dateStr) {
                if (!dateStr || typeof dateStr !== 'string') return dateStr;
                const match = dateStr.trim().match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
                if (!match) return dateStr;
                const [_, year, month, day] = match;
                const paddedMonth = month.padStart(2, '0');
                const paddedDay = day.padStart(2, '0');
                return `${year}-${paddedMonth}-${paddedDay}`;
            }
            
            rows.forEach(row => {
                const nameCell = row.querySelector('td[style*="position:sticky"]');
                if (nameCell) {
                if (currentGroup.length > 0) passengerBlocks.push(currentGroup);
                currentGroup = [row];
                currentGroup.name = normalizeName(nameCell.innerText);
            } else {
                         currentGroup.push(row);
        }
    });
    if (currentGroup.length > 0) passengerBlocks.push(currentGroup);
    
    // üß© ÊØîÂ∞çË≥áÊñô
    const validData = [];
    const unmatchedNames = [];
    
    filteredData.forEach(rowData => {
        // Ë∑≥ÈÅéÊï¥ÂàóÂπæ‰πéÁ©∫ÁôΩÁöÑË°å
        const hasContent = Object.values(rowData).some(val => val && val.trim && val.trim() !== '');
        if (!hasContent) return;
        
        const csvName = normalizeName(rowData['ÊóÖÂÆ¢ÂßìÂêç'] || '');
        if (!csvName) return; 
        
        const matchGroup = passengerBlocks.find(g => g.name === csvName);
        if (matchGroup && matchGroup.length >= 2) {
        validData.push({ rowData, group: matchGroup });
    } else {
        unmatchedNames.push(csvName);
    }
    });
    
    if (unmatchedNames.length === filteredData.length) {
        showErrorToast('‰∏äÂÇ≥Ê™îÊ°àÊóÖÂÆ¢ÂßìÂêç‰∏çÁõ∏Á¨¶');
        fileInput.value = '';
        return;
    }
    if (unmatchedNames.length > 0) {
        showErrorToast(`‚ö†Ô∏è ÁÑ°Ê≥ïÂ∞çÊáâÁöÑÊóÖÂÆ¢Ôºö${unmatchedNames.join('„ÄÅ')}`);
    }
    
    // ‚úÖ ÂØ´ÂÖ•Áï´Èù¢Ê¨Ñ‰Ωç
    validData.forEach(({ rowData, group }) => {
                        const passportRow = group[0];
                        const visaRow = group[1];
                        if (!passportRow || !visaRow) return;
                        const passportInputs = passportRow.querySelectorAll('input.editable-field, select.editable-field');
                        
                        // ‚úÖ Ê†πÊìöÁï´Èù¢‰∏äÁöÑÂßìÂêçÊ¨ÑÊòØÂê¶ÂåÖÂê´ ‚îî Âà§Êñ∑ÊòØÂê¶ÁÇ∫ INF
                        const nameCell = passportRow.querySelector('td[style*="position:sticky"]');
                        const isInf = nameCell && nameCell.innerText.includes('‚îî');
                        let gender = (rowData['ÊÄßÂà•'] || '').trim().toUpperCase();
                        
                        // ‚úÖ INFÔºöM ‚Üí MI, F ‚Üí FI
                        if (isInf && (gender === 'M' || gender === 'F')) {
                        gender = gender === 'M' ? 'MI' : 'FI';
                       }
                       
                       // ‚úÖ Èùû INFÔºöMI ‚Üí M, FI ‚Üí F
                       if (!isInf && (gender === 'MI' || gender === 'FI')) {
        gender = gender === 'MI' ? 'M' : 'F';
    }
    
    const passportValues = [
        rowData['ÊÄßÂà•'],
        rowData['ÂúãÁ±ç'],
        normalizeDate(rowData['Âá∫ÁîüÊó•Êúü']),
        rowData['Ë≠∑ÁÖß_Ë≠â‰ª∂ËôüÁ¢º'],
        normalizeDate(rowData['Ë≠∑ÁÖß_Âà∞ÊúüÊó•']),
        rowData['Ë≠∑ÁÖß_ÁôºÁÖßÂúãÂÆ∂(ÈÅ©Áî®ÂúãÂÆ∂)'],
        rowData['Ë°óÈÅì'],
        rowData['ÂüéÂ∏Ç'],
        rowData['Â∑û/ÁúÅ'],
        rowData['ÈÉµÈÅûÂçÄËôü'],
        rowData['Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂßìÂêç'],
        rowData['Á∑äÊÄ•ËÅØÁµ°‰∫∫ÂúãÁ±ç'],
        rowData['Á∑äÊÄ•ËÅØÁµ°‰∫∫ÈõªË©±']
    ];
    
    passportInputs.forEach((input, i) => {
        let val = passportValues[i];
        if (typeof val === 'string') val = val.trim();
        
        // ‚úÖ Ëã•ÊòØ„ÄåÂ∑û/ÁúÅ„ÄçÊ¨Ñ‰ΩçÔºåÈúÄÂÖàÊØîÂ∞ç select ÈÅ∏È†Ö
        const isStateSelect = (i === 8 && input.tagName === 'SELECT');
        if (isStateSelect) {
        const options = Array.from(input.options).map(opt => opt.value);
        if (!options.includes(val)) return;  // ‚ùå ‰∏çÂú®‰∏ãÊãâÈÅ∏ÂñÆ‰∏≠Â∞±Áï•ÈÅé
    }
                           
                           if (val) {
        input.value = val;
        input.dispatchEvent(new Event('input', { bubbles: true }));
        input.dispatchEvent(new Event('blur', { bubbles: true }));
        input.style.boxShadow = '0 0 5px 2px #ffcc00';
        setTimeout(() => input.style.boxShadow = '', 1000);
        
        const id = input.getAttribute('id');
        if (id) {
            const hiddenInput = document.getElementById(id + 'Hidden');
            if (hiddenInput) hiddenInput.value = val;
        }
    }
    });
    
    const visaInputs = visaRow.querySelectorAll('input.editable-field');
    const visaValues = [
        rowData['Á∞ΩË≠â_Ë≠â‰ª∂ËôüÁ¢º'],
        normalizeDate(rowData['Á∞ΩË≠â_Âà∞ÊúüÊó•']),
        rowData['Á∞ΩË≠â_ÁôºÁÖßÂúãÂÆ∂(ÈÅ©Áî®ÂúãÂÆ∂)']
    ];
    
    visaInputs.forEach((input, i) => {
        let val = visaValues[i];                               
        if (typeof val === 'string') val = val.trim();
        if (val) {
        input.value = val;
        input.dispatchEvent(new Event('input', { bubbles: true }));
    input.dispatchEvent(new Event('blur', { bubbles: true }));
    input.style.boxShadow = '0 0 5px 2px #00bfff';
    setTimeout(() => input.style.boxShadow = '', 1000);
    const id = input.getAttribute('id');
    if (id) {
        const hiddenInput = document.getElementById(id + 'Hidden');
        if (hiddenInput) hiddenInput.value = val;
    }
    }
    });
    });
    window.isEditing = true;
    document.querySelectorAll('.editable-field').forEach(input => {
        input.disabled = false;
    });
        fileInput.value = '';
    };
        
        reader.readAsText(file);
    });
        
        function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    });
        
        
        // Listen for Bootstrap tab changes
        document.addEventListener('DOMContentLoaded', function() {
        var tabLinks = document.querySelectorAll('[data-bs-toggle="tab"]');
        tabLinks.forEach(function(tabLink) {
        tabLink.addEventListener('shown.bs.tab', function(event) {
        // Extract PNR from tab target (format: #tab{PNR})
        var tabTarget = event.target.getAttribute('data-bs-target');
        if (tabTarget) {
        var pnr = tabTarget.replace('#tab', '');
        
        // Update edit button visibility based on PNR's C1OperationDisable status
        var editButton = document.getElementById('testbtn');
        if (editButton && !window.isEditing) {  // Only update if not currently editing
        var isDisabled = pnrC1DisabledMap[pnr] || false;
        editButton.style.display = isDisabled ? 'none' : '';
    }
                                                         
                                                         }
                                                         });
    });
    });
    
    // Add style for the input fields
    const style = document.createElement('style');
    style.textContent = `
    .form-control-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.2rem;
        text-align: center;
    }
    
    .editable-field:disabled {
        background-color: rgba(248, 248, 248, 1) !important;
        border: 1px solid rgba(223, 220, 215, 1);
        padding: 0;
        margin: 0;
        height: auto;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        text-align: center;
    }
    
    td.text-center {
        text-align: center;
        vertical-align: middle;
    }
    
    td.text-center .form-control {
        margin: 0 auto;
    }
    `;
    document.head.appendChild(style);
    
    /*function toggleLoading(show) {
        if(show) {
            $('[id$=ajaxloading_start]').show();
        } else {
            $('[id$=ajaxloading_start]').hide();
        }
    }*/
    
    function clearFields(button) {
        const row = button.closest('tr');
        row.querySelectorAll('input.ClearItems, select.ClearItems').forEach(i=>{
            i.value = '';
        });
        }
            
            // Mobile accordion clear function for specific document section
            function clearDocumentData(documentId, docType) {
            const documentSection = event.target.closest('.document-section');
            if (documentSection) {
            documentSection.querySelectorAll('input.ClearItems, select.ClearItems').forEach(input => {
            input.value = '';
            // Trigger blur event to ensure hidden fields are updated
            input.dispatchEvent(new Event('blur', { bubbles: true }));
    });
    
    // Show visual feedback
    documentSection.querySelectorAll('.ClearItems').forEach(input => {
        input.style.boxShadow = '0 0 5px 2px #dc3545';
        setTimeout(() => input.style.boxShadow = '', 1000);
    });
    }
    }
        
        // Function to handle passenger selection filtering for mobile
        function filterMobilePassengers() {
        // This function will be called when passengers are selected/deselected
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        const selectedIds = new Set();
        
        checkboxes.forEach(cb => {
        const id = cb.getAttribute('data-id');
        if (id) selectedIds.add(id);
    });
        
        // Show/hide accordion items based on selection
        const accordionItems = document.querySelectorAll('.passenger-accordion');
        accordionItems.forEach(item => {
        const passengerId = item.getAttribute('data-passenger-id');
        if (selectedIds.size === 0 || selectedIds.has(passengerId)) {
        item.classList.remove('passenger-hidden');
    } else {
        item.classList.add('passenger-hidden');
    }
    });
    }
        
        // Enhanced function to handle both table rows and accordion items
        function getEditableFieldsInCurrentView() {
        const allEditableFields = document.querySelectorAll('.editable-field');
        // Filter out fields that are not visible (either in hidden table on mobile or hidden accordion on desktop)
        return Array.from(allEditableFields).filter(field => {
        const parent = field.closest('.table-responsive, .mobile-accordion');
        if (!parent) return true; // Keep fields that aren't in either structure
        
        const computedStyle = window.getComputedStyle(parent);
        return computedStyle.display !== 'none';
    });
    }
        
        // Update the validateFields function to work with current view
        function validateFieldsCurrentView() {
        const editableFields = getEditableFieldsInCurrentView().filter(f => !f.disabled && f.offsetParent !== null);
        let ok = true;
        
        editableFields.forEach(f => {
        const tag = f.tagName.toLowerCase();
        const value = f.value.trim();
        const api = f.dataset.api || '';
        
        // Clear previous validation state
        f.classList.remove('is-invalid');
        const existingFeedback = f.parentElement.querySelector('.invalid-feedback');
        if (existingFeedback) existingFeedback.remove();
        
        // Validation logic (keeping existing validation rules)
        let isValid = true;
        let errorMessage = '';
        
        if (api.includes('PassportNumber__c') || api.includes('VisaNumber__c')) {
        if (!value) {
        isValid = false;
        errorMessage = 'Ë´ãËº∏ÂÖ•Ë≠â‰ª∂ËôüÁ¢º';
    }
    }
        
        if (api.includes('ExpiryDate__c')) {
        if (!value) {
        isValid = false;
        errorMessage = 'Ë´ãÈÅ∏ÊìáÂà∞ÊúüÊó•';
    }
    }
        
        if (!isValid) {
        f.classList.add('is-invalid');
        const feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        feedback.textContent = errorMessage;
        f.parentElement.appendChild(feedback);
        ok = false;
    }
    });
        
        return ok;
    }
        
        
        let originalValues = {};
        const editButton = document.getElementById('testbtn');
        const cancelButton = document.getElementById('cancelBtn');
        const nextStepBtn = document.getElementById('nextStep1');
        const uploadButton = document.getElementById('uploadButton');
        const submitButton = document.getElementById('submitButton');
        let isEditing = false;
        
        
        function validateFields() {
        const editableFields = Array.from(document.querySelectorAll('.editable-field:not([disabled])'))
        .filter(f => f.offsetParent !== null) // ‚úÖ ÈÅéÊøæÊéâ display:none ÁöÑÊ¨Ñ‰Ωç
        
        //.filter(f => f.dataset.doc !== 'visa');
        let ok = true;
        
        editableFields.forEach(f => {
        const tag = f.tagName.toLowerCase();
        const value = f.value.trim();
        const api = f.dataset.api || '';
        const doc = f.dataset.doc || ''; // e.g., 'visa'
        
        f.classList.remove('is-invalid');
        
        // Ê∏ÖÈô§ËàäÁöÑÈåØË™§Ë®äÊÅØ
        const old = f.parentElement.querySelector('.invalid-feedback');
        if (old) old.remove();
        
        if (f.classList.contains('is-invalid')) {
        console.warn('‚ùå È©óË≠âÂ§±ÊïóÊ¨Ñ‰ΩçÔºö', f);
        ok = false;
    }
        
        // ‚úÖ Step 1: ÂøÖÂ°´Ê™¢Êü•
        if (!value && doc !== 'visa') {
        ok = false;
        f.classList.add('is-invalid');
        const div = document.createElement('div');
        div.className = 'invalid-feedback';
        div.textContent = 'ÂøÖÂ°´';
        f.parentElement.appendChild(div);
        return; // ‚ùå ‰∏çÂÅöÂæåÁ∫åÊ†ºÂºèÈ©óË≠â
    }
        
        // ‚úÖ Step 2: Ë≠∑ÁÖßÊ†ºÂºèÈ©óË≠â
        if (doc !== 'visa' && value !== '') {
        validatePassportInput(f);
    }
        
        // ‚úÖ Step 3: Á∞ΩË≠âÊ†ºÂºèÈ©óË≠âÔºàÂÉÖÈáùÂ∞ç docType = 'visa' ÁöÑÊ¨Ñ‰ΩçÔºâ
        if (doc === 'visa' && value !== '') {
        if (api === 'VisaNumber__c') {
        validateVisaInput(f, 'number');
    } else if (api === 'VisaExpiryDate__c') {
        validateVisaInput(f, 'visaDate');
    } else if (api === 'VisaIssuingCountry__c') {
        validateVisaInput(f, 'visaCountry');
    }
    }
        
        if (f.classList.contains('is-invalid')) {
        ok = false;
    }
    });
        
        return ok;
    }
        
        
        
        
        /*submitButton.addEventListener('click', function () {
            //toggleLoading(true);
            $('[id$=hsubmit]').click();
            console.log('hihihi');
    });*/
        
        editButton.addEventListener('click',()=>{
        
        const editableFields = getEditableFieldsInCurrentView();
        const actionButtons = document.querySelectorAll('.actionbtn');
        
        /* ---------- ÈÄ≤ÂÖ•„ÄåÁ∑®ËºØ„Äç ---------- */
        if(!isEditing){
        isEditing = true;
        editButton.textContent = 'ÂÑ≤Â≠ò';
        
        // Add editing class to mobile accordion to show clear buttons
        const mobileAccordion = document.querySelector('.mobile-accordion');
        if (mobileAccordion) {
        mobileAccordion.classList.add('editing');
    }
        
        const allTabs = document.querySelectorAll('#tabResults .nav-link');
        const activeTab = document.querySelector('#tabResults .nav-link.active');
        allTabs.forEach(tab => {
        if (tab !== activeTab) {
        tab.classList.add('disabled');
        tab.style.pointerEvents = 'none';
        tab.style.opacity = '0.4';
    }
    });
        
        // Â∞á flightSearchForm Ë£°ÁöÑÊ¨Ñ‰Ωç disable
        const flightSearchForm = document.getElementById('flightSearchForm');
        if (flightSearchForm) {
        flightSearchForm.querySelectorAll('input, select, button').forEach(el => {
        el.disabled = true;
        el.classList.add('disabled-by-edit'); // Ëã•Êó•ÂæåÈúÄË¶ÅÂèñÊ∂àÂèØÁî®Ê≠§ class ÂçÄÂàÜ
    });
    }
        
        cancelButton.style.display = 'block';
        nextStepBtn.style.display  = 'none';
        uploadButton.style.display = 'block';
        
        document.querySelectorAll('.edit-only').forEach(td => {
        td.style.display = 'table-cell';
    });
        
        editableFields.forEach(f=>{
        f.dataset.orig = f.value;          // Êãç‰∏ãÂéüÂÄº
        f.disabled  = false;
        f.style.backgroundColor = '#fff';
        f.style.border = '1px solid #ced4da';
        if (f.type === 'date' && (f.dataset.api === 'PassportExpiryDate__c' || f.dataset.api === 'VisaExpiryDate__c')) {
        const departureDate = document.getElementById('{!$Component.searchForm.departureDate}').value;
        f.setAttribute('min', departureDate);
    }
    });
        
        applyDOBConstraints();
        
        actionButtons.forEach(b => {
        b.disabled = false;
        b.style.cursor = 'pointer';
        
        // Ëã•ÊòØ‰ΩèÂùÄÊåâÈàïÔºåË£úÁ∂Å‰∫ã‰ª∂
        if (b.classList.contains('USaddressbtn')) {
        b.onclick = function () {
        showUSAddressModal(this);
    };
    }
        
        // Ëã•ÊòØÂúòÁ∞ΩÊåâÈàï
        if (b.classList.contains('groupVisaBtn')) {
        b.onclick = function () {
        showGroupModal();
    };
    }
    });
        document.querySelectorAll('select.editable-field').forEach(select => {
        const placeholderOption = select.querySelector('option[data-placeholder="true"]');
        if (placeholderOption && placeholderOption.textContent.trim() === '') {
        placeholderOption.textContent = 'Ë´ãÈÅ∏Êìá';
    }
    });
        
        return;
    }
        
        /* ---------- Èªû„ÄåÂÑ≤Â≠ò„Äç ---------- */
        if (!validateFieldsCurrentView()) {
        console.log('‚ùå È©óË≠âÊú™ÈÄöÈÅé');
        
        return;
    }
        console.log('‚úÖ È©óË≠âÈÄöÈÅéÔºåÈÄ≤ÂÖ•ÂÑ≤Â≠òÊµÅÁ®ã');             // È©óË≠âÊ≤íÈÅéÁõ¥Êé•Ë∑≥Ëµ∞
        
        document.getElementById('loadingOverlay').style.display = 'block';
        document.body.style.overflow = 'hidden'; // Á¶ÅÊ≠¢ÊªæÂãïÔºàÈÅøÂÖç‰∫ÇÈªûÔºâ
        
        document.querySelectorAll('.edit-only').forEach(td => {
        td.style.display = 'none';
    });
        
        /* ÈÄôË£°Â¶ÇÊûúË¶ÅÂëºÂè´ Apex save()ÔºåË´ãÂú®Ê≠§Ëß∏Áôº hidden commandButton Êàñ actionFunction */
        //Ethan 6/13            
        // call apex funtion
        function saveSelectedTravellers(){
        const hid = document.querySelector('[id$=selectedIdsHidden]');
        const val = hid ? hid.value : '[]';
        doUploadDocumentWithIds(val);   // ÂëºÂè´Êñ∞ÁöÑ actionFunction
    }
                                                            
                                                            
                                                            saveSelectedTravellers();    // ‚Üê ÂëºÂè´ actionFunction ‰∏¶ÂÇ≥ÈÄ≤ Apex
    //callUploadDocument(JSON.stringify(data));
    
    isEditing = false;
    editButton.textContent = 'Á∑®ËºØ';
    
    // Remove editing class from mobile accordion to hide clear buttons
    const mobileAccordion = document.querySelector('.mobile-accordion');
    if (mobileAccordion) {
        mobileAccordion.classList.remove('editing');
    }
    
    cancelButton.style.display = 'none';
    nextStepBtn.style.display  = 'block';
    uploadButton.style.display = 'none';
    
    editableFields.forEach(f=>{
        f.disabled  = true;
        f.style.backgroundColor = 'transparent';
        //f.style.border = 'none';
        if (f.tagName.toLowerCase() === 'select' && $(f).hasClass('select2-hidden-accessible')) {
        $(f).select2();
    }
        f.classList.remove('is-invalid');
        delete f.dataset.orig;                // ÁúüÊ≠£ÂÑ≤Â≠òÊàêÂäüÂæåÊääÂø´ÁÖßÁßªÈô§
        const fb = f.parentElement.querySelector('.invalid-feedback');
        if(fb) fb.remove();
    });
        
        actionButtons.forEach(b=>{
        b.disabled = true;
        b.style.cursor = 'not-allowed';
    });
        
        document.querySelectorAll('select.editable-field').forEach(select => {
        const placeholderOption = select.querySelector('option[data-placeholder="true"]');
        if (placeholderOption && placeholderOption.textContent.trim() === 'Ë´ãÈÅ∏Êìá') {
        placeholderOption.textContent = '\u00A0'; // &nbsp;
    }
    });
        
        // ÊàêÂäüÊèêÁ§∫
        /*const okPanel = document.querySelector('[id$=editSuccessPanel]');
            if(okPanel){
            okPanel.style.display='block';
            setTimeout(()=>{ okPanel.style.display='none'; },2000);
        }*/
            });
                
                /* ==============  Âèñ   Ê∂à  ============== */
                cancelButton.addEventListener('click', () => {
                const flightSearchForm = document.getElementById('flightSearchForm');
                if (flightSearchForm) {
                flightSearchForm.querySelectorAll('.disabled-by-edit').forEach(el => {
                if (el.id !== 'flightPrefix') {
                el.disabled = false;
                el.classList.remove('disabled-by-edit');
            }
            });
            }
                
                document.querySelectorAll('.edit-only').forEach(td => {
                td.style.display = 'none';
            });
                
                const editableFields = getEditableFieldsInCurrentView();
                const actionButtons  = document.querySelectorAll('.actionbtn');
                
                editableFields.forEach(f => {
                if (f.dataset.orig !== undefined) {
                f.value = f.dataset.orig;
            }
                
                f.disabled = true;
                
                if (f.tagName.toLowerCase() === 'select' && $(f).hasClass('select2-hidden-accessible')) {
                $(f).prop('disabled', true).select2();
                const $selection = $(f).next('.select2-container').find('.select2-selection');
                $selection.css({
                height: '60px',
                'line-height': '60px',
                'border-radius': '4px',
                'font-size': '0.875rem',
                'padding': '0',
                'text-align': 'center',
                'box-shadow': 'none',
                'outline': 'none',
                'background-color': '#f8f8f8',
                'border': '1px solid #dfdcd7',
                'cursor': 'not-allowed'
            });
    }
    
    f.style.backgroundColor = 'transparent';
    f.style.border = '1px solid #ced4da';
    f.classList.remove('is-invalid');
    const fb = f.parentElement.querySelector('.invalid-feedback');
    if (fb) fb.remove();
    delete f.dataset.orig;
    });
    
    actionButtons.forEach(b => {
        b.disabled = true;
        b.style.cursor = 'not-allowed';
    });
        
        isEditing = false;
        editButton.textContent = 'Á∑®ËºØ';
        
        // Remove editing class from mobile accordion to hide clear buttons
        const mobileAccordion = document.querySelector('.mobile-accordion');
        if (mobileAccordion) {
        mobileAccordion.classList.remove('editing');
    }
        
        cancelButton.style.display = 'none';
        nextStepBtn.style.display  = 'block';
        uploadButton.style.display = 'none';
    });
        
        
        function showTabs() {
        const msgs        = document.getElementById('{!$Component.msgs}');
        const successTip  = document.getElementById('{!$Component.SearchSuccessPanel}');
        const errorTip      = document.getElementById('{!$Component.SearchErrorPanel}');
        const tabResults  = document.getElementById('tabResults');
        const searchResults = document.getElementById('searchResults');
        const fixedBtns   = document.getElementById('fixedBottomButtons');
        const searchPrompt = document.getElementById('searchPrompt');
        
        const pnrC1DisabledMapContainer = document.getElementById('pnrC1DisabledMapContainer');
        if (pnrC1DisabledMapContainer) {
        console.log("pnrC1DisabledMapContainer: " + pnrC1DisabledMapContainer);
        pnrC1DisabledMap = JSON.parse(pnrC1DisabledMapContainer.getAttribute('data-pnr-c1-disabled-map'));
    }
        console.log("pnrC1DisabledMap: " + JSON.stringify(pnrC1DisabledMap));
        const activeTab = document.querySelector('#tabResults .nav-link.active');
        console.log("activeTab: " + activeTab);
        const currentPNR =
        activeTab?.dataset.bsTarget?.replace('#tab', '') || activeTab?.textContent.trim() || null;
        if (currentPNR) {
        updateEditButtonVisibility(currentPNR);
    }
        // ÊúâÂæåÁ´ØÈåØË™§ or Info Ôºà‰ΩøÁî® pageMessages Êàñ SearchErrorPanelÔºâ
        const errorMessage = errorTip.textContent.trim().split('//<![CDATA[')[0].split('/*<![CDATA[')[0].trim();
        const hasErrorText = !(errorMessage === null) && !(errorMessage.trim().length === 0);
        console.log('error: ' + errorMessage);
        console.log(!(errorMessage === null));
        console.log(!(errorMessage.trim().length === 0));
        
        if (hasErrorText) {
        console.log('error');
        if (errorMessage.startsWith('Êü•ÁÑ°ÈÉ®ÂàÜPNR')){
        searchPrompt.style.display   = 'none';
        tabResults.style.display     = 'block';
        searchResults.style.display  = 'block';
        fixedBtns.style.display      = 'flex';
        successTip.style.display     = 'none';
        errorTip.style.display       = 'block';
        
        setTimeout(() => {
        successTip.style.display = 'none';
    }, 2000);
    } else {
        // È°ØÁ§∫ÈåØË™§ÊèêÁ§∫ÔºåÈö±ËóèË≥áÊñôÂçÄÂ°ä
        searchPrompt.style.display   = '';
        searchPrompt.textContent     = 'Êü•Ë©¢ÁÑ°ÁµêÊûú';
        tabResults.style.display     = 'none';
        searchResults.style.display  = 'none';
        fixedBtns.style.display      = 'none';
        successTip.style.display     = 'none';
        errorTip.style.display       = 'block';
    }
    } else {
        console.log('no error');
        // È°ØÁ§∫Ê≠£Â∏∏Ë≥áÊñô
        searchPrompt.style.display   = 'none';
        tabResults.style.display     = 'block';
        searchResults.style.display  = 'block';
        fixedBtns.style.display      = 'flex';
        successTip.style.display     = 'none';
        errorTip.style.display       = 'none';
        
        setTimeout(() => {
        successTip.style.display = 'none';
    }, 2000);
    }
        
        document.getElementById('loadingOverlay').style.display = 'none';
        try{ if (typeof window.afterSearchAutoOpenPicker==='function'){ window.afterSearchAutoOpenPicker(); } }catch(e){}
    }
        
        
        // ÂèñÊ∂àÊåâÈàï
        cancelButton.addEventListener('click', function () {
        const editableFields = getEditableFieldsInCurrentView();
        const actionButtons = document.querySelectorAll('.actionbtn');
        
        // ÊÅ¢Âæ©ÂéüÂßãÂÄº
        editableFields.forEach(field => {
        // Ê∏ÖÈô§È©óË≠âÁãÄÊÖã
        field.classList.remove('is-invalid');
        const feedback = field.parentElement.querySelector('.invalid-feedback');
        if (feedback) {
        feedback.remove();
    }
        
        // ÊÅ¢Âæ©ÂéüÂßãÂÄºÔºàÂ¶ÇÊûúÊúâÔºâ
        if (originalValues[field.id]) {
        field.value = originalValues[field.id];
    }
        
        // Á¶ÅÁî®Ê¨Ñ‰Ωç
        field.disabled = true;
        field.style.backgroundColor = 'transparent';
        field.style.border = '1px solid #ced4da';
    });
        
        // Á¶ÅÁî®Êìç‰ΩúÊåâÈàï
        actionButtons.forEach(button => {
        button.disabled = true;
        button.style.cursor = 'not-allowed';
    });
        
        // ÈáçË®≠Áõ∏ÈóúÊåâÈàïÁãÄÊÖã
        isEditing = false;
        
        // Remove editing class from mobile accordion to hide clear buttons
        const mobileAccordion = document.querySelector('.mobile-accordion');
        if (mobileAccordion) {
        mobileAccordion.classList.remove('editing');
    }
        
        const allTabs = document.querySelectorAll('#tabResults .nav-link');
        allTabs.forEach(tab => {
        tab.classList.remove('disabled');
        tab.style.pointerEvents = 'auto';
        tab.style.opacity = '1';
    });
        cancelButton.style.display = 'none';
        nextStepBtn.style.display = 'block';
        uploadButton.style.display = 'none';
        editButton.textContent = 'Á∑®ËºØ';
        
        document.querySelectorAll('select.editable-field').forEach(select => {
        const placeholderOption = select.querySelector('option[data-placeholder="true"]');
        if (placeholderOption && placeholderOption.textContent.trim() === 'Ë´ãÈÅ∏Êìá') {
        placeholderOption.textContent = '\u00A0'; // &nbsp;
    }
    });
    });
        
        function updateEditButtonVisibility(targetPNR) {
        try {
        // Get the disable status for the target PNR from global variable
        var isDisabled = false;
        if (targetPNR && pnrC1DisabledMap.hasOwnProperty(targetPNR)) {
        isDisabled = pnrC1DisabledMap[targetPNR] === true;
    }
        console.log("üîç [updateEditButtonVisibility] Is disabled: ", isDisabled);
        
        // Update button visibility
        var editBtn = document.getElementById("testbtn");
        if (editBtn) {
        console.log("üîç [updateEditButtonVisibility] Updating button from ", editBtn.style.display, " to ", isDisabled ? "none" : "");
        editBtn.style.display = isDisabled ? "none" : "";
    } else {
                          console.log("‚ùå [updateEditButtonVisibility] Edit button not found!");
    }
    } catch (error) {
        console.error("‚ùå Error in updateEditButtonVisibility:", error);
    }
    }
    
    
    // È°ØÁ§∫ÁæéÂúãÁ∞ΩË≠âÂΩàË∑≥Ë¶ñÁ™óÁöÑÂäüËÉΩ
    function showUSAddressModal(button) {
        const recordId = button.getAttribute('data-id');
        
        // Â∞áÈÄôÂÄã recordId Â°´ÂÖ• modal ÊâÄÊúâ input
        document.querySelectorAll('#usAddressModal input[data-api], #usAddressModal select[data-api]').forEach(input => {
            input.setAttribute('data-id', recordId);
        });
            
            const modalElement = document.getElementById('usAddressModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            setTimeout(() => {
            initSelect2States();  // Á≠âÂæÖ modal DOM ÂàùÂßãÂåñÂæåÂÜçÂ•óÁî® select2
        }, 300);
        }
            
            
            // È°ØÁ§∫ÂúòÈ´îÁ∞ΩË≠âÂΩàË∑≥Ë¶ñÁ™óÁöÑÂäüËÉΩ
            function showGroupModal() {
            const modalElement = document.getElementById('groupVisaModal');
            if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        }        
            
            function adjustContentWrapper() {
            var sidebar = document.getElementById('sidebar');
            var contentWrapper = document.getElementById('content-wrapper');
            var fixedBottomButtons = document.getElementById('fixedBottomButtons');
            
            // ÂèñÂæó sidebar ÁöÑÁï∂ÂâçÊ®£Âºè
            var sidebarStyle = window.getComputedStyle(sidebar);
            var transformValue = sidebarStyle.getPropertyValue('transform');
            
            // Ê™¢Êü• sidebar ÊòØÂê¶Êúâ 'hidden' class Êàñ 'normal' class
            if (sidebar.classList.contains('hidden') && window.innerWidth >= 1025) {
            contentWrapper.style.paddingLeft = '0';
            fixedBottomButtons.style.paddingLeft = '0';
        } else if (sidebar.classList.contains('hidden') && window.innerWidth < 1025) {
            contentWrapper.style.paddingLeft = '0';
            fixedBottomButtons.style.paddingLeft = '0';
        }
            
            if (sidebar.classList.contains('normal') && window.innerWidth >= 1025) {
            contentWrapper.style.paddingLeft = '250px';
            contentWrapper.style.transition = 'padding-left 0.3s ease-in-out';
            fixedBottomButtons.style.paddingLeft = '250px';
            fixedBottomButtons.style.transition = 'padding-left 0.3s ease-in-out';
        } else if (sidebar.classList.contains('normal') && window.innerWidth < 1025) {
            contentWrapper.style.paddingLeft = '0';
            fixedBottomButtons.style.paddingLeft = '0';
        }
        }
            
            // Áõ£ËÅΩ sidebar ÁöÑ class ËÆäÂåñ
            var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
            if (mutation.type === "attributes" && mutation.attributeName === "class") {
            adjustContentWrapper();
        }
        });
        });
            
            // Áï∂ DOM ÂÖßÂÆπÂä†ËºâÂÆåÊàêÂæåÂü∑Ë°å
            document.addEventListener('DOMContentLoaded', function() {
            var sidebar = document.getElementById('sidebar');
            observer.observe(sidebar, {
            attributes: true
        });
        
        // ÂàùÂßãË™øÁî® adjustContentWrapper
        adjustContentWrapper();
    });
    
    // ÂêåÊôÇÁõ£ËÅΩ window resize ‰∫ã‰ª∂ÔºåËÆìÁï´Èù¢Á∏ÆÂ∞èÂæå‰πüËÉΩÊ≠£Á¢∫Ë™øÊï¥
    window.addEventListener('resize', adjustContentWrapper);
    
    //Ê∏ÖÈô§ÈçµÊääÊù±Ë•øÈÉΩÊ∏ÖÈô§
    document.addEventListener('DOMContentLoaded', function() {
        const btnClear = document.getElementById('clearButton');
        btnClear.addEventListener('click', function() {
            doReset(); 
            // ÊãøÂà∞ VF ÁúüÊ≠£Áî¢ÁîüÁöÑ input id
            
            const idFlightNum = '{!$Component.searchForm.flightNumber}';
            const idDepart    = '{!$Component.searchForm.departureDate}';
            const idBooking   = '{!$Component.searchForm.bookingCodes}';
            
            // 1. Ê∏ÖÁ©∫Ê¨Ñ‰ΩçÂÄº
            document.getElementById('flightNumber_display').value = '';
            document.getElementById(idFlightNum).value = '';
            document.getElementById(idDepart).value    = '';
            document.getElementById(idBooking).value   = '';
            
            // 2. ÁßªÈô§ÊâÄÊúâÈ©óË≠âÊ®£Âºè & Ë®äÊÅØ
            document.querySelectorAll('#flightSearchForm .required-field').forEach(field => {
                field.classList.remove('is-invalid');
                const fb = field.parentElement.querySelector('.invalid-feedback');
                if (fb) fb.remove();
            });
                
                // 3. ÈÇÑÂéü‰ªãÈù¢È°ØÁ§∫
                document.getElementById('outerWrapper').style.marginBottom   = '0';
                document.getElementById('fixedBottomButtons').style.display  = 'none';
                document.getElementById('searchResults').style.display      = 'none';
                //document.getElementById('searchPrompt').style.display       = 'block';
                document.getElementById('searchPrompt').textContent         = 'Ë´ãÊêúÂ∞ãË≥áÊñô'; 
                document.getElementById('tabResults').style.display         = 'none';
                
                hasSearched = false;
            });
            });
                
                
                function validateSearch () {
                
                const fields = document.querySelectorAll('#flightSearchForm .required-field');
                let ok = true;
                
                fields.forEach(field => {
                field.classList.remove('is-invalid');
                const old = field.parentElement.querySelector('.invalid-feedback');
                if (old) old.remove();
                
                if (!field.value.trim()) {
                ok = false;
                field.classList.add('is-invalid');
                
                const div = document.createElement('div');
                div.className = 'invalid-feedback w-100';
                div.textContent = 'ÂøÖÂ°´';
                field.insertAdjacentElement('afterend', div);
            }
            });
                
                if (ok) {
                // È°ØÁ§∫ loading ÈÅÆÁΩ©
                document.getElementById('loadingOverlay').style.display = 'block';
                document.body.style.overflow = 'hidden';  // Á¶ÅÊ≠¢ÊªæÂãï
                
                // È©óË≠âÈÄöÈÅé ‚Üí Ëß∏ÁôºÈö±ËóèÁöÑ commandButton
                doSearch();
            }
            }
                
                function afterSaveSuccess() {
                console.log('‚úÖ ÂÑ≤Â≠òÂÆåÊàêÔºåÈñãÂßãËôïÁêÜÂæåÁ∫å UI');
                
                // ‚úÖ Èö±Ëóè loading
                document.getElementById('loadingOverlay').style.display = 'none';
                document.body.style.overflow = 'auto';
                const flightSearchForm = document.getElementById('flightSearchForm');
                if (flightSearchForm) {
                flightSearchForm.querySelectorAll('.disabled-by-edit').forEach(el => {
                el.disabled = false;
                el.classList.remove('disabled-by-edit');
            });
            }
                // ‚úÖ È°ØÁ§∫ÂÑ≤Â≠òÊàêÂäüÊèêÁ§∫
                const okPanel = document.querySelector('[id$=editSuccessPanel]');
                if (okPanel) {
                okPanel.style.display = 'block';
                setTimeout(() => {
                okPanel.style.display = 'none';
            }, 2000);
            }
                
                // ‚úÖ È°ØÁ§∫ÊêúÂ∞ãÁµêÊûúÁï´Èù¢ÔºàÁïôÂú®ÁõÆÂâçÈ†ÅÈù¢Ôºâ
                showTabs(); // ‚Üê ‰Ω†Â∑≤ÂÆöÁæ©ÁöÑÂáΩÂºèÔºåÊúÉÈ°ØÁ§∫ tabResults„ÄÅsearchResults
            }
                
                
                
                
                </script>
    
    
    
    
    <!-- ‚ñº‚ñº‚ñº [Integrated SPM] JS: auto-modal, child binding, apply-only render, smart upload -->
    <script>
    /*
      ‚úÖ ÂäüËÉΩÂåØÁ∏Ω
      - ÊêúÂ∞ãÊàêÂäüËá™ÂãïË∑≥Âá∫ ModalÔºàÁ¨¨‰∏ÄÊ¨° & Á¨¨‰∫åÊ¨°‚Ä¶ÁöÜÂèØÔºâ
      - ‰∫åÊ¨°ÊêúÂ∞ãÊúÉÈáçÁΩÆÈÅ∏ÂèñÁãÄÊÖãÔºà‰∏çÂ∏∂ÂÖ•ËàäÂêçÂñÆÔºâ
      - ÈªûÂêçÂ≠óÂèØÂàáÊèõÂãæÈÅ∏
      - Â§ß‰∫∫ÂãæÈÅ∏Ëá™ÂãïÂåÖÂê´ÂÖ∂‰∏ãÊñπÂ∞èÂ≠©ÔºàÂßìÂêçÂê´„Äå‚îî„ÄçÔºâÔºåÂ∞èÂ≠©‰∏çÈ°ØÁ§∫ checkbox
      - Êåâ„ÄåÂ•óÁî®„ÄçÊâçÊ∏≤Êüì‰∏ãÊñπ TableÔºàÂú® Modal ÈñãÂïüÊôÇÊúÉÂÖàÈö±Ëóè TableÔºâ
      - ‰∏äÂÇ≥ÔºàdoUploadDocumentÔºâÊôÇÔºåËã•ÊúâÈÅ∏ÂèñÂêçÂñÆÔºåÂÉÖÈÄÅÂá∫Ë¢´ÈÅ∏ Id
    */
    (function(){
        if (window.__SPM3_INSTALLED__) return;
        window.__SPM3_INSTALLED__ = true;
        
        // ---------- Â∞èÂ∑•ÂÖ∑ ----------
        const $ = (sel, root=document) => root.querySelector(sel);
        const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
        
        function getCurrentPNR(){
            const active = $('#tabResults .nav-link.active');
            if(!active) return null;
            const target = active.getAttribute('data-bs-target')||'';
            return target.replace('#tab','') || active.textContent.trim();
        }
        function activePane(pnr){ return $('#tab'+pnr+'.tab-pane'); }
        function toggleResults(show){
            const sr = $('#searchResults');
            const fb = $('#fixedBottomButtons');
            if (sr) sr.style.display = show ? '' : 'none';
            if (fb) fb.style.display = show ? '' : 'none';
        }
        function hiddenSelected(){
            // Visualforce ÊúÉÁî¢ÁîüÂØ¶Èöõ idÔºåÈÄôË£°Áî® suffix ÂèñÊ≥ï
            return document.querySelector('[id$="selectedIdsHidden"]');
        }
        
        // ---------- ÁãÄÊÖã ----------
        const S = window.__SPM3__ = {
            // ÊØèÊ¨° search ÊàêÂäüÈÉΩÊúÉ RESET
            selectedPerPNR: {},   // {PNR:Set<Id>} Âè™Ë®ò„ÄåË¢´ÂãæÈÅ∏ÁöÑÂ§ß‰∫∫„Äç
            groupsPerPNR: {},     // {PNR:Array<Group>}
            appliedPerPNR: {},    // {PNR:Boolean} ÈÄôÂÄã pnr ÊòØÂê¶Â∑≤„ÄåÂ•óÁî®„ÄçÈÅé
        };
        
        // ---------- DOM ÊéÉÊèèÔºöÊää‰∏Ä‰ΩçÊóÖÂÆ¢(2Âàó)Ë¶ñÁÇ∫‰∏ÄÁµÑÔºåÂª∫Á´ãÂ§ß‰∫∫/Â∞èÂ≠©ÈóúËÅØ ----------
        function collectGroups(pnr){
            const pane = activePane(pnr);
            if(!pane) return [];
            const rows = $$('tbody tr', pane);
            const groups = [];
            let lastAdultIdx = -1;
            
            for (let i=0;i<rows.length;i++){
                const r = rows[i];
                //const sticky = r.querySelector('td[style*="position:sticky"]');
                const sticky = r.querySelector('td[data-passport-finished]');

                if(!sticky) continue;
                
                const next = rows[i+1] || null;
                // ÂòóË©¶ÊäìÈÄô‰ΩçÊóÖÂÆ¢ÁöÑ recordIdÔºàÁî®‰Ω†È†ÅÈù¢‰∏äÂ∑≤Â≠òÂú®ÁöÑ data-idÔºâ
                let recId = null;
                const hid = r.querySelector('input[type="hidden"][data-id]');
                if (hid) recId = hid.getAttribute('data-id');
                if (!recId){
                    const btn = r.querySelector('.USaddressbtn[data-id]');
                    if (btn) recId = btn.getAttribute('data-id');
                }
                if(!recId) continue;
                
                const isUploaded = sticky && sticky.getAttribute('data-passport-finished') === 'true';
                const rawName = (sticky.innerText||'').trim().replace(/\s+/g,' ');
                const isChild = rawName.includes('‚îî');
                const g = { id: recId, name: rawName, rows:[r, next].filter(Boolean), isChild, isUploaded, parentId:null, childId:null };
                if (isChild && lastAdultIdx>=0){
                    g.parentId = groups[lastAdultIdx].id;
                    groups[lastAdultIdx].childId = g.id;
                } else if (!isChild){
                    lastAdultIdx = groups.length;
                }
                groups.push(g);
            }
            return groups;
        }
        function ensureGroups(pnr){
            if (!S.groupsPerPNR[pnr]) S.groupsPerPNR[pnr] = collectGroups(pnr);
            if (!S.selectedPerPNR[pnr]) S.selectedPerPNR[pnr] = new Set();
            return S.groupsPerPNR[pnr];
        }
        
        // ---------- Âª∫Á´ã Modal ÂêçÂñÆ ----------
        function buildPicker(pnr){
            const list = $('#spm-list'); if(!list) return;
            const pnrSpan = $('#spm-pnr'); if (pnrSpan) pnrSpan.textContent = pnr||'';
            
            list.innerHTML = '';
            const groups = ensureGroups(pnr);
            const picked = S.selectedPerPNR[pnr];
            
            groups.forEach(g=>{
                const row = document.createElement('label');
                row.className = 'list-group-item d-flex align-items-center';
                row.style.cursor = 'pointer';
                
                const nameHtml = g.name + (g.isUploaded ? ' <small class="text-success">(Êñá‰ª∂Â∑≤‰∏äÂÇ≥)</small>' : '');
                
                if (g.isChild){
                // Â∞èÂ≠©ÂàóÔºö‰∏çÊèê‰æõ checkboxÔºåÂÉÖÈ°ØÁ§∫Èö®Âêå
                row.innerHTML = `<div class="flex-grow-1 text-muted" style="margin-left:2.1rem">ÔºàÈö®ÂêåÔºâ${g.name}</div>`;
                           row.addEventListener('click', ()=>{
                if(!g.parentId) return;
                const parentCb = list.querySelector(`input.spm-adult[value="${g.parentId}"]`);
                if(parentCb){ parentCb.checked = !parentCb.checked; parentCb.dispatchEvent(new Event('change', {bubbles:true})); }
    });
    }else{
        row.innerHTML = `
        <input class="form-check-input me-3 spm-adult" type="checkbox" value="${g.id}" ${picked.has(g.id)?'checked':''}>
            <div class="flex-grow-1 spm-name">${nameHtml}</div>`;
            
            // ÈªûÊï¥ÂàóÊàñÂêçÂ≠óÈÉΩÂèØÂàáÊèõ
            row.addEventListener('click', (e)=>{
                if (!e.target.classList.contains('spm-adult')){
                const cb = row.querySelector('.spm-adult');
                cb.checked = !cb.checked;
                cb.dispatchEvent(new Event('change', {bubbles:true}));
    }
    });
    // Áï∂ÂãæÈÅ∏ÁãÄÊÖãÊîπËÆäÔºåÊõ¥Êñ∞ picked set
    row.addEventListener('change', (e)=>{
        if (!e.target.classList.contains('spm-adult')) return;
        const id = e.target.value;
        if (e.target.checked) picked.add(id); else picked.delete(id);
    });
    }
    list.appendChild(row);
    });
    
    // ÂÖ®ÈÅ∏/ÂÖ®‰∏çÈÅ∏ Âè™‰ΩúÁî®ÊñºÂ§ß‰∫∫
    const btnAll  = $('#spm-select-all');
    const btnNone = $('#spm-clear-all');
    if (btnAll) btnAll.onclick = ()=>{ S.selectedPerPNR[pnr] = new Set(groups.filter(g=>!g.isChild).map(g=>g.id)); buildPicker(pnr); };
                                      if (btnNone) btnNone.onclick = ()=>{ S.selectedPerPNR[pnr].clear(); buildPicker(pnr); };
                                     }
                                      
                                      // ---------- ÈñãÂïü / Â•óÁî® ----------
                                      function openPicker(){
                                      const pnr = getCurrentPNR(); if(!pnr) return;
                                      ensureGroups(pnr);
                                      buildPicker(pnr);
                                      // ÈñãÂïüÊôÇÂÖàÈö±Ëóè‰∏ãÊñπ TableÔºàÁõ¥Âà∞Êåâ„ÄåÂ•óÁî®„ÄçÊâçÈ°ØÁ§∫Ôºâ
                                      toggleResults(false);
                                      const modalEl = $('#selectPassengersModal'); if(!modalEl) return;
                                      (bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl, {backdrop:'static'})).show();
    }
    
    function applySelection(){
        const pnr = getCurrentPNR(); if(!pnr) return;
        const groups = ensureGroups(pnr);
        const pickedAdults = S.selectedPerPNR[pnr];
        const finalIds = new Set();
        
        groups.forEach(g=>{
            if (!g.isChild && pickedAdults.has(g.id)){
            finalIds.add(g.id);
            if (g.childId) finalIds.add(g.childId);   // Â§ß‰∫∫ÂåÖÂê´Â∞èÂ≠©
        }
                       });
        
        // ÂØ´Âõû hiddenÔºåÁµ¶ÂæåÁ´Ø & ‰∏äÂÇ≥Áî®
        const hid = hiddenSelected();
        if (hid) hid.value = JSON.stringify(Array.from(finalIds));
        
        // Âè™È°ØÁ§∫Ë¢´ÈÅ∏ÁöÑÂ§ß‰∫∫ + Â∞èÂ≠©ÁöÑÂÖ©Âàó
        groups.forEach(g=>{
            const show = finalIds.has(g.id) || (g.isChild && g.parentId && finalIds.has(g.parentId));
            g.rows.forEach(tr => tr.style.display = show ? '' : 'none');
        });
        
        S.appliedPerPNR[pnr] = true;
        toggleResults(true);
        
        const modalEl = $('#selectPassengersModal');
        const inst = modalEl ? bootstrap.Modal.getInstance(modalEl) : null;
        if (inst) inst.hide();
    }
    
    // ---------- Á∂ÅÂÆöÂ•óÁî®ÊåâÈàï ----------
    /*document.addEventListener('click', function(e){
        if (e.target && e.target.id === 'spm-apply'){
            e.preventDefault();
            try{ applySelection(); } catch(err){ console.error('[SPM3] apply failed:', err); }
        }
    });*/
    document.addEventListener('click', function(e){
  const btn = e.target.closest('#spm-apply');
  if (btn) {
    e.preventDefault();
    applySelection();
  }
});
    
    // ---------- ÂàÜÈ†ÅÂàáÊèõÔºöÂ∑≤Â•óÁî® ‚Üí Â•óÁî®ÁØ©ÈÅ∏ÔºõÊú™Â•óÁî® ‚Üí ÂÜçÈñã Picker ----------
    document.addEventListener('DOMContentLoaded', function(){
        $$('[data-bs-toggle="tab"]').forEach(tabLink => {
            tabLink.addEventListener('shown.bs.tab', function(){
            const pnr = getCurrentPNR(); if(!pnr) return;
            ensureGroups(pnr);
            if (S.appliedPerPNR[pnr]){
            // ÈáçÊñ∞Â•óÁî®ÁõÆÂâç hidden ÁöÑÂêçÂñÆÔºàÈÅøÂÖç DOM ÈáçÁπ™Â§±ÂéªÈ°ØÁ§∫ÁãÄÊÖãÔºâ
            const ids = new Set(JSON.parse(hiddenSelected()?.value || '[]'));
            const groups = S.groupsPerPNR[pnr];
            groups.forEach(g=>{
            const show = ids.has(g.id) || (g.isChild && g.parentId && ids.has(g.parentId));
            g.rows.forEach(tr => tr.style.display = show ? '' : 'none');
        });
        toggleResults(true);
    }else{
                              openPicker();
    }
    });
    });
    });
    
    // ---------- Ëá™ÂãïÂΩàÂá∫ÔºöÂú® showTabs() ÂæåËß∏ÁôºÔºõ‰∏¶Âú®ÊØèÊ¨° search Âæå RESET ÁãÄÊÖã ----------
    (function wrapShowTabs(){
        if (window.__SPM3_WRAP_SHOWTABS__) return;
        window.__SPM3_WRAP_SHOWTABS__ = true;
        const _orig = window.showTabs;
        window.showTabs = function(){
            const rv = (typeof _orig === 'function') ? _orig.apply(this, arguments) : undefined;
            // ÈáçÊñ∞ÊêúÂ∞ãÂæåÔºöÊ∏ÖÁ©∫ S ÁãÄÊÖã & hidden ÂêçÂñÆ
            S.selectedPerPNR = {};
            S.groupsPerPNR = {};
            S.appliedPerPNR = {};
            const hid = hiddenSelected(); if (hid) hid.value = '[]';
            // Á≠â reRender ÂÆåÔºåÊâìÈñã‰∏ÄÊ¨°
            setTimeout(()=>{ openPicker(); }, 30);
                            return rv;
                           };
                           })();
                            
                            // ---------- ‰∏äÂÇ≥ÔºöËã•ÊúâÂêçÂñÆ ‚Üí ÂëºÂè´ uploadDocumentSelected ----------
                            (function wrapUpload(){
                            const _orig = window.doUploadDocument;
                            window.doUploadDocument = function(){
                            try{
                            const hid = hiddenSelected();
                            const val = hid?.value || '[]';
                            const ids = JSON.parse(val);
                            if (Array.isArray(ids) && ids.length>0 && typeof window.doUploadDocumentWithIds==='function'){
                            return window.doUploadDocumentWithIds(val);
                           }
                           }catch(e){}
                            if (typeof _orig === 'function') return _orig.apply(this, arguments);
                           };
                           })();
                            
                            // ---------- Â∞çÂ§ñÈô§ÈåØ ----------
                            window.__SPM3_API__ = { openPicker, applySelection, collectGroups, state:S };
                       })();
            </script>
    <script>
    /* fix: Èò≤Ê≠¢ label ÈÄ†ÊàêÁöÑÈ†êË®≠ÂàáÊèõÔºåÊîπÁÇ∫Âè™ÊâãÂãïÂàá‰∏ÄÊ¨° */
    (function(){
        document.addEventListener('click', function (e) {
            const list = document.getElementById('spm-list');
            if (!list || !list.contains(e.target)) return;
            
            const row = e.target.closest('.list-group-item');
            if (!row) return;
            
            const cb = row.querySelector('input.spm-adult');
            if (!cb) return; // Â∞èÂ≠©ÂàóÊ≤íÊúâ checkbox
            
            // Âè™Ë¶ÅÈªûÂà∞„ÄåÈùû checkbox Êú¨È´î„ÄçÔºåÂ∞±ÈòªÊ≠¢ label ÁöÑÈ†êË®≠ÂàáÊèõÔºåÊîπÊàêÊàëÂÄëËá™Â∑±Âàá‰∏ÄÊ¨°
            if (!e.target.classList.contains('spm-adult')) {
                e.preventDefault();       // ÈòªÊ≠¢ label ÁöÑÂéüÁîüÂàáÊèõ
                e.stopPropagation();      // ÈÅøÂÖçÂÜíÊ≥°ÈÄ†ÊàêÂÖ∂‰ªñ‰∫åÊ¨°ËôïÁêÜ
                cb.checked = !cb.checked; // ÊîπÁî±ÊàëÂÄëÊâãÂãïÂàá
                cb.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }, true);
    })();
    </script>
    <script>
    /* [Append-only] ËÆì„ÄåÂàáÊèõ‰ªª‰ΩïÂàÜÈ†Å„ÄçÈÉΩÊúÉÈñã ModalÔºàÊú™Â•óÁî®ËÄÖÔºâÊàñÈáçÊñ∞Â•óÁî®ÈÅéÊøæÔºàÂ∑≤Â•óÁî®ËÄÖÔºâ */
    (function(){
        // Â∞èÂ∑•ÂÖ∑ÔºöÂèñÂæóÁõÆÂâç PNR
        function getCurrentPNR(){
            const active = document.querySelector('#tabResults .nav-link.active');
            if(!active) return null;
            const target = active.getAttribute('data-bs-target')||'';
            return target.replace('#tab','') || active.textContent.trim();
        }
        // ‰æùÁï∂ÂâçÂàÜÈ†Å DOM Âª∫Á´ãÁæ§ÁµÑÔºàÂíå‰Ω†‰∏ªËÖ≥Êú¨‰∏ÄËá¥Ôºâ
        function rebuildGroups(pnr){
            const pane = document.querySelector('#tab'+pnr+'.tab-pane');
            if(!pane) return [];
            const rows = Array.from(pane.querySelectorAll('tbody tr'));
            const groups = [];
            let lastAdultIdx = -1;
            for(let i=0;i<rows.length;i++){
                const r = rows[i];
                const nameCell = r.querySelector('td[style*="position:sticky"]');
                if(!nameCell) continue;
                const next = rows[i+1] || null;
                let recId = null;
                const hid = r.querySelector('input[type="hidden"][data-id]');
                if(hid) recId = hid.getAttribute('data-id');
                if(!recId){
                    const btn = r.querySelector('.USaddressbtn[data-id]');
                    if(btn) recId = btn.getAttribute('data-id');
                }
                if(!recId) continue;
                const isChild = (nameCell.innerText||'').includes('‚îî');
                const g = { id: recId, isChild, parentId:null, childId:null, rows:[r,next].filter(Boolean) };
                if(isChild && lastAdultIdx>=0){
                    g.parentId = groups[lastAdultIdx].id;
                    groups[lastAdultIdx].childId = g.id;
                }else if(!isChild){
                    lastAdultIdx = groups.length;
                }
                groups.push(g);
            }
            return groups;
        }
        function toggleResults(show){
            const sr = document.getElementById('searchResults');
            const fb = document.getElementById('fixedBottomButtons');
            if (sr) sr.style.display = show ? '' : 'none';
            if (fb) fb.style.display = show ? '' : 'none';
        }
        
        // ÂßîÊ¥æÁõ£ËÅΩÔºö‰ªª‰Ωï tab È°ØÁ§∫ÈÉΩÊúÉËß∏ÁôºÔºàÊ∂µËìã reRender ÂæåÁöÑÊñ∞ÁØÄÈªûÔºâ
        document.addEventListener('shown.bs.tab', function(e){
            // ÂÉÖËôïÁêÜ PNR ÂàÜÈ†Å
            if(!e.target || !e.target.matches('#tabResults [data-bs-toggle="tab"]')) return;
            
            const pnr = getCurrentPNR(); if(!pnr) return;
            
            // Á¢∫‰øù SPM ÁãÄÊÖãÁâ©‰ª∂Â≠òÂú®
            window.__SPM3__ = window.__SPM3__ || { appliedPerPNR:{}, selectedPerPNR:{}, groupsPerPNR:{} };
            const S = window.__SPM3__;
            
            // ÊØèÊ¨°ÂàáÂàÜÈ†ÅÈÉΩ‰ª•ÊúÄÊñ∞ DOM ÈáçÂª∫Áæ§ÁµÑÔºàÈÅøÂÖçÊ≤øÁî®ËàäÂø´ÂèñÔºâ
            const groups = rebuildGroups(pnr);
            S.groupsPerPNR[pnr] = groups;
            S.selectedPerPNR[pnr] = S.selectedPerPNR[pnr] || new Set();
            
            if (S.appliedPerPNR[pnr]) {
                // Â∑≤Â•óÁî®Ôºö‰æùÂ∑≤ÂãæÈÅ∏ÁöÑÂ§ß‰∫∫ÈáçÁÆó finalIds ‰∏¶ÈÅéÊøæÈ°ØÁ§∫
                const pickedAdults = S.selectedPerPNR[pnr];
                const finalIds = new Set();
                groups.forEach(g=>{
                    if(!g.isChild && pickedAdults.has(g.id)){
                    finalIds.add(g.id);
                    if(g.childId) finalIds.add(g.childId);
                }
                               });
                groups.forEach(g=>{
                    const show = finalIds.has(g.id) || (g.isChild && g.parentId && finalIds.has(g.parentId));
                    g.rows.forEach(tr=> tr.style.display = show ? '' : 'none');
                });
                toggleResults(true);
            } else {
                // Êú™Â•óÁî®ÔºöÂÖàÈö±ËóèË°®Ê†ºÔºåÁõ¥Êé•ÊâìÈñã Modal ËÆì‰Ω†ÈÅ∏
                toggleResults(false);
                if (typeof window.__SPM3_API__?.openPicker === 'function') {
                    window.__SPM3_API__.openPicker();
                    } else {
                    // ÂæåÂÇôÔºöÁõ¥Êé•Èñã Modal
                    const el = document.getElementById('selectPassengersModal');
                    if (el && window.bootstrap) (window.bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el,{backdrop:'static'})).show();
            }
        }
                                  }, true);
    })();
    </script>
    <script>
    /* [Append-only] ‰øÆË£úÁ¨¨‰∫åÈ†ÅÂæå Modal ÊóÖÂÆ¢ÂßìÂêçÈ°ØÁ§∫ÁÇ∫ undefined ÁöÑÂïèÈ°å */
    (function(){
        function getCurrentPNR(){
            const active = document.querySelector('#tabResults .nav-link.active');
            if(!active) return null;
            const target = active.getAttribute('data-bs-target')||'';
            return target.replace('#tab','') || active.textContent.trim();
        }
        
        // Â∞áÁº∫Â∞ë name ÁöÑÁæ§ÁµÑÔºåÂæûÁï∂ÂâçË°®Ê†º DOM ‰∏≠Ë£úÈΩäÔºà‰πüÈ†Ü‰æøÊõ¥Êñ∞ isChildÔºâ
        function fillMissingNames(pnr){
            const S = window.__SPM3__;
            if (!S || !S.groupsPerPNR || !S.groupsPerPNR[pnr]) return;
            const groups = S.groupsPerPNR[pnr];
            
            groups.forEach(g=>{
                if (!g.name) {
                const firstRow = g.rows && g.rows[0];
                if (!firstRow) return;
                const nameCell = firstRow.querySelector('td[style*="position:sticky"]');
                if (!nameCell) return;
                const txt = (nameCell.innerText || '').trim().replace(/\s+/g,' ');
                g.name = txt;
                g.isChild = txt.includes('‚îî'); // ‰ª•ÂØ¶ÈöõÈ°ØÁ§∫ÁÇ∫Ê∫ñÊõ¥Êñ∞ child Âà§Êñ∑
            }
                           });
        }
        
        // A) ÊØèÊ¨°ÂàÜÈ†ÅÈ°ØÁ§∫ÂæåÔºåÂÖàË£úÈΩä nameÔºàÈÅøÂÖçË¢´ËºÉÊó©ÁöÑÁ≤æÁ∞° rebuild Ë¶ÜËìãÔºâ
        document.addEventListener('shown.bs.tab', function(e){
            if(!e.target || !e.target.matches('#tabResults [data-bs-toggle="tab"]')) return;
            const pnr = getCurrentPNR(); if(!pnr) return;
            try { fillMissingNames(pnr); } catch(err){ console.warn('[SPM-name-fix] shown.bs.tab:', err); }
        }, true);
        
        // B) Âú®ÈñãÂïü Modal ‰πãÂâç‰πüË£ú‰∏ÄÊ¨°Ôºà‰øùÈö™Ôºâ
        if (window.__SPM3_API__ && typeof window.__SPM3_API__.openPicker === 'function') {
            const _origOpen = window.__SPM3_API__.openPicker;
            window.__SPM3_API__.openPicker = function(){
                try { const pnr = getCurrentPNR(); if(pnr) fillMissingNames(pnr); } catch(e){}
                return _origOpen.apply(this, arguments);
            };
        }
    })();
    </script>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ [Integrated SPM] End -->
    
</apex:page>