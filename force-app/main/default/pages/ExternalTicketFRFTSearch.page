<apex:page controller="ExternalTicketFRFTSearchController" action="{!ensureAuth}"
           docType="html-5.0" applyHtmlTag="true" 
           standardStylesheets="false" showHeader="false">
  <head>
    <title>F1 - Free &amp; Reduced Fare Tickets Search</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
      	/* 把你的 CSS 原封不動複製過來 */
      	body{ background:#E9ECEF; font-weight: 700; }
      	.shell{ width: 96%; margin: 20px auto; max-width: 1400px; }
      	.header{ display:flex; justify-content:flex-end; align-items:center; gap:14px; margin-bottom:16px; }
      	.btn{ background:#2F3B52; color:#fff; border-radius:999px; padding:.45rem .9rem; font-weight:700; letter-spacing:.3px; font-size:14px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
      	.badge-dept{ background:#FFF; color:#2F3B52;text-shadow: 0.2px 0 0 currentColor, -0.2px 0 0 currentColor;  border:none; border-radius:999px; padding:.45rem 1.1rem; font-weight:700; font-size:14px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
      	.canvas{ background:#fff; border-radius:12px; padding:48px 40px; min-height: calc(100vh - 160px); box-shadow:0 2px 10px rgba(0,0,0,.06); }
      	.grid-wrap{ padding: 20px 12px 40px; }
      	@media (max-width: 991px){ .header{ justify-content:space-between; } .grid-wrap{ padding:10px; } }
      	.notification-panel{ position: relative; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 16px; border-radius: 6px; box-sizing: border-box; padding: 14px 48px 14px 24px; min-width: 450px; margin: 12px auto; }
      	.success-notification{ background-color: #73AB5D; color: #fff; }
      	.slds-notify__close{ position: absolute; right: 16px; top: 50%; transform: translateY(-50%); appearance: none; background: transparent; border: 0; color: inherit; font-weight: 800; font-size: 18px; line-height: 1; cursor: pointer; opacity: .9; }
      	.slds-notify__close:hover { opacity: 1; }
      	.notify-wrap { position: fixed; top: 26px; left: 50%; transform: translateX(-50%); z-index: 1080; padding: 0 16px; }
        .btn:hover {
          background: #2F3B52 ; /* 淺灰藍 */
          color: #fff;
        }
        
        .btn:active {
          background: #7F8FA9; /* 更淺灰藍 */
          color: #fff;
        }
        .table, .table th, .table td {
            border: 2px solid #2F3B52 !important; /* 原本是 1px */
        }
        .table td {
            font-weight: 700; /* 粗體 */
        }
        
        /* 遮罩：鎖背景 */
        .modal-mask{
          position: fixed; inset: 0;
          background: rgba(0,0,0,.5);
          z-index: 1040;
        }
        
        /* 卡片 */
        .modal-card{
          position: fixed;
          top: 50%; left: 50%;
          transform: translate(-50%,-50%);
          width: min(560px, 92vw);
          background: #fff;
          border-radius: 6px;
          box-shadow: 0 10px 30px rgba(0,0,0,.2);
          z-index: 1050;
          padding: 40px 48px 28px;
          min-height: 360px;
          padding-left: 80px;
          padding-right: 80px;
        }
        
        /* 輸入框：底色 #EDF2F7、去邊框、focus 不改色不加外框 */
        .modal-card .form-control{
          background: #EDF2F7 !important;
          border: none !important;
          box-shadow: none !important;
          height: 44px;                   /* 視覺更穩定 */
          font-weight:700;
        }
        .modal-card .form-control:focus{
          background: #EDF2F7 !important;
          border: none !important;
          box-shadow: none !important;
          font-weight:700;
        }
        
        /* 右上角 X */
        .modal-close{
          position: absolute; top: 10px; right: 14px;
          text-decoration: none;
          color: #2F3B52; font-size: 22px; font-weight: 800;
        }
        
        /* 內容與按鈕 */
        .modal-body{ 
		  padding: 48px 4px 6px;
		  font-weight: 700; 
		  margin-bottom: 36px;
		}
        .modal-actions{
          display: flex; gap: 12px; justify-content: flex-end;
          padding-top: 10px;
        }
        
        /* 底部按鈕左右各半 */
        .modal-actions{
          display: flex;
          gap: 12px;
          padding-top: 16px;
        }
        .modal-actions .btn-split{
          flex: 1 1 50%;
          width: 50%;
          text-align: center;
          border-radius: 6px;            /* 比膠囊略方，視覺更穩 */
        }
                
        /* 按鈕風格（沿用你的主題） */
        .btn-cancel{
          background: #E2E2E2; color:#2F3B52;
          border-radius: 999px; padding:.55rem 1.2rem; font-weight:700; border:none;
          padding: 1rem 1.6rem;
  	      font-size: 16px; /* 字體也稍微大一點 */
          text-shadow: 0.4px 0 0 currentColor, -0.4px 0 0 currentColor;
        }
        .btn-cancel:hover{ background:#DEE2E6; }
        
       
        .btn-confirm{
          background:#2F3B52; color:#fff;
          border-radius: 999px; padding:.55rem 1.2rem; font-weight:700; border:none;
          padding: 1rem 1.6rem;
  	      font-size: 16px; /* 字體也稍微大一點 */
          text-shadow: 0.2px 0 0 currentColor, -0.2px 0 0 currentColor;
        }
        .btn-confirm:hover{ background:#5F6F8A; }
        .btn-confirm:active{ background:#7F8FA9; }
		.info-notification{
          background:#2F3B52;
          color:#fff;
        }
    </style>
  </head>

  <body>
    <!-- 置頂置中通知 -->
    <div class="shell">
      <!-- Header -->
      <div class="header">
        <span class="badge-dept">{!IF(NOT(ISBLANK(departmentCode)), departmentCode, '—')}</span>
        <apex:form >
          <apex:commandButton value="LOG OUT" action="{!logout}" styleClass="btn"/>
        </apex:form>
      </div>

      <!-- 白色內容區 -->
      <div class="canvas">
        <div class="grid-wrap">
            <!-- Error Toast（紅色） -->            
            <div class="notify-wrap">
              <div id="pleaseSearchToast" class="notification-panel info-notification" style="display:none; background:#BD484A; color:#FFFFFF;">
                <span>Please search again.</span>
                <button type="button" class="slds-notify__close" onclick="hideErrorToast()">×</button>
              </div>
            </div>
            <div class="notify-wrap" id="errorToast" style="{!IF(showError,'','display:none;')}">
              <div class="notification-panel" style="background:#BD484A; color:#FFFFFF;">
                <span>{!errorMsg}</span>
                <button type="button" class="slds-notify__close" onclick="hideErrorToast()">×</button>
              </div>
            </div>
            
            <!-- 遮罩 -->
            <div class="modal-mask" style="{!IF(showModal,'','display:none;')}"></div>
            
            <!-- 彈窗 -->
            <apex:form id="dialogForm">
              <div class="modal-card" style="{!IF(showModal,'','display:none;')}">
                <!-- 右上角關閉 -->
                <apex:commandLink action="{!cancel}" styleClass="modal-close" value="×" />
            
                <div class="modal-body">
                  <label class="form-label mb-2">BPM Application Number</label>
                  <apex:inputText value="{!bpmAppNo}" styleClass="form-control" html-placeholder="Please type" />
                </div>
            
                <div class="modal-actions">
                  <apex:commandButton value="CANCEL"  action="{!cancel}" styleClass="btn btn-cancel btn-split"/>
                  <apex:commandButton value="CONFIRM" action="{!search}" styleClass="btn btn-confirm btn-split" id="confirmBtn"/>
                </div>
              </div>
            </apex:form>

        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function getUrlParameter(name){
        name = name.replace(/[\[]/,'\\[').replace(/[\]]/,'\\]');
        var regex = new RegExp('[\\?&]'+name+'=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g,' '));
      }

      document.addEventListener('DOMContentLoaded', function(){
        var toastParam = getUrlParameter('toast');
        if (toastParam === 'login') {
          var el = document.getElementById('loginSuccessNotification');
          if (el) el.style.display = 'inline-flex';
        }

        // 讀 cookie 範例
        var cookies = document.cookie.split(';').reduce((acc, cookie) => {
          let [name, value] = cookie.split('=');
          acc[name.trim()] = decodeURIComponent(value);
          return acc;
        }, {});
        console.log('Cookies:', cookies);
      });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        var confirmBtnId = '{!$Component.dialogForm.confirmBtn}';
        var confirmBtn = document.getElementById(confirmBtnId);
        if (confirmBtn) {
          confirmBtn.click();
        }
      }
    });
      
    function hideErrorToast(){
      var t = document.getElementById('errorToast');
      var s = document.getElementById('pleaseSearchToast');
      if(t) t.style.display = 'none';
      if(s) s.style.display = 'none';
    }
    
    // 點擊畫面任何地方就隱藏錯誤提示
    document.addEventListener('click', function(e){
      if (!e.target.closest('#errorToast')) {
        hideErrorToast();
      }
    });

    document.addEventListener('DOMContentLoaded', function(){
      var toastParam = getUrlParameter('toast');
      if (toastParam === 'again') {
        var el = document.getElementById('pleaseSearchToast');
        if (el){
          el.style.display = 'inline-flex';
        }
      }
    });      
      
    </script>
  </body>
</apex:page>