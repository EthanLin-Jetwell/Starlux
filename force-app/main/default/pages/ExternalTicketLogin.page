<!--============================= Infos =======================================

Name: Login
Author: Erick Lin
Purpose: STARLUX Airlines 

Static Resources:
Name                             MIME        Description
-------------------------------------------------------------------------------


-------------------------------------------------------------------------------
Backup File:


============================= Infos =======================================-->
<apex:page controller="ExternalTicketLoginController" docType="html-5.0" applyHtmlTag="true" standardStylesheets="false" showHeader="false">
    <head>
        <title>L1 - Login</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
        <c:styleinclude ></c:styleinclude>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
        <style>
            .custom-validation-form .form-control.is-invalid {
            border-color: #41464A;
            padding-right: calc(1.5em + 0.75rem);
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
            }
            .login-sidebar {
            background-color: #41464A;
            color: white;
            }
            
            .custom-validation-form .invalid-feedback{
            margin-top:0
            }
            
            .custom-validation-form .form-control.is-invalid {
            background-image:none;
            
            }
            
            .form-control.is-valid:focus,
            .was-validated .form-control:valid:focus {
            box-shadow: 0 0 0 0.15rem rgba(160, 0, 0, 1);
            }

            .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: #666;
            }
            
            .toggle-password:focus {
            outline: none;
            }
            
            ::placeholder {
            color: #7D8289 !important;
            opacity: 1;
            }
            
            .form-control:focus {
            box-shadow: 0 0 0 0.15rem rgba(77, 140, 77, 1);
            } 
            
            .notification-panel {
              display: inline-flex;
              align-items: center;
              white-space: nowrap;
              background-color: #f8d7da;
              color: #721c24;
              font-weight: bold;
              font-size: 16px;
              border-radius: 6px;
              box-sizing: border-box;
              padding: 6px 24px;
              gap: 10px;
            
              /* 關鍵點：強制展開 */
              min-width: 450px;              /* ✅ 建議設一個實體寬度保底 */
              width: fit-content;            /* ✅ 更強大的 max-content 替代品 */
              max-width: 95vw;
              margin: 12px auto;
            }
            
            .notification-panel .slds-notify__close {
              margin-left: 4px;
            }
            
            .notification-panel img {
              margin-right: 2px;
              vertical-align: middle;
              height: 20px;
            }

            input[type="password"]::-ms-reveal {
            display: none !important;
            }
            
            input[type="password"]::-ms-clear {
            display: none !important;
            }
            
            input[type="password"]::-o-clear {
            display: none !important;
            }
            
            .slds-button{
            margin-right:10px !important;
            }
            
            body {
                background: linear-gradient(to right, #41464A 50%, #E3E3E3 50%);
            }
            
            .login-box {
            	padding-top: 60px; /* 加這一行讓整體往下 */
              	background-color: transparent !important;
                border: none !important;
                box-shadow: none !important;
            }
            .login-form {
              background-color: white;  /* 只有表單是白底 */
              padding: 66px;
              height: 600px;
            
            }
            .login-body {
              padding-left: 6%;
              padding-right: 6%;
            }
            
            .btn-login-full {
              width: 100%;
              background-color: #41464A;
              color: white;
              border-radius: 5rem;
              font-weight: bold;
              padding: 14px;
              font-size: 18px;
              border: none;
            }
            
            /* 輸入框：統一底色、邊框、加粗、放大 */
            .input-custom-style {
              background-color: #EDF2F7 !important;
              border: 1px solid #EDF2F7 !important;
              font-weight: bold;
              font-size: 110%;
              height: calc(1.5em + 1.25rem + 2px);
            }
            
            /* 圖示大小微調以符合放大的欄位 */
            .material-symbols-outlined {
              font-size: 24px !important;
            }

.position-fixed .notification-panel.success-notification {
  background-color:#73AB5D !important;
  color:#fff !important;
}
/* 關閉叉叉樣式 —— 放在最後 */
.slds-notify__close{
  appearance: none;
  -webkit-appearance: none;
  background: transparent;   /* 透明背景 */
  border: 0;                 /* 去邊框 */
  color: inherit;            /* 跟著父層字色（綠底白字時就是白色） */
  font-weight: 800;
  font-size: 20px;           /* 叉叉大小 */
  line-height: 1;
  padding: 0;
  margin-left: 8px;          /* 與文字間距 */
  cursor: pointer;
  opacity: .9;
}
.slds-notify__close:hover{ opacity: 1; }
.slds-notify__close:focus{ outline: none; box-shadow: none; }
        </style>
    </head>
    
    
    <body class="d-flex flex-column align-items-center py-4">
        <div style="width: 100%; text-align: center; margin-bottom: 20px;">
            <c:globalnotification message="登入已超過 {!logoutminutes} 分鐘，請重新登入以繼續使用" isVisible="{!islogout}" />
            <c:globalnotification message="Incorrect Department Code or Verification Code." isVisible="{!isWrongCredentials}" />
            <c:globalnotification message="帳號尚未開通，已重新寄送開通信件" isVisible="{!isAccountInactive}" />
            <apex:outputPanel rendered="{!isPasswordExpired}">
                <c:globalnotification message="密碼已逾期，請重新重設密碼" isVisible="{!isPasswordExpired}" />
            </apex:outputPanel>
        </div>
<!-- Logout Success Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
  <div id="logoutSuccessNotification" class="notification-panel success-notification" style="display:none;">
    <span>Logged out successfully.</span>
    <button type="button" class="slds-notify__close" onclick="this.parentElement.style.display='none';">×</button>
  </div>
</div> 
        <apex:outputPanel id="messagePanel" layout="block" style="position: absolute; top: 0; right: 0; transform: scale(0.5); color: transparent;">
            <apex:pageMessages id="messages"/>
        </apex:outputPanel>
        
        <main class="login-container mx-auto">
            <apex:form id="loginForm">
                <div class="card login-box">
                    <div class="row g-0 login-body">
                        <div class="col-md-5 login-sidebar d-flex flex-column justify-content-center" style="height:600px">
                            <h3 class="fw-bold mb-2 text-center login-title"><img src="{!URLFOR($Resource.StarluxLogo_White)}" class="logo" alt="Logo" style="width:50%;height:auto;font-size:34px"/></h3>
                        </div>
                        <div class="col-md-2"></div> 
                        <div class="col-md-5 login-form" style="padding:66px;height:600px" >
                            <div class="w-100">
                                <h2 class="fw-bold pb-2" style="font-size:28px;">Hi! Welcome back.</h2>
                                <p style="font-size:18px;color:rgba(65, 70, 74, 1);font-weight:bold;margin-bottom:48px">Free &amp; Reduced Fare Tickets Quota Inquiry System</p>
                                
                                <div class="custom-validation-form">
                                  <div class="position-relative test1" style="margin-bottom:48px">
                                    <span class="material-symbols-outlined" style="position:absolute;margin:11px 8px 10px 16px;color:rgba(65, 70, 74, 1)">work</span>
                                    <apex:inputText style="padding-left:50px" id="CompanyType" styleClass="form-control input-custom-style" value="{!CompanyType}" html-placeholder="Company Type" maxlength="20"/>
                                    <div id="CompanyTypeFeedback" class="invalid-feedback" style="margin-top:0">
                                      必填
                                    </div>
                                  </div>
                                
                                  <div class="position-relative test1" style="margin-bottom:48px">
                                    <span class="material-symbols-outlined" style="position:absolute;margin:11px 8px 10px 16px;color:rgba(65, 70, 74, 1)">account_circle</span>
                                    <apex:inputText style="padding-left:50px" styleClass="form-control input-custom-style" value="{!DepartmentCode}" html-placeholder="Deparment Code" maxlength="11"/>
                                    <div class="invalid-feedback" style="margin-top:0">
                                      必填
                                    </div>
                                  </div> 
                                
                                  <div class="position-relative test1" style="margin-bottom:48px">
                                    <span class="material-symbols-outlined" style="position:absolute;margin:11px 8px 10px 16px;color:rgba(65, 70, 74, 1)">lock</span>
                                    <button type="button" class="toggle-password" tabindex="-1" onclick="togglePassword(this)">
                                      <i class="fas fa-eye-slash"></i>
                                    </button>
                                    <apex:inputSecret style="padding-left:50px;padding-right:32px" styleClass="form-control input-custom-style" value="{!VerificationCode}" html-placeholder="Verification Code" maxlength="50"/>
                                    <div class="invalid-feedback" style="margin-top:0;">
                                      必填
                                    </div>
                                  </div>
                                    
                                    <div>
                                        <apex:commandButton styleClass="btn-login-full mb-3" 
                                            action="{!login}" 
                                            value="LOGIN" 
                                            onclick="return validateForm(event);" 
                                            id="loginBtn"/>
                                    </div>
                                    <!--<apex:commandLink action="{!forgotPassword}" value="忘記密碼"/>-->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </apex:form>
            <!--
            <div class="card-footer text-center mt-3">
                <p class="text-white" style="font-size:14px">COPYRIGHT © 2024 STARLUX AIRLINES. ALL RIGHTS RESERVED. </p>
            </div>
            -->
            
            
        </main>
        
    </body>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script>   
    // 偵測使用者按下 Enter 鍵
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // 防止表單預設提交動作
            document.getElementById('{!$Component.loginForm.loginBtn}').click(); // 觸發登入按鈕
        }
    });
    
    
    // 讀取 URL 參數的函數
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
document.addEventListener('DOMContentLoaded', function(){
  var toastParam = getUrlParameter('toast');
  if (toastParam === 'logout') {
    var el = document.getElementById('logoutSuccessNotification');
    if (el) el.style.display = 'inline-flex';
  }
});
    // 當頁面載入時執行
    document.addEventListener('DOMContentLoaded', function() {
        // 取得 resetPassword 參數值
        var resetPassword = getUrlParameter('resetPassword');
        
        // 如果 resetPassword 為 true，顯示通知元件
        if (resetPassword === 'true') {
            document.querySelector('.successNotification').style.display = 'block';
        }
    });
    
    
    function validateForm(event) {
        var form = document.querySelector('.custom-validation-form');
        var inputs = form.querySelectorAll('input');
        var isValid = true;
        
        // Regular expressions for validation
        const numberOnly = /^\d+$/;
        const alphanumericSpecial = /^[A-Za-z0-9\-]+$/;
        const alphanumericOnly = /^[A-Za-z0-9]+$/;
        
        inputs.forEach(function(input) {
        var test1Element = input.closest('.test1');
        var feedbackElement = input.parentElement.querySelector('.invalid-feedback');
        var value = input.value.trim();
        
        // Reset styles
        input.classList.remove('is-invalid');
        input.parentElement.classList.remove('was-validated');
        if (test1Element) {
        test1Element.style.marginBottom = '48px';
        }
        
        // Common validation: Required field
        if (value === '') {
        isValid = false;
        setInvalid(input, test1Element, feedbackElement, "必填");
        return;
        }
        
        // Specific validations based on placeholder
        switch(input.placeholder) {
        case "Company Type":
        // Check if numbers only
        if (!alphanumericSpecial.test(value)) {
            isValid = false;
            setInvalid(input, test1Element, feedbackElement, "僅英文字、數字，特殊符號(-)");
            return;
        }
        break;
        
        case "Deparment Code":
        // Check if alphanumeric and special characters only
        if (!alphanumericOnly.test(value)) {
            isValid = false;
            setInvalid(input, test1Element, feedbackElement, "僅英文字、數字");
            return;
        }
        break;
        
        case "Verification Code":
        // Check if alphanumeric and special characters only
        if (!alphanumericOnly.test(value)) {
            isValid = false;
            setInvalid(input, test1Element, feedbackElement, "僅英文字、數字");
            return;
        }
        break;
    }
    });
    
    // Adjust eye button position if needed
    adjustTogglePasswordPosition();
    
    if (!isValid) {
        event.preventDefault();
    }
    return isValid;
    }
    
    // Helper function to set invalid state
    function setInvalid(input, test1Element, feedbackElement, message) {
        input.classList.add('is-invalid');
        input.parentElement.classList.add('was-validated');
        if (feedbackElement) {
            feedbackElement.textContent = message;
        }
        if (test1Element) {
            test1Element.style.marginBottom = 'calc(48px - 21px)';
        }
    }
    
    
    function togglePassword(button) {
        const input = button.parentElement.querySelector('input');
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        }
    }
    
    function adjustTogglePasswordPosition() {
        const toggleButtons = document.querySelectorAll('.toggle-password');
        toggleButtons.forEach(function(button) {
            const input = button.parentElement.querySelector('input');
            const icon = button.querySelector('i');
            const inputHeight = input.offsetHeight;
            
            button.style.top = (inputHeight / 2) + 'px';  // 重新定位按鈕，確保居中
        });
    }
    
    function closeNotification(button) {
        // 對應 parent .notification-panel 來關閉該區塊
        var panel = button.closest('.notification-panel');
        if (panel) {
            panel.style.display = 'none';
        }
    }
    
    document.addEventListener('click', function(event) {
        // 尋找所有 notification 面板（可能有多個）
        const notifications = document.querySelectorAll('.notification-panel');
        
        notifications.forEach(function(notification) {
            // 如果點擊的不是 notification 裡面的東西，就關閉
            if (!notification.contains(event.target)) {
                notification.style.display = 'none';
            }
        });
    });

    </script>
</apex:page>