<apex:page controller="ExternalTicketQuotaStatisticsController" action="{!ensureAuth}"
           docType="html-5.0" applyHtmlTag="true" 
           standardStylesheets="false" showHeader="false">
  <head>
    <title>Q1 - Quota Statistics</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
      	/* 把你的 CSS 原封不動複製過來 */
      	body{ background:#E9ECEF; }
      	.shell{ width: 96%; margin: 20px auto; max-width: 1400px; }
      	.header{ display:flex; justify-content:flex-end; align-items:center; gap:14px; margin-bottom:16px; }
      	.btn{ background:#2F3B52; color:#fff; border-radius:999px; padding:.45rem .9rem; font-weight:700; letter-spacing:.3px; font-size:14px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
		.badge-dept{ background:#FFF; color:#2F3B52;text-shadow: 0.2px 0 0 currentColor, -0.2px 0 0 currentColor;  border:none; border-radius:999px; padding:.45rem 1.1rem; font-weight:700; font-size:14px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }      	.canvas{ background:#fff; border-radius:12px; padding:48px 40px; min-height: calc(100vh - 160px); box-shadow:0 2px 10px rgba(0,0,0,.06); }
      	.grid-wrap{ padding: 20px 12px 40px; }
      	@media (max-width: 991px){ .header{ justify-content:space-between; } .grid-wrap{ padding:10px; } }
      	.notification-panel{ position: relative; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 16px; border-radius: 6px; box-sizing: border-box; padding: 14px 48px 14px 24px; min-width: 450px; margin: 12px auto; }
      	.success-notification{ background-color: #73AB5D; color: #fff; }
      	.slds-notify__close{ position: absolute; right: 16px; top: 50%; transform: translateY(-50%); appearance: none; background: transparent; border: 0; color: inherit; font-weight: 800; font-size: 18px; line-height: 1; cursor: pointer; opacity: .9; }
      	.slds-notify__close:hover { opacity: 1; }
      	.notify-wrap { position: fixed; top: 26px; left: 50%; transform: translateX(-50%); z-index: 1080; padding: 0 16px; }
        .btn:hover {
          background: #2F3B52 ; /* 淺灰藍 */
          color: #fff;
        }
        
        .btn:active {
          background: #7F8FA9; /* 更淺灰藍 */
          color: #fff;
        }
        .table, .table th, .table td {
            border: 2px solid #2F3B52 !important; /* 原本是 1px */
        }
        .table td {
            font-weight: 600; /* 粗體 */
        }
        
        /* 只縮這張表的字級與行高 */
        .quota-table{
          font-size: 15px;     /* 原本 14~16，視覺會明顯變窄 */
          line-height: 1.15;
        }
        
        /* 表頭可再小一點（第二列小標更小） */
        .quota-table thead th{ font-size: 14px; }
        .quota-table thead tr:nth-child(2) th{ font-size: 13px; }
        
        /* 同時縮 cell padding，讓整體更緊湊 */
        .quota-table th,
        .quota-table td{
          padding: .45rem .45rem;      /* 比 Bootstrap 預設更小 */
          border-width: 1px !important;/* 你先前設 2px，改回 1px 比較不吃寬 */
        }
        
        
        
    </style>
  </head>

  <body>
    <!-- 置頂置中通知 -->
    <div class="notify-wrap">
      <div id="loginSuccessNotification" class="notification-panel success-notification" style="display:none;">
        <span>Login Successfully</span>
        <button type="button" class="slds-notify__close" onclick="this.parentElement.style.display='none';">×</button>
      </div>
    </div>

    <div class="shell">
      <!-- Header -->
      <div class="header">
        <span class="badge-dept">{!IF(NOT(ISBLANK(departmentCode)), departmentCode, '—')}</span>
        <apex:form >
          <apex:commandButton value="LOG OUT" action="{!logout}" styleClass="btn"/>
        </apex:form>
      </div>

      <!-- 白色內容區 -->
      <div class="canvas">
        <div class="grid-wrap">
            <table class="table table-bordered text-center align-middle quota-table">
                <thead class="table-light">
                    <tr>
                        <th></th>
                        <apex:repeat value="{!discountCodes}" var="code">
                            <th colspan="4">{!code}</th>
                        </apex:repeat>
                    </tr>
                    <tr>
                        <th></th>
                        <apex:repeat value="{!discountCodes}" var="code">
                            <th>Total</th>
                            <th>Transit</th>
                            <th>Used</th>
                            <th>Remain</th>
                        </apex:repeat>
                    </tr>
                </thead>
                <tbody>
                    <apex:repeat value="{!discountRows}" var="row">
                        <tr>
                            <td>{!row}</td>
                            <apex:repeat value="{!discountCodes}" var="code">
                                <apex:variable var="data" value="{!IF(
                                    AND(NOT(ISBLANK(quotaMap[row])),
                                        NOT(ISBLANK(quotaMap[row][code]))
                                    ),
                                    quotaMap[row][code],
                                    null
                                )}"/>
                                <td>{!IF(ISBLANK(data.total), '-', data.total)}</td>
                                <td>{!IF(ISBLANK(data.transit), '-', data.transit)}</td>
                                <td>{!IF(ISBLANK(data.used), '-', data.used)}</td>
                                <td>{!IF(ISBLANK(data.remain), '-', data.remain)}</td>
                            </apex:repeat>
                        </tr>
                    </apex:repeat>
                </tbody>
            </table>

            <div style="margin-bottom: 20px;">
                <a href="{!URLFOR($Page.ExternalTicketHome)}"
                   class="btn" 
                   style="text-decoration:none; padding:.6rem 1.4rem; font-size:16px;">
                    BACK
                </a>
            </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function getUrlParameter(name){
        name = name.replace(/[\[]/,'\\[').replace(/[\]]/,'\\]');
        var regex = new RegExp('[\\?&]'+name+'=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g,' '));
      }

      document.addEventListener('DOMContentLoaded', function(){
        var toastParam = getUrlParameter('toast');
        if (toastParam === 'login') {
          var el = document.getElementById('loginSuccessNotification');
          if (el) el.style.display = 'inline-flex';
        }

        // 讀 cookie 範例
        var cookies = document.cookie.split(';').reduce((acc, cookie) => {
          let [name, value] = cookie.split('=');
          acc[name.trim()] = decodeURIComponent(value);
          return acc;
        }, {});
        console.log('Cookies:', cookies);
      });
    </script>
  </body>
</apex:page>