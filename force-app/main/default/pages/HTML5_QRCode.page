<apex:page controller="QRcodeScanController" showHeader="false" sidebar="false">
    <html lang="en">
        <head>
            <meta charset="UTF-8"/>
            <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
            <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
            <title>Document</title>
            <style>
                main {
                display: flex;
                justify-content: center;
                align-items: center;
                }
                #reader {
                width: 90vh ;
                height: 90vh;
                
                }
                #result {
                text-align: center;
                font-size: 1.5rem;
                }
            </style>
        </head>
        <body>
            <apex:form id="scanForm">
                <apex:actionFunction action="{!afterScan}" name="callAfterScan" reRender="resultPanel">
                    <apex:param name="scannedValueParam" value=""/>
                </apex:actionFunction>
                <input type="hidden" id="scannedValueInput" name="scannedValue" value="" />
            </apex:form>
            
            <div id="resultPanel" style='padding:10px; text-align:center; font-size:15px;'>
                <apex:outputText value="{!errorMessage}" style="color: red;" rendered="{!NOT(ISBLANK(errorMessage))}" />
            </div>
            
            <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js" integrity="sha512-k/KAe4Yff9EUdYI5/IAHlwUswqeipP+Cp5qnrsUjTPCgl51La2/JhyyjNciztD7mWNKLSXci48m7cctATKfLlQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
            
            <main>
                <div id="reader"></div>
                <div id="result"></div>
            </main>
            <script>
                const scanner = new Html5QrcodeScanner('reader', {
                    qrbox: {
                        width: 250,
                        height: 250,
                    },
                    fps: 20,
                });

                scanner.render(scanSuccess);

                function focusCamera(stream) {
                    let videoTrack = stream.getVideoTracks()[0];
                    if (typeof videoTrack.getCapabilities === 'function') {
                        let capabilities = videoTrack.getCapabilities();
                        if (capabilities.focusDistance) {
                            videoTrack.applyConstraints({ advanced: [{ focusDistance: 1 }] });
                        }
                    }
                }

                function scanSuccess(result) {
                    document.getElementById('scannedValueInput').value = result;
                    document.getElementById('result').innerHTML = `
                    <h2>Success!</h2>
                    <p><a href="${result}">${result}</a></p>
                    `;
                    scanner.clear();
                    document.getElementById('reader').remove();
                    
                    
                    callAfterScan(result);
                }

                // Add a click event to the video element to attempt focus on click
                setTimeout(() => {
                    let videoElement = document.querySelector('video');
                    if (videoElement) {
                        videoElement.addEventListener('click', () => {
                            let stream = videoElement.srcObject;
                            if (stream) {
                                focusCamera(stream);
                            }
                        });
                    }
                }, 2000);
            </script>
        </body>
    </html>
</apex:page>