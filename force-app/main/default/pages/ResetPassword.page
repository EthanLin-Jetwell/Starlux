<!--============================= Infos =======================================

Name: ResetPassword
Author: Benson Tseng 
Purpose: STARLUX Airlines 

Static Resources:
Name                             MIME        Description
-------------------------------------------------------------------------------


-------------------------------------------------------------------------------
Backup File:


============================= Infos =======================================-->
<apex:page controller="ResetPasswordController" docType="html-5.0" applyHtmlTag="true" standardStylesheets="false" showHeader="false">
    <head>
    <script>
      window.onload = function () {
        var isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        if (isTouchDevice) {
          // 取當前的 query string (例如 ?emailid=1223456)
          var query = window.location.search;
          // 拼到目標頁面
          window.location.href = '/ResetPasswordMobile' + query;
        }
      };
    </script>
        <title>ResetPassword</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
        <c:styleinclude ></c:styleinclude>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
        <apex:stylesheet value="{!$Resource.style_login}"/>
        <style>
            .login-sidebar {
            background-image: url('{!URLFOR($Resource.LoginBackground)}');
            color: white;
            }
            .custom-validation-form .form-control.is-invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
            }
            
            .custom-validation-form .invalid-feedback{
            margin-top:0
            }
            
            .custom-validation-form .form-control.is-invalid {
            background-image:none;
            
            }
            
            .form-control.is-valid:focus,
            .was-validated .form-control:valid:focus {
            border-color: rgba(142, 114, 72, 1);
            box-shadow: 0 0 0 0.25rem rgba(142, 114, 72, 0.25);
            }
            
            .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: #666;
            }
            
            .toggle-password:focus {
            outline: none;
            }
            
            ::placeholder {
            color: #ccc !important;
            opacity: 1;
            }
            
            .form-control:focus {
            border-color: rgba(142, 114, 72, 1);
            box-shadow: 0 0 0 0.2rem rgba(232, 224, 218, 0.5);
            } 
            
			            
            .custom-disabled {
                rgba(142, 114, 72, 1) !important;
            }
            
            input[type="password"]::-ms-reveal {
              display: none !important;
            }
            
            input[type="password"]::-ms-clear {
              display: none !important;
            }
            
            input[type="password"]::-o-clear {
              display: none !important;
            }
            
            .notification-panel {
            width: 400px !important;
            }
        </style>
    </head>
    
    <body class="d-flex align-items-center py-4">
        <c:globalnotification message="密碼不得與前三次設定相同" isVisible="{!isDifferentPassword}" />
        
        <apex:outputPanel rendered="{!isExpired}">
            <c:globalnotification message="驗證連結失效，請返回登入頁面重新驗證" isVisible="{!isExpired}" />
            
            <script>
            setTimeout(function() {
                window.location.href = '/apex/Login';
            }, 5000);  // 5秒後跳轉回登入頁
            </script>
        </apex:outputPanel>
        
        <apex:outputPanel rendered="{!isResetPassword}">
            <c:successNotification message="密碼已重設，請重新登入" isVisible="{!isResetPassword}" />
            
            <script>
            setTimeout(function() {
                window.location.href = '/apex/Login';
            }, 2000);  // 2秒後跳轉
            </script>
        </apex:outputPanel>
        
        <apex:outputPanel id="messagePanel" layout="block" style="position: absolute; top: 0; right: 0; transform: scale(0.5); color: transparent;">
            <apex:pageMessages id="messages"/>
        </apex:outputPanel>

        <main class="login-container mx-auto">
            <apex:form >
                <div class="card login-box">
                    <div class="row g-0 login-body">
                        <div class="col-md-6 login-sidebar d-flex flex-column justify-content-center" style="height:600px">
                            <h3 class="fw-bold mb-2 text-center login-title"><img src="{!URLFOR($Resource.Logo2)}" class="logo" alt="Logo" style="width:10%;height:auto;font-size:34px"/>旅遊同業團體作業B2B平台</h3>
                        </div>
                        <div class="col-md-6 login-form" style="padding:66px;height:600px; position:relative;">
                            <div class="=w-100">
                                <h2 class="fw-bold pb-2" style="font-size:36px">重置密碼</h2>
                                <p style="font-size:12px;color:rgba(142, 114, 72, 1);font-weight:bold;margin-bottom:50px">旅遊同業團體作業B2B平台</p>
                                
                                
                                <div class="custom-validation-form" style="padding-top:36px;">
                                    <div class="position-relative test1" style="margin-bottom:36px">
                                        <span class="material-symbols-outlined" style="position:absolute;margin:11px 8px 10px 16px;font-size:20px;color:rgba(142, 114, 72, 1)">lock</span>
                                        <!--<button type="button" class="toggle-password" onclick="togglePassword(this)"> <i class="fas fa-eye-slash"></i> </button>-->
                                        <apex:inputText style="padding-left:50px" id="newPassword" styleClass="form-control"  value="{!password}" html-placeholder="新密碼" maxlength="20"/>
                                        <div class="invalid-feedback" id="NewPasswordFeedback" style="margin-top:0">
                                            必填
                                        </div>
                                    </div>
                                    <div class="position-relative test1" style="margin-bottom:36px">
                                        <span class="material-symbols-outlined" style="position:absolute;margin:11px 8px 10px 16px;font-size:20px;color:rgba(142, 114, 72, 1)">lock_open</span>
                                        <button type="button" class="toggle-password" onclick="togglePassword(this)"> <i class="fas fa-eye-slash"></i> </button>
                                        <apex:inputSecret style="padding-left:50px" id="confirmPassword" styleClass="form-control"  value="{!newpassword}" html-placeholder="再次輸入新密碼" maxlength="20"/>
                                        <div class="invalid-feedback" id="confirmPasswordFeedback" style="margin-top:0">
                                            必填
                                        </div>
                                    </div>
                                    <apex:commandButton styleClass="w-100 btn btn-lg btn-primary btn-login mb-3 {!IF(isExpired, 'custom-disabled', '')}" action="{!resetPassword}" value="確認" disabled="{!isExpired}" onclick="return validateForm(event);"/>
                                </div>
                            </div>
                            <div style="position:absolute; right:6px; bottom:23px;">
                              <img src="{!URLFOR($Resource.Logo3)}" alt="Logo"/>
                            </div>
                        </div>
                    </div>
                </div>
            </apex:form>
            
            <div class="card-footer text-center mt-3">
                <p class="text-white" style="font-size:14px">COPYRIGHT © 2024 STARLUX AIRLINES. ALL RIGHTS RESERVED. </p>
            </div>
            

            
        </main>
        
    </body>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
<script>  

    // 檢查是否含有三碼升/降冪連續排列 (例如：ABC、CBA、aBc、123)
    function hasSequentialTriplet(str) {
        if (!str) return false;

        for (var i = 0; i <= str.length - 3; i++) {
            var c1 = str.charAt(i);
            var c2 = str.charAt(i + 1);
            var c3 = str.charAt(i + 2);

            // 英文字母 (忽略大小寫)
            if (/[A-Za-z]/.test(c1) && /[A-Za-z]/.test(c2) && /[A-Za-z]/.test(c3)) {
                var n1 = c1.toUpperCase().charCodeAt(0);
                var n2 = c2.toUpperCase().charCodeAt(0);
                var n3 = c3.toUpperCase().charCodeAt(0);

                // 升冪：ABC
                if (n2 === n1 + 1 && n3 === n2 + 1) return true;
                // 降冪：CBA
                if (n2 === n1 - 1 && n3 === n2 - 1) return true;
            }
            // 數字
            else if (/\d/.test(c1) && /\d/.test(c2) && /\d/.test(c3)) {
                var d1 = c1.charCodeAt(0);
                var d2 = c2.charCodeAt(0);
                var d3 = c3.charCodeAt(0);

                // 升冪：123
                if (d2 === d1 + 1 && d3 === d2 + 1) return true;
                // 降冪：321
                if (d2 === d1 - 1 && d3 === d2 - 1) return true;
            }
        }
        return false;
    }

    function validateForm(event) {
        var form = document.querySelector('.custom-validation-form');
        var inputs = form.querySelectorAll('input');
        var isValid = true;
        
        // Regular expressions for password validation
        const hasUpperCase   = /[A-Z]/;
        const hasLowerCase   = /[a-z]/;
        const hasNumber      = /\d/;
        const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/;
        
        inputs.forEach(function(input) {
            var test1Element    = input.closest('.test1');
            var feedbackElement = input.parentElement.querySelector('.invalid-feedback');
            var value           = input.value.trim();
            
            // Reset styles
            input.classList.remove('is-invalid');
            input.parentElement.classList.remove('was-validated');
            if (test1Element) {
                test1Element.style.marginBottom = '36px';
            }
            
            // Common validation: Required field
            if (value === '') {
                isValid = false;
                setInvalid(input, test1Element, feedbackElement, "必填");
                return;
            }
            
            // Specific validations based on placeholder
            switch(input.placeholder) {
                /*
                case "新密碼":
                    // Check minimum length
                    if (value.length < 10) {
                        isValid = false;
                        setInvalid(input, test1Element, feedbackElement, "請至少輸入10個字元");
                        return;
                    }
                    
                    // Check password complexity
                    if (!(hasUpperCase.test(value) && 
                          hasLowerCase.test(value) && 
                          hasNumber.test(value) && 
                          hasSpecialChar.test(value))) {
                        isValid = false;
                        setInvalid(
                            input, test1Element, feedbackElement,
                            "密碼需包含大寫、小寫英文字、特殊字元、數字"
                        );
                        return;
                    }

                    // ★ 新增：不得三碼升、降冪連續排列 (英數)
                    if (hasSequentialTriplet(value)) {
                        isValid = false;
                        setInvalid(
                            input, test1Element, feedbackElement,
                            "密碼不得三碼升、降冪連續排列 (例如：ABC、CBA、aBc、123)"
                        );
                        return;
                    }
                    break;*/
                case "新密碼": {
                    // 三個條件各自算結果
                    const isLenOk        = (value.length >= 10);
                    const isComplexOk    = (hasUpperCase.test(value) &&
                                            hasLowerCase.test(value) &&
                                            hasNumber.test(value) &&
                                            hasSpecialChar.test(value));
                    const isSeqTripletOk = !hasSequentialTriplet(value); // true = OK
                
                    // 只要有任何一個不符合，就一次回覆所有不符合的原因
                    if (!isLenOk || !isComplexOk || !isSeqTripletOk) {
                        isValid = false;
                
                        const msgs = [];
                        if (!isLenOk)        msgs.push("請至少輸入10個字元");
                        if (!isComplexOk)    msgs.push("密碼需包含大寫、小寫英文字、特殊字元、數字");
                        if (!isSeqTripletOk) msgs.push("密碼不得三碼升、降冪連續排列 (例如：ABC、CBA、aBc、123)");
                
                        setInvalid(input, test1Element, feedbackElement, msgs.join("；"));
                        return;
                    }
                    break;
                }
                    
                    
                case "再次輸入新密碼":
                    var newPasswordInput = form.querySelector('input[placeholder="新密碼"]');
                    // Check if passwords match
                    if (value !== newPasswordInput.value) {
                        isValid = false;
                        setInvalid(
                            input, test1Element, feedbackElement,
                            "密碼不相符，請重新輸入確認密碼"
                        );
                        return;
                    }
                    break;
            }
        });
        
        // 調整眼睛按鈕的位置
        adjustTogglePasswordPosition();
        
        if (!isValid) {
            event.preventDefault();
        }
        return isValid;
    }
    
    // Helper function to set invalid state
    function setInvalid(input, test1Element, feedbackElement, message) {
        input.classList.add('is-invalid');
        input.parentElement.classList.add('was-validated');
        if (feedbackElement) {
            feedbackElement.textContent = message;
        }
        if (test1Element) {
            test1Element.style.marginBottom = 'calc(36px - 21px)';
        }
    }
    
    
    function togglePassword(button) {
        const input = button.parentElement.querySelector('input');
        const icon  = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        }
    }
    
    function adjustTogglePasswordPosition() {
        const toggleButtons = document.querySelectorAll('.toggle-password');
        toggleButtons.forEach(function(button) {
            const input = button.parentElement.querySelector('input');
            const inputHeight = input.offsetHeight;
            button.style.top = (inputHeight / 2) + 'px';  // 重新定位按鈕，確保居中
        });
    }

</script>
</apex:page>