<apex:page controller="ResetPasswordController" docType="html-5.0" applyHtmlTag="true" standardStylesheets="false" showHeader="false">
  <head>
    <title>ResetPassword</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
    <c:styleinclude ></c:styleinclude>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <apex:stylesheet value="{!$Resource.style_login}"/>

    <style>
      /* ==== 通用驗證樣式（比照 LoginMobile） ==== */
      .custom-validation-form .form-control.is-invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 2.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }
      .custom-validation-form .invalid-feedback { display:block; min-height:18px; font-size:12px; color:#dc3545; visibility:hidden; }
      .form-control.is-invalid + .invalid-feedback { visibility: visible; }

      /* ==== 版面：直式單欄、上方窄橫幅 + 置中白卡 ==== */
      .login-sidebar {
        height: 8vh;
        background-image: url('{!$Resource.LoginBackground}');
        background-size: 105% auto; 
        background-position: left center;
        background-repeat: no-repeat;
        color: white;
        display: flex; align-items: center; justify-content: center; text-align: center;
        width: calc(100% - 6%);
        max-width: 600px; margin: auto;
        border-top-left-radius: 8px; border-top-right-radius: 8px;
        box-shadow: 4px 6px 12px rgba(0,0,0,0.35);
      }
      body { background-color:#f8f9fa; padding-top:12px; }
      .login-box { width: calc(100% - 6%); max-width: 600px; margin:auto; padding:40px; background:#fff; border-radius:0 0 8px 8px; box-shadow:4px 6px 12px rgba(0,0,0,0.35); }
      .form-control:focus { border-color: rgba(142,114,72,1); box-shadow: 0 0 0 0.2rem rgba(232,224,218,0.5); }
      .material-symbols-outlined { position:absolute; margin:11px 8px 10px 16px; font-size:20px; color: rgba(142,114,72,1); }
      .position-relative { position:relative; }
      .toggle-password { position:absolute; right:12px; top: 35%; transform: translateY(-50%); padding:0; border:none; background:none; color:#666; cursor:pointer; }

      .copyright { font-size:14px; }
    </style>
  </head>

  <body>
    <!-- 全域通知 & 成功/失效導頁 -->
    <c:globalnotification message="密碼不得與前三次設定相同" isVisible="{!isDifferentPassword}" />

    <apex:outputPanel rendered="{!isExpired}">
      <c:globalnotification message="驗證連結失效，請返回登入頁面重新驗證" isVisible="{!isExpired}" />
      <script>
        setTimeout(function(){ window.location.href = '/apex/Login'; }, 5000);
      </script>
    </apex:outputPanel>

    <apex:outputPanel rendered="{!isResetPassword}">
      <c:successNotification message="密碼已重設，請重新登入" isVisible="{!isResetPassword}" />
      <script>
        setTimeout(function(){ window.location.href = '/apex/Login'; }, 2000);
      </script>
    </apex:outputPanel>

    <!-- 保留 pageMessages -->
    <apex:outputPanel id="messagePanel" layout="block" style="position:absolute; top:0; right:0; transform:scale(0.5); color:transparent;">
      <apex:pageMessages id="messages"/>
    </apex:outputPanel>

    <!-- 上方窄 Banner -->
    <div class="login-sidebar">
      <h3>
        <img src="{!URLFOR($Resource.Logo2)}" class="logo" alt="Logo" style="width:9%;height:auto;font-size:24px"/>
        旅遊同業團體作業B2B平台
      </h3>
    </div>

    <main>
      <apex:form id="resetForm">
        <div class="login-box">
          <h2 class="fw-bold pb-2 text-center" style="font-size:30px">重置密碼</h2>
          <p class="text-center" style="font-size:12px; color: rgba(142,114,72,1); font-weight:bold; margin-bottom:24px;">旅遊同業團體作業B2B平台</p>

          <div class="custom-validation-form" style="padding-top: 6px;">
            <!-- 新密碼 -->
            <div class="position-relative mb-3" style="margin-top:24px;">
              <span class="material-symbols-outlined">lock</span>
              <button type="button" class="toggle-password" onclick="togglePw(this)"><i class="fas fa-eye-slash"></i></button>
              <apex:inputSecret id="newPassword" styleClass="form-control" value="{!password}" html-placeholder="新密碼" maxlength="20" style="padding-left:50px; padding-right:38px;"/>
              <div id="NewPasswordFeedback" class="invalid-feedback">必填</div>
            </div>

            <!-- 再次輸入新密碼 -->
            <div class="position-relative mb-3">
              <span class="material-symbols-outlined">lock_open</span>
              <button type="button" class="toggle-password" onclick="togglePw(this)"><i class="fas fa-eye-slash"></i></button>
              <apex:inputSecret id="confirmPassword" styleClass="form-control" value="{!newpassword}" html-placeholder="再次輸入新密碼" maxlength="20" style="padding-left:50px; padding-right:38px;"/>
              <div id="confirmPasswordFeedback" class="invalid-feedback">必填</div>
            </div>

            <apex:commandButton styleClass="w-100 btn btn-lg btn-primary btn-login mb-3 {!IF(isExpired, 'disabled', '')}" value="確認" action="{!resetPassword}" disabled="{!isExpired}" onclick="return validateForm(event);"/>
          </div>

          <div class="d-flex justify-content-end" style="width:100%">
            <img src="{!URLFOR($Resource.Logo3)}" class="mb-0" alt="Logo"/>
          </div>
        </div>
      </apex:form>
    </main>

    <div class="text-center mt-3">
      <p class="text-white copyright">COPYRIGHT © 2024 STARLUX AIRLINES. ALL RIGHTS RESERVED.</p>
    </div>

    <script>
      // Enter = submit
      document.addEventListener('keydown', function(e){
        if (e.key === 'Enter') {
          e.preventDefault();
          try { document.getElementById('{!$Component.resetForm.j_id0}').click(); } catch(err) {}
        }
      });

      function togglePw(btn){
        var input = btn.parentElement.querySelector('input');
        var icon = btn.querySelector('i');
        if (input.type === 'password') { input.type = 'text'; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
        else { input.type = 'password'; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); }
      }

      function validateForm(event){
        var form = document.querySelector('.custom-validation-form');
        var isValid = true;
        var pw1 = document.getElementById('{!$Component.resetForm.newPassword}');
        var pw2 = document.getElementById('{!$Component.resetForm.confirmPassword}');
        var hasUpper = /[A-Z]/; var hasLower = /[a-z]/; var hasNum = /\d/; var hasSpec = /[!@#$%^&amp;*(),.?":{}|<>]/;

        [pw1, pw2].forEach(function(input){ input.classList.remove('is-invalid'); });

        // 新密碼檢核
        var msg1 = document.getElementById('NewPasswordFeedback');
        var v1 = (pw1.value || '').trim();
        
        // reset（如果你前面已經做過可省略）
        msg1.textContent = '';
        pw1.classList.remove('is-invalid');
        
        if (!v1) {
          msg1.textContent = '必填';
          pw1.classList.add('is-invalid');
          isValid = false;
        } else {
          // 三個條件：長度、複雜度、連續三碼
          var isLenOk     = (v1.length >= 10);
          var isComplexOk = (hasUpper.test(v1) && hasLower.test(v1) && hasNum.test(v1) && hasSpec.test(v1));
          var isSeqOk     = !hasSequentialTriplet(v1);
        
          if (!isLenOk || !isComplexOk || !isSeqOk) {
            var msgs = [];
            if (!isLenOk)     msgs.push('請至少輸入10個字元');
            if (!isComplexOk) msgs.push('密碼需包含大寫、小寫英文字、特殊字元、數字');
            if (!isSeqOk)     msgs.push('密碼不得三碼升、降冪連續排列 (例如：ABC、CBA、aBc、123)');
        
            msg1.textContent = msgs.join('；');
            pw1.classList.add('is-invalid');
            isValid = false;
          }
        }

        // 二次確認
        var msg2 = document.getElementById('confirmPasswordFeedback');
        if (!pw2.value.trim()) { msg2.textContent='必填'; pw2.classList.add('is-invalid'); isValid=false; }
        else if (pw1.value !== pw2.value) { msg2.textContent='密碼不相符，請重新輸入確認密碼'; pw2.classList.add('is-invalid'); isValid=false; }

        if (!isValid) event.preventDefault();
        return isValid;
      }
      
    function hasSequentialTriplet(str) {
      if (!str) return false;
      var s = str;
    
      for (var i = 0; i <= s.length - 3; i++) {
        var c1 = s.charAt(i);
        var c2 = s.charAt(i + 1);
        var c3 = s.charAt(i + 2);
    
        // 英文字母 (忽略大小寫)
        if (/[A-Za-z]/.test(c1) && /[A-Za-z]/.test(c2) && /[A-Za-z]/.test(c3)) {
          var n1 = c1.toUpperCase().charCodeAt(0);
          var n2 = c2.toUpperCase().charCodeAt(0);
          var n3 = c3.toUpperCase().charCodeAt(0);
    
          // 升冪：ABC、aBc 之類
          if (n2 === n1 + 1 && n3 === n2 + 1) return true;
          // 降冪：CBA 之類
          if (n2 === n1 - 1 && n3 === n2 - 1) return true;
        }
        // 數字
        else if (/\d/.test(c1) && /\d/.test(c2) && /\d/.test(c3)) {
          var d1 = c1.charCodeAt(0);
          var d2 = c2.charCodeAt(0);
          var d3 = c3.charCodeAt(0);
    
          // 升冪：123
          if (d2 === d1 + 1 && d3 === d2 + 1) return true;
          // 降冪：321
          if (d2 === d1 - 1 && d3 === d2 - 1) return true;
        }
      }
      return false;
    }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
  </body>
</apex:page>