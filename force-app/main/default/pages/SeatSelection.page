<apex:page docType="html-5.0"
    controller="SeatSelectionController"
    applyHtmlTag="true"
    standardStylesheets="false"
    showHeader="false"
>
    <head>
        <title>Seat Selection/Switching</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" />
        <c:styleinclude ></c:styleinclude>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="{!$Resource.B2BStyle}" />

        <!-- jQuery (å¿…è¦) -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <!-- Select2 JS -->
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <style>
            /* Seat and Toilet Dimensions */
            :root {
                --seat-width: 50px;
                --seat-height: 50px;
                --seat-gap: 1px;
            }

            .modal-lg {
                --bs-modal-width: 615px;
            }

            .modal-footer {
                border: none;
            }

            .pagination-controls {
                box-shadow: 0 2px 4px #ccbbb0;
            }

            .seat-map {
                display: flex;
                flex-direction: column;
                gap: 6px;
                margin-top: 10px;
            }

            .seat {
                width: var(--seat-width);
                height: var(--seat-height);
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
                border: none;
                cursor: pointer;
            }

            .seat-general {
                background-image: url("{!URLFOR($Resource.seat_general)}");
            }

            .seat-no-window {
                background-image: url("{!URLFOR($Resource.seat_nowindow)}");
            }

            .seat-selected {
                background-image: url("{!URLFOR($Resource.seat_selected)}");
            }

            .seat-disabled {
                background-image: url("{!URLFOR($Resource.seat_disabled)}");
                cursor: not-allowed;
            }

            .exit-row {
                position: relative;
                height: 20px;
                margin: 8px 0;
            }

            .exit-sign::before,
            .exit-sign::after {
                content: "";
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                width: 28px; /* Slightly smaller overall width */
                height: 16px;
                background-color: #d72828;
            }

            /* â† Left Arrow with Tail */
            .exit-sign::before {
                left: -10px;
                /* Left-pointing arrow: thick triangular head + thin short shaft */
                clip-path: polygon(
                    0 50%,
                    /* Left point of arrow head */ 40% 0,
                    /* Top of thick arrow head */ 40% 35%,
                    /* Top of thin shaft */ 100% 35%,
                    /* Top right of short shaft */ 100% 65%,
                    /* Bottom right of short shaft */ 40% 65%,
                    /* Bottom of thin shaft */ 40% 100% /* Bottom of thick arrow head */
                );
            }

            /* â†’ Right Arrow with Tail */
            .exit-sign::after {
                right: -10px;
                /* Right-pointing arrow: thin short shaft + thick triangular head */
                clip-path: polygon(
                    0 35%,
                    /* Top left of thin shaft */ 60% 35%,
                    /* Top of thin shaft */ 60% 0,
                    /* Top of thick arrow head */ 100% 50%,
                    /* Right point of arrow head */ 60% 100%,
                    /* Bottom of thick arrow head */ 60% 65%,
                    /* Bottom of thin shaft */ 0 65% /* Bottom left of thin shaft */
                );
            }

            /* No-window row styling with brown borders */
            /* .no-window-row {
            position: relative;
            border-left: 10px solid #B08080; 
            border-right: 10px solid #B08080;
            } */

            .seatmap-frame {
                border: 8px solid #bb9f92;
                padding: 8px 12px;
                background: #fff;
                margin: 20px;
            }

            /* Cabin æ¨™é¡Œï¼ˆBusiness / Economyï¼‰ */
            .cabin-title {
                font-weight: 600;
                margin: 6px 0 3px;
            }

            /* Header å­—æ¯åˆ— */
            .seat-header {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 1px;
                margin-bottom: 1px;
                font-weight: 500;
            }

            .row-wrap {
                position: relative;
                margin: 10px;
            }

            .seat-letter {
                font-size: 18px;
                width: var(--seat-width);
                text-align: center;
            }

            /* èµ°é“ (å«åˆ—è™Ÿ) */
            .walkway {
                width: var(--seat-width);
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* åº§ä½åˆ— (å·¦å³å„ä¸€çµ„) */
            .seat-group {
                display: flex;
                gap: 1px;
            }

            .row-wrap {
                display: flex;
                gap: 1px;
                justify-content: center;
            }

            .row-num {
                font-size: 18px;
                width: var(--seat-width);
                height: var(--seat-height);
                line-height: var(--seat-height);
                text-align: center;
                font-weight: 500;
            }

            /* Toilet styling */
            .toilet {
                background-color: #9e9e9e;
                color: white;
                font-weight: bold;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
            }

            /* =========================================================
            * âœ¨ NEW STYLES for Flexible Layouts
            * ========================================================= */

            /* Container for staggered seat + desk */
            .staggered-seat-container {
                display: flex;
                align-items: center;
                gap: 2px;
            }

            /* Style for the desk component */
            .desk {
                width: var(--seat-width);
                height: var(--seat-height);
                background-color: #a0a0a0; /* Grey color for the desk */
                border-radius: 2px;
                /* Creates the trapezoid shape - 75% size, centered */
                clip-path: polygon(12.5% 44.75%, 48.5% 12.5%, 87.5% 12.5%, 87.5% 87.5%, 12.5% 87.5%);
            }

            /* Modifier to flip the desk for right-side placement */
            .desk-right {
                order: 2; /* Puts the desk after the seat */
                /* Flip the shape horizontally */
                transform: scaleX(-1);
            }

            /* Ensure the seat is ordered correctly */
            .staggered-seat-container .seat {
                order: 1;
            }

            /* A simple placeholder for empty seat slots */
            .seat-placeholder {
                width: var(--seat-width);
                height: var(--seat-height);
                display: inline-block; /* Ensures it takes up space */
            }

            /* ========================================================= */

            /* Passenger Selection Styling */
            .passenger-row {
                cursor: pointer;
                transition: all 0.2s ease;
                border: 2px solid transparent;
            }

            .passenger-row:hover,
            .passenger-row.selected {
                background-color: var(--primary-brown);
                color: white !important;
            }

            .passenger-row:hover .circle,
            .passenger-row.selected .circle {
                border: 1px solid white !important;
            }

            /* Disabled passenger row styling */
            .passenger-row.disabled {
                background-color: lightgray !important;
                cursor: not-allowed !important;
                pointer-events: none;
            }

            /* Passenger Number Circles on Seats */
            .seat {
                position: relative;
            }

            .passenger-number-circle {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                background-color: white;
                color: grey;
                z-index: 10;
                pointer-events: none;
            }

            /* Ensure proper scrolling for the main content */
            .content-wrapper {
                overflow-y: auto;
                padding-bottom: 0;
                height: 100vh !important;
            }

            /* Ensure the search results can scroll properly */
            #searchResults {
                max-height: calc(100vh - 200px);
                overflow-y: auto;
                padding-bottom: 120px; /* Space for fixed bottom buttons */
            }

            /* Make sure the seat map area can accommodate all content */
            .seatmap-frame {
                min-height: 600px; /* Ensure minimum height for seat maps */
                overflow: visible;
            }

            /* Adjust container fluid to prevent overflow issues */
            .container-fluid {
                padding-bottom: 120px; /* Space for fixed buttons */
            }

            /* Ensure body can scroll */
            body {
                overflow-y: auto !important;
            }

            /* Fix for the tab content */
            .tab-content {
                min-height: 500px;
                overflow: visible;
            }

            .passenger-box {
                position: sticky !important;
                top: 80px; /* Adjust this value based on your header height */
                align-self: flex-start; /* Ensures it stays at the top of its flex container */
                z-index: 100; /* Ensures it stays above other content */
                background: white; /* Ensures it has a solid background */
                border-radius: 4px; /* Optional: adds rounded corners */
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Optional: adds subtle shadow */
                max-height: calc(100vh - 120px); /* Prevents it from exceeding viewport */
                overflow-y: auto; /* Allows scrolling within passenger box if needed */
            }

            /* Make sure fixed buttons don't interfere with scrolling */
            .fixed-bottom-buttons {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1050 !important;
                background: white;
                box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
            }

            /* Responsive adjustments */
            @media (max-width: 768px) {
                /* 1. Make the selector's container fixed to the top */
                .mobile-passenger-selector-container {
                    position: sticky;
                    /* Adjust this 'top' value to sit perfectly below your navbar */
                    top: 0;
                    background-color: white;
                    padding: 1rem;
                    /* A subtle shadow helps it feel layered on top */
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    /* A high z-index ensures it stays on top of other content */
                    z-index: 1010;
                }

                /* Hide the original pagination controls that are now replaced by the dropdown */
                .pagination-controls {
                    display: none !important;
                }
            }

            /* å¤–å±¤ï¼šåªè² è²¬ sticky */
            .passenger-box-sticky {
                position: sticky;
                top: 80px; /* ä¾ä½ çš„é é¢èª¿æ•´ */
                z-index: 100;
            }

            /* å…§å±¤ï¼šåªè² è²¬æ»¾å‹• */
            .passenger-box {
                background: #fff;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);

                /* ä½ è¦æ±‚çš„é«˜åº¦ä¸Šé™ */
                max-height: min(500px, 50vh);
                overflow-y: auto;
                overflow-x: hidden;

                /* é¿å…é€£é–æ»¾åˆ°å¤–å±¤ */
                overscroll-behavior: contain;

                /* äº’å‹•ç´°ç¯€ */
                -webkit-overflow-scrolling: touch;
                scrollbar-gutter: stable;
                touch-action: pan-y;
                pointer-events: auto; /* ç¢ºä¿èƒ½æ¥äº‹ä»¶ */
            }

            /* è‹¥ä½ çš„é é¢æœ‰å¤–å±¤æ»¾å‹•å®¹å™¨ï¼Œå»ºè­°åŠ é€™å€‹é¿å…æ¶æ»¾ */
            .content-wrapper {
                overflow-y: auto;
                height: 100vh !important;
                overscroll-behavior: contain;
            }

            /* å¦‚æœä½ åªæƒ³åœ¨ hover æ™‚æ‰é¡¯ç¤ºæ²è»¸ï¼ˆå¯é¸ï¼‰ */
            /* å¸¸æ…‹éš±è—ï¼ˆä»å¯ç”¨æ»‘è¼ªæ²å‹•ï¼Œä½†ä¸é¡¯ç¤ºæ²è»¸ï¼‰ */
            .passenger-box {
                scrollbar-width: thin; /* Firefoxï¼šç´°æ²è»¸ï¼ˆæˆ–ç”¨ none éš±è—ï¼‰*/
            }
            /* Chromium éš±è—æ²è»¸ï¼ˆå¯é¸ï¼‰ */
            .passenger-box::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            .passenger-box:hover::-webkit-scrollbar {
                width: 8px;
                height: 8px; /* hover æ™‚é¡¯ç¤º */
            }
        </style>
    </head>

    <body class="d-flex py-4">
        <c:B2BNavbar ></c:B2BNavbar>
        <apex:outputPanel id="SearchSuccessPanel" style="display: none">
            <c:successNotification message="æœå°‹æˆåŠŸ" />
        </apex:outputPanel>
        <apex:outputPanel id="SearchErrorPanel" style="display: none">
            <c:FailNotification message="{!errorMessage}" />
        </apex:outputPanel>
        <apex:outputPanel id="editSuccessPanel" style="display: none">
            <c:successNotification message="{!successMessage}" />
        </apex:outputPanel>

        <div class="content-wrapper" id="content-wrapper">
            <div class="container-fluid">
                <apex:form id="searchForm">
                    <!--<apex:pageMessages id="msgs"/>-->
                    <apex:actionFunction name="doReset"
                        action="{!reset}"
                        rerender="resultsBlock,SearchSuccessPanel,SearchErrorPanel"
                    />

                    <div id="flightSearchForm" class="row g-3">
                        <!-- èˆªç­è™Ÿç¢¼ -->
                        <div class="col-md-3">
                            <label class="form-label">èˆªç­è™Ÿç¢¼*</label>
                            <div class="d-flex">
                                <!-- å·¦é‚Šçš„ Prefix+dash -->
                                <div class="input-group me-2" style="width: 40%">
                                    <input
                                        id="flightPrefix"
                                        class="form-control"
                                        value="{!flightPrefix}"
                                        disabled="true"
                                        style="height: 38px; border-radius: 2px"
                                    />
                                    <span class="input-group-text" style="border: none; background: none; height: 38px"
                                        >-</span
                                    >
                                </div>
                                <!-- å³é‚Šçš„è¼¸å…¥æ¡† -->
                                <div class="input-group" style="flex: 1">
                                    <!-- é¡¯ç¤ºç”¨è¼¸å…¥æ¡† -->
                                    <input
                                        type="text"
                                        id="flightNumber_display"
                                        class="form-control required-field"
                                        placeholder="è«‹è¼¸å…¥"
                                        oninput="limitFlightInput(this)"
                                        onblur="formatFlightNumber()"
                                    />

                                    <!-- å¯¦éš›é€å‡ºæ¬„ä½ -->
                                    <apex:inputHidden value="{!flightNumber}" id="flightNumber" />
                                </div>
                            </div>
                            <div class="invalid-feedback w-100 ps-4">å¿…å¡«</div>
                        </div>
                        <!-- èµ·é£›æ—¥æœŸ -->
                        <div class="col-md-2">
                            <label class="form-label">èµ·é£›æ—¥æœŸ*</label>
                            <div class="input-group">
                                <apex:inputText value="{!departureDateStr}"
                                    id="departureDate"
                                    styleClass="form-control required-field always-visible"
                                    onkeydown="return false;"
                                />
                            </div>
                            <div class="invalid-feedback w-100">å¿…å¡«</div>
                        </div>
                        <!-- èµ·é£›åœ° -->
                        <div class="col-md-2">
                            <label class="form-label">èµ·é£›åœ°*</label>

                            <apex:selectList id="departure"
                                value="{!departureLocation}"
                                size="1"
                                styleClass="form-select required-field"
                                style="border-radius: 2px"
                            >
                                <apex:selectOptions value="{!originOptions}" />
                            </apex:selectList>

                            <div class="invalid-feedback">å¿…å¡«</div>
                        </div>

                        <!-- è¨‚ä½ä»£è™Ÿ -->
                        <div class="col-md-3">
                            <label class="form-label">è¨‚ä½ä»£è™Ÿ*</label>
                            <apex:inputText value="{!bookingCodes}"
                                id="bookingCodes"
                                styleClass="form-control required-field"
                                html-placeholder="è«‹è¼¸å…¥"
                            />
                            <div class="invalid-feedback w-100">å¿…å¡«</div>
                        </div>

                        <!-- æŒ‰éˆ• -->

                        <div class="col-md-2 d-flex justify-content-end" style="align-items: anchor-center">
                            <button
                                id="clearButton"
                                type="button"
                                class="btn me-2"
                                style="height: 48px; width: 80px; color: #8e7248; background: #fff"
                            >
                                æ¸…é™¤
                            </button>
                            <apex:actionFunction name="doSearch"
                                action="{!searchPnr}"
                                rerender="resultsBlock,msgs,SearchSuccessPanel,SearchErrorPanel,fixedBottomButtons"
                                oncomplete="showTabs();"
                            />
                            <apex:actionFunction name="callHandleTabSwitch"
                                action="{!handleTabSwitch}"
                                rerender="resultsBlock,msgs,SearchSuccessPanel,SearchErrorPanel,fixedBottomButtons"
                                oncomplete="showTabs();"
                            >
                                <apex:param name="pnrToSwitchTo" assignTo="{!currentTabKey}" value="" />
                            </apex:actionFunction>
                            <apex:actionFunction name="saveSeatAssignments"
                                action="{!saveSeatAssignments}"
                                rerender="msgs,SearchSuccessPanel,SearchErrorPanel,editSuccessPanel,resultsBlock"
                                oncomplete="console.log('ğŸ”” ActionFunction oncomplete triggered'); handleSeatAssignmentSave();"
                            >
                                <!-- Add this parameter -->
                                <apex:param name="activePNR" assignTo="{!currentTabKey}" value="" />
                            </apex:actionFunction>
                            <!-- <apex:actionFunction
                                name="refreshPNRDataFromBackend"
                                action="{!refreshPNRData}"
                                rerender="resultsBlock"
                                oncomplete="handleTabSwitchComplete();"
                            >
                                <apex:param name="targetPNR" assignTo="{!currentTabKey}" value="" />
                            </apex:actionFunction> -->

                            <apex:inputHidden value="{!seatAssignmentInput}" id="seatAssignmentInput" />

                            <button
                                id="validateBtn"
                                type="button"
                                class="btn"
                                style="height: 48px; width: 80px; background: #8e7248; color: #fff"
                                onclick="validateSearch();"
                            >
                                æœå°‹
                            </button>
                        </div>
                    </div>
                </apex:form>

                <!-- ======== çµæœå€ (reRender ç›®æ¨™) ======== -->
                <apex:outputPanel id="resultsBlock" layout="block">
                    <!-- Tabs (åªæœ‰æœå°‹å¾Œæ‰é¡¯ç¤º) -->
                    <div class="mt-4" id="tabResults" style="{!IF(ISBLANK(currentTabKey),'display:none;','')}">
                        <ul class="nav nav-tabs" role="tablist" style="border: none">
                            <apex:repeat value="{!pnrKeys}" var="pnr">
                                <li class="nav-item" role="presentation">
                                    <button
                                        class="nav-link {!IF(pnr==currentTabKey,'active','')}"
                                        data-bs-toggle="tab"
                                        data-bs-target="#tab{!pnr}"
                                        type="button"
                                        role="tab"
                                        style="
                                            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                                            margin-right: 4px;
                                            border-radius: 0.375rem;
                                        "
                                    >
                                        {!pnr}
                                    </button>
                                </li>
                            </apex:repeat>
                        </ul>
                    </div>

                    <!-- å¤–æ¡† -->
                    <div
                        id="outerWrapper"
                        class="mt-0"
                        style="background:#fff;border-radius:4px;
                                                               {!IF(ISBLANK(currentTabKey),'display:block;','')}
                                                               "
                    >
                        <!-- æ²’è³‡æ–™æ™‚æç¤º -->
                        <div
                            id="searchPrompt"
                            class="search-prompt"
                            style="{!IF(ISBLANK(currentTabKey),'min-height: calc(100vh - 300px) !important;
                                                                            display: flex !important;
                                                                            align-items: center !important;
                                                                            justify-content: center !important;','display:none;')}"
                        >
                            è«‹æœå°‹è³‡æ–™
                        </div>

                        <!-- çµæœè¡¨æ ¼ -->
                        <div
                            id="searchResults"
                            style="{!IF(ISBLANK(currentTabKey),'display:none;','')}; position: relative; min-height: 400px; padding-bottom: 120px;"
                        >
                            <!-- é€™è£¡å¯æ”¾åˆ†é æ§åˆ¶ -->
                            <div
                                class="pagination-controls d-flex align-items-center justify-content-between"
                                style="
                                    position: sticky;
                                    top: 0;
                                    z-index: 10;
                                    height: auto;
                                    padding: 0.5rem 1rem;
                                    margin-top: 3px;
                                "
                            >
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="btn btn-primary px-3 py-1" tabindex="-1" onclick="showLegendModal()">
                                        åœ–ä¾‹èªªæ˜
                                    </button>
                                    <button
                                        class="btn btn-secondary px-3 py-1"
                                        tabindex="-1"
                                        onclick="showNoticeModal()"
                                    >
                                        é¸ä½é ˆçŸ¥
                                    </button>
                                </div>
                            </div>

                            <div class="tab-content" id="resultTabContent">
                                <apex:repeat value="{!pnrKeys}" var="pnr">
                                    <div
                                        id="tab{!pnr}"
                                        role="tabpanel"
                                        class="tab-pane fade {!IF(pnr==currentTabKey,'show active','')}"
                                    >
                                        <div class="d-flex flex-wrap gap-3">
                                            <!-- æ¡Œé¢ç‰ˆæ—…å®¢è³‡è¨Š -->
                                            <div class="passenger-box-sticky">
                                                <div class="passenger-box d-none d-md-block" style="min-width: 300px">
                                                    <div
                                                        style="
                                                            background-color: #7b5e43;
                                                            color: white;
                                                            padding: 0.5rem 1rem;
                                                        "
                                                    >
                                                        æ—…å®¢è³‡è¨Š
                                                    </div>
                                                    <div style="background-color: #d7c2af; border: 1px solid #785143">
                                                        <div style="">
                                                            <apex:variable var="idx" value="{!0}" />
                                                            <apex:repeat value="{!tabData[pnr]}" var="pax">
                                                                <apex:variable var="idx" value="{!idx + 1}" />

                                                                <div
                                                                    class="passenger-row d-flex justify-content-between align-items-center py-1 px-2 border-bottom"
                                                                    style="font-weight: 500; color: #333"
                                                                    data-passenger-index="{!idx}"
                                                                    data-pnr="{!pnr}"
                                                                >
                                                                    <div class="d-flex align-items-center">
                                                                        <span
                                                                            class="circle text-center me-2"
                                                                            style="
                                                                                display: inline-block;
                                                                                width: 20px;
                                                                                height: 20px;
                                                                                line-height: 20px;
                                                                                font-size: 0.8rem;
                                                                                border: 1px solid #000;
                                                                                border-radius: 50%;
                                                                            "
                                                                        >
                                                                            {!idx}
                                                                        </span>
                                                                        {!pax.name}
                                                                    </div>
                                                                    <div style="white-space: nowrap">
                                                                        <span class="passenger-seat-display">
                                                                            <apex:outputText rendered="{!pax.passengerType == 'INF'}"
                                                                                >ç„¡æ³•é¸ä½</apex:outputText>
                                                                            <apex:outputText rendered="{!pax.passengerType != 'INF' && ISBLANK(pax.seat)}"
                                                                                >å°šæœªé¸ä½</apex:outputText>
                                                                            <apex:outputText rendered="{!pax.passengerType != 'INF' && NOT(ISBLANK(pax.seat))}"
                                                                                >{!pax.seat}</apex:outputText>
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </apex:repeat>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="mobile-passenger-selector-container-{!pnr}" 
                                                 class="w-100 d-md-none mb-3 mobile-passenger-selector-container">
                                                <label class="form-label">è«‹é¸æ“‡æ—…å®¢</label>
                                                <!-- The <select> dropdown will be injected here by JavaScript -->
                                            </div>

                                            <div class="seatmap-frame flex-grow-1">
                                                <div id="seatmap-wrapper"></div>
                                                <div id="seatmap-wrapper-{!pnr}"></div>
                                            </div>
                                            <div
                                                class="seat-info-btn d-md-none"
                                                style="margin-left: auto; padding-right: 1rem; pointer-events: auto"
                                            >
                                                <button
                                                    class="btn btn-secondary px-3 py-1"
                                                    tabindex="-1"
                                                    onclick="showNoticeModal()"
                                                >
                                                    é¸ä½é ˆçŸ¥
                                                </button>
                                            </div>
                                            <div
                                                class="mobile-seat-legend d-md-none"
                                                style="margin: 0 2rem; width: 100%"
                                            >
                                                <div class="d-flex justify-content-between text-center">
                                                    <div>
                                                        <img
                                                            src="{!URLFOR($Resource.seat_general)}"
                                                            style="height: 75px"
                                                        />
                                                        <div>ä¸€èˆ¬åº§ä½</div>
                                                    </div>
                                                    <div>
                                                        <img
                                                            src="{!URLFOR($Resource.seat_nowindow)}"
                                                            style="height: 75px"
                                                        />
                                                        <div>é çª—æ²’æ™¯</div>
                                                    </div>
                                                    <div>
                                                        <img
                                                            src="{!URLFOR($Resource.seat_selected)}"
                                                            style="height: 75px"
                                                        />
                                                        <div>å·²é¸åº§ä½</div>
                                                    </div>
                                                    <div>
                                                        <img
                                                            src="{!URLFOR($Resource.seat_disabled)}"
                                                            style="height: 75px"
                                                        />
                                                        <div>ç„¡æ³•æŒ‘é¸</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </apex:repeat>
                            </div>
                        </div>
                        <!-- /searchResults -->
                    </div>
                    <!-- NEW: All PNR Data Containers for Frontend Management -->
                    <div
                        id="allSeatMapDataContainer"
                        style="display: none"
                        data-all-seatmap="{!(SeatMapDataForJS)}"
                    ></div>
                    <div id="allTabDataContainer" style="display: none" data-all-tabdata="{!(AllTabDataForJS)}"></div>
                    <div
                        id="pnrC2DisabledMapContainer"
                        style="display: none"
                        data-pnr-c2-disabled-map="{!(pnrC2DisabledMapJSON)}"
                    ></div>

                    <!-- Store error message for JavaScript processing -->
                    <div id="errorMessageContainer" style="display: none" data-error-message="{!JSENCODE(errorMessage)}"></div>
                </apex:outputPanel>
            </div>
        </div>

        <!-- åœ–ä¾‹èªªæ˜ Modal -->
        <div class="modal fade" id="legendModal" tabindex="-1" aria-labelledby="legendModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="legendModalLabel">åœ–ä¾‹èªªæ˜</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-around flex-wrap text-center">
                            <div>
                                <img src="{!URLFOR($Resource.seat_general)}" style="height: 75px" />
                                <div>ä¸€èˆ¬åº§ä½</div>
                            </div>
                            <div>
                                <img src="{!URLFOR($Resource.seat_nowindow)}" style="height: 75px" />
                                <div>é çª—æ²’æ™¯</div>
                            </div>
                            <div>
                                <img src="{!URLFOR($Resource.seat_selected)}" style="height: 75px" />
                                <div>å·²é¸åº§ä½</div>
                            </div>
                            <div>
                                <img src="{!URLFOR($Resource.seat_disabled)}" style="height: 75px" />
                                <div>ç„¡æ³•æŒ‘é¸</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">é—œé–‰</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¸ä½é ˆçŸ¥ Modal -->
        <div class="modal fade" id="noticeModal" tabindex="-1" aria-labelledby="noticeModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-body">
                        <apex:outputText value="{!NoticeContentSeatSelection}" escape="false"></apex:outputText>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">é—œé–‰</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Also update the fixed bottom buttons to ensure proper spacing -->
        <div
            class="fixed-bottom-buttons"
            id="fixedBottomButtons"
            style="display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1050"
        >
            <div
                class="container"
                style="
                    margin-top: 0;
                    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
                    background-color: #fff;
                    padding: 10px 15px;
                "
            >
                <button
                    type="button"
                    class="btn"
                    id="cancelBtn"
                    style="
                        width: 73px;
                        height: 48px;
                        background-color: white;
                        color: #8e7248;
                        border: none;
                        display: none;
                    "
                >
                    å–æ¶ˆ
                </button>
                <button
                    type="reset"
                    id="testbtn"
                    class="btn"
                    style="width: 100px; height: 48px; background-color: #8e7248; color: white; border-radius: 4px"
                >
                    é¸ä½/æ›ä½
                </button>
                <button
                    type="back"
                    id="lastStep"
                    class="btn me-2"
                    style="
                        width: 89px;
                        height: 48px;
                        border-color: #8e7248;
                        color: #8e7248;
                        background-color: white;
                        border-radius: 4px;
                    "
                >
                    ä¸Šä¸€æ­¥
                </button>
                <button
                    type="button"
                    id="nextStep1"
                    onclick="goToNextStep();"
                    class="btn me-2"
                    style="
                        width: 89px;
                        height: 48px;
                        border-color: #8e7248;
                        color: #8e7248;
                        background-color: white;
                        border-radius: 4px;
                    "
                >
                    ä¸‹ä¸€æ­¥
                </button>
            </div>
        </div>
        <div id="loadingOverlay" style="display: none">
            <div
                style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: rgba(255, 255, 255, 0.7);
                    z-index: 99999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                "
            >
                <div class="spinner-border" role="status" style="width: 4rem; height: 4rem; color: #212121">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </body>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script type="text/javascript">

        function debounce(fn, delay) {
            let t;
            return function () {
                clearTimeout(t);
                const ctx = this,
                    args = arguments;
                t = setTimeout(() => fn.apply(ctx, args), delay);
            };
        }

        // åˆ‡åˆ°æ–° tab ä¹‹å¾Œè¦åšçš„äº‹ï¼šé‡è·‘æœå°‹
        const rerunSearch = debounce(function () {
            // æ–¹æ¡ˆ Aï¼šç›´æ¥è§¸ç™¼ä½ åŸæœ¬çš„æœå°‹æŒ‰éˆ• clickï¼ˆå®Œå…¨é‡ç”¨æ—¢æœ‰æµç¨‹ï¼‰
            const btn = document.getElementById("validateBtn");
            if (btn) {
                btn.click();
                return;
            }
            // æ–¹æ¡ˆ Bï¼šå¦‚æœä½ æ¯”è¼ƒæƒ³ç›´æ¥å«å‡½å¼ï¼ˆå…©è€…æ“‡ä¸€å³å¯ï¼‰
            if (typeof window.validateSearch === "function") {
                window.validateSearch();
            } else {
                console.warn("validateBtn æˆ– validateSearch() éƒ½æ‰¾ä¸åˆ°ã€‚");
            }
        }, 150);

        // ç¶å®š Bootstrap 5 çš„ tab åˆ‡æ›å®Œæˆäº‹ä»¶ï¼ˆä¸æ”¹ DOM çµæ§‹ï¼‰
        document.addEventListener("DOMContentLoaded", function () {
            const container = document.getElementById("tabResults");
            if (!container) return;

            // ä½¿ç”¨äº‹ä»¶å§”æ´¾ï¼Œæœªä¾†å°±ç®—æœ‰å‹•æ…‹æ–°å¢ tab ä¹Ÿèƒ½åƒåˆ°äº‹ä»¶
            container.addEventListener(
                "shown.bs.tab",
                function (e) {
                    // e.target æ˜¯è¢«åˆ‡æ›åˆ°çš„é‚£é¡† tab æŒ‰éˆ•
                    // å¦‚æœä½ éœ€è¦çŸ¥é“ç›®å‰çš„ PNRï¼Œå¯ç”¨ä¸‹é¢é€™è¡Œå–å¾—æŒ‰éˆ•æ–‡å­—ï¼š
                    // const currentPnr = e.target.textContent.trim();

                    // è§¸ç™¼ä¸€æ¬¡ã€Œæœå°‹ã€
                    rerunSearch();
                },
                false
            );
        });
        function goToNextStep() {
            const flightPrefix = document.getElementById("flightPrefix")?.value || "";
            const flightNumber = document.getElementById("flightNumber_display")?.value || "";
            const departureDate = document.getElementById("{!$Component.searchForm.departureDate}")?.value || "";

            // âœ… é€™è£¡æ”¹æˆç”¨ $Componentï¼ˆæœ¬é  id æ˜¯ departureï¼‰
            const depEl =
                document.getElementById("{!$Component.searchForm.departure}") ||
                document.querySelector('[id$="departure"]') || // ä¿åº•ï¼šè‹¥æœªä¾†æ”¹åä»å¯æŠ“åˆ°
                document.querySelector('[id$="departureLocation"]'); // å†ä¿åº•ï¼šå’Œå…¶ä»–é ç›¸å®¹

            const departureLocation = depEl?.value || "";
            const bookingCodes = document.getElementById("{!$Component.searchForm.bookingCodes}")?.value || "";

            if (!flightNumber || !departureDate || !departureLocation || !bookingCodes) {
                alert("è«‹å…ˆå¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ã€‚");
                return;
            }

            const params = new URLSearchParams({
                flightPrefix,
                flightNumber,
                departureDate,
                departureLocation,
                bookingCodes,
            });

            window.location.href = "/apex/CheckIn?" + params.toString();
        }
        let hasSearched = false;
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            const flightNumber = urlParams.get("flightNumber") || "";
            const departureDate = urlParams.get("departureDate") || "";
            const bookingCodes = urlParams.get("bookingCodes") || "";
            const departureLocation = urlParams.get("departureLocation") || "";

            // è¨­ç½®å€¼åˆ°å°æ‡‰æ¬„ä½
            document.getElementById("flightNumber_display").value = flightNumber;
            document.getElementById("{!$Component.searchForm.flightNumber}").value = flightNumber;
            document.getElementById("{!$Component.searchForm.departureDate}").value = departureDate;
            const depEl = document.getElementById("{!$Component.searchForm.departure}");
            if (depEl && departureLocation) depEl.value = departureLocation;
            document.getElementById("{!$Component.searchForm.bookingCodes}").value = bookingCodes;

            // å¦‚æœ select å…ƒç´ æ˜¯ç”± apex:selectList ç”Ÿæˆçš„ï¼Œå¯èƒ½éœ€è¦é¡å¤–è™•ç†:
            const depSelect = document.getElementById("{!$Component.searchForm.departure}");
            if (depSelect) {
                for (let option of depSelect.options) {
                    if (option.value === departureLocation) {
                        option.selected = true;
                        break;
                    }
                }
            }

            // å¯è§¸ç™¼æœå°‹
            if (flightNumber && departureDate && (depEl?.value || departureLocation) && bookingCodes) {
                // âœ… é¡¯ç¤º loading ç•«é¢
                const overlay = document.getElementById("loadingOverlay");
                if (overlay) {
                    overlay.style.display = "block";
                    document.body.style.overflow = "hidden";
                }

                // âœ… åŸ·è¡Œæœå°‹
                doSearch();
            }

            var backBtn = document.getElementById("lastStep");
            if (!backBtn) return;

            backBtn.addEventListener("click", function (e) {
                // ä¸è®“ submit è§¸ç™¼é è¨­æäº¤
                e.preventDefault();

                // è®€å–ç›®å‰è¡¨å–®å€¼
                var flightPrefix = document.getElementById("flightPrefix")?.value || "";
                var flightNumber = document.getElementById("flightNumber_display")?.value || "";
                var departureDate = document.getElementById("{!$Component.searchForm.departure}")
                    ? document.getElementById("{!$Component.searchForm.departureDate}").value
                    : document.querySelector('[id$="departureDate"]')?.value || "";
                // departureï¼ˆBoardingPassPrinting çš„ select id å« "departure"ï¼‰
                var depEl =
                    document.getElementById("{!$Component.searchForm.departure}") ||
                    document.querySelector('[id$="departure"]');
                var departureLocation = depEl ? depEl.value : "";

                var bookingCodes = document.getElementById("{!$Component.searchForm.bookingCodes}")
                    ? document.getElementById("{!$Component.searchForm.bookingCodes}").value
                    : document.querySelector('[id$="bookingCodes"]')?.value || "";

                // çµ„ QueryStringï¼ˆæ²¿ç”¨ CheckIn â†’ BoardingPassPrinting çš„ key å‘½åï¼‰
                var params = new URLSearchParams({
                    flightPrefix: flightPrefix,
                    flightNumber: flightNumber,
                    departureDate: departureDate,
                    departureLocation: departureLocation, // é—œéµï¼šç”¨ departureLocation é€™å€‹ key
                    bookingCodes: bookingCodes,
                });

                // å°å› CheckIn
                window.location.href = "/apex/EditTraveler?" + params.toString();
            });
        });
        /* =========================================================
         * STARLUX SEAT SELECTION SYSTEM
         * Organized and maintainable seat selection interface
         * ========================================================= */

        /* =========================================================
         * 1. GLOBAL STATE AND CONFIGURATION
         * ========================================================= */

        // Application state
        let selectedPassenger = null; // { tabKey, passengerIndex, passengerName }
        let seatAssignments = {}; // { tabKey: { passengerIndex: seatCode } }
        let currentTabOriginalAssignments = {}; // Original assignments for cancel functionality
        let currentActivePnr = null; // Currently active PNR tab
        let allSeatMapData = {}; // All PNR seat map data from backend
        let allTabData = {}; // All PNR passenger data from backend
        let isEditing = false; // Current editing state
        let originalSeatStates = {}; // Store original seat types: { pnrCode: { seatCode: 'seat-general'|'seat-no-window'|'seat-disabled' } }
        let pnrC2DisabledMap = {}; // Global map to hold C2OperationDisable status for each PNR
        let isSaveComplete = false; // Flag to prevent duplicate completion calls
        let saveTimeoutId = null; // Store timeout ID to enable clearing
        let pendingTabSwitchPNR = null; // Store target PNR for tab switch refresh

        // UI control elements
        const editButton = document.getElementById("testbtn");
        const cancelButton = document.getElementById("cancelBtn");
        const nextStepBtn = document.getElementById("nextStep1");
        const lastStepBtn = document.getElementById("lastStep");

        // Global function to update edit button visibility based on PNR
        function updateEditButtonVisibility(targetPNR) {
            try {
                // Get the disable status for the target PNR from global variable
                var isDisabled = false;
                if (targetPNR && pnrC2DisabledMap.hasOwnProperty(targetPNR)) {
                    isDisabled = pnrC2DisabledMap[targetPNR] === true;
                }
                console.log("ğŸ” [updateEditButtonVisibility] Is disabled: ", isDisabled);

                // Update button visibility
                var editBtn = document.getElementById("testbtn");
                if (editBtn) {
                    console.log(
                        "ğŸ” [updateEditButtonVisibility] Updating button from ",
                        editBtn.style.display,
                        " to ",
                        isDisabled ? "none" : ""
                    );
                    editBtn.style.display = isDisabled ? "none" : "";
                } else {
                    console.log("âŒ [updateEditButtonVisibility] Edit button not found!");
                }
            } catch (error) {
                console.error("âŒ Error in updateEditButtonVisibility:", error);
            }
        }

        /* =========================================================
         * 1.5. SEAT CODE NORMALIZATION UTILITIES
         * Functions to handle seat codes with/without leading zeros
         * ========================================================= */

        /**
         * Normalizes seat code by removing leading zeros from row number
         * @param {string} seatCode - Seat code like "01A" or "1A"
         * @returns {string} Normalized seat code like "1A"
         */
        function normalizeSeatCode(seatCode) {
            if (!seatCode || typeof seatCode !== "string") return seatCode;

            // Extract row number and letter parts
            const match = seatCode.match(/^(\d+)([A-Z]+)$/);
            if (!match) return seatCode; // Return as-is if doesn't match expected format

            const rowNumber = parseInt(match[1], 10); // This removes leading zeros
            const letter = match[2];

            return `${rowNumber}${letter}`;
        }

        /**
         * Finds seat element using normalized seat code lookup
         * @param {string} seatCode - Original seat code (may have leading zeros)
         * @param {string} pnrCode - PNR code for context (optional)
         * @returns {Element|null} Found seat element or null
         */
        function findSeatElement(seatCode, pnrCode = null) {
            const normalizedCode = normalizeSeatCode(seatCode);
            const context = pnrCode ? `#seatmap-wrapper-${pnrCode}` : "";

            // Try normalized code first
            let seatElement = document.querySelector(`${context} [data-seat="${normalizedCode}"]`);

            // If not found and original code is different, try original
            if (!seatElement && seatCode !== normalizedCode) {
                seatElement = document.querySelector(`${context} [data-seat="${seatCode}"]`);
            }

            return seatElement;
        }

        /* =========================================================
         * 2. AIRCRAFT LAYOUT CONFIGURATIONS (with Aisle Widths)
         * ========================================================= */
        const aircraftLayoutConfigs = {
            "32Q-Y": {
                // 3-3 layout has one aisle in the middle.
                headerLetters: ["A", "B", "C", "H", "J", "K"],
                structure: [
                    ["A", "B", "C"],
                    ["H", "J", "K"],
                ],
                aisleWidths: [1], // âœ¨ NEW: One standard aisle.
            },
            "32Q-J": {
                // 2-2 layout has one aisle in the middle.
                headerLetters: ["A", "C", "H", "K"],
                structure: [
                    ["A", "C"],
                    ["H", "K"],
                ],
                aisleWidths: [4], // âœ¨ NEW: One standard aisle for regular seat rows.
            },
            "339-Y": {
                // 2-4-2 layout has two aisles.
                headerLetters: ["A", "C", "D", "E", "F", "G", "H", "K"],
                structure: [
                    ["A", "C"],
                    ["D", "E", "F", "G"],
                    ["H", "K"],
                ],
                aisleWidths: [1, 1], // âœ¨ NEW: Two standard aisles.
            },
            "339-J": {
                // 2-4-2 layout has two aisles.
                headerLetters: ["A", "C", "D", "E", "F", "G", "H", "K"],
                structure: [
                    ["A", "C"],
                    ["D", "E", "F", "G"],
                    ["H", "K"],
                ],
                aisleWidths: [1, 1], // âœ¨ NEW: Two standard aisles.
                staggered: true, // âœ¨ NEW: Staggered layout affects width calculations
            },
            "359-Y": {
                // 3-3-3 layout has two aisles.
                headerLetters: ["A", "B", "C", "D", "E", "G", "H", "J", "K"],
                structure: [
                    ["A", "B", "C"],
                    ["D", "E", "G"],
                    ["H", "J", "K"],
                ],
                aisleWidths: [2, 2], // âœ¨ NEW: Two standard aisles.
            },
            "359-W": {
                // 2-4-2 layout has two aisles.
                headerLetters: ["A", "C", "D", "E", "F", "G", "H", "K"],
                structure: [
                    ["A", "C"],
                    ["D", "E", "F", "G"],
                    ["H", "K"],
                ],
                aisleWidths: [1, 1], // âœ¨ NEW: Two standard aisles.
            },
            "359-J": {
                // 1-2-1 layout has two aisles.
                headerLetters: ["A", "D", "G", "K"],
                structure: [["A"], ["D", "G"], ["K"]],
                aisleWidths: [1, 1], // âœ¨ NEW: Two standard aisles.
            },
            "359-F": {
                // 1-2-1 layout has two aisles.
                headerLetters: ["A", "D", "G", "K"],
                structure: [["A"], ["D", "G"], ["K"]],
                aisleWidths: [1, 1], // âœ¨ NEW: Two standard aisles.
            },
            "351-Y": {
                // 3-3-3 layout has two aisles.
                headerLetters: ["A", "B", "C", "D", "E", "G", "H", "J", "K"],
                structure: [
                    ["A", "B", "C"],
                    ["D", "E", "G"],
                    ["H", "J", "K"],
                ],
                aisleWidths: [2, 2], // âœ¨ NEW: Two standard aisles.
            },
            "351-W": {
                // 2-4-2 layout has two aisles.
                headerLetters: ["A", "C", "D", "E", "F", "G", "H", "K"],
                structure: [
                    ["A", "C"],
                    ["D", "E", "F", "G"],
                    ["H", "K"],
                ],
                aisleWidths: [1, 1], // âœ¨ NEW: Two standard aisles.
            },
            "351-J": {
                // 1-2-1 layout has two aisles.
                headerLetters: ["A", "D", "G", "K"],
                structure: [["A"], ["D", "G"], ["K"]],
                aisleWidths: [1, 1], // âœ¨ NEW: Two standard aisles.
            },
            "351-F": {
                // 1-2-1 layout has two aisles.
                headerLetters: ["A", "D", "G", "K"],
                structure: [["A"], ["D", "G"], ["K"]],
                aisleWidths: [1, 1], // âœ¨ NEW: Two standard aisles.
            },
        };

        const toiletSVG = `
    <svg xmlns="http://www.w3.org/2000/svg" 
    height="80%" width="80%" 
    viewBox="0 0 24 24" 
    fill="#FFFFFF"
    style="transform: rotate(90deg);">
        <path d="M.01 0h24v24h-24V0z" fill="none"/>
            <!-- Male figure (shifted left) -->
                <g transform="translate(-1.5, 0)">
                    <path d="M5.5 22v-7.5H4V9c0-1.1.9-2 2-2h3c1.1 0 2 .9 2 2v5.5H9.5V22h-4z"/>
                        <path d="M7.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2z"/>
                            </g>
                        <!-- Divider line -->
                            <rect x="11.5" y="0" width="1" height="24" fill="#FFFFFF"/>
                                <!-- Female figure (shifted right) -->
                                    <g transform="translate(1.5, 0)">
                                        <path d="M18 22v-6h3l-2.54-7.63C18.18 7.55 17.42 7 16.56 7h-.12c-.86 0-1.63.55-1.9 1.37L12 16h3v6h3z"/>
                                            <path d="M16.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2z"/>
                                                </g>
                                            </svg>
                                            `;

        /* =========================================================
         * 3. UTILITY FUNCTIONS
         * Helper functions for seat map generation and calculations
         * ========================================================= */

        /**
         * Gets CSS custom property values for dimensions
         * @returns {Object} Object containing all dimension values
         */
        function getDimensions() {
            const rootStyle = getComputedStyle(document.documentElement);
            return {
                seatWidth: parseInt(rootStyle.getPropertyValue("--seat-width")),
                seatHeight: parseInt(rootStyle.getPropertyValue("--seat-height")),
                seatGap: parseInt(rootStyle.getPropertyValue("--seat-gap")),
            };
        }

        /**
         * Calculates width for toilet/empty sections based on number of seats
         * @param {number} seatCount - Number of seats to calculate width for
         * @param {boolean} isStaggered - Whether the layout uses staggered seats (seat + desk)
         * @returns {number} Width in pixels
         */
        function calculateSectionWidth(seatCount, isStaggered = false) {
            const dims = getDimensions();
            const baseWidth = seatCount * dims.seatWidth + (seatCount > 0 ? (seatCount - 1) * dims.seatGap : 0);

            // For staggered layouts, add desk width for each seat
            if (isStaggered && seatCount > 0) {
                return baseWidth + seatCount * dims.seatWidth; // Add desk width (same as seat width)
            }

            return baseWidth;
        }

        /**
         * Maps seat type array to section types based on aircraft structure
         * @param {Array} seatTypeArray - Array of seat types
         * @param {number} structureLength - Length of aircraft structure
         * @returns {Array} Mapped section types
         */
        function mapSeatTypesToSections(seatTypeArray, structureLength) {
            if (seatTypeArray.length === 1) {
                return new Array(structureLength).fill(seatTypeArray[0]);
            } else if (seatTypeArray.length === 2 && structureLength === 2) {
                return seatTypeArray;
            } else if (seatTypeArray.length === 2 && structureLength === 3) {
                return [seatTypeArray[0], "empty", seatTypeArray[1]];
            } else if (seatTypeArray.length === 3) {
                return seatTypeArray;
            } else {
                const result = [...seatTypeArray];
                while (result.length < structureLength) {
                    result.push("general");
                }
                return result.slice(0, structureLength);
            }
        }

        /* =========================================================
         * 4. SEAT MAP RENDERING FUNCTIONS
         * Functions for generating aircraft seat layouts
         * ========================================================= */

        /**
         * Generates seat header row with column letters
         * @param {string} aircraftType - Aircraft type code
         * @param {string} cabinClass - Cabin class code
         * @returns {string} HTML string for header row
         */
        function generateSeatHeader(aircraftType, cabinClass) {
            const config = aircraftLayoutConfigs[`${aircraftType}-${cabinClass}`];
            if (!config) return "<div>Header config not found</div>";

            const finalAisleWidths = config.aisleWidths || [];

            let html = '<div class="seat-header">';
            config.structure.forEach((sectionLetters, index) => {
                sectionLetters.forEach((letter) => {
                    html += `<div class="seat-letter">${letter}</div>`;
                });

                // Add walkway with proper width based on aisleWidths configuration
                if (index < config.structure.length - 1) {
                    const aisleWidthMultiplier = finalAisleWidths[index] || 1;
                    // âœ¨ FIX: Aisles should remain regular width even in staggered layouts
                    const aislePixelWidth = calculateSectionWidth(aisleWidthMultiplier, false);
                    html += `<div class="walkway" style="width: ${aislePixelWidth}px;"></div>`;
                }
            });
            html += "</div>";
            return html;
        }
        /**
         * ğŸ”§ MODIFIED: Generates a flexible aircraft seat row with advanced configuration.
         * Now supports:
         * - Special components with custom row/col spans (e.g., toilets).
         * - Staggered layouts for business class.
         * - Rendering only specific seats in a row.
         * - No-window rows with brown border styling.
         *
         * @param {Object} config - Row configuration object.
         * @param {number} config.rowNumber - Row number.
         * @param {Array}  config.rowNumberAisles - Aisle positions for row numbers.
         * @param {string} config.aircraftType - Aircraft type.
         * @param {string} config.cabinClass - Cabin class.
         * @param {Array}  config.seatTypes - Array of strings or objects. Objects can define special components.
         * @param {Array}  config.seatsToRender - Array of seat letters. Only these seats will be rendered. Others become placeholders.
         * @param {boolean} config.withExitSign - If true, adds an exit sign to the row.
         */
        function generateFlexibleRow({
            rowNumber = null,
            rowNumberAisles = [0],
            aircraftType,
            cabinClass,
            seatTypes = ["general"],
            seatsToRender = null,
            withExitSign = false,
        }) {
            const config = aircraftLayoutConfigs[`${aircraftType}-${cabinClass}`];
            if (!config) {
                return `<div class="row-wrap">Config not found</div>`;
            }

            const finalAisleWidths = config.aisleWidths || [];
            const sectionTypes = mapSeatTypesToSections(seatTypes, config.structure.length);

            // âœ¨ NEW: Check if this row contains no-window seats
            const hasNoWindowSeats = sectionTypes.includes("no-window");

            // âœ¨ NEW: Add no-window-row class if the row has no-window seats
            let rowClasses = "row-wrap";
            if (withExitSign) rowClasses += " exit-sign";
            // if (hasNoWindowSeats) rowClasses += " no-window-row";

            let html = `<div class="${rowClasses}">`;

            config.structure.forEach((sectionLetters, sectionIndex) => {
                const sectionType = sectionTypes[sectionIndex];

                // âœ¨ NEW: Logic to handle special components defined as objects
                if (typeof sectionType === "object" && sectionType !== null) {
                    const component = sectionType;
                    const colSpan = component.colSpan || sectionLetters.length; // Default to section width
                    const rowSpan = component.rowSpan || 1; // Default to 1 row height

                    // Check if this aircraft configuration uses staggered layout
                    const width = calculateSectionWidth(colSpan);
                    const height = rowSpan * getDimensions().seatHeight + (rowSpan - 1) * getDimensions().seatGap;

                    if (component.type === "toilet") {
                        html += `<div class="toilet" style="width: ${width}px; height: ${height}px; display: flex; align-items: center; justify-content: center;">${toiletSVG}</div>`;
                    } else if (component.type === "empty") {
                        html += `<div style="width: ${width}px; height: ${height}px;"></div>`;
                    }
                    // Add other component types like 'galley' here if needed
                }
                // Logic for standard seat sections
                else {
                    // âœ¨ NEW: Handle empty sections in staggered layouts differently
                    const isStaggeredConfig = config.staggered || false;

                    if (sectionType === "empty" && isStaggeredConfig) {
                        // For empty sections in staggered layout, create a div with proper width
                        const sectionWidth = calculateSectionWidth(sectionLetters.length);
                        html += `<div style="width: ${sectionWidth}px; height: ${getDimensions().seatHeight}px;"></div>`;
                    } else {
                        html += '<div class="seat-group">';
                        sectionLetters.forEach((letter, index) => {
                            // âœ¨ NEW: Logic to render a seat or a placeholder
                            if (seatsToRender === null || seatsToRender.includes(letter)) {
                                const seatId = rowNumber ? `${rowNumber}${letter}` : `SPEC-${letter}`;

                                // âœ¨ FIXED: Proper seat class assignment based on section type
                                let seatClass;
                                if (sectionType === "general") {
                                    seatClass = "seat-general";
                                } else if (sectionType === "no-window") {
                                    seatClass = "seat-no-window";
                                } else if (sectionType === "disabled") {
                                    seatClass = "seat-disabled";
                                } else if (sectionType === "empty") {
                                    // For empty seats, don't render anything - just create an invisible placeholder
                                    html += `<div style="width: ${getDimensions().seatWidth}px; height: ${getDimensions().seatHeight}px;"></div>`;
                                    return;
                                }

                                // âœ¨ NEW: Logic for staggered layout using aircraft config
                                if (isStaggeredConfig && rowNumber) {
                                    // Determine desk position based on even/odd row number
                                    const isRowOdd = rowNumber % 2 === 1;
                                    const isColumnOdd = index % 2 === 1;

                                    if (isRowOdd == isColumnOdd) {
                                        return; // âœ… FIXED: Use return instead of continue in forEach
                                    }

                                    const deskPosition = isRowOdd ? "desk-right" : "";
                                    html += `<div class="staggered-seat-container">
                    <div class="desk ${deskPosition}"></div>
                    <div class="seat ${seatClass}" data-seat="${seatId}"></div>
                    </div>`;
                                } else {
                                    // Original seat rendering
                                    html += `<div class="seat ${seatClass}" data-seat="${seatId}"></div>`;
                                }
                            } else {
                                // Render an empty placeholder if seat is not in seatsToRender
                                // if (isStaggeredConfig) {
                                //     // In staggered layout, placeholder needs seat+desk width
                                //     const placeholderWidth = calculateSectionWidth(1, true);
                                //     html += `<div class="seat-placeholder" style="width: ${placeholderWidth}px;"></div>`;
                                // } else {
                                //     html += '<div class="seat-placeholder"></div>';
                                // }
                                html += '<div class="seat-placeholder"></div>';
                            }
                        });
                        html += "</div>";
                    }
                }

                // Walkway rendering logic now automatically uses the config widths.
                if (sectionIndex < config.structure.length - 1) {
                    const aisleWidthMultiplier = finalAisleWidths[sectionIndex] || 1;
                    const aislePixelWidth = calculateSectionWidth(aisleWidthMultiplier);

                    html += `<div class="walkway" style="width: ${aislePixelWidth}px;">`;
                    const showRowNumber = rowNumber !== null;
                    html += `<div class="row-num">${showRowNumber ? rowNumber : ""}</div>`;
                    html += "</div>";
                }
            });

            html += "</div>";
            return html;
        }

        /**
         * Generates multiple rows with the same configuration
         */
        function generateFlexibleRows(startRow, endRow, rowConfig) {
            let html = "";
            for (let row = startRow; row <= endRow; row++) {
                html += generateFlexibleRow({
                    ...rowConfig,
                    rowNumber: row,
                });
            }
            return html;
        }

        /**
         * Generates exit arrows
         */
        function generateExitRow() {
            return '<div class="exit-row exit-sign"></div>';
        }

        /**
         * Generates galley area
         */
        function generateGalley(text = "") {
            return `<div class="galley-area" style="height:30px; background:white; text-align:center; line-height:30px; margin: 5px 0;">${text}</div>`;
        }

        /**
         * Gets the complete HTML template for a given aircraft and cabin class
         */

        function getLayoutTemplate(aircraftType, cabinClass) {
            const layoutKey = `${aircraftType}-${cabinClass}`;
            console.log("ğŸ› Layout Key in getLayoutTemplate:", layoutKey);

            // Base configuration to be reused in most row generation calls
            const baseConfig = {
                aircraftType: aircraftType,
                cabinClass: cabinClass,
                rowNumberAisles: [0], // Default position for displaying the row number in an aisle
            };

            switch (layoutKey) {
                case "32Q-Y": // âœ… SOLVED: Flexible toilet height and width
                    return `
                <div class="cabin-section">
                    ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 4, seatTypes: ["disabled"] })}
                ${generateFlexibleRows(5, 13, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 14, seatTypes: ["disabled"], withExitSign: true })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 15, seatTypes: ["disabled"], withExitSign: true })}
                ${generateFlexibleRows(16, 24, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 25, seatTypes: ["no-window"] })}
                ${generateFlexibleRows(26, 33, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRow({
                    ...baseConfig,
                    rowNumber: null,
                    // Toilets are now 1 row high by default. We specify their width in seat units.
                    seatTypes: [
                        { type: "toilet", colSpan: 3 }, // A toilet 3 seats wide in the first section
                        { type: "empty", colSpan: 3 }, // An empty space 3 seats wide in the second section
                    ],
                })}
                ${generateFlexibleRow({
                    ...baseConfig,
                    rowNumber: null,
                    // Toilets are now 1 row high by default. We specify their width in seat units.
                    seatTypes: [
                        { type: "toilet", colSpan: 3 }, // A toilet 3 seats wide in the first section
                        { type: "toilet", colSpan: 3 }, // A toilet 3 seats wide in the second section
                    ],
                })}
                ${generateExitRow()}
                </div>`;

                case "32Q-J": // âœ… UPDATED: Corrected dimensions for 50px seat width
                    return `
                <div class="cabin-section">
                    <div class="row-wrap">
                        <div class="toilet" style="width: 152px; height: 50px; display: flex; align-items: center; justify-content: center;">
                            ${toiletSVG}
                </div>
                <div class="walkway" style="width: 100px;">
                    <div class="row-num"></div>
                    </div>
                    <div style="width: 152px; height: 50px;"></div>
                    </div>
                    ${generateExitRow()}
                ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRows(2, 3, { ...baseConfig, seatTypes: ["general"] })}
                </div>`;

                case "339-Y": // âœ… UPDATED: Corrected dimensions for 50px seat width
                    return `
                <div class="cabin-section">
                    ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: null, seatTypes: [{ type: "toilet", rowSpan: 2 }, "empty", "empty"] })}
                ${generateExitRow()}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 30, seatTypes: ["disabled", "empty", "disabled"] })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 31, seatTypes: ["general", "disabled", "general"] })}
                ${generateFlexibleRows(32, 34, { ...baseConfig })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 35, seatTypes: ["no-window", "general", "no-window"] })}
                ${generateFlexibleRows(36, 47, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 48, seatTypes: ["empty", "general", "general"] })}
                ${generateGalley()}
                <div class="row-wrap">
                    <!-- Left toilet -->
                        <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                            ${toiletSVG}
                </div>
                
                <!-- Left walkway with row number -->
                    <div class="walkway" style="width: 50px;"></div>
                    
                    <!-- Middle seat group -->
                        <div class="seat-group">
                            <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                                ${toiletSVG}
                </div>
                <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                    ${toiletSVG}
                </div>
                </div>
                
                <!-- Right walkway -->
                    <div class="walkway" style="width: 50px;">
                        <div class="row-num"></div>
                        </div>
                        
                        <div class="seat-group">
                            <div class="seat-placeholder"></div>
                            <div class="seat-placeholder"></div>
                            </div>
                            </div>
                            
                            ${generateGalley()}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 50, seatTypes: ["empty", "disabled", "empty"], withExitSign: true })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 51, seatTypes: ["disabled", "general", "disabled"] })}
                ${generateFlexibleRows(52, 53, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRows(58, 64, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRows(65, 68, {
                    // Rows 65-68 have a missing seat
                    ...baseConfig,
                    // Only render seats in this list; others become placeholders
                    seatsToRender: ["A", "C", "D", "E", "G", "H", "K"],
                })}
                <div class="row-wrap"><div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                    ${toiletSVG}
                </div><div class="walkway" style="width: 50px;"><div class="row-num" style="margin-top: -50px;">69</div></div><div class="seat-group"><div class="seat seat-disabled" data-seat="69D"></div><div class="seat seat-general" data-seat="69E"></div><div class="seat-placeholder"></div><div class="seat seat-general" data-seat="69G"></div></div><div class="walkway" style="width: 50px;"><div class="row-num" style="margin-top: -50px;">69</div></div><div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                    ${toiletSVG}
                </div></div>
                    ${generateExitRow()}
                </div>`;
                
                case "339-J": // âœ… SOLVED: Staggered business class layout
                    return `
                <div class="cabin-section">
                    ${generateFlexibleRow({ ...baseConfig, rowNumber: null, seatTypes: [{ type: "toilet", rowSpan: 2 }, "empty", "empty"] })}
                ${generateExitRow()}
                ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRows(2, 8, {
                    ...baseConfig,
                    seatTypes: ["general"],
                    // Staggered layout is now handled by aircraft configuration
                })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: null, seatTypes: ["empty", "empty", { type: "toilet", rowSpan: 2 }] })}
                </div>`;

                case "359-Y":
                    return `
                <div class="cabin-section">
                    ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 30, seatTypes: ["empty", "disabled", "empty"] })}
                ${generateFlexibleRows(31, 41, { ...baseConfig, seatTypes: ["general"] })}
                ${generateGalley()}
                
                <!-- Middle toilet row -->
                    <div class="row-wrap">
                        <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                            ${toiletSVG}
                </div>
                <div class="walkway" style="width: 101px;">
                    <div class="row-num"></div>
                    </div>
                    <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                        ${toiletSVG}
                </div>
                <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                    ${toiletSVG}
                </div>
                <div class="walkway" style="width: 101px;">
                    <div class="row-num"></div>
                    </div>
                    <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                        ${toiletSVG}
                </div>
                </div>
                
                ${generateExitRow()}
                ${generateGalley()}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 50, seatTypes: ["empty", "disabled", "empty"] })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 51, seatTypes: ["disabled", "general", "disabled"] })}
                ${generateFlexibleRows(52, 53, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRows(58, 69, { ...baseConfig, seatTypes: ["general"] })}
                ${generateExitRow()}
                
                <!-- Bottom toilet row with seats -->
                    <div class="row-wrap">
                        <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center; margin-right: 25.5px;">
                            ${toiletSVG}
                </div>
                <div class="walkway" style="width: 101px;">
                    <div class="row-num"></div>
                    </div>
                    <div class="seat-group">
                        <div class="seat" data-seat="SPEC-D"></div>
                        <div class="seat" data-seat="SPEC-E"></div>
                        <div class="seat" data-seat="SPEC-G"></div>
                        </div>
                        <div class="walkway" style="width: 101px;">
                            <div class="row-num"></div>
                            </div>
                            <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center; margin-left: 25.5px;">
                                ${toiletSVG}
                </div>
                </div>
                </div>`;

                case "359-W":
                    return `
                <div class="cabin-section">
                    ${generateExitRow()}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: null, seatTypes: ["empty", "empty", { type: "toilet", rowSpan: 2 }] })}
                ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRows(20, 23, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 24, seatTypes: ["general", "empty", "general"] })}
                </div>`;

                case "359-J":
                    return `
                <div class="cabin-section">
                    ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRows(2, 7, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 8, seatTypes: [{ type: "toilet" }, "general", { type: "toilet" }] })}
                ${generateExitRow()}
                </div>`;

                case "359-F":
                    return `
                <div class="cabin-section">
                    ${generateFlexibleRow({ ...baseConfig, rowNumber: null, seatTypes: [{ type: "toilet" }, "empty", "empty"] })}
                ${generateExitRow()}
                ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 1, seatTypes: ["general"] })}
                </div>`;
                
                case "351-F":
                    return `
                <div class="cabin-section">
                    ${generateFlexibleRow({ ...baseConfig, rowNumber: null, seatTypes: [{ type: "toilet" }, "empty", "empty"] })}
                ${generateExitRow()}
                ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 1, seatTypes: ["general"] })}
                </div>`;
                
                case "351-J":
                    return `
                <div class="cabin-section">
                    ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRows(2, 11, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: null, seatTypes: [{ type: "toilet" }, "empty", { type: "toilet" }] })}
                ${generateExitRow()}
                </div>`;
                
                case "351-W":
                    return `
                <div class="cabin-section">
                    ${generateExitRow()}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: null, seatTypes: ["empty", "empty", { type: "toilet", rowSpan: 2 }] })}
                ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 20, seatTypes: ["general", "disabled", "general"] })}
                ${generateFlexibleRows(21, 23, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 24, seatTypes: ["general", "empty", "general"] })}
                </div>`;
                
                case "351-Y":
                    return `
                <div class="cabin-section">
                    ${generateSeatHeader(aircraftType, cabinClass)}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 30, seatTypes: ["empty", "disabled", "empty"] })}
                ${generateFlexibleRows(31, 41, { ...baseConfig, seatTypes: ["general"] })}
                ${generateGalley()}
                
                <!-- Middle toilet row -->
                    <div class="row-wrap">
                        <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                            ${toiletSVG}
                </div>
                <div class="walkway" style="width: 101px;">
                    <div class="row-num"></div>
                    </div>
                    <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                        ${toiletSVG}
                </div>
                <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                    ${toiletSVG}
                </div>
                <div class="walkway" style="width: 101px;">
                    <div class="row-num"></div>
                    </div>
                    <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center;">
                        ${toiletSVG}
                </div>
                </div>
                
                ${generateExitRow()}
                ${generateGalley()}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 50, seatTypes: ["empty", "disabled", "empty"] })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 51, seatTypes: ["disabled", "general", "disabled"] })}
                ${generateFlexibleRows(52, 53, { ...baseConfig, seatTypes: ["general"] })}
                ${generateFlexibleRow({ ...baseConfig, rowNumber: 54, seatTypes: ["empty", "general", "empty"] })}
                ${generateFlexibleRows(55, 69, { ...baseConfig, seatTypes: ["general"] })}
                ${generateExitRow()}
                
                <!-- Bottom toilet row with seats -->
                    <div class="row-wrap">
                        <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center; margin-right: 25.5px;">
                            ${toiletSVG}
                </div>
                <div class="walkway" style="width: 101px;">
                    <div class="row-num"></div>
                    </div>
                    <div class="seat-group">
                        <div class="seat" data-seat="SPEC-D"></div>
                        <div class="seat" data-seat="SPEC-E"></div>
                        <div class="seat" data-seat="SPEC-G"></div>
                        </div>
                        <div class="walkway" style="width: 101px;">
                            <div class="row-num"></div>
                            </div>
                            <div class="toilet" style="width: 101px; height: 101px; display: flex; align-items: center; justify-content: center; margin-left: 25.5px;">
                                ${toiletSVG}
                </div>
                </div>
                </div>`;
                
                default:
                    console.warn(`âŒ Layout template not implemented: ${layoutKey}`);
                    return `<div class="cabin-section"><div class="cabin-title">Layout not implemented: ${layoutKey}</div></div>`;
            }
        }
        /**
         * Renders the complete aircraft layout for a specific PNR
         * @param {string} aircraftType - Aircraft type code
         * @param {string} cabinClass - Cabin class code
         * @param {string} targetPnr - Target PNR code (optional)
         */
        function renderLayout(aircraftType, cabinClass, targetPnr = null) {
            const layoutKey = `${aircraftType}-${cabinClass}`;
            console.log("ğŸ› Layout Key in renderLayout:", layoutKey, "for PNR:", targetPnr);
            const template = getLayoutTemplate(aircraftType, cabinClass);

            if (!template) {
                console.warn(`âŒ Layout not found: ${layoutKey}`);
                return;
            }

            // Determine which wrapper to use
            const wrapperSelector = targetPnr ? `seatmap-wrapper-${targetPnr}` : "seatmap-wrapper";
            const wrapper = document.getElementById(wrapperSelector);

            if (!wrapper) {
                console.warn(`âŒ seatmap-wrapper element not found: ${wrapperSelector}`);
                return;
            }

            // Clear existing content
            wrapper.innerHTML = "";

            // Insert the layout template
            wrapper.innerHTML = template;

            // Add click handlers to all seats
            addSeatClickHandlers();

            console.log(`âœ… Rendered layout: ${layoutKey} in wrapper: ${wrapperSelector}`);
        }

        /**
         * Adds click handlers to all seat elements
         */
        function addSeatClickHandlers() {
            const seats = document.querySelectorAll(".seat");
            seats.forEach((seat) => {
                seat.onclick = seatClickHandler;
            });
        }

        /* =========================================================
         * 5. PASSENGER MANAGEMENT FUNCTIONS
         * Functions for handling passenger selection and display
         * ========================================================= */

        /**
         * Initializes passenger selection handlers for all passenger rows
         */
        function initializePassengerSelection() {
            const passengerRows = document.querySelectorAll(".passenger-row");
            passengerRows.forEach((row) => {
                row.onclick = passengerClickHandler;
            });
        }

        /**
         * Handles passenger row click events for selection
         */
        function passengerClickHandler() {
            if (!isEditing) return; // Only allow selection when in editing mode

            // Check if this passenger row is disabled (chargeable seat or blocked seat)
            if (this.classList.contains("disabled")) {
                showErrorPanel("æ­¤æ—…å®¢ç„¡æ³•é€²è¡Œåº§ä½è®Šæ›´");
                return;
            }

            const passengerIndex = parseInt(this.dataset.passengerIndex);
            const pnr = this.dataset.pnr;
            const passengerName = this.querySelector(".d-flex .align-items-center").textContent.trim();

            // Update selected passenger
            selectedPassenger = {
                tabKey: pnr,
                passengerIndex: passengerIndex,
                passengerName: passengerName,
            };

            // Update visual highlighting
            updatePassengerSelectionVisual();

            // âœ¨ ADD THIS NEW BLOCK to sync with the mobile selector
            const mobileSelector = document.querySelector("#tab" + pnr + " .mobile-passenger-selector");
            if (mobileSelector && selectedPassenger) {
                mobileSelector.value = selectedPassenger.passengerIndex;
            }

            console.log("Selected passenger:", selectedPassenger);
        }

        /**
         * Updates visual highlighting for the currently selected passenger
         */
        function updatePassengerSelectionVisual() {
            // Remove previous selection
            document.querySelectorAll(".passenger-row").forEach((row) => {
                row.classList.remove("selected");
            });

            // Add selection to current passenger
            if (selectedPassenger) {
                const selectedRow = document.querySelector(
                    `[data-pnr="${selectedPassenger.tabKey}"][data-passenger-index="${selectedPassenger.passengerIndex}"]`
                );
                if (selectedRow) {
                    selectedRow.classList.add("selected");
                }
            }
        }

        /* =========================================================
         * 6. SEAT ASSIGNMENT FUNCTIONS
         * Functions for handling seat selection and assignment
         * ========================================================= */

        /**
         * Handles seat click events for assignment
         */
        function seatClickHandler() {
            if (!isEditing) return; // Only allow selection when in editing mode

            const seatCode = this.dataset.seat;

            if (!selectedPassenger) {
                showErrorPanel("è«‹å…ˆé¸æ“‡æ—…å®¢");
                return;
            }

            // Check if this seat is already assigned to the same passenger (using normalized comparison)
            const normalizedSeatCode = normalizeSeatCode(seatCode);

            if (
                seatAssignments[selectedPassenger.tabKey] &&
                normalizeSeatCode(seatAssignments[selectedPassenger.tabKey][selectedPassenger.passengerIndex]) ===
                    normalizedSeatCode
            ) {
                showErrorPanel("æ­¤åº§ä½å·²æŒ‡æ´¾çµ¦é¸ä¸­çš„æ—…å®¢");
                return;
            }

            // Check if this seat is already assigned to a different passenger in the same PNR
            if (seatAssignments[selectedPassenger.tabKey]) {
                const assignedToPassenger = Object.keys(seatAssignments[selectedPassenger.tabKey]).find(
                    (passengerIndex) =>
                        normalizeSeatCode(seatAssignments[selectedPassenger.tabKey][passengerIndex]) ===
                        normalizedSeatCode
                );

                if (assignedToPassenger && assignedToPassenger !== selectedPassenger.passengerIndex.toString()) {
                    showErrorPanel("è«‹é¸æ“‡å…¶ä»–åº§ä½");
                    return;
                }
            }

            // Allow clicking on disabled seats only if they are assigned to passengers in this PNR
            if (this.classList.contains("seat-disabled")) {
                // Check if this seat is assigned to any passenger in current PNR (using normalized comparison)
                const isAssignedInCurrentPNR =
                    seatAssignments[selectedPassenger.tabKey] &&
                    Object.values(seatAssignments[selectedPassenger.tabKey]).some(
                        (assignedSeat) => normalizeSeatCode(assignedSeat) === normalizedSeatCode
                    );

                if (!isAssignedInCurrentPNR) {
                    showErrorPanel("æ­¤åº§ä½ç„¡æ³•é¸æ“‡");
                    return;
                }
            }

            // Assign seat to selected passenger
            assignSeatToPassenger(seatCode);
        }

        /**
         * Assigns a seat to the currently selected passenger
         * @param {string} seatCode - The seat code to assign (e.g., "10A")
         */
        function assignSeatToPassenger(seatCode) {
            const { tabKey, passengerIndex } = selectedPassenger;

            // Initialize assignments for this tab if needed
            if (!seatAssignments[tabKey]) {
                seatAssignments[tabKey] = {};
            }

            // Clear previous assignment for this passenger
            const previousSeat = seatAssignments[tabKey][passengerIndex];
            if (previousSeat) {
                clearSeatAssignment(previousSeat, tabKey);
            }

            // Clear any existing assignment for this seat (reassignment)
            // Normalize both codes for comparison to handle leading zeros
            const normalizedSeatCode = normalizeSeatCode(seatCode);
            Object.keys(seatAssignments[tabKey]).forEach((pIndex) => {
                const assignedSeat = seatAssignments[tabKey][pIndex];
                if (normalizeSeatCode(assignedSeat) === normalizedSeatCode) {
                    delete seatAssignments[tabKey][pIndex];
                }
            });

            // Assign new seat
            seatAssignments[tabKey][passengerIndex] = seatCode;

            // Update UI with PNR context
            updateSeatVisual(seatCode, passengerIndex, tabKey);
            updatePassengerSeatDisplay(tabKey, passengerIndex, seatCode);

            console.log(`Seat assigned: ${seatCode} to passenger ${passengerIndex} in PNR ${tabKey}`);
            console.log("Current assignments:", seatAssignments);
        }

        /**
         * Clears seat assignment and restores original seat state
         * @param {string} seatCode - The seat code to clear (e.g., "10A")
         * @param {string} pnrCode - The PNR code for context (optional)
         */
        function clearSeatAssignment(seatCode, pnrCode = null) {
            console.log("ğŸ”„ Clearing seat assignment for:", seatCode, "in PNR:", pnrCode);

            // Use PNR-specific context if provided
            const targetPnr = pnrCode || currentActivePnr;
            const normalizedSeatCode = normalizeSeatCode(seatCode);

            console.log("ğŸ” Looking for seat (normalized):", normalizedSeatCode, "from original:", seatCode);
            const seatElement = findSeatElement(seatCode, targetPnr);

            if (seatElement) {
                console.log("âœ… Found seat element:", seatElement);

                // Remove ALL passenger number circles (in case there are duplicates)
                const circles = seatElement.querySelectorAll(".passenger-number-circle");
                console.log("ğŸ”„ Circle elements found:", circles.length);
                circles.forEach((circle, index) => {
                    circle.remove();
                    console.log(`âœ… Circle ${index + 1} removed`);
                });

                // Remove assigned class
                seatElement.classList.remove("seat-selected");
                console.log("âœ… Removed seat-selected class");

                // Restore original state using stored seat states
                const originalState = getOriginalSeatState(seatCode, targetPnr);
                if (originalState) {
                    seatElement.classList.add(originalState);
                    console.log(`âœ… Restored to original state: ${originalState}`);
                } else {
                    // Fallback: check if blocked, otherwise default to general
                    if (
                        targetPnr &&
                        allSeatMapData[targetPnr] &&
                        allSeatMapData[targetPnr].blockedSeats &&
                        allSeatMapData[targetPnr].blockedSeats.includes(seatCode)
                    ) {
                        seatElement.classList.add("seat-disabled");
                        console.log("âœ… Fallback: Restored to seat-disabled");
                    } else {
                        seatElement.classList.add("seat-general");
                        console.log("âœ… Fallback: Restored to seat-general");
                    }
                }
            } else {
                console.warn("âŒ Seat element not found with selector:", `${context} [data-seat="${seatCode}"]`);
                console.warn("âŒ Available seat maps:", document.querySelectorAll('[id^="seatmap-wrapper"]'));
                console.warn("âŒ All seats in current context:", document.querySelectorAll(`${context} [data-seat]`));

                // Fallback: Try to find and clear the seat in any seat map
                console.log("ğŸ”„ Attempting fallback: clearing from all seat maps");
                const allSeatsWithCode = document.querySelectorAll(`[data-seat="${seatCode}"]`);
                allSeatsWithCode.forEach((seat, index) => {
                    console.log(`ğŸ”„ Fallback: Found seat ${index + 1}:`, seat);
                    const circles = seat.querySelectorAll(".passenger-number-circle");
                    circles.forEach((circle, circleIndex) => {
                        circle.remove();
                        console.log(`âœ… Fallback: Removed circle ${circleIndex + 1} from seat ${index + 1}`);
                    });
                    seat.classList.remove("seat-selected");

                    // Try to determine the correct original state using available PNRs
                    let restored = false;
                    for (const pnr of Object.keys(originalSeatStates)) {
                        const originalState = getOriginalSeatState(seatCode, pnr);
                        if (originalState) {
                            seat.classList.add(originalState);
                            console.log(`âœ… Fallback: Restored seat ${index + 1} to ${originalState} using PNR ${pnr}`);
                            restored = true;
                            break;
                        }
                    }

                    // If no original state found, use default logic
                    if (
                        !restored &&
                        !seat.classList.contains("seat-disabled") &&
                        !seat.classList.contains("seat-general") &&
                        !seat.classList.contains("seat-no-window")
                    ) {
                        seat.classList.add("seat-general");
                        console.log(`âœ… Fallback: Restored seat ${index + 1} to general (default)`);
                    }
                });
            }
        }

        /**
         * Helper function to store original seat state
         * @param {string} seatCode - The seat code (e.g., "10A")
         * @param {string} seatClass - The original seat class (e.g., "seat-general", "seat-no-window", "seat-disabled")
         * @param {string} pnrCode - The PNR code
         */
        function storeOriginalSeatState(seatCode, seatClass, pnrCode) {
            if (!originalSeatStates[pnrCode]) {
                originalSeatStates[pnrCode] = {};
            }
            originalSeatStates[pnrCode][seatCode] = seatClass;
        }

        /**
         * Helper function to get original seat state
         * @param {string} seatCode - The seat code (e.g., "10A")
         * @param {string} pnrCode - The PNR code
         * @returns {string|null} The original seat class or null if not found
         */
        function getOriginalSeatState(seatCode, pnrCode) {
            if (originalSeatStates[pnrCode] && originalSeatStates[pnrCode][seatCode]) {
                return originalSeatStates[pnrCode][seatCode];
            }
            return null;
        }

        /**
         * Capture original seat states after layout is rendered
         * @param {string} pnrCode - The PNR code
         */
        function captureOriginalSeatStates(pnrCode) {
            console.log("ğŸ“¸ Capturing original seat states for PNR:", pnrCode);

            if (!originalSeatStates[pnrCode]) {
                originalSeatStates[pnrCode] = {};
            }

            const context = `#seatmap-wrapper-${pnrCode}`;
            const seats = document.querySelectorAll(`${context} .seat[data-seat]`);

            seats.forEach((seatElement) => {
                const seatCode = seatElement.getAttribute("data-seat");
                if (seatCode) {
                    // Determine the original seat type based on current classes
                    let originalClass = "seat-general"; // default

                    if (seatElement.classList.contains("seat-no-window")) {
                        originalClass = "seat-no-window";
                    } else if (seatElement.classList.contains("seat-disabled")) {
                        originalClass = "seat-disabled";
                    } else if (seatElement.classList.contains("seat-general")) {
                        originalClass = "seat-general";
                    }

                    // Store the original state
                    originalSeatStates[pnrCode][seatCode] = originalClass;
                }
            });

            console.log(
                `âœ… Captured ${Object.keys(originalSeatStates[pnrCode]).length} original seat states for PNR ${pnrCode}`
            );
        }

        /**
         * Update seat visual with passenger number circle
         */
        function updateSeatVisual(seatCode, passengerIndex, pnrCode = null) {
            // Use current active PNR if not specified
            const targetPnr = pnrCode || currentActivePnr;
            const normalizedSeatCode = normalizeSeatCode(seatCode);
            const seatElement = findSeatElement(seatCode, targetPnr);
            if (!seatElement) {
                console.warn(
                    `âŒ Seat element not found: ${seatCode} (normalized: ${normalizedSeatCode}) in PNR: ${targetPnr}`
                );
                return;
            }

            // Remove any existing circles (in case there are duplicates)
            const existingCircles = seatElement.querySelectorAll(".passenger-number-circle");
            existingCircles.forEach((circle) => circle.remove());

            // Remove existing state classes
            seatElement.classList.remove("seat-general", "seat-no-window", "seat-disabled");

            // Create passenger number circle with correct color class
            const circle = document.createElement("div");
            circle.className = `passenger-number-circle passenger-${passengerIndex}-circle`;
            circle.textContent = passengerIndex;

            // Add circle to seat
            seatElement.appendChild(circle);
            seatElement.classList.add("seat-selected");

            console.log(
                `âœ… Seat ${seatCode} assigned to passenger ${passengerIndex} in PNR ${targetPnr} with color class: passenger-${passengerIndex}-circle`
            );
        }

        /**
         * Get the appropriate seat display text based on passenger type and seat assignment
         */
        /*function getSeatDisplayText(passenger, seatCode) {
            if (passenger.passengerType === 'INF') {
                return 'ç„¡æ³•é¸ä½';
            }
            return seatCode || 'å°šæœªé¸ä½';
        }*/

        /*250729 Richard èª¿æ•´é¡¯ç¤ºæ–‡æ¡ˆé‚è¼¯*/
        function getSeatDisplayText(passenger, seatCode) {
            const isINF = passenger.passengerType === "INF";
            const hasSeat = seatCode && seatCode.trim() !== "";
            const isChargeable = passenger.seatIsChargeable === true;

            if (isINF) {
                return "ç„¡æ³•é¸ä½";
            }

            // Normalize seat code to remove leading zeros for display
            const normalizedSeat = hasSeat ? normalizeSeatCode(seatCode) : seatCode;

            if (hasSeat && isChargeable) {
                return normalizedSeat + " ç„¡æ³•æ›ä½";
            }

            if (hasSeat) {
                return normalizedSeat;
            }

            return "å°šæœªé¸ä½";
        }

        /**
         * Update passenger seat display in the passenger list
         */
        function updatePassengerSeatDisplay(tabKey, passengerIndex, seatCode) {
            const passengerRow = document.querySelector(
                `[data-pnr="${tabKey}"][data-passenger-index="${passengerIndex}"]`
            );
            if (passengerRow) {
                const seatDisplay = passengerRow.querySelector(".passenger-seat-display");
                if (seatDisplay) {
                    // Get passenger data to check passenger type
                    const passenger = allTabData[tabKey] && allTabData[tabKey][passengerIndex - 1];
                    if (passenger) {
                        seatDisplay.textContent = getSeatDisplayText(passenger, seatCode);
                    } else {
                        seatDisplay.textContent = seatCode;
                    }
                }
            }

                let mobilePassengerSelector =
                    document.querySelector('#resultTabContent .tab-pane.show.active .mobile-passenger-selector');
                if (!mobilePassengerSelector) {
                    mobilePassengerSelector =
                        document.querySelector('#resultTabContent .tab-pane.active .mobile-passenger-selector');
                }
                if (mobilePassengerSelector && window.innerWidth <= 768) {
                    const optionToUpdate = mobilePassengerSelector.querySelector(`option[value="${passengerIndex}"]`);

                if (optionToUpdate) {
                    const passenger = allTabData[tabKey][passengerIndex - 1];
                    if (passenger) {
                        optionToUpdate.textContent = `${passengerIndex}. ${passenger.name} - ${getSeatDisplayText(passenger, seatCode)}`;
                    }
                }
            }
        }

        /* =========================================================
         * 7. DATA INITIALIZATION FUNCTIONS
         * Functions for loading and initializing data from backend
         * ========================================================= */

        /**
         * Normalizes all initial passenger seat displays to remove leading zeros
         */
        function normalizeInitialPassengerSeatDisplays() {
            console.log("ğŸ”„ Normalizing initial passenger seat displays");

            // Find all passenger seat display elements
            const seatDisplays = document.querySelectorAll(".passenger-seat-display");

            seatDisplays.forEach((seatDisplay) => {
                const currentText = seatDisplay.textContent.trim();

                // Check if it's a seat code (not status text like "ç„¡æ³•é¸ä½" or "å°šæœªé¸ä½")
                if (
                    currentText &&
                    !currentText.includes("ç„¡æ³•é¸ä½") &&
                    !currentText.includes("å°šæœªé¸ä½") &&
                    !currentText.includes("ç„¡æ³•æ›ä½")
                ) {
                    // Extract seat code from text (handle case like "07C ç„¡æ³•æ›ä½")
                    const parts = currentText.split(" ");
                    const seatCode = parts[0];

                    // Normalize the seat code
                    const normalizedSeat = normalizeSeatCode(seatCode);

                    if (normalizedSeat !== seatCode) {
                        // Replace the seat code in the original text
                        const normalizedText = currentText.replace(seatCode, normalizedSeat);
                        seatDisplay.textContent = normalizedText;
                        console.log(`âœ… Normalized seat display: "${currentText}" â†’ "${normalizedText}"`);
                    }
                }
            });

            console.log("âœ… Initial passenger seat displays normalized");
        }

        /**
         * Initializes existing seat assignments from passenger data
         */
        function initializeExistingSeatAssignments() {
            console.log("ğŸ”„ Initializing existing seat assignments from passenger data");
            seatAssignments = {}; // Reset current assignments

            // Load existing assignments from all tab data
            Object.keys(allTabData).forEach((pnrCode) => {
                const passengers = allTabData[pnrCode];
                if (!passengers) return;

                // Initialize assignments for this PNR
                seatAssignments[pnrCode] = {};

                passengers.forEach((passenger, index) => {
                    const passengerIndex = index + 1; // 1-based indexing
                    if (passenger.seat && passenger.seat !== "å°šæœªé¸ä½") {
                        // Store current assignments (keep original format from backend)
                        seatAssignments[pnrCode][passengerIndex] = passenger.seat;
                        const normalizedSeat = normalizeSeatCode(passenger.seat);
                        console.log(
                            `ğŸ“ Found existing assignment: PNR ${pnrCode}, Passenger ${passengerIndex} -> Seat ${passenger.seat} (normalized: ${normalizedSeat})`
                        );
                    }
                });
            });

            console.log("âœ… Existing seat assignments initialized:", seatAssignments);
        }

        /**
         * Load seat map with retry logic to handle timing issues
         */
        function loadSeatMapWithRetry(maxRetries = 3, currentRetry = 0) {
            console.log(`ğŸ”„ [DEBUG] Attempting to load seat map (attempt ${currentRetry + 1}/${maxRetries + 1})`);

            // Check if data containers exist and have data
            const allSeatMapContainer = document.getElementById("allSeatMapDataContainer");
            const allTabDataContainer = document.getElementById("allTabDataContainer");

            console.log(`ğŸ” [DEBUG] allSeatMapContainer found:`, !!allSeatMapContainer);
            console.log(`ğŸ” [DEBUG] allTabDataContainer found:`, !!allTabDataContainer);

            if (!allSeatMapContainer || !allTabDataContainer) {
                console.warn("âŒ [DEBUG] Data containers not found");
                console.warn("âŒ [DEBUG] Missing allSeatMapContainer:", !allSeatMapContainer);
                console.warn("âŒ [DEBUG] Missing allTabDataContainer:", !allTabDataContainer);
                if (currentRetry < maxRetries) {
                    console.log(`ğŸ”„ [DEBUG] Retrying in 300ms (attempt ${currentRetry + 1}/${maxRetries})`);
                    setTimeout(() => {
                        loadSeatMapWithRetry(maxRetries, currentRetry + 1);
                    }, 300);
                    return;
                }
                console.error("âŒ [DEBUG] Failed to find data containers after retries");
                return;
            }

            const seatMapData = allSeatMapContainer.getAttribute("data-all-seatmap") || "{}";
            const tabData = allTabDataContainer.getAttribute("data-all-tabdata") || "{}";

            console.log(`ğŸ“Š [DEBUG] seatMapData length: ${seatMapData.length}`);
            console.log(`ğŸ“Š [DEBUG] tabData length: ${tabData.length}`);
            console.log(`ğŸ“Š [DEBUG] seatMapData content (first 200 chars): ${seatMapData.substring(0, 200)}...`);
            console.log(`ğŸ“Š [DEBUG] tabData content (first 200 chars): ${tabData.substring(0, 200)}...`);

            // Check if data is actually populated (not just empty objects)
            if (seatMapData === "{}" || tabData === "{}" || seatMapData.length < 10 || tabData.length < 10) {
                console.warn("âŒ [DEBUG] Data not yet populated, retrying...");
                console.warn(`âŒ [DEBUG] seatMapData is empty object: ${seatMapData === "{}"}`);
                console.warn(`âŒ [DEBUG] tabData is empty object: ${tabData === "{}"}`);
                console.warn(`âŒ [DEBUG] seatMapData too short: ${seatMapData.length < 10} (length: ${seatMapData.length})`);
                console.warn(`âŒ [DEBUG] tabData too short: ${tabData.length < 10} (length: ${tabData.length})`);
                if (currentRetry < maxRetries) {
                    console.log(`ğŸ”„ [DEBUG] Retrying in 300ms (attempt ${currentRetry + 1}/${maxRetries})`);
                    setTimeout(() => {
                        loadSeatMapWithRetry(maxRetries, currentRetry + 1);
                    }, 300);
                    return;
                }
                console.error("âŒ [DEBUG] Data still not populated after retries");
                return;
            }

            console.log("âœ… [DEBUG] Data validation passed, proceeding with loadSeatMap()");
            loadSeatMap();
        }


        /**
         * Clear current tab seat assignments and revert to original state
         */
        function clearCurrentTabSeatAssignments() {
            if (!currentActivePnr) {
                console.warn("âŒ No active PNR to clear assignments for");
                return;
            }

            console.log("ğŸ”„ Reverting current tab seat assignments for PNR:", currentActivePnr);

            // Clear visual elements from current tab's seat map only
            const context = `#seatmap-wrapper-${currentActivePnr}`;
            document.querySelectorAll(`${context} .passenger-number-circle`).forEach((circle) => {
                circle.remove();
            });
            document.querySelectorAll(`${context} .seat`).forEach((seat) => {
                seat.classList.remove("seat-selected");

                // Restore original seat type using stored original states
                const seatCode = seat.getAttribute("data-seat");

                // First, remove all seat type classes to start fresh
                seat.classList.remove("seat-general", "seat-no-window", "seat-disabled");

                // Try to get the original seat state
                const originalState = getOriginalSeatState(seatCode, currentActivePnr);
                if (originalState) {
                    seat.classList.add(originalState);
                    console.log(`âœ… Restored seat ${seatCode} to original state: ${originalState}`);
                } else {
                    // Fallback: check if blocked, otherwise default to general
                    const isBlocked =
                        allSeatMapData[currentActivePnr] &&
                        allSeatMapData[currentActivePnr].blockedSeats &&
                        allSeatMapData[currentActivePnr].blockedSeats.includes(seatCode);

                    if (isBlocked) {
                        seat.classList.add("seat-disabled");
                        console.log(`âœ… Fallback: Restored seat ${seatCode} to seat-disabled`);
                    } else {
                        seat.classList.add("seat-general");
                        console.log(`âœ… Fallback: Restored seat ${seatCode} to seat-general`);
                    }
                }
            });

            // Revert current tab's seatAssignments to original state
            if (currentTabOriginalAssignments && Object.keys(currentTabOriginalAssignments).length > 0) {
                seatAssignments[currentActivePnr] = JSON.parse(JSON.stringify(currentTabOriginalAssignments));
            } else {
                // If no original assignments, clear current tab assignments
                if (seatAssignments[currentActivePnr]) {
                    delete seatAssignments[currentActivePnr];
                }
            }

            // Clear passenger selection visual
            selectedPassenger = null;
            document.querySelectorAll(".passenger-row").forEach((row) => {
                row.classList.remove("selected");
            });

            // Restore original passenger seat displays for current tab only
            if (allTabData[currentActivePnr]) {
                const passengers = allTabData[currentActivePnr];
                passengers.forEach((passenger, index) => {
                    const passengerIndex = index + 1;
                    const originalSeat = currentTabOriginalAssignments[passengerIndex];

                    // Update passenger display
                    const passengerRow = document.querySelector(
                        `[data-pnr="${currentActivePnr}"][data-passenger-index="${passengerIndex}"]`
                    );
                    if (passengerRow) {
                        const seatDisplay = passengerRow.querySelector(".passenger-seat-display");
                        if (seatDisplay) {
                            seatDisplay.textContent = getSeatDisplayText(passenger, originalSeat);
                        }
                    }
                });

                // Re-apply original seat assignments to current tab's seat map
                if (currentTabOriginalAssignments && Object.keys(currentTabOriginalAssignments).length > 0) {
                    Object.entries(currentTabOriginalAssignments).forEach(([passengerIndex, seatCode]) => {
                        updateSeatVisual(seatCode, passengerIndex, currentActivePnr);
                    });
                }
            }

            console.log("âœ… Reverted current tab to original seat assignments:", currentTabOriginalAssignments);
        }

        /* =========================================================
         * 4. Seat Click Handler (Legacy - now enhanced above)
         * =======================================================*/

        /* =========================================================
         * 5. Apply Blocked Seats from Controller
         * =======================================================*/

        /**
         * Filters blocked seats to remove seats occupied by passengers who can change seats
         * @param {Array} blockedSeats - Original blocked seats array
         * @param {string} pnrCode - PNR code to check passengers for
         * @returns {Array} Filtered blocked seats array
         */
        function filterBlockedSeatsForPNR(blockedSeats, pnrCode) {
            if (!Array.isArray(blockedSeats) || !pnrCode || !allTabData[pnrCode]) {
                return blockedSeats;
            }

            console.log(`ğŸ” Filtering blocked seats for PNR ${pnrCode}`);

            // Find seats that should remain selectable (occupied by passengers who can change seats)
            const selectableSeats = new Set();
            const passengers = allTabData[pnrCode];

            passengers.forEach((passenger, index) => {
                // Check if passenger should be disabled using the same logic as passenger rows
                const isDisabled = passenger.seatIsChargeable || passenger.passengerType === "INF";

                // If passenger is NOT disabled and has a seat assigned, that seat should remain selectable
                if (!isDisabled && passenger.seat && passenger.seat !== "å°šæœªé¸ä½") {
                    // Add both original and normalized seat codes to handle legacy data
                    selectableSeats.add(passenger.seat);
                    selectableSeats.add(normalizeSeatCode(passenger.seat));
                    console.log(
                        `ğŸª‘ Passenger ${index + 1} (${passenger.name}) can change seats - keeping seat ${passenger.seat} (normalized: ${normalizeSeatCode(passenger.seat)}) selectable`
                    );
                }
            });

            // Filter out selectable seats from blocked seats
            const filteredBlockedSeats = blockedSeats.filter((seat) => !selectableSeats.has(seat));

            console.log(`âœ… Filtered ${selectableSeats.size} selectable seats from blocked list`);
            console.log(`ğŸ“ Selectable seats:`, Array.from(selectableSeats));
            console.log(`ğŸš« Remaining blocked seats:`, filteredBlockedSeats);

            return filteredBlockedSeats;
        }

        // Updated applyBlockedSeats function to work with specific PNR
        function applyBlockedSeats(blockedSeats, targetPnr = null) {
            if (!Array.isArray(blockedSeats)) return;

            const context = targetPnr ? `#seatmap-wrapper-${targetPnr}` : "#seatmap-wrapper";

            blockedSeats.forEach((seatCode) => {
                const seatElement = findSeatElement(seatCode, targetPnr);
                if (seatElement) {
                    // Remove any existing seat class
                    seatElement.classList.remove("seat-general", "seat-no-window", "seat-selected");
                    // Add disabled class
                    seatElement.classList.add("seat-disabled");

                    // Update the stored original state to reflect that this seat is now disabled
                    if (targetPnr) {
                        storeOriginalSeatState(seatCode, "seat-disabled", targetPnr);
                    }
                }
            });

            console.log(`ğŸš« Applied ${blockedSeats.length} blocked seats for ${targetPnr || "default"}`);
        }

        /* =========================================================
         * 6. Main Seat Map Loading Function
         * =======================================================*/

        /* =========================================================
         * 8. MAIN LOADING AND RENDERING FUNCTIONS
         * Core functions for loading data and rendering seat maps
         * ========================================================= */

        /**
         * Main function to load seat map data from backend and initialize the interface
         */
        function loadSeatMap() {
            try {
                console.log("ğŸš€ LOAD SEAT MAP - Loading ALL PNR data");

                // 1. Get ALL seat map data from controller
                const allSeatMapContainer = document.getElementById("allSeatMapDataContainer");
                console.log("ğŸ” allSeatMapDataContainer element:", allSeatMapContainer);
                if (!allSeatMapContainer) {
                    console.warn("âŒ allSeatMapDataContainer element not found - this is normal before search");
                    return;
                }

                const allSeatMapJsonString = allSeatMapContainer.getAttribute("data-all-seatmap") || "{}";
                console.log("ğŸ—ºï¸ ALL Seat Map JSON from controller (raw):", allSeatMapJsonString);
                console.log("ğŸ—ºï¸ JSON length:", allSeatMapJsonString.length);

                // 2. Get ALL passenger data from controller
                const allTabDataContainer = document.getElementById("allTabDataContainer");
                if (!allTabDataContainer) {
                    console.warn("âŒ allTabDataContainer element not found");
                    return;
                }

                const allTabDataJsonString = allTabDataContainer.getAttribute("data-all-tabdata") || "{}";
                console.log("ğŸ‘¥ ALL Tab Data JSON from controller (raw):", allTabDataJsonString);
                console.log("ğŸ‘¥ JSON length:", allTabDataJsonString.length);

                // 3. Parse the data
                try {
                    allSeatMapData = JSON.parse(allSeatMapJsonString);
                    console.log("âœ… Successfully parsed seat map data:", allSeatMapData);
                } catch (parseError) {
                    console.error("âŒ Error parsing seat map JSON:", parseError);
                    console.error("âŒ Raw JSON:", allSeatMapJsonString);
                    return;
                }

                try {
                    allTabData = JSON.parse(allTabDataJsonString);
                    console.log("âœ… Successfully parsed passenger data:", allTabData);
                } catch (parseError) {
                    console.error("âŒ Error parsing passenger JSON:", parseError);
                    console.error("âŒ Raw JSON:", allTabDataJsonString);
                    return;
                }

                console.log("ğŸ“Š [DEBUG] LOADED DATA SUMMARY:");
                console.log("  - Seat Map PNRs:", Object.keys(allSeatMapData));
                console.log("  - Passenger PNRs:", Object.keys(allTabData));

                // 4. Get current active tab from the DOM instead of URL
                console.log("ğŸ” [DEBUG] Looking for active tab element...");
                const activeTabElement = document.querySelector(".tab-pane.active");
                console.log("ğŸ” [DEBUG] Active tab element found:", !!activeTabElement, activeTabElement);

                const availablePnrs = Object.keys(allSeatMapData);
                console.log("ğŸ” [DEBUG] Available PNRs:", availablePnrs);

                if (availablePnrs.length === 0) {
                    console.warn("âŒ [DEBUG] No PNR data available");
                    return;
                }

                // Extract PNR from active tab ID (e.g., "tab69YAFA" -> "69YAFA")
                let activePnrFromDOM = null;
                if (activeTabElement && activeTabElement.id) {
                    activePnrFromDOM = activeTabElement.id.replace("tab", "");
                    console.log("ğŸ” Active tab found in DOM:", activePnrFromDOM);
                }

                // Set the initial active PNR - prioritize DOM active tab, fallback to first available
                currentActivePnr =
                    activePnrFromDOM && allSeatMapData[activePnrFromDOM] ? activePnrFromDOM : availablePnrs[0];
                console.log("ğŸ¯ Active PNR set to:", currentActivePnr, "(from DOM:", activePnrFromDOM, ")");

                // 6. Initialize existing seat assignments from passenger data FIRST
                console.log("ğŸ“ Initializing existing seat assignments");
                initializeExistingSeatAssignments();

                // 7. Re-render the layout to apply existing assignments
                console.log("ğŸ”„ [DEBUG] Re-rendering layout to apply existing assignments");
                console.log("ğŸ”„ [DEBUG] About to call renderLayoutForPNR with:", currentActivePnr);
                renderLayoutForPNR(currentActivePnr);
                console.log("ğŸ”„ [DEBUG] renderLayoutForPNR completed");

                // 8. Initialize tab switching handlers
                console.log("ğŸ”„ Initializing tab switching handlers");
                initializeTabSwitching();

                // 9. Initialize passenger selection handlers
                console.log("ğŸ‘¤ Initializing passenger selection handlers");
                initializePassengerSelection();

                console.log("âœ… LOAD SEAT MAP COMPLETED - All PNR data loaded and ready");
            } catch (err) {
                console.error("âŒ CRITICAL ERROR in loadSeatMap:", err);
                console.error("Error details:", err.message);
                console.error("Stack trace:", err.stack);
            }
        }

        /**
         * Renders layout for a specific PNR with proper error handling
         * @param {string} pnrCode - The PNR code to render layout for
         */
        function renderLayoutForPNR(pnrCode) {
            console.log("ğŸ¨ [DEBUG] RENDER LAYOUT FOR PNR:", pnrCode);
            console.log("ğŸ” [DEBUG] All available seat map data:", allSeatMapData);
            console.log("ğŸ” [DEBUG] All available passenger data:", allTabData);

            // Check if seat map wrapper exists FIRST
            const wrapperElement = document.getElementById(`seatmap-wrapper-${pnrCode}`);
            console.log("ğŸ” [DEBUG] Seat map wrapper element for", pnrCode, "found:", !!wrapperElement);
            if (!wrapperElement) {
                console.error("âŒ [DEBUG] Seat map wrapper element not found: seatmap-wrapper-" + pnrCode);
                // List all available wrapper elements
                const allWrappers = document.querySelectorAll('[id*="seatmap-wrapper"]');
                console.log("ğŸ” [DEBUG] Available wrapper elements:", Array.from(allWrappers).map(w => w.id));
                return;
            }

            if (!allSeatMapData[pnrCode]) {
                console.error("âŒ [DEBUG] No seat map data for PNR:", pnrCode);
                console.error("âŒ [DEBUG] Available PNR keys:", Object.keys(allSeatMapData));

                // Display a user-friendly message instead of blank area
                const wrapper = document.getElementById(`seatmap-wrapper-${pnrCode}`);
                if (wrapper) {
                    wrapper.innerHTML =
                        '<div class="alert alert-warning text-center" style="margin: 20px; padding: 20px;">' +
                        "<h5>åº§ä½åœ–è³‡æ–™ç„¡æ³•è¼‰å…¥</h5>" +
                        "<p>æ­¤ PNR çš„åº§ä½åœ–æš«æ™‚ç„¡æ³•é¡¯ç¤ºï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«å®¢æœã€‚</p>" +
                        "</div>";
                }
                return;
            }

            const seatMapData = allSeatMapData[pnrCode];
            console.log("ğŸ—ºï¸ Seat map data for PNR:", pnrCode, seatMapData);

            const aircraftType = seatMapData.aircraftType || seatMapData.iataAircraftTypeCode;
            const cabinClasses = seatMapData.cabinClasses || [];
            const blockedSeats = seatMapData.blockedSeats || [];

            console.log(
                `âœˆï¸ PNR ${pnrCode} - Aircraft: ${aircraftType}, Cabins: ${JSON.stringify(cabinClasses)}, Blocked: ${blockedSeats.length} seats`
            );

            if (aircraftType && cabinClasses.length > 0) {
                const cabinClass = cabinClasses[0];
                console.log(`ğŸ¯ [DEBUG] About to render layout: ${aircraftType}-${cabinClass} for PNR: ${pnrCode}`);

                // Pass the target PNR to renderLayout
                console.log(`ğŸ¯ [DEBUG] Calling renderLayout with params:`, { aircraftType, cabinClass, pnrCode });
                renderLayout(aircraftType, cabinClass, pnrCode);
                console.log("âœ… [DEBUG] renderLayout() completed");

                if (blockedSeats.length > 0) {
                    // Filter out seats that are occupied by passengers who can change seats
                    const filteredBlockedSeats = filterBlockedSeatsForPNR(blockedSeats, pnrCode);
                    console.log(
                        `ğŸš« Original blocked seats: ${blockedSeats.length}, Filtered blocked seats: ${filteredBlockedSeats.length}`
                    );
                    console.log(
                        `ğŸš« Applying ${filteredBlockedSeats.length} filtered blocked seats:`,
                        filteredBlockedSeats.slice(0, 5),
                        "..."
                    );
                    applyBlockedSeats(filteredBlockedSeats, pnrCode);
                    console.log("âœ… applyBlockedSeats() completed");
                }

                // Capture original seat states AFTER blocked seats are applied
                captureOriginalSeatStates(pnrCode);
                console.log("âœ… captureOriginalSeatStates() completed");

                // Apply existing seat assignments AFTER blocked seats to override disabled state
                console.log("ğŸ“ Applying existing seat assignments for PNR:", pnrCode);
                applyExistingSeatAssignments(pnrCode);
                console.log("âœ… applyExistingSeatAssignments() completed");

                // Render passengers for this PNR
                console.log("ğŸ‘¥ Rendering passengers for PNR:", pnrCode);
                renderPassengersForPNR(pnrCode);
                console.log("âœ… renderPassengersForPNR() completed");

                // Restore any NEW seat assignments for this PNR (from current editing session)
                // Only restore if there are NEW assignments that differ from existing ones
                if (seatAssignments[pnrCode] && hasNewSessionAssignments(pnrCode)) {
                    console.log("â™»ï¸ Restoring session seat assignments for PNR:", pnrCode);
                    restoreSeatAssignments(pnrCode);
                    console.log("âœ… restoreSeatAssignments() completed");
                } else {
                    console.log("â„¹ï¸ No new session seat assignments for PNR:", pnrCode);
                }

                renderPassengerSelector(pnrCode); // Create the mobile dropdown

                console.log(`âœ… LAYOUT RENDERED SUCCESSFULLY for PNR ${pnrCode}: ${aircraftType}-${cabinClass}`);
            } else {
                console.error(`âŒ Missing aircraft type or cabin class for PNR ${pnrCode}:`, seatMapData);
            }
        }

        /**
         * Render passengers for a specific PNR dynamically
         */
        function renderPassengersForPNR(pnrCode) {
            console.log("ğŸ‘¥ Rendering passengers for PNR:", pnrCode);

            if (!allTabData[pnrCode]) {
                console.warn("âŒ No passenger data for PNR:", pnrCode);
                return;
            }

            const passengers = allTabData[pnrCode];
            // Fix: Remove the dash from the ID selector
            const tabContent = document.getElementById(`tab${pnrCode}`);

            if (!tabContent) {
                console.warn("âŒ Tab content not found for PNR:", pnrCode);
                console.warn("âŒ Looking for element with ID:", `tab${pnrCode}`);
                return;
            }

            // Find the passenger list container within this specific tab
            const passengerListContainer = tabContent.querySelector(".passenger-box");
            if (!passengerListContainer) {
                console.warn("âŒ Passenger list container not found for PNR:", pnrCode);
                return;
            }

            // Clear existing passengers (if any) but preserve the header
            const passengerContent = passengerListContainer.querySelector('div[style*="background-color: #d7c2af"]');
            if (passengerContent) {
                passengerContent.innerHTML = "";

                // Generate passenger rows
                passengers.forEach((passenger, index) => {
                    const passengerIndex = index + 1; // 1-based indexing

                    // Check if passenger should be disabled (chargeable or INF passenger)
                    let isDisabled = passenger.seatIsChargeable || passenger.passengerType === "INF";

                    const disabledClass = isDisabled ? " disabled" : "";
                    const passengerHtml = `
                <div class="passenger-row${disabledClass} d-flex justify-content-between align-items-center py-2 px-2 border-bottom" 
                style="font-weight: 500; color: #333" 
                data-passenger-index="${passengerIndex}" 
                data-pnr="${pnrCode}">
                <div class="d-flex align-items-center">
                <span class="text-center me-2 circle" style="
                display: inline-block;
                width: 20px;
                height: 20px;
                line-height: 20px;
                font-size: 0.8rem;
                border: 1px solid #000;
                border-radius: 50%;
                ">
                ${passengerIndex}
                               </span>
                               ${passenger.name}
                               </div>
                               <div style="white-space: nowrap">
                               <span class="passenger-seat-display">
                               ${getSeatDisplayText(passenger, passenger.seat)}
        </span>
        </div>
        </div>
        `;
                    passengerContent.innerHTML += passengerHtml;
                });

                // Re-initialize passenger selection handlers for the new rows
                initializePassengerSelectionForPNR(pnrCode);

                console.log(`âœ… Rendered ${passengers.length} passengers for PNR ${pnrCode}`);
            } else {
                console.warn("âŒ Passenger content area not found for PNR:", pnrCode);
            }
        }

        /**
         * Initialize passenger selection for a specific PNR
         */
        function initializePassengerSelectionForPNR(pnrCode) {
            const passengerRows = document.querySelectorAll(`[data-pnr="${pnrCode}"].passenger-row`);
            passengerRows.forEach((row) => {
                row.onclick = passengerClickHandler;
            });
            console.log(`âœ… Passenger selection initialized for ${passengerRows.length} passengers in PNR ${pnrCode}`);
        }

        /* =========================================================
         * 9. TAB MANAGEMENT FUNCTIONS
         * Functions for handling tab switching and PNR navigation
         * ========================================================= */

        /**
         * Initializes tab switching functionality with proper event handlers
         */
        function initializeTabSwitching() {
            console.log("ğŸ”„ Initializing tab switching");

            // Get all tab buttons
            const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');

            tabButtons.forEach((tabButton, index) => {
                const href = tabButton.getAttribute("href");
                const target = tabButton.getAttribute("data-bs-target");

                tabButton.addEventListener("click", function (e) {
                    // Try both href and data-bs-target attributes
                    let targetPnr;
                    if (this.getAttribute("href")) {
                        targetPnr = this.getAttribute("href").replace("#tab", "");
                    } else if (this.getAttribute("data-bs-target")) {
                        targetPnr = this.getAttribute("data-bs-target").replace("#tab", "");
                    } else {
                        console.error("âŒ Could not determine target PNR from tab button");
                        return;
                    }

                    console.log("ğŸ”„ TAB CLICKED - switching to PNR:", targetPnr);

                    // Update current active PNR
                    currentActivePnr = targetPnr;
                    console.log("ğŸ¯ Updated currentActivePnr to:", currentActivePnr);

                    // Update edit button visibility based on PNR's C2OperationDisable status
                    if (editButton && !isEditing) {
                        // Only update if not currently editing
                        var isDisabled = pnrC2DisabledMap[targetPnr] || false;
                        editButton.style.display = isDisabled ? "none" : "";
                        console.log("ğŸ”’ C2OperationDisable status for PNR", targetPnr, ":", isDisabled);
                    }

                    // Update URL to reflect active tab
                    const url = new URL(window.location);
                    url.searchParams.set("tab", targetPnr);
                    window.history.replaceState({}, "", url);
                    console.log("ğŸ”— Updated URL with tab:", targetPnr);


                    // Show loading overlay during API call
                    const overlay = document.getElementById("loadingOverlay");
                    if (overlay) {
                        overlay.style.display = "block";
                        document.body.style.overflow = "hidden";
                    }

                    // Call backend to refresh data for this PNR
                    // This will trigger: refreshDataForPNR() â†’ API calls â†’ update properties â†’ rerender
                    // Then oncomplete will call handleTabSwitchComplete() to render
                    setTimeout(() => {
                        console.log("â° Calling backend to refresh data for PNR:", targetPnr);
                        callHandleTabSwitch(targetPnr);
                    }, 100);
                });
            });

            console.log("âœ… Tab switching initialized for", tabButtons.length, "tabs");
        }

        /**
         * Check if there are new session assignments that differ from existing passenger data
         * @param {string} pnrCode - PNR code to check
         * @returns {boolean} True if there are new assignments
         */
        function hasNewSessionAssignments(pnrCode) {
            if (!seatAssignments[pnrCode] || !allTabData[pnrCode]) {
                return false;
            }

            // Compare session assignments with existing passenger data
            for (const [passengerIndex, sessionSeat] of Object.entries(seatAssignments[pnrCode])) {
                const passengerData = allTabData[pnrCode][parseInt(passengerIndex) - 1];
                const existingSeat = passengerData ? passengerData.seat : null;

                // If session seat differs from existing seat, we have new assignments
                if (sessionSeat !== existingSeat && existingSeat !== "å°šæœªé¸ä½") {
                    return true;
                }
            }

            return false;
        }

        /**
         * Restore seat assignments when switching tabs
         */
        function restoreSeatAssignments(pnrCode) {
            if (!seatAssignments[pnrCode]) return;

            console.log("â™»ï¸ Restoring seat assignments for PNR:", pnrCode, seatAssignments[pnrCode]);

            const context = `#seatmap-wrapper-${pnrCode}`;

            Object.entries(seatAssignments[pnrCode]).forEach(([passengerIndex, seatCode]) => {
                const seat = document.querySelector(`${context} [data-seat="${seatCode}"]`);
                if (seat) {
                    // Add passenger number circle
                    const circle = document.createElement("div");
                    circle.className = `passenger-number-circle`;
                    circle.textContent = passengerIndex;
                    seat.appendChild(circle);

                    // Mark seat as assigned
                    seat.classList.add("seat-selected");
                }
            });

            console.log("âœ… Seat assignments restored for PNR:", pnrCode);
        }

        /* =========================================================
         * 10. UI UTILITY FUNCTIONS
         * Helper functions for user interface interactions
         * ========================================================= */

        /**
         * Shows error message using the SearchErrorPanel
         * @param {string} message - Error message to display
         */
        function showErrorPanel(message) {
            console.warn("âŒ Error:", message);

            // Find the SearchErrorPanel container
            let errorPanel = null;

            // Method 1: Try the component ID
            try {
                errorPanel = document.getElementById("{!$Component.SearchErrorPanel}");
            } catch (e) {
                console.log("Component ID method failed:", e);
            }

            // Method 2: Find by partial ID match
            if (!errorPanel) {
                errorPanel =
                    document.querySelector('[id$="SearchErrorPanel"]') ||
                    document.querySelector('[id*="SearchErrorPanel"]');
            }

            console.log("Found error panel container:", errorPanel);

            if (errorPanel) {
                // Find the actual notification panel inside the container
                const notificationPanel = errorPanel.querySelector(".notification-panel-error");

                if (notificationPanel) {
                    // Find the message paragraph element
                    const messageElement = notificationPanel.querySelector("p");

                    if (messageElement) {
                        // Update the message content
                        messageElement.textContent = message;
                        console.log("âœ… Updated message to:", message);

                        // Show the error panel container
                        errorPanel.style.display = "block";

                        // Make sure the notification panel itself is visible
                        notificationPanel.style.display = "flex";

                        console.log("âœ… Showed error panel");

                        // Auto-hide after 3 seconds
                        setTimeout(() => {
                            errorPanel.style.display = "none";
                            console.log("âœ… Hid error panel after timeout");
                        }, 3000);

                        return true; // Success
                    } else {
                        console.warn("âŒ Could not find <p> element in notification panel");
                    }
                } else {
                    console.warn("âŒ Could not find .notification-panel-error inside container");
                }
            }

            // Fallback to toast if the panel approach fails
            console.warn("âŒ SearchErrorPanel approach failed, using toast fallback");
            return false;
        }

        /* =========================================================
         * 12. DEBUG AND TESTING FUNCTIONS
         * Functions for debugging and testing the seat selection system
         * ========================================================= */

        /**
         * Debug function to test specific aircraft layouts
         * @param {string} aircraftType - Aircraft type to test
         * @param {string} cabinClass - Cabin class to test
         */
        function debugLayout(aircraftType, cabinClass) {
            console.log(`ğŸ› Debug Layout: ${aircraftType}-${cabinClass}`);

            try {
                // Clear any existing layout
                const wrapper = document.getElementById("seatmap-wrapper");
                if (!wrapper) {
                    console.error("âŒ seatmap-wrapper element not found!");
                    alert("Error: seatmap-wrapper element not found!");
                    return;
                }

                wrapper.innerHTML = "";

                // Render the debug layout
                renderLayout(aircraftType, cabinClass);

                // Show some debug info
                console.log(`ğŸ“‹ Layout template for ${aircraftType}-${cabinClass}:`);
                console.log(getLayoutTemplate(aircraftType, cabinClass));

                // Apply some sample blocked seats for testing
                const sampleBlockedSeats = getSampleBlockedSeats(aircraftType, cabinClass);
                if (sampleBlockedSeats.length > 0) {
                    console.log(`ğŸš« Applying sample blocked seats:`, sampleBlockedSeats);
                    applyBlockedSeats(sampleBlockedSeats);
                }

                // Initialize passenger selection handlers
                initializePassengerSelection();

                // Show seat count
                const seats = document.querySelectorAll(".seat");
                console.log(`ğŸ’º Total seats rendered: ${seats.length}`);

                // Show passenger count for testing
                const passengers = document.querySelectorAll(".passenger-row");
                console.log(`ğŸ‘¥ Total passengers found: ${passengers.length}`);

                // Make sure the results area is visible
                const searchResults = document.getElementById("searchResults");
                const tabResults = document.getElementById("tabResults");
                const searchPrompt = document.getElementById("searchPrompt");

                if (searchResults) searchResults.style.display = "block";
                if (tabResults) tabResults.style.display = "block";
                if (searchPrompt) searchPrompt.style.display = "none";

                console.log(`âœ… Debug layout ${aircraftType}-${cabinClass} completed successfully!`);
                alert(`âœ… Layout ${aircraftType}-${cabinClass} loaded successfully!\nCheck console for details.`);
            } catch (error) {
                console.error("âŒ Error in debugLayout:", error);
                alert(`âŒ Error loading layout: ${error.message}`);
            }
        }

        function getSampleBlockedSeats(aircraftType, cabinClass) {
            // Return some sample blocked seats for testing
            switch (`${aircraftType}-${cabinClass}`) {
                case "32Q-Y":
                    return ["5A", "5B", "10H", "10J", "15K", "20A", "25B"];
                case "32Q-J":
                    return ["2A", "3K"];
                case "339-Y":
                    return ["30A", "31D", "31E", "50G", "69D"];
                case "339-J":
                    return ["6A", "7C", "11G"];
                case "359-Y":
                    return ["30D", "31A", "41B", "51H", "60G"];
                case "359-W":
                    return ["20A", "21E", "25J"];
                case "359-J":
                    return ["11A", "12C", "18K"];
                case "359-F":
                    return ["1A", "4K"];
                case "351-W":
                    return ["20D", "20E", "20F", "20G"];
				case "351-Y":
                    return ["30D", "31A", "41B", "51H", "60G"];
                default:
                    return [];
            }
        }

        // Enhanced debug function to show controller data
        function debugControllerData() {
            console.log("ğŸ® Controller Data Debug:");
            console.log("Aircraft Type:", "{!SeatMapAircraftType}");
            console.log("Cabin Classes:", "{!SeatMapCabins}");
            console.log("Disabled Seats:", "{!SeatMapDisabledSeats}");
            console.log("Current Tab Key:", "{!currentTabKey}");
            console.log("PNR Keys:", "{!pnrKeys}");

            // Debug the actual data containers
            const allSeatMapContainer = document.getElementById("allSeatMapDataContainer");
            const allTabDataContainer = document.getElementById("allTabDataContainer");

            if (allSeatMapContainer) {
                const seatMapData = allSeatMapContainer.getAttribute("data-all-seatmap");
                console.log("ğŸ—ºï¸ Raw seat map data:", seatMapData);
            }

            if (allTabDataContainer) {
                const tabData = allTabDataContainer.getAttribute("data-all-tabdata");
                console.log("ğŸ‘¥ Raw tab data:", tabData);
            }

            try {
                const cabinClasses = JSON.parse("{!SeatMapCabins}");
                const blockedSeats = JSON.parse("{!SeatMapDisabledSeats}");
                console.log("Parsed Cabin Classes:", cabinClasses);
                console.log("Parsed Blocked Seats:", blockedSeats);

                alert(
                    `Controller Data:\nAircraft: {!SeatMapAircraftType}\nCabins: ${JSON.stringify(cabinClasses)}\nBlocked: ${blockedSeats.length} seats`
                );
            } catch (e) {
                console.error("Error parsing controller data:", e);
                alert("Controller data is empty or invalid - this is normal before search");
            }
        }

        // New debug function specifically for tab switching issues
        function debugTabSwitching() {
            console.log("ğŸ”„ DEBUG TAB SWITCHING:");
            console.log("Current Active PNR:", currentActivePnr);
            console.log("All Seat Map Data:", allSeatMapData);
            console.log("All Tab Data:", allTabData);
            console.log("Available PNR keys in seat map:", Object.keys(allSeatMapData));
            console.log("Available PNR keys in tab data:", Object.keys(allTabData));

            // Test rendering each PNR
            Object.keys(allSeatMapData).forEach((pnr) => {
                console.log(`ğŸ¯ Testing PNR ${pnr}:`, allSeatMapData[pnr]);
            });

            alert(
                `Debug Info:\nCurrent PNR: ${currentActivePnr}\nAvailable PNRs: ${Object.keys(allSeatMapData).join(", ")}`
            );
        }

        // Function to test layout switching
        function testAllLayouts() {
            const layouts = [
                ["32Q", "Y"],
                ["32Q", "J"],
                ["339", "Y"],
                ["339", "J"],
                ["359", "Y"],
                ["359", "W"],
                ["359", "J"],
                ["359", "F"],
                ["351", "Y"],
                ["351", "W"],
                ["351", "J"],
                ["351", "F"],
            ];

            let index = 0;
            function showNext() {
                if (index < layouts.length) {
                    const [aircraft, cabin] = layouts[index];
                    console.log(`Testing layout ${index + 1}/${layouts.length}: ${aircraft}-${cabin}`);
                    debugLayout(aircraft, cabin);
                    index++;
                    setTimeout(showNext, 3000); // Show each layout for 3 seconds
                } else {
                    console.log("âœ… All layouts tested");
                    alert("âœ… All layouts tested! Check console for details.");
                }
            }

            if (confirm("This will cycle through all 8 layouts (3 seconds each). Continue?")) {
                showNext();
            }
        }

        /* =========================================================
         * 13. MODAL AND FORM FUNCTIONS
         * Functions for handling modals and form interactions
         * ========================================================= */

        /**
         * Shows the legend modal with seat type explanations
         */
        function showLegendModal() {
            const modal = new bootstrap.Modal(document.getElementById("legendModal"));
            modal.show();
        }

        /**
         * Shows the notice modal with seat selection guidelines
         */
        function showNoticeModal() {
            const modal = new bootstrap.Modal(document.getElementById("noticeModal"));
            modal.show();
        }

        /**
         * Input validation for booking codes field
         */
        document.addEventListener("DOMContentLoaded", function () {
            const bookingInput = document.getElementById("{!$Component.searchForm.bookingCodes}");
            if (bookingInput) {
                bookingInput.setAttribute("maxlength", "50");

                bookingInput.addEventListener("input", function () {
                    this.value = this.value.toUpperCase().replace(/[^A-Z0-9,]/g, "");
                });
            }
        });

        /**
         * Limits and formats flight number input
         * @param {HTMLElement} el - The input element
         */
        function limitFlightInput(el) {
            let raw = el.value.toUpperCase().replace(/[^0-9A-Z]/g, "");
            raw = raw.slice(0, 5);

            const match = raw.match(/^(\d*)([A-Z]*)$/);
            if (!match) {
                el.value = raw;
                return;
            }

            let numberPart = match[1];
            let letterPart = match[2];

            if (letterPart.length === 0) {
                numberPart = numberPart.slice(0, 4);
            } else {
                const maxDigits = 5 - letterPart.length;
                numberPart = numberPart.slice(0, maxDigits);
            }

            el.value = numberPart + letterPart;
        }

        /**
         * Formats flight number with proper padding
         */
        function formatFlightNumber() {
            const displayEl = document.getElementById("flightNumber_display");
            const hiddenEl = document.getElementById("{!$Component.searchForm.flightNumber}");

            let raw = displayEl.value.trim().toUpperCase();
            const match = raw.match(/^(\d*)([A-Z]*)$/);

            if (!match) {
                hiddenEl.value = raw;
                displayEl.value = raw;
                return;
            }

            let numberPart = match[1];
            const letterPart = match[2];

            if (letterPart.length === 0) {
                // ç´”æ•¸å­—ï¼šè£œ 0 åˆ° 4 ç¢¼
                numberPart = numberPart.padStart(4, "0");
            } else {
                // å«è‹±æ–‡ï¼šè£œ 0 åˆ°ç¸½é•· 5 ç¢¼
                const padLength = 5 - letterPart.length;
                numberPart = numberPart.padStart(padLength, "0");
            }

            const formatted = numberPart + letterPart;

            displayEl.value = formatted;
            hiddenEl.value = raw;
        }

        //20250607 Richæ—¥æœŸé–å®šï¼Œè¦ç”¨å†æ‰“é–‹
        document.addEventListener("DOMContentLoaded", function () {
            /* 1ï¸âƒ£ å–å¾—æ—¥æœŸè¼¸å…¥æ¡† */
            const dateEl = document.getElementById("{!$Component.searchForm.departureDate}");

            /* 2ï¸âƒ£ ç®—å‡ºã€Œä»Šå¤© â€“ 4 å¤©ã€ */
            const today = new Date();
            const minDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 4);

            /* 3ï¸âƒ£ è½‰æˆ yyyy-MM-dd æ ¼å¼ (date input éœ€è¦) */
            const pad = (n) => n.toString().padStart(2, "0");
            const minStr = [minDay.getFullYear(), pad(minDay.getMonth() + 1), pad(minDay.getDate())].join("-");

            /* 4ï¸âƒ£ å¯«å…¥ min å±¬æ€§ */
            dateEl.setAttribute("min", minStr);

            /* 5ï¸âƒ£ è‹¥æ¬„ä½é è¨­å€¼ < minï¼Œä¹ŸåŒæ­¥èª¿æ•´ */
            if (dateEl.value && dateEl.value < minStr) {
                dateEl.value = minStr;
            }
        });

        document.addEventListener("click", function (event) {
            // å°‹æ‰¾æ‰€æœ‰ notification é¢æ¿ï¼ˆå¯èƒ½æœ‰å¤šå€‹ï¼‰
            const notifications = document.querySelectorAll(".notification-panel");

            notifications.forEach(function (notification) {
                // å¦‚æœé»æ“Šçš„ä¸æ˜¯ notification è£¡é¢çš„æ±è¥¿ï¼Œå°±é—œé–‰
                if (!notification.contains(event.target)) {
                    notification.style.display = "none";
                }
            });
        });

        /**
         * Disables tab switching during edit mode
         */
        function disableTabSwitching() {
            const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');

            tabButtons.forEach((tabButton) => {
                // Don't disable the currently active tab
                if (!tabButton.classList.contains("active")) {
                    tabButton.disabled = true;
                    tabButton.style.opacity = "0.5";
                    tabButton.style.cursor = "not-allowed";
                    tabButton.style.pointerEvents = "none";

                    // Add a visual indicator that tabs are disabled
                    tabButton.setAttribute("title", "è«‹å…ˆå®Œæˆç•¶å‰é¸ä½æ“ä½œ");
                }
            });

            console.log("ğŸš« Tab switching disabled during edit mode");
        }

        /**
         * Re-enables tab switching after edit mode
         */
        function enableTabSwitching() {
            const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');

            tabButtons.forEach((tabButton) => {
                tabButton.disabled = false;
                tabButton.style.opacity = "1";
                tabButton.style.cursor = "pointer";
                tabButton.style.pointerEvents = "auto";
                tabButton.removeAttribute("title");
            });

            console.log("âœ… Tab switching re-enabled");
        }

        /* =========================================================
         * 11. SAVE/CANCEL FUNCTIONALITY
         * Functions for handling seat selection save and cancel operations
         * ========================================================= */

        let originalValues = {};

        /**
         * Validates required fields before saving
         * @returns {boolean} True if all fields are valid
         */
        function validateFields() {
            const editableFields = document.querySelectorAll(".editable-field:not([disabled])");
            let ok = true;

            editableFields.forEach((f) => {
                const tag = f.tagName.toLowerCase();

                f.classList.remove("is-invalid");

                const old = f.parentElement.querySelector(".invalid-feedback");
                if (old) old.remove();

                const value = f.value.trim();

                if ((tag === "input" || tag === "select") && !value) {
                    ok = false;
                    f.classList.add("is-invalid");

                    const div = document.createElement("div");
                    div.className = "invalid-feedback";
                    div.textContent = "å¿…å¡«";
                    f.parentElement.appendChild(div);
                }
            });

            return ok;
        }

        editButton.addEventListener("click", () => {
            const editableFields = document.querySelectorAll(".editable-field");
            const actionButtons = document.querySelectorAll(".actionbtn");
            let mobilePassengerSelector =
                document.querySelector('#resultTabContent .tab-pane.show.active .mobile-passenger-selector');
            if (!mobilePassengerSelector) {
                mobilePassengerSelector =
                    document.querySelector('#resultTabContent .tab-pane.active .mobile-passenger-selector');
            }

            /* ---------- é€²å…¥ã€Œé¸ä½/æ›ä½ã€ ---------- */
            if (!isEditing) {
                // Store current tab's original assignments before entering edit mode
                storeCurrentTabOriginalAssignments();

                isEditing = true;
                editButton.textContent = "å„²å­˜";

                disableTabSwitching();

                document.getElementById("resultTabContent").style.pointerEvents = "auto"; // âœ… é–‹æ”¾äº’å‹•
                cancelButton.style.display = "block";
                nextStepBtn.style.display = "none";
                lastStepBtn.style.display = "none";

                // å°‡ flightSearchForm è£¡çš„æ¬„ä½ disable
                const flightSearchForm = document.getElementById("flightSearchForm");
                if (flightSearchForm) {
                    flightSearchForm.querySelectorAll("input, select, button").forEach((el) => {
                        el.disabled = true;
                        el.classList.add("disabled-by-edit"); // è‹¥æ—¥å¾Œéœ€è¦å–æ¶ˆå¯ç”¨æ­¤ class å€åˆ†
                    });
                }

                document.querySelectorAll(".edit-only").forEach((td) => {
                    td.style.display = "table-cell";
                });

                editableFields.forEach((f) => {
                    f.dataset.orig = f.value; // æ‹ä¸‹åŸå€¼
                    f.disabled = false;
                    f.style.backgroundColor = "#fff";
                    f.style.border = "1px solid #ced4da";
                });

                // Initialize passenger selection for editing mode
                initializePassengerSelection();

                if (mobilePassengerSelector) mobilePassengerSelector.disabled = false;

                console.log("ğŸ”“ Entered seat selection mode for tab:", currentActivePnr);
                return; // ä¸ç¹¼çºŒåŸ·è¡Œå„²å­˜
            }

            /* ---------- é»ã€Œå„²å­˜ã€ ---------- */
            if (!validateFields()) return; // é©—è­‰æ²’éç›´æ¥è·³èµ°

            // Show loading overlay
            document.getElementById("loadingOverlay").style.display = "block";
            document.body.style.overflow = "hidden";

            // Save seat assignments to backend (current tab only)
            if (
                currentActivePnr &&
                seatAssignments[currentActivePnr] &&
                Object.keys(seatAssignments[currentActivePnr]).length > 0
            ) {
                const currentTabAssignments = { [currentActivePnr]: seatAssignments[currentActivePnr] };
                console.log("ğŸ’¾ Saving current tab seat assignments to backend:", currentTabAssignments);

                // Set the hidden input value with current tab seat assignments JSON
                const seatAssignmentInputField = document.querySelector('input[id*="seatAssignmentInput"]');
                if (seatAssignmentInputField) {
                    seatAssignmentInputField.value = JSON.stringify(currentTabAssignments);
                    console.log("ğŸ’¾ Set seat assignment input:", JSON.stringify(currentTabAssignments));

                    // Reset completion flag for new save operation
                    isSaveComplete = false;

                    // Call the backend method
                    console.log("ğŸš€ Calling saveSeatAssignments() backend method...");
                    saveSeatAssignments(currentActivePnr);
                    console.log("ğŸ“¤ saveSeatAssignments() call initiated, waiting for backend response...");

                    // Add a fallback timeout in case the oncomplete doesn't trigger
                    // saveTimeoutId = setTimeout(() => {
                    //     if (isEditing && !isSaveComplete) {
                    //         console.warn("âš ï¸ Fallback timeout triggered - completing save process");
                    //         handleSeatAssignmentSave();
                    //     }
                    // }, 5000); // 5 second fallback

                    return; // Don't continue with the UI changes yet, wait for backend response
                } else {
                    console.warn("âŒ Could not find seatAssignmentInput field");
                    // Hide loading overlay since we won't be calling backend
                    document.getElementById("loadingOverlay").style.display = "none";
                    document.body.style.overflow = "";
                }
            } else {
                console.log("ğŸ’¾ No seat assignments to save for current tab:", currentActivePnr);
                // Hide loading overlay since we won't be calling backend
                document.getElementById("loadingOverlay").style.display = "none";
                document.body.style.overflow = "";
            }

            // Complete the save process (this will be called by handleSeatAssignmentSave after backend save)
            completeSaveProcess();
        });

        /* ================ å®Œæˆå„²å­˜æµç¨‹ ================ */
        function completeSaveProcess() {
            console.log("ğŸ”„ completeSaveProcess starting...");

            const editableFields = document.querySelectorAll(".editable-field");
            const actionButtons = document.querySelectorAll(".actionbtn");
            let mobilePassengerSelector =
                document.querySelector('#resultTabContent .tab-pane.show.active .mobile-passenger-selector');
            if (!mobilePassengerSelector) {
                mobilePassengerSelector =
                    document.querySelector('#resultTabContent .tab-pane.active .mobile-passenger-selector');
            }
            
            if (mobilePassengerSelector) {
                mobilePassengerSelector.value = ""; // Reset to the default "-- è«‹é¸æ“‡æ—…å®¢ --" option
                mobilePassengerSelector.disabled = true;
            }

            // Re-enable the flight search form that was disabled during edit mode
            const flightSearchForm = document.getElementById("flightSearchForm");
            if (flightSearchForm) {
                flightSearchForm.querySelectorAll(".disabled-by-edit").forEach((el) => {
                    el.disabled = false;
                    el.classList.remove("disabled-by-edit");
                });
            }

            document.querySelectorAll(".edit-only").forEach((td) => {
                td.style.display = "none";
            });

            isEditing = false;
            editButton.textContent = "é¸ä½/æ›ä½";
            cancelButton.style.display = "none";
            nextStepBtn.style.display = "block";
            lastStepBtn.style.display = "block";

            // Re-enable tab switching when saving
            enableTabSwitching();

            document.getElementById("resultTabContent").style.pointerEvents = "none";

            editableFields.forEach((f) => {
                f.disabled = true;
                f.style.backgroundColor = "transparent";
                f.style.border = "none";
                f.classList.remove("is-invalid");
                delete f.dataset.orig;
            });

            actionButtons.forEach((b) => {
                b.disabled = true;
                b.style.cursor = "not-allowed";
            });

            // Clear passenger selection visual but keep assignments
            selectedPassenger = null;
            updatePassengerSelectionVisual();

            // Show success toast with dynamic message from backend
            const successPanel = document.querySelector("[id$=editSuccessPanel]");
            if (successPanel) {
                // Add delay to wait for rerender completion before checking message
                setTimeout(() => {
                    successPanel.style.display = "block";
                    setTimeout(() => {
                        successPanel.style.display = "none";
                    }, 2000);
                }, 100); // Wait for rerender to complete
            }

            // Hide loading overlay
            document.getElementById("loadingOverlay").style.display = "none";
            document.body.style.overflow = "";

            console.log("ğŸ” Saved and exited seat selection mode");
        }

        /* ================ è™•ç†åº§ä½é¸æ“‡å„²å­˜å›æ‡‰ ================ */
        function handleSeatAssignmentSave() {
            // Guard against duplicate calls - check at the very beginning
            if (isSaveComplete) {
                console.log("âš ï¸ handleSeatAssignmentSave called but already completed, skipping");
                return;
            }

            console.log("ğŸ“¥ Backend save completed for current tab:", currentActivePnr);

            // Set completion flag immediately to prevent second call
            isSaveComplete = true;

            // Clear the fallback timeout since backend completed successfully
            if (saveTimeoutId) {
                clearTimeout(saveTimeoutId);
                saveTimeoutId = null;
                console.log("âœ… Cleared fallback timeout");
            }

            try {
                // Update currentTabOriginalAssignments for next edit session
                if (currentActivePnr && seatAssignments[currentActivePnr]) {
                    currentTabOriginalAssignments = JSON.parse(JSON.stringify(seatAssignments[currentActivePnr]));
                }

                // Update the allTabData with the new seat assignments for current tab only
                if (currentActivePnr && allTabData[currentActivePnr] && seatAssignments[currentActivePnr]) {
                    Object.entries(seatAssignments[currentActivePnr]).forEach(([passengerIndex, seatCode]) => {
                        const arrayIndex = parseInt(passengerIndex) - 1; // Convert to 0-based
                        if (allTabData[currentActivePnr][arrayIndex]) {
                            allTabData[currentActivePnr][arrayIndex].seat = seatCode;
                        }

                        // Update passenger seat display in UI
                        updatePassengerSeatDisplay(currentActivePnr, passengerIndex, seatCode);
                    });
                }

                console.log("ğŸ’¾ Updated passenger data and seat displays with saved assignments for current tab");

                // âœ… Re-parse fresh data from backend after rerender
                console.log("ğŸ”„ Re-parsing fresh data from backend containers");
                const allSeatMapContainer = document.getElementById("allSeatMapDataContainer");
                const allTabDataContainer = document.getElementById("allTabDataContainer");

                if (allSeatMapContainer && allTabDataContainer) {
                    try {
                        allSeatMapData = JSON.parse(allSeatMapContainer.getAttribute("data-all-seatmap") || "{}");
                        allTabData = JSON.parse(allTabDataContainer.getAttribute("data-all-tabdata") || "{}");
                        console.log("âœ… Fresh data parsed successfully");
                        console.log("  - SeatMapData PNRs:", Object.keys(allSeatMapData));
                        console.log("  - TabData PNRs:", Object.keys(allTabData));
                    } catch (parseError) {
                        console.error("âŒ Error parsing fresh data:", parseError);
                    }
                } else {
                    console.warn("âš ï¸ Data containers not found, skipping data refresh");
                }

                // âœ… Re-render the seat map for current PNR with fresh backend data
                if (currentActivePnr && allSeatMapData[currentActivePnr]) {
                    console.log("ğŸ¨ Re-rendering seat map for PNR:", currentActivePnr);
                    try {
                        renderLayoutForPNR(currentActivePnr);
                        console.log("âœ… Seat map re-rendered successfully");
                    } catch (renderError) {
                        console.error("âŒ Error re-rendering seat map:", renderError);
                    }
                } else {
                    console.warn("âš ï¸ Cannot re-render seat map - missing PNR or data:", {
                        currentActivePnr,
                        hasSeatMapData: !!allSeatMapData[currentActivePnr]
                    });
                }

                // âœ… Re-initialize tab switching and passenger selection handlers after rerender
                console.log("ğŸ”„ Re-initializing tab switching and passenger selection handlers");
                try {
                    initializeTabSwitching();
                    initializePassengerSelection();
                    console.log("âœ… Event handlers re-initialized successfully");
                } catch (initError) {
                    console.error("âŒ Error re-initializing event handlers:", initError);
                }

                // Complete the save process to exit edit mode
                completeSaveProcess();

                console.log("âœ… handleSeatAssignmentSave completed successfully");
            } catch (error) {
                console.error("âŒ Error in handleSeatAssignmentSave:", error);
                console.error("Error details:", error.message);
                console.error("Stack trace:", error.stack);

                // Still try to complete the save process even if there are errors
                completeSaveProcess();
            }
        }

        /* ================ è™•ç† Tab åˆ‡æ›å¾Œçš„è³‡æ–™åˆ·æ–° ================ */
        function handleTabSwitchComplete() {
            console.log("ğŸ“¥ Backend refresh completed for tab switch, target PNR:", pendingTabSwitchPNR);

            if (!pendingTabSwitchPNR) {
                console.warn("âš ï¸ No pending tab switch PNR found");
                return;
            }

            try {
                const targetPnr = pendingTabSwitchPNR;
                pendingTabSwitchPNR = null; // Clear the pending state

                // Re-parse fresh data from backend containers (same as save flow)
                console.log("ğŸ”„ Re-parsing fresh data from backend containers for tab switch");
                const allSeatMapContainer = document.getElementById("allSeatMapDataContainer");
                const allTabDataContainer = document.getElementById("allTabDataContainer");

                if (allSeatMapContainer && allTabDataContainer) {
                    try {
                        allSeatMapData = JSON.parse(allSeatMapContainer.getAttribute("data-all-seatmap") || "{}");
                        allTabData = JSON.parse(allTabDataContainer.getAttribute("data-all-tabdata") || "{}");
                        console.log("âœ… Fresh data parsed successfully for tab switch");
                        console.log("  - SeatMapData PNRs:", Object.keys(allSeatMapData));
                        console.log("  - TabData PNRs:", Object.keys(allTabData));
                    } catch (parseError) {
                        console.error("âŒ Error parsing fresh data:", parseError);
                    }
                }

                // Re-render the seat map for target PNR with fresh backend data
                if (allSeatMapData[targetPnr]) {
                    console.log("ğŸ¨ Re-rendering seat map for switched tab PNR:", targetPnr);
                    try {
                        renderLayoutForPNR(targetPnr);
                        console.log("âœ… Seat map re-rendered successfully for tab switch");
                    } catch (renderError) {
                        console.error("âŒ Error re-rendering seat map:", renderError);
                    }
                } else {
                    console.warn("âš ï¸ No seat map data found for PNR:", targetPnr);
                }

                // Re-initialize event handlers (in case rerender affected them)
                try {
                    initializeTabSwitching();
                    initializePassengerSelection();
                    console.log("âœ… Event handlers re-initialized after tab switch");
                } catch (initError) {
                    console.error("âŒ Error re-initializing event handlers:", initError);
                }

                console.log("âœ… handleTabSwitchComplete finished successfully");
            } catch (error) {
                console.error("âŒ Error in handleTabSwitchComplete:", error);
                console.error("Error details:", error.message);
                console.error("Stack trace:", error.stack);
            } finally {
                // Hide loading overlay
                const overlay = document.getElementById("loadingOverlay");
                if (overlay) {
                    overlay.style.display = "none";
                    document.body.style.overflow = "";
                }
            }
        }

        /* ==============  å–   æ¶ˆ  ============== */
        cancelButton.addEventListener("click", () => {
            const editableFields = document.querySelectorAll(".editable-field");
            const actionButtons = document.querySelectorAll(".actionbtn");
            let mobilePassengerSelector =
                document.querySelector('#resultTabContent .tab-pane.show.active .mobile-passenger-selector');
            if (!mobilePassengerSelector) {
                mobilePassengerSelector =
                    document.querySelector('#resultTabContent .tab-pane.active .mobile-passenger-selector');
            }
            if (mobilePassengerSelector) {
                mobilePassengerSelector.value = ""; // Reset to the default "-- è«‹é¸æ“‡æ—…å®¢ --" option
                mobilePassengerSelector.disabled = true;
            }

            const flightSearchForm = document.getElementById("flightSearchForm");
            if (flightSearchForm) {
                flightSearchForm.querySelectorAll(".disabled-by-edit").forEach((el) => {
                    el.disabled = false;
                    el.classList.remove("disabled-by-edit");
                });
            }

            document.querySelectorAll(".edit-only").forEach((td) => {
                td.style.display = "none";
            });

            editableFields.forEach((f) => {
                if (f.dataset.orig !== undefined) f.value = f.dataset.orig;
                f.disabled = true;
                f.style.backgroundColor = "transparent";
                f.style.border = "1px solid #ced4da";
                f.classList.remove("is-invalid");
                delete f.dataset.orig;
            });

            actionButtons.forEach((b) => {
                b.disabled = true;
                b.style.cursor = "not-allowed";
            });

            // Clear current tab seat assignments and reset to original state
            clearCurrentTabSeatAssignments();

            isEditing = false;
            editButton.textContent = "é¸ä½/æ›ä½";
            cancelButton.style.display = "none";
            nextStepBtn.style.display = "block";
            lastStepBtn.style.display = "block";

            // Re-enable tab switching when canceling
            enableTabSwitching();

            document.getElementById("resultTabContent").style.pointerEvents = "none"; // ğŸ”’ é—œé–‰äº’å‹•

            console.log("âŒ Canceled seat selection - current tab assignments reverted to original state");
        });

        function showTabs() {
            console.log("ğŸš€ [DEBUG] showTabs() function started");

            // Parse and store the C2OperationDisable map globally at the beginning
            const pnrC2DisabledMapContainer = document.getElementById("pnrC2DisabledMapContainer");
            if (pnrC2DisabledMapContainer) {
                pnrC2DisabledMap = JSON.parse(pnrC2DisabledMapContainer.getAttribute("data-pnr-c2-disabled-map"));
            }
            console.log("pnrC2DisabledMap: " + pnrC2DisabledMap);
            // pnrC2DisabledMap = { 'D5549O': true };

            console.log("ğŸ” [DEBUG] Getting DOM elements...");
            // const msgs = document.getElementById("{!$Component.msgs}");
            const successTip = document.getElementById("{!$Component.SearchSuccessPanel}");
            const errorTip = document.getElementById("{!$Component.SearchErrorPanel}");
            const tabResults = document.getElementById("tabResults");
            const searchResults = document.getElementById("searchResults");
            const fixedBtns = document.getElementById("fixedBottomButtons");
            const searchPrompt = document.getElementById("searchPrompt");

            console.log("ğŸ” [DEBUG] DOM elements found:", {
                successTip: !!successTip,
                errorTip: !!errorTip,
                tabResults: !!tabResults,
                searchResults: !!searchResults,
                fixedBtns: !!fixedBtns,
                searchPrompt: !!searchPrompt
            });

            // Simple DOM-based error message retrieval (like seat data)
            const errorContainer = document.getElementById("errorMessageContainer");
            const errorMessage = errorContainer ? errorContainer.getAttribute("data-error-message") || "" : "";

            console.log("ğŸ”§ [ERROR_STATE] Error message from DOM:", errorMessage);

            console.log("ğŸ” [DEBUG] Checking error message condition...");
            if (errorMessage) {
                console.log("ğŸš¨ [DEBUG] Error message detected, entering error handling path");
                if (errorMessage.includes("éƒ¨åˆ†PNR")) {
                    console.log("ğŸ” [DEBUG] Partial PNR case detected");
                    searchPrompt.style.display = "none";
                    tabResults.style.display = "block";
                    searchResults.style.display = "block";
                    fixedBtns.style.display = "flex";
                    successTip.style.display = "none";
                    errorTip.style.display = "block";

                    console.log("ğŸ” [showTabs] Partial PNR success - showing buttons");
                    console.log("  - fixedBtns element: ", fixedBtns);
                    console.log("  - fixedBtns display style: ", fixedBtns.style.display);

                    setTimeout(() => {
                        successTip.style.display = "none";
                    }, 2000);

                    // Load seat map for partial success cases - CRITICAL FIX
                    setTimeout(() => {
                        console.log("ğŸ”„ [DEBUG] Calling loadSeatMapWithRetry from partial PNR path");
                        loadSeatMapWithRetry();
                    }, 200);
                } else {
                    // é¡¯ç¤ºéŒ¯èª¤æç¤ºï¼Œéš±è—è³‡æ–™å€å¡Š
                    searchPrompt.style.display = "";
                    searchPrompt.textContent = "æŸ¥è©¢ç„¡çµæœ";
                    tabResults.style.display = "none";
                    searchResults.style.display = "none";
                    fixedBtns.style.display = "none";
                    successTip.style.display = "none";
                    errorTip.style.display = "block";

                    console.log("ğŸ” [showTabs] Error case - hiding buttons");
                    console.log("  - fixedBtns display style: ", fixedBtns.style.display);
                }
            } else {
                console.log("âœ… [DEBUG] No error message, entering SUCCESS path");
                // æˆåŠŸï¼šé¡¯ç¤ºè³‡æ–™ã€åº•éƒ¨æŒ‰éˆ•ï¼ŒæŠŠã€Œæœå°‹æˆåŠŸã€åå‡ºä¾†
                searchPrompt.style.display = "none";
                tabResults.style.display = "block";
                searchResults.style.display = "block";
                fixedBtns.style.display = "flex";
                successTip.style.display = "block";
                document.getElementById("resultTabContent").style.pointerEvents = "none"; // ğŸ”’ ç¦æ­¢äº’å‹•

                console.log("ğŸ” [showTabs] Normal success - showing buttons");
                console.log("  - fixedBtns element: ", fixedBtns);
                console.log("  - fixedBtns display style: ", fixedBtns.style.display);

                // å…©ç§’å¾Œè‡ªå‹•éš±è—
                setTimeout(() => {
                    successTip.style.display = "none";
                }, 2000);

                // Load seat map with delay to ensure DOM is updated
                setTimeout(() => {
                    console.log("ğŸ”„ [DEBUG] Calling loadSeatMapWithRetry from SUCCESS path");
                    loadSeatMapWithRetry();
                }, 200);
            }
            document.getElementById("loadingOverlay").style.display = "none";

            // Normalize initial passenger seat displays to remove leading zeros
            normalizeInitialPassengerSeatDisplays();

            // Update edit button visibility based on current tab's C2OperationDisable status
            console.log("ğŸ” [showTabs] Updating button visibility for current tab...");
            setTimeout(() => {
                try {
                    // Find the currently active tab
                    const activeTab = document.querySelector("#tabResults .nav-link.active");
                    console.log("activeTab: " + activeTab);
                    const currentPNR =
                        activeTab?.dataset.bsTarget?.replace("#tab", "") || activeTab?.textContent.trim() || null;

                    console.log("currentPNR:", currentPNR);

                    console.log("ğŸ” [showTabs] Initial active PNR: ", currentPNR);

                    // Use the centralized function to update button visibility
                    if (currentPNR) {
                        updateEditButtonVisibility(currentPNR);
                    }
                } catch (error) {
                    console.error("âŒ Error in showTabs button update:", error);
                }
            }, 100);
        }

        // å–æ¶ˆæŒ‰éˆ•
        cancelButton.addEventListener("click", function () {
            const editableFields = document.querySelectorAll(".editable-field");
            const actionButtons = document.querySelectorAll(".actionbtn");
            document.getElementById("resultTabContent").style.pointerEvents = "none";

            // æ¢å¾©åŸå§‹å€¼
            editableFields.forEach((field) => {
                // æ¸…é™¤é©—è­‰ç‹€æ…‹
                field.classList.remove("is-invalid");
                const feedback = field.parentElement.querySelector(".invalid-feedback");
                if (feedback) {
                    feedback.remove();
                }

                // æ¢å¾©åŸå§‹å€¼ï¼ˆå¦‚æœæœ‰ï¼‰
                if (originalValues[field.id]) {
                    field.value = originalValues[field.id];
                }

                // ç¦ç”¨æ¬„ä½
                field.disabled = true;
                field.style.backgroundColor = "transparent";
                field.style.border = "1px solid #ced4da";
            });

            // ç¦ç”¨æ“ä½œæŒ‰éˆ•
            actionButtons.forEach((button) => {
                button.disabled = true;
                button.style.cursor = "not-allowed";
            });

            // é‡è¨­ç›¸é—œæŒ‰éˆ•ç‹€æ…‹
            isEditing = false;
            cancelButton.style.display = "none";
            nextStepBtn.style.display = "block";
            editButton.textContent = "é¸ä½/æ›ä½";
        });

        (function () {
            var sidebar = document.getElementById("sidebar");
            if (sidebar) {
                sidebar.classList.add("hidden");
                sidebar.classList.remove("normal");
            }
        })();
        function adjustContentWrapper() {
            var sidebar = document.getElementById("sidebar");
            var contentWrapper = document.getElementById("content-wrapper");
            var fixedBottomButtons = document.getElementById("fixedBottomButtons");

            // å–å¾— sidebar çš„ç•¶å‰æ¨£å¼
            var sidebarStyle = window.getComputedStyle(sidebar);
            var transformValue = sidebarStyle.getPropertyValue("transform");

            // æª¢æŸ¥ sidebar æ˜¯å¦æœ‰ 'hidden' class æˆ– 'normal' class
            if (sidebar.classList.contains("hidden") && window.innerWidth >= 1025) {
                contentWrapper.style.paddingLeft = "0";
                fixedBottomButtons.style.paddingLeft = "0";
            } else if (sidebar.classList.contains("hidden") && window.innerWidth < 1025) {
                contentWrapper.style.paddingLeft = "0";
                fixedBottomButtons.style.paddingLeft = "0";
            }

            if (sidebar.classList.contains("normal") && window.innerWidth >= 1025) {
                contentWrapper.style.paddingLeft = "250px";
                contentWrapper.style.transition = "padding-left 0.3s ease-in-out";
                fixedBottomButtons.style.paddingLeft = "250px";
                fixedBottomButtons.style.transition = "padding-left 0.3s ease-in-out";
            } else if (sidebar.classList.contains("normal") && window.innerWidth < 1025) {
                contentWrapper.style.paddingLeft = "0";
                fixedBottomButtons.style.paddingLeft = "0";
            }
        }

        // ç›£è½ sidebar çš„ class è®ŠåŒ–
        var observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === "attributes" && mutation.attributeName === "class") {
                    adjustContentWrapper();
                }
            });
        });

        // ç•¶ DOM å…§å®¹åŠ è¼‰å®Œæˆå¾ŒåŸ·è¡Œ
        document.addEventListener("DOMContentLoaded", function () {
            var sidebar = document.getElementById("sidebar");
            observer.observe(sidebar, {
                attributes: true,
            });

            // åˆå§‹èª¿ç”¨ adjustContentWrapper
            adjustContentWrapper();
        });

        // åŒæ™‚ç›£è½ window resize äº‹ä»¶ï¼Œè®“ç•«é¢ç¸®å°å¾Œä¹Ÿèƒ½æ­£ç¢ºèª¿æ•´
        window.addEventListener("resize", adjustContentWrapper);

        // Tab change event listener for button visibility
        document.addEventListener("DOMContentLoaded", function () {
            console.log("ğŸ” Setting up tab change listeners...");

            // Use event delegation to catch all tab clicks
            document.body.addEventListener(
                "shown.bs.tab",
                function (event) {
                    if (event.target && event.target.classList.contains("nav-link")) {
                        var target = event.target.getAttribute("data-bs-target");
                        if (target) {
                            var targetPNR = target.replace("#tab", "");
                            console.log("ğŸ” [Tab Change] Tab changed to PNR: ", targetPNR);
                            updateEditButtonVisibility(targetPNR);
                        }
                    }
                },
                true
            );

            // Also handle direct clicks on tab links
            document.body.addEventListener("click", function (event) {
                if (
                    event.target &&
                    event.target.classList.contains("nav-link") &&
                    event.target.getAttribute("data-bs-toggle") === "tab"
                ) {
                    setTimeout(() => {
                        var target = event.target.getAttribute("data-bs-target");
                        if (target) {
                            var targetPNR = target.replace("#tab", "");
                            console.log("ğŸ” [Tab Click] Tab clicked for PNR: ", targetPNR);
                            updateEditButtonVisibility(targetPNR);
                        }
                    }, 50);
                }
            });
        });

        //æ¸…é™¤éµæŠŠæ±è¥¿éƒ½æ¸…é™¤
        document.addEventListener("DOMContentLoaded", function () {
            const btnClear = document.getElementById("clearButton");
            btnClear.addEventListener("click", function () {
                // æ‹¿åˆ° VF çœŸæ­£ç”¢ç”Ÿçš„ input id
                doReset();
                const idFlightNum = "{!$Component.searchForm.flightNumber}";
                const idDepart = "{!$Component.searchForm.departureDate}";
                const idBooking = "{!$Component.searchForm.bookingCodes}";

                // 1. æ¸…ç©ºæ¬„ä½å€¼
                document.getElementById("flightNumber_display").value = "";
                document.getElementById(idFlightNum).value = "";
                document.getElementById(idDepart).value = "";
                document.getElementById(idBooking).value = "";

                // 2. ç§»é™¤æ‰€æœ‰é©—è­‰æ¨£å¼ & è¨Šæ¯
                document.querySelectorAll("#flightSearchForm .required-field").forEach((field) => {
                    field.classList.remove("is-invalid");
                    const fb = field.parentElement.querySelector(".invalid-feedback");
                    if (fb) fb.remove();
                });

                // 3. é‚„åŸä»‹é¢é¡¯ç¤º
                document.getElementById("outerWrapper").style.marginBottom = "0";
                document.getElementById("fixedBottomButtons").style.display = "none";
                document.getElementById("searchResults").style.display = "none";
                document.getElementById("searchPrompt").style.display = "block";
                document.getElementById("searchPrompt").textContent = "è«‹æœå°‹è³‡æ–™";
                document.getElementById("tabResults").style.display = "none";

                hasSearched = false;
            });
        });

        /**
         * Validates search form before submission
         */
        function validateSearch() {
            console.log("ğŸ› validateSearch");

            const fields = document.querySelectorAll("#flightSearchForm .required-field");
            let ok = true;

            fields.forEach((field) => {
                field.classList.remove("is-invalid");
                const old = field.parentElement.querySelector(".invalid-feedback");
                if (old) old.remove();

                if (!field.value.trim()) {
                    ok = false;
                    field.classList.add("is-invalid");

                    const div = document.createElement("div");
                    div.className = "invalid-feedback w-100";
                    div.textContent = "å¿…å¡«";
                    field.insertAdjacentElement("afterend", div);
                }
            });

            if (ok) {
                // é¡¯ç¤º loading é®ç½©
                document.getElementById("loadingOverlay").style.display = "block";
                document.body.style.overflow = "hidden"; // ç¦æ­¢æ»¾å‹•

                // é©—è­‰é€šé â†’ è§¸ç™¼éš±è—çš„ commandButton
                doSearch();
            }
        }

        /**
         * Store current tab's original assignments when entering edit mode
         */
        function storeCurrentTabOriginalAssignments() {
            if (!currentActivePnr) {
                console.warn("âŒ No active PNR to store original assignments for");
                return;
            }

            console.log("ğŸ’¾ Storing original assignments for current tab:", currentActivePnr);

            // Store the current tab's assignments as original for cancel functionality
            currentTabOriginalAssignments = {};

            if (seatAssignments[currentActivePnr]) {
                currentTabOriginalAssignments = JSON.parse(JSON.stringify(seatAssignments[currentActivePnr]));
            }

            console.log("âœ… Stored current tab original assignments:", currentTabOriginalAssignments);
        }

        /**
         * Apply existing seat assignments to the seat map for a specific PNR
         */
        function applyExistingSeatAssignments(pnrCode) {
            console.log("ğŸ¯ Applying existing seat assignments for PNR:", pnrCode);

            if (!seatAssignments[pnrCode]) {
                console.log("â„¹ï¸ No existing assignments for PNR:", pnrCode);
                return;
            }

            const context = `#seatmap-wrapper-${pnrCode}`;

            // Apply each assignment
            Object.entries(seatAssignments[pnrCode]).forEach(([passengerIndex, seatCode]) => {
                console.log(`ğŸª‘ Applying assignment: Passenger ${passengerIndex} -> Seat ${seatCode}`);

                const seatElement = findSeatElement(seatCode, pnrCode);
                if (seatElement) {
                    seatElement.classList.remove("seat-general", "seat-no-window");

                    // Add selected class
                    if (!seatElement.classList.contains("seat-disabled")) {
                        seatElement.classList.add("seat-selected");
                    }

                    // Remove any existing circles (in case there are duplicates)
                    const existingCircles = seatElement.querySelectorAll(".passenger-number-circle");
                    existingCircles.forEach((circle) => circle.remove());

                    // Create passenger number circle
                    const circle = document.createElement("div");
                    circle.className = "passenger-number-circle";
                    circle.textContent = passengerIndex;
                    seatElement.appendChild(circle);

                    console.log(`âœ… Applied existing assignment: Seat ${seatCode} for passenger ${passengerIndex}`);
                } else {
                    console.warn(`âŒ Seat element not found: ${seatCode} in context ${context}`);
                }
            });

            console.log("âœ… Existing seat assignments applied for PNR:", pnrCode);
        }

        /**
         * âœ¨ NEW: Renders a dropdown selector for passengers on mobile
         * @param {string} pnrCode - The PNR code for which to render the selector
         */
        function renderPassengerSelector(pnrCode) {
            const container = document.getElementById("mobile-passenger-selector-container-" + pnrCode);
            if (!container) return;

            // Clear any previous selector
            container.innerHTML = '<label class="form-label">è«‹é¸æ“‡æ—…å®¢</>';

            const passengers = allTabData[pnrCode];
            if (!passengers || passengers.length === 0) return;

            // Create the select element
            const select = document.createElement("select");
            select.id = "mobile-passenger-selector-" + pnrCode;
            select.className = "form-select mobile-passenger-selector";
            select.disabled = !isEditing; // Disable unless in edit mode

            // Add a default placeholder option
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡æ—…å®¢ --</option>';

            // Populate with passengers
            passengers.forEach((passenger, index) => {
                const passengerIndex = index + 1;
                const option = document.createElement("option");
                option.value = passengerIndex;

                // Set the display text using our existing helper
                option.textContent = `${passengerIndex}. ${passenger.name} - ${getSeatDisplayText(passenger, passenger.seat)}`;

                // Disable the option if the passenger cannot select a seat
                if (passenger.passengerType === "INF" || passenger.seatIsChargeable) {
                    option.disabled = true;
                }

                select.appendChild(option);
            });

            // Add event listener to update global state on change
            select.onchange = function () {
                const pIndex = parseInt(this.value, 10);

                if (!pIndex) {
                    selectedPassenger = null;
                    return;
                }

                const paxData = allTabData[pnrCode][pIndex - 1];
                selectedPassenger = {
                    tabKey: pnrCode,
                    passengerIndex: pIndex,
                    passengerName: paxData.name,
                };
                console.log("Mobile selector changed. Selected passenger:", selectedPassenger);

                // Also update the desktop list for visual consistency (if visible)
                updatePassengerSelectionVisual();
            };

            container.appendChild(select);
        }

        /* =========================================================
         * CODE ORGANIZATION SUMMARY
         * ========================================================= 
         * 
         * This seat selection system has been reorganized for better maintainability:
         * 
         * STRUCTURE:
         * 1. Global State & Configuration - Application variables
         * 2. Aircraft Layout Configurations - Static seat arrangements  
         * 3. Utility Functions - Helper calculations
         * 4. Seat Map Rendering - Layout generation
         * 5. Passenger Management - Selection and display
         * 6. Seat Assignment - Selection logic
         * 7. Data Initialization - Backend data loading
         * 8. Main Loading & Rendering - Core functionality
         * 9. Tab Management - PNR navigation
         * 10. UI Utilities - Interface helpers
         * 11. Save/Cancel - Operation handling
         * 12. Debug & Testing - Development utilities
         * 13. Modal & Form - User interactions
         * 
         * 
         ========================================================= */
    </script>
    <script>
        (function () {
            // ç›´æ¥ç”¨ getElementByIdï¼Œé¿å… selector éœ€è¦å†’è™Ÿè½‰ç¾©çš„å•é¡Œ
            var fieldId = "{!$Component.searchForm:departureDate}";

            function isMobileLike() {
                try {
                    if (window.matchMedia && window.matchMedia("(pointer: coarse)").matches) return true;
                } catch (e) {}
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }

            function supportsNativeDate() {
                var i = document.createElement("input");
                i.setAttribute("type", "date");
                return i.type === "date" && "valueAsDate" in i;
            }

            function initDateField() {
                var el = document.getElementById(fieldId);
                if (!el) return;

                // é¿å…é‡è¤‡åˆå§‹åŒ–
                if (el._flatpickr) {
                    el._flatpickr.destroy();
                }

                var mobile = isMobileLike();

                if (mobile) {
                    // æ‰‹æ©Ÿï¼šå¼·åˆ¶ç”¨ flatpickrï¼ˆé¿å…åŸç”Ÿèˆ‡å¥—ä»¶åŒæ™‚å‡ºç¾ï¼‰
                    el.setAttribute("type", "text");
                    if (window.flatpickr) {
                        flatpickr(el, {
                            dateFormat: "Y-m-d",
                            allowInput: false,
                            clickOpens: true,
                            disableMobile: true,
                            minDate: new Date().fp_incr(-4),
                        });
                    }
                } else {
                    // æ¡Œæ©Ÿï¼šå„ªå…ˆåŸç”Ÿï¼›è‹¥ç€è¦½å™¨ä¸æ”¯æ´ï¼Œå†é€€å› flatpickr
                    if (supportsNativeDate()) {
                        el.setAttribute("type", "date"); // åªç”¨åŸç”Ÿï¼Œä¸åˆå§‹åŒ– flatpickr
                    } else {
                        el.setAttribute("type", "text");
                        if (window.flatpickr) {
                            flatpickr(el, {
                                dateFormat: "Y-m-d",
                                allowInput: false,
                                clickOpens: true,
                                disableMobile: true,
                            });
                        }
                    }
                }
            }

            // åˆæ¬¡è¼‰å…¥
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", initDateField);
            } else {
                initDateField();
            }
            window.addEventListener("load", initDateField);

            // VF/JSF å±€éƒ¨é‡ç¹ªå¾Œé‡æ›
            // 1) åŸç”Ÿ JSF AJAXï¼ˆè‹¥é é¢æœ‰ç”¨ï¼‰
            if (window.jsf && jsf.ajax && jsf.ajax.addOnEvent) {
                jsf.ajax.addOnEvent(function (data) {
                    if (data && data.status === "success") initDateField();
                });
            }
            // 2) jQuery AJAXï¼ˆè‹¥æœ‰ï¼‰
            if (window.jQuery) {
                jQuery(document).on("ajaxComplete", initDateField);
            }
            // 3) è®“ apex:commandButton/commandLink å¯åœ¨ oncomplete å‘¼å«
            window.initDateField = initDateField;
        })();
    </script>
</apex:page>